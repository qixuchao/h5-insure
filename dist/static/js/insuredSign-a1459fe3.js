import{d as e,i,h as s,c5 as a,j as n,bc as o,l as t,o as r,c as d,b as l,a as c,u,F as f,s as g,p,f as m,w as v,v as b,cQ as h,bj as S,bb as y,cO as I,cP as j,T as w,c4 as D,bd as N,bO as L,a$ as O,cR as E,b3 as R}from"./index-83a8b446.js";import{b as C}from"./product-6bdc6741.js";import{g as U,m as V}from"./trial-e48acfbd.js";import{_ as q}from"./SignPart-b63aa187.js";import{u as P}from"./useOrder-5d8cb7c9.js";import{N as T}from"./notice-8819bd7b.js";import"./PolicyInfo-9498e98e.js";import{p as _}from"./utils-89a8b2ff.js";import{g as k}from"./utils-7bac2bc5.js";import{i as B}from"./core-3b1d23d8.js";import"./index-340d107b.js";import"./cloneDeep-d236c69c.js";import"./utils-1b63caf2.js";import"./createProposal-4bee1c8e.js";import"./trial-166a0af0.js";import"./infoCollection-207a44bb.js";const $={class:"long-verify"},x={class:"header"},z={class:"verify-content"},F={class:"footer-button footer-bar"},M=e({__name:"insuredSign",setup(e){const M=i(),A=s(),{tenantId:H,orderNo:G,orderCode:J,extraInfo:Q,isShare:W,insurerCode:K,preview:X}=M.query;let Y={};try{Y=JSON.parse(decodeURIComponent(Q))}catch(re){}const Z=P(),ee=`${window.origin}/baseInsurance/long/phoneVerify?${a.stringify({...M.query,orderNo:J||G})}`,ie=n(),se=n({holder:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""},insured:{fileList:[],personalInfo:[],isSign:!1,isVerify:!1,isShareSign:!1,signData:{},compositionSign:""},agent:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""}}),ae=(e,i,s)=>{var a;h(e,i,null==(a=Z.value)?void 0:a.id,H,s).then((()=>{G&&U({orderNo:J||G,tenantId:H}).then((({code:e,data:i})=>{if("10000"===e){const e={};i.tenantOrderAttachmentList.forEach((i=>{i.objectType===T.INSURED&&(30===i.category?e[i.objectId].push(i.fileBase64):21===i.category&&(se.value.insured.compositionSign=i.uri))})),se.value.insured.signData=e}}))}))},ne=n({sign:[],verify:[],scribing:""}),oe=()=>{if(X)return void S(y.SIGN,M.query);const e=[];ie.value&&((W?ne.value.sign.includes("5"):ne.value.sign.includes("3"))&&e.push(...(ie.value||[]).map((e=>e.validateSign()))),ne.value.verify.includes("2")&&e.push(...(ie.value||[]).map((e=>e.validateVerify())))),Promise.all(e).then((e=>{I({bizObjectId:Z.value.insuredList.map((e=>e.id)),bizObjectType:j.INSURED,orderId:Z.value.id,tenantId:H,shareFlag:W?1:2}).then((({code:e,data:i})=>{if("10000"===e&&i){if(W)return w("本次签名已完成"),void setTimeout((()=>{B?D.closeWindow():window.close()}),1500);A.push({path:N.sign,query:M.query})}}))})).catch((e=>{w(e.message)}))};n({imgUrl:"",desc:"",title:"",link:ee});o((()=>{(async()=>{let e={};const{code:i,data:s}=await U({orderNo:J||G,tenantId:H});"10000"===i&&(Object.assign(Z.value,s),se.value.insured.personalInfo=s.insuredList.map((e=>(e.isCert=1,e))),e=_(s.insuredList[0].productList),s.tenantOrderAttachmentList.forEach((e=>{e.objectType===T.INSURED&&e.objectId&&(30===e.category?se.value.insured.signData[e.objectId]?se.value.insured.signData[e.objectId].push(e.fileBase64):se.value.insured.signData[e.objectId]=[e.fileBase64]:21===e.category&&(se.value.insured.compositionSign=e.uri))}))),C(e).then((({code:e,data:i})=>{var s;if("10000"===e){const{signMaterialMap:e}=(null==(s=i.productMaterialPlanVOList)?void 0:s[1])||{};(Object.values(e||[]).flat()||[]).forEach((e=>{e.noticeObject===T.INSURED&&se.value.insured.fileList.push({attachmentName:e.materialName,attachmentList:[{...e,materialSource:k(`${null==e?void 0:e.materialSource}`,null==e?void 0:e.materialContent)}]})}))}})),V(e).then((({data:e,code:i})=>{if("10000"===i){const{signInfo:i}=L(e.productFactor);i.schema.forEach((e=>{"eleSign"===e.name&&e.columns.forEach((i=>{e.required&&ne.value.sign.push(i.code),"1"===i.code?se.value.agent.isSign=!0:"2"===i.code?se.value.holder.isSign=!0:"3"===i.code?se.value.insured.isSign=!0:"4"===i.code?se.value.holder.isShareSign=!0:"5"===i.code&&(se.value.insured.isShareSign=!0)}))}))}}))})()}));const te=n();return t((()=>{setTimeout((async()=>{te.value=window.getIseeBiz&&await window.getIseeBiz()}),1500)})),(e,i)=>{var s,a,n,o;const t=O,h=E,S=R;return r(),d("div",$,[l(t),c("div",x,[l(h,{type:"warning",content:(null==(a=null==(s=u(se).insured.personalInfo)?void 0:s[0])?void 0:a.name)&&`本人${null==(o=null==(n=u(se).insured.personalInfo)?void 0:n[0])?void 0:o.name}已阅读并同意签署《电子投保单》（投保信息确认）`},null,8,["content"])]),c("div",z,[!u(W)||u(se).insured.isShareSign?(r(!0),d(f,{key:0},g(u(se).insured.personalInfo||[],(e=>(r(),p(q,{key:e.id,ref_for:!0,ref_key:"insuredSignRef",ref:ie,"data-source":[],"order-detail":u(Z),"sign-string":u(se).insured.signData[e.id],"show-sign":u(W)?u(se).insured.isShareSign:u(se).insured.isSign,"show-verify":u(se).insured.isVerify,"file-list":u(se).insured.fileList,"personal-info":e||{},"composition-sign":u(se).insured.compositionSign,title:"被保险人",onHandleSign:i=>ae("INSURED",i,e.id)},null,8,["order-detail","sign-string","show-sign","show-verify","file-list","personal-info","composition-sign","onHandleSign"])))),128)):m("",!0)]),c("div",F,[l(S,{type:"primary",class:"submit-btn",onClick:oe},{default:v((()=>[b("确定")])),_:1})])])}}});export{M as default};
