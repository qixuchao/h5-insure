import{z as e,d as a,a as r,u as t,r as n,t as o,C as l,I as s,v as i,$ as d,bj as u,a5 as c,b as m,c as p,e as v,w as y,i as f,a9 as h,Z as I,f as N,x as g,bE as w,Y as b,g as k,ad as C,W as T,T as O,D as F,B as L,aZ as D,U as P,V as j,ca as x,as as S,c0 as H,q as U}from"./index-3300826d.js";import{d as E}from"./debounce-eed12388.js";import{O as q}from"./order-1732f29e.js";import{S as A,R,P as V,I as _}from"./infoCollection-aa0e608b.js";import{i as M,d as B,e as $,s as K,p as Y,g as z}from"./trial-fa78661d.js";import{p as W}from"./product-276c1373.js";import{t as G,g as J,a as Z,o as Q,s as X,v as ee,b as ae,j as re}from"./utils-e5a01531.js";import{t as te}from"./theme-ea709837.js";import{d as ne,B as oe,D as le,G as se,S as ie,H as de,P as ue,U as ce,_ as me,W as pe,a as ve}from"./auth-b95054ad.js";import{_ as ye}from"./close-fb8f525f.js";import"./pdfh5-008ca364.js";import"./isObjectLike-a9798079.js";import"./trial-28355e02.js";import"./index-01e7eada.js";import"./index-c7e07159.js";import"./index-3dcb1c75.js";/* empty css              */import"./bankCard-07bf592d.js";import"./validator-5a13dc82.js";import"./phoneVerify-2f15fb99.js";import"./index-99b3573f.js";const fe={key:0},he={class:"page-internet-product-detail"},Ie={class:"info"},Ne={class:"footer-button"},ge={class:"price"},we=(e=>(P("data-v-6874810e"),e=e(),j(),e))((()=>N("span",null,"总保费",-1))),be={key:0};var ke=e(a({__name:"packageProcess",setup(e){const a=r(),P=t(),{productCode:j="BWYL2021",tenantId:ke,orderNo:Ce,phoneNo:Te,agentCode:Oe="",saleChannelId:Fe,paymentMethod:Le,certNo:De,name:Pe,pageCode:je,from:xe}=P.query,Se=n(),He=n(),Ue=n(),Ee=n(),qe="payBack"===je;n(!1);const Ae=n(!1),Re=n(!1),Ve=n(0),_e=n(!1),Me=n(!1),Be=n({show:!1,html:""}),$e=n({}),Ke=n(),Ye=n(!1),ze=n("");let We="";const Ge=o({holder:{certNo:De,certType:l.CERT,mobile:Te,name:Pe,socialFlag:A.HAS},insured:{certNo:De,certType:l.CERT,name:Pe,socialFlag:A.HAS,relationToHolder:R.SELF},paymentMethod:Le,renewalDK:"Y",paymentFrequency:V.YEAR,packageProductList:[],mobileSmsCode:""}),Je=n(ne),Ze=n(ne),Qe=o({showInsure:!qe,canInsure:!1,canUpgrade:!1}),Xe=s((()=>{var e,a;return(null==(a=null==(e=He.value)?void 0:e.tenantProductInsureVO)?void 0:a.attachmentVOList.filter((e=>"健康告知"===e.attachmentName)))||[]})),ea=s((()=>{var e,a;return(null==(a=null==(e=He.value)?void 0:e.tenantProductInsureVO)?void 0:a.attachmentVOList.filter((e=>"健康告知"!==e.attachmentName)))||[]})),aa=()=>{ze.value=Ee.value?Ge.paymentFrequency==V.YEAR?"元/年":"元/月":""},ra=()=>{a.push({path:"/internet/guaranteeUpgrade",query:{...P.query,tenantId:ke,productCode:"BWYL2022",orderNo:Ce,agentCode:Oe}})},ta=()=>{Me.value=!1},na=()=>{Ze.value=Je.value},oa=()=>{Ze.value={...Ze.value,relationToHolderDisable:!1,insuredNameDisable:!1,insuredCertDisable:!1,insuredSocialDisable:!1}},la=e=>`${H}/internet/payFail?tenantId=${ke}&orderNo=${e}&agentCode=${Oe}&pageCode=payBack&from=${xe||"normal"}`,sa=async e=>{const a=J({tenantId:ke,saleUserId:Oe,saleChannelId:Fe,detail:He.value,insureDetail:Ue.value,paymentMethod:Ge.paymentMethod,paymentFrequency:Ge.paymentFrequency,renewalDK:Ge.renewalDK,iseeBizNo:We,successJumpUrl:"",premium:Ee.value,holder:Ge.holder,insured:Ge.insured,tenantOrderRiskList:e,orderStatus:"",orderTopStatus:"",orderNo:Ce,originOrderIds:Ke.value});try{const e=await K(a),{code:t,data:n}=e;Re.value=!1,Ae.value=!1,"10000"===t&&(O.clear(),delete a.id,$e.value={orderNo:n.data,order:a},Re.value=!0,r=0,Ve.value=r,Re.value=!0)}catch(t){O.clear(),Qe.canInsure=!0}var r},ia=()=>new Promise(((e,a)=>{var r,t;null==(t=null==(r=Se.value)?void 0:r.validateForm)||t.call(r).then((async()=>{if(!(()=>{if(Ge.holder.certNo){const e=U(Ge.holder.certNo);if(ee(Ge.holder.certNo,18,"year"))return O("投保人年龄必须大于等于18岁！"),!1;if(Ge.insured.certNo&&Ge.insured.relationToHolder===R.MATE&&e===U(Ge.insured.certNo))return O("被保人为配偶时，性别不可相同！"),!1}if(Ge.insured.certNo){if(Ge.insured.relationToHolder===R.CHILD&&ee(Ge.insured.certNo,30,"day"))return O("被保人为子女时，年龄必须大于等于30天！"),!1;if(Ge.insured.relationToHolder===R.PARENT&&!ee(Ge.insured.certNo,71,"year"))return O("被保人为父母时，年龄必须小于等于70岁！"),!1}if([R.CHILD,R.PARENT].includes(Ge.insured.relationToHolder)){const e=ae(Ge.holder.certNo,"year"),a=ae(Ge.insured.certNo,"year");if(Ge.insured.relationToHolder===R.CHILD&&e-a<18)return O("投保人和子女年龄必须相差18岁！"),!1;if(Ge.insured.relationToHolder===R.PARENT&&a-e<18)return O("投保人和父母年龄必须相差18岁！"),!1}return!0})())return void(Qe.canInsure=!0);const{calcData:r,riskVOList:t}=Z({holder:Ge.holder,insured:Ge.insured,tenantId:ke,productDetail:He.value,insureDetail:Ue.value,paymentFrequency:Ge.paymentFrequency,packageRiskIdList:Q(Ge.packageProductList)},!1,re);(!Array.isArray(t)||t.length<1)&&(O("被保人年龄需在30天(含) - 70岁(含)之间！"),Ee.value=null,a(new Error));const n=await Y(r),{code:o,data:l}=n;"10000"===o?(Ee.value=l.premium,e({condition:t,data:l})):(Ee.value=null,a(new Error))})).catch((e=>{Qe.canInsure=!0,X(e)}))})),da=async()=>{var e;if(qe)ra();else try{O.loading({message:"订单生成中...",forbidClick:!0,duration:0});const{condition:a,data:r}=await ia(),t={},n=(e=[])=>{(e||[]).forEach((e=>{var a;t[e.riskCode]=e,(null==(a=e.riskPremiumDetailVOList)?void 0:a.length)&&n(e.riskPremiumDetailVOList)}))};n(r.riskPremiumDetailVOList);const o=G({tenantId:ke,riskList:a,riskPremium:t,productId:null==(e=He.value)?void 0:e.id});sa(o)}catch(a){Qe.canInsure=!0}finally{O.clear()}},ua=e=>{var a;"allFalse"===e?(Ae.value=!1,Qe.canInsure=!0,(async e=>{O.loading({message:"核保中...",forbidClick:!0,duration:0});try{const a=await B(e),{code:r}=a;if("10000"===r){const a=await $({orderNo:e.orderNo,tenantId:ke}),{data:r}=a;"10000"===a.code&&(2===r.type?(Be.value={show:!0,html:r.paymentUrl},console.log("data.paymentUrl",Be.value),S((()=>{console.log("document.forms",document.forms);const e=document.getElementById("cashierSubmit");null==e||e.addEventListener("submit",(e=>{e.preventDefault()})),null==e||e.submit()}))):window.location.href=r.paymentUrl)}Qe.canInsure=!0}catch(a){Qe.canInsure=!0}finally{O.clear()}})({...$e.value.order,orderNo:$e.value.orderNo,extInfo:{extraInfo:{renewalDK:Ge.renewalDK,paymentMethod:Ge.paymentMethod,paymentFrequency:Ge.paymentFrequency,successJumpUrl:(a=$e.value.orderNo,`${H}/pay?orderNo=${a}&saleUserId=${Oe}&tenantId=${ke}`),failUrl:la($e.value.orderNo)},iseeBizNo:We}})):F.confirm({message:"您当前的健康状况不符合该产品",confirmButtonText:"确定"}).then((()=>{window.history.back()})).catch((()=>{Qe.canInsure=!0}))},ca=()=>{Re.value=!1,Ae.value=!1,Qe.canInsure=!0},ma=()=>{Re.value=!1,Ae.value=!0};i([()=>Ge.insured.certNo,()=>Ge.insured.socialFlag,()=>Ge.packageProductList,()=>Ge.paymentFrequency],E((()=>{Ge.insured.certNo&&Ge.insured.socialFlag&&(()=>{const{holder:{certNo:e,mobile:a,name:r,socialFlag:t},insured:{certNo:n,name:o,socialFlag:l,relationToHolder:s},paymentMethod:i}=Ge;return!(!x(n)||!l)})()&&(async()=>{const{calcData:e,riskVOList:a}=Z({holder:Ge.holder,insured:Ge.insured,tenantId:ke,productDetail:He.value,insureDetail:Ue.value,paymentFrequency:Ge.paymentFrequency,packageRiskIdList:Q(Ge.packageProductList)},!1,re);if(!Array.isArray(a)||a.length<1)return O("被保人年龄需在30天(含) - 70岁(含)之间！"),Ee.value=null,{};Ye.value=!0;const r=await Y(e);Ye.value=!1;const{code:t,data:n}=r;"10000"===t?Ge.insured.certNo?(Ee.value=n.premium,aa()):(Ee.value=null,aa()):Ee.value=null})()}),500),{deep:!0,immediate:!0}),i((()=>Ge.insured.certNo),(()=>{Ge.insured.certNo||(Ee.value=null)}));const pa=async()=>{var e,a,r,t,n,o,l,s,i,d,u,c,m,p,v;const y=await z({orderNo:Ce,tenantId:ke}),{code:f,data:h}=y;if("10000"===f){const{id:y,tenantOrderHolder:f,tenantOrderInsuredList:I,extInfo:N}=h;if(!qe){Ke.value={id:y,holderId:null==f?void 0:f.id,insuredId:null==I?void 0:I[0].id};const s=((null==(a=null==(e=I[0])?void 0:e.tenantOrderProductList[0])?void 0:a.tenantOrderRiskList)||[]).map((e=>{var a;return(null==(a=e.extInfo)?void 0:a.riskId)||""}));return Ge.packageProductList.forEach((e=>{e.value=e.productRiskVoList.filter((e=>s.includes(e.id))).length>0?_.INSURE:_.UN_INSURE})),Object.assign(Ge,{holder:{certNo:f.certNo,certType:f.certType,mobile:f.mobile,name:f.name,socialFlag:A.HAS},insured:{certNo:null==I?void 0:I[0].certNo,certType:null==(r=I[0])?void 0:r.certType,name:null==(t=I[0])?void 0:t.name,socialFlag:null==(o=null==(n=I[0])?void 0:n.extInfo)?void 0:o.hasSocialInsurance,relationToHolder:null==(l=I[0])?void 0:l.relationToHolder},paymentMethod:N.extraInfo.paymentMethod,paymentFrequency:N.extraInfo.paymentFrequency,renewalDK:N.extraInfo.renewalDK||"N"}),void(Qe.canInsure=!0)}Object.assign(Ge,{holder:{certNo:f.certNo,certType:f.certType,mobile:f.mobile,name:f.name,socialFlag:A.HAS},insured:{certNo:null==I?void 0:I[0].certNo,certType:null==(s=I[0])?void 0:s.certType,name:null==(i=I[0])?void 0:i.name,socialFlag:null==(u=null==(d=I[0])?void 0:d.extInfo)?void 0:u.hasSocialInsurance,relationToHolder:null==(c=I[0])?void 0:c.relationToHolder},paymentMethod:N.extraInfo.paymentMethod,paymentFrequency:N.extraInfo.paymentFrequency,renewalDK:N.extraInfo.renewalDK||"N"}),Ee.value=null==(v=null==(p=null==(m=I[0])?void 0:m.tenantOrderProductList)?void 0:p[0])?void 0:v.premium,h.orderStatus!==q.ACCEPT_POLICY&&h.orderStatus!==q.PAYMENT_SUCCESS||(Qe.canUpgrade=!0,_e.value=!1,Me.value=!0),h.orderStatus===q.PAYING&&(_e.value=!0,setTimeout((()=>{pa()}),3e3))}};return d((()=>{console.log("投保链接"),Ze.value=ve,Je.value=ve,Qe.canInsure=!0,(async()=>{var e,a;const r=await W({productCode:j,withInsureInfo:!0,tenantId:ke});"10000"===r.code&&(He.value=r.data,document.title=(null==(e=r.data)?void 0:e.productFullName)||"");const t=await M({productCode:j});"10000"===t.code&&(Ge.packageProductList=((null==(a=t.data)?void 0:a.packageProductVOList)||[]).map((e=>({...e,value:_.UN_INSURE,disabled:!1}))),Ue.value=t.data),Ce&&pa()})(),setTimeout((async()=>{We=window.getIseeBiz&&await window.getIseeBiz()}),1500)})),(e,a)=>{const r=u,t=L,n=D,o=c("dompurify-html");return m(),p(T,null,[v(n,{"theme-vars":f(te)},{default:y((()=>{var e,a,n,l,s,i,d;return[f(Be).show?h((m(),p("div",fe,null,512)),[[o,f(Be).html]]):I("",!0),N("div",he,[N("div",Ie,[v(oe,{url:null==(a=null==(e=f(He))?void 0:e.tenantProductInsureVO)?void 0:a.banner[0]},null,8,["url"]),v(le,{"product-name":null==(n=f(He))?void 0:n.productFullName,"product-desc":null==(s=null==(l=f(He))?void 0:l.showConfigVO)?void 0:s.desc},null,8,["product-name","product-desc"])]),v(se,{"show-service-config":"","guarantee-list":null==(d=null==(i=f(He))?void 0:i.tenantProductInsureVO)?void 0:d.titleAndDescVOS},null,8,["guarantee-list"]),v(ie,{detail:f(He).tenantProductInsureVO},{form:y((()=>[v(de,{ref_key:"formRef",ref:Se,"is-show-package":"",disable:!f(Qe).showInsure,"form-auth":f(Ze),"form-info":f(Ge),"product-detail":f(He),onOnReset:na,onOnUpdate:oa},null,8,["disable","form-auth","form-info","product-detail"])])),_:1},8,["detail"]),N("div",Ne,[N("div",ge,[we,f(Ye)?(m(),b(r,{key:1,class:"premium-loading",type:"spinner"})):(m(),p("span",be,g(f(Ee)?"￥":"")+g(f(w)(f(Ee)))+" "+g(f(ze)),1))]),v(t,{type:"primary",class:"right",disabled:!(f(Qe).canInsure||f(Qe).canUpgrade),onClick:da},{default:y((()=>[k(g(f(Qe).showInsure?"立即投保":"升级保障"),1)])),_:1},8,["disabled"])])]),f(Ce)?I("",!0):(m(),b(ue,{key:1,"product-detail":f(He)},null,8,["product-detail"])),v(ce,{"order-no":f(Ce),"tenant-id":f(ke),"is-show":f(Me),onOnConfirm:ra,onOnClose:ta},null,8,["order-no","tenant-id","is-show"])]})),_:1},8,["theme-vars"]),v(me,{show:f(Ae),"onUpdate:show":a[0]||(a[0]=e=>C(Ae)?Ae.value=e:null),"content-list":f(Xe),"active-index":0,onOnConfirmHealth:ua,onOnCloseHealth:ca},null,8,["show","content-list"]),f(Re)?(m(),b(ye,{key:0,show:f(Re),"onUpdate:show":a[1]||(a[1]=e=>C(Re)?Re.value=e:null),"content-list":f(ea),"active-index":f(Ve),text:"我已逐页阅读并确认告知内容","force-read-count":2,"on-close-file-preview":"",onSubmit:ma,onOnCloseFilePreview:ca},null,8,["show","content-list","active-index"])):I("",!0),v(pe,{"is-show":f(_e)},null,8,["is-show"])],64)}}}),[["__scopeId","data-v-6874810e"]]);export{ke as default};
