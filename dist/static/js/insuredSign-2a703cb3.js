import{d as e,i,h as a,bK as s,j as n,az as t,l as r,o,c as d,b as l,a as c,u,F as f,s as g,p,f as m,w as v,a8 as h,cJ as S,aF as b,ay as y,cH as I,cI as j,T as w,v as D,bA as N,ab as L,cK as E,aj as O}from"./index-c752b76c.js";import{b as C}from"./product-79bb5f4a.js";import{g as R,m as U}from"./trial-8fff5f38.js";import{_ as V}from"./SignPart-da5c9ae8.js";import{u as q}from"./useOrder-ab57545e.js";import{N as _}from"./notice-33e6eedd.js";import"./PolicyInfo-7194dfb2.js";import{p as k}from"./utils-19ff44cc.js";import{g as z}from"./utils-4976d5d5.js";import"./index-b369b631.js";import"./cloneDeep-a1b35667.js";import"./infoCollection-0fc92d75.js";import"./trial-2256b852.js";const B={class:"long-verify"},T={class:"header"},x={class:"verify-content"},P={class:"footer-button footer-bar"},A=e({__name:"insuredSign",setup(e){const A=i(),F=a(),{tenantId:H,orderNo:M,orderCode:$,extraInfo:J,isShare:K,insurerCode:G,preview:Q}=A.query;let W={};try{W=JSON.parse(decodeURIComponent(J))}catch(te){}const X=q(),Y=`${window.origin}/baseInsurance/long/phoneVerify?${s.stringify({...A.query,orderNo:$||M})}`,Z=n(),ee=n({holder:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""},insured:{fileList:[],personalInfo:[],isSign:!1,isVerify:!1,isShareSign:!1,signData:{}},agent:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""}}),ie=(e,i,a)=>{var s;S(e,i,null==(s=X.value)?void 0:s.id,H,a).then((()=>{M&&R({orderNo:$||M,tenantId:H}).then((({code:e,data:i})=>{if("10000"===e){const e={};i.tenantOrderAttachmentList.forEach((i=>{i.objectType===_.INSURED&&30===i.category&&e[i.objectId].push(i.fileBase64)})),ee.value.insured.signData=e}}))}))},ae=n({sign:[],verify:[],scribing:""}),se=()=>{if(Q)return void b(y.SIGN,A.query);const e=[];Z.value&&((K?ae.value.sign.includes("5"):ae.value.sign.includes("3"))&&e.push(...(Z.value||[]).map((e=>e.validateSign()))),ae.value.verify.includes("2")&&e.push(...(Z.value||[]).map((e=>e.validateVerify())))),Promise.all(e).then((e=>{I({bizObjectId:X.value.insuredList.map((e=>e.id)),bizObjectType:j.INSURED,orderId:X.value.id,tenantId:H}).then((({code:e,data:i})=>{if("10000"===e&&i){if(K)return void w("已完成");F.push({path:D.sign,query:A.query})}}))})).catch((e=>{w(e.message)}))};n({imgUrl:"",desc:"",title:"",link:Y});t((()=>{(async()=>{let e={};const{code:i,data:a}=await R({orderNo:$||M,tenantId:H});"10000"===i&&(Object.assign(X.value,a),ee.value.insured.personalInfo=a.insuredList.map((e=>(e.isCert=1,e))),e=k(a.insuredList[0].productList),a.tenantOrderAttachmentList.forEach((e=>{e.objectType===_.INSURED&&30===e.category&&e.objectId&&(ee.value.insured.signData[e.objectId]?ee.value.insured.signData[e.objectId].push(e.fileBase64):ee.value.insured.signData[e.objectId]=[e.fileBase64])}))),C(e).then((({code:e,data:i})=>{var a;if("10000"===e){const{signMaterialMap:e}=(null==(a=i.productMaterialPlanVOList)?void 0:a[1])||{};(Object.values(e||[]).flat()||[]).forEach((e=>{e.noticeObject===_.INSURED&&ee.value.insured.fileList.push({attachmentName:e.materialName,attachmentList:[{...e,materialSource:z(`${null==e?void 0:e.materialSource}`,null==e?void 0:e.materialContent)}]})}))}})),U(e).then((({data:e,code:i})=>{if("10000"===i){const{signInfo:i}=N(e.productFactor);i.schema.forEach((e=>{"eleSign"===e.name&&e.columns.forEach((i=>{e.required&&ae.value.sign.push(i.code),"1"===i.code?ee.value.agent.isSign=!0:"2"===i.code?ee.value.holder.isSign=!0:"3"===i.code?ee.value.insured.isSign=!0:"4"===i.code?ee.value.holder.isShareSign=!0:"5"===i.code&&(ee.value.insured.isShareSign=!0)}))}))}}))})()}));const ne=n();return r((()=>{setTimeout((async()=>{ne.value=window.getIseeBiz&&await window.getIseeBiz()}),1500)})),(e,i)=>{const a=L,s=E,n=O;return o(),d("div",B,[l(a),c("div",T,[l(s,{type:"warning",title:"尊敬的客户，本次投保需要进行身份认证",content:"本产品投保需要对投保人、被保人进行实名认证，您购买本产品的累计总保费已超过20万，按监管要求，需要提供投保人、被保人、指定受益人证件影像，本产品非本人投保且带身故责任、需对投保人、被保人（成人）的投保意愿进行签字确认。"})]),c("div",x,[!u(K)||u(ee).insured.isShareSign?(o(!0),d(f,{key:0},g(u(ee).insured.personalInfo||[],(e=>(o(),p(V,{key:e.id,ref_for:!0,ref_key:"insuredSignRef",ref:Z,"data-source":[],"order-detail":u(X),"sign-string":u(ee).insured.signData[e.id],"show-sign":u(K)?u(ee).insured.isShareSign:u(ee).insured.isSign,"show-verify":u(ee).insured.isVerify,"file-list":u(ee).insured.fileList,"personal-info":e||{},title:"被保人",onHandleSign:i=>ie("INSURED",i,e.id)},null,8,["order-detail","sign-string","show-sign","show-verify","file-list","personal-info","onHandleSign"])))),128)):m("",!0)]),c("div",P,[l(n,{type:"primary",class:"submit-btn",onClick:se},{default:v((()=>[h("确定")])),_:1})])])}}});export{A as default};
