import{d as e,h as a,g as i,bF as s,ch as t,i as r,z as n,av as o,af as l,o as d,c as u,b as c,a as f,u as v,l as p,q as h,a0 as g,w as y,a8 as m,aB as S,T as I,a6 as j,cd as b,ci as N,bj as O,aa as L,c7 as x,cj as T,an as D,ck as E}from"./index-fc7a5429.js";import{c as q}from"./product-3b28f723.js";import{g as k,m as w}from"./trial-fe69f29d.js";import{_ as C}from"./SignPart-caea2a5a.js";import{u as V}from"./useOrder-eca64ba2.js";import{M as R}from"./product-585b0e6f.js";import{N as A}from"./notice-33e6eedd.js";import{f as U,s as H,b as P,a as _}from"./verify-add58d74.js";import"./PolicyInfo-05518c56.js";import{a as B,P as G}from"./constants-fe95ef6f.js";import{c as M}from"./scribing-d2a97706.js";import{a as z}from"./utils-394f97a4.js";import"./useAttachment-44a9a27e.js";import"./utils-d51ac434.js";import"./infoCollection-ea7671fe.js";import"./trial-3d0e9acc.js";import"./index-267cc904.js";const F={class:"long-verify"},$={class:"header"},J={class:"verify-content"},Y={class:"footer-button"},K=e({__name:"holderSign",setup(e){const K=a(),Q=i(),{productCode:W="",tenantId:X,agentCode:Z="",agencyCode:ee,saleChannelId:ae,saleUserId:ie,orderNo:se,orderCode:te,extraInfo:re,isShare:ne,insurerCode:oe,preview:le}=K.query;let de={};try{de=JSON.parse(decodeURIComponent(re))}catch(je){}const ue=V(),ce=`${window.origin}/baseInsurance/long/phoneVerify?${s.stringify({...K.query,orderNo:te||se})}`,fe=new t({source:"localStorage"}),ve=r(),pe=r({holder:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""},insured:{fileList:[],personalInfo:[],isSign:!1,isVerify:!1,isShareSign:!1,signData:{}},agent:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""}}),he=r({}),ge=r({}),ye=r({sign:[],verify:[],scribing:""}),me=()=>{if(le)return void S(B.SIGN,K.query);const e=[];ve.value&&((ne?ye.value.sign.includes("4"):ye.value.sign.includes("2"))&&e.push(ve.value.validateSign()),ye.value.verify.includes("1")&&e.push(ve.value.validateVerify())),Promise.all(e).then((e=>{!ye.value.scribing||he.value.status?P(ue.value).then((({code:e,data:a})=>{"10000"===e&&(a.authStatus===`${j.YES}`?Q.push({path:G.payAuth,query:K.query}):_({bizObjectId:[ue.value.holder.id],bizObjectType:b.HOLDER,orderId:ue.value.id,tenantId:X}).then((({code:e,data:a})=>{"10000"===e&&a&&Q.push({path:G.sign,query:K.query})})))})):I("请先完成风险抄录")})).catch((e=>{I(e.message)}))},Se=()=>{se&&k({orderNo:te||se,tenantId:X}).then((({code:e,data:a})=>{var i,s,t,r;"10000"===e&&(Object.assign(ue.value,a),pe.value.holder.personalInfo=a.holder,Object.assign(ge.value,{type:N[a.extInfo.transcriptionType],signInfo:null==(s=null==(i=a.riskTranscriptionList)?void 0:i[0])?void 0:s.uri,text:null==(r=null==(t=a.riskTranscriptionList)?void 0:t[0])?void 0:r.content,status:!!a.extInfo.transcriptionStatus}))}))};r({imgUrl:"",desc:"",title:"",link:ce});const Ie=e=>{const{type:a,text:i}=he.value,s={...K.query,orderNo:te||se,text:i,orderId:ue.value.id};"handle"===a?Q.push({path:"scribing",query:s}):M({content:i,image:e,orderNo:te||se,tenantId:X,transcriptionType:E.AUTO}).then((({code:e})=>{"10000"===e&&Se()}))};return n([()=>ge.value,()=>he.value],(()=>{Object.assign(he.value,{type:ge.value.type||he.value.type,text:ge.value.text||he.value.text,status:ge.value.status||he.value.status,signInfo:ge.value.signInfo||he.value.signInfo})}),{deep:!0,immediate:!0}),o((()=>{(async()=>{var e,a,i,s;let t={};const{code:r,data:n}=await k({orderNo:te||se,tenantId:X});"10000"===r&&(Object.assign(ue.value,n),pe.value.holder.personalInfo={...n.holder,isCert:1},t=z(n.insuredList[0].productList),Object.assign(ge.value,{type:N[n.extInfo.transcriptionType],signInfo:null==(a=null==(e=n.riskTranscriptionList)?void 0:e[0])?void 0:a.uri,text:null==(s=null==(i=n.riskTranscriptionList)?void 0:i[0])?void 0:s.content,status:!!n.extInfo.transcriptionStatus}),n.tenantOrderAttachmentList.forEach((e=>{e.objectType===A.HOlDER?pe.value.holder.signData=e.fileBase64:e.objectType===A.AGENT?pe.value.agent.signData=e.fileBase64:e.objectType===A.INSURED&&(pe.value.insured.signData[e.objectId]=e.fileBase64)}))),q(t).then((({code:e,data:a})=>{var i;if("10000"===e){const{productMaterialMap:e}=(null==(i=a.productMaterialPlanVOList)?void 0:i[0])||{};(Object.values(e||{})||[]).flat().filter((e=>e.materialType===R.SIGN)).forEach((e=>{e.noticeObject===A.AGENT?pe.value.agent.fileList.push(e):e.noticeObject===A.HOlDER?pe.value.holder.fileList.push(e):e.noticeObject===A.INSURED&&pe.value.insured.fileList.push(e)}))}})),w(t).then((({data:e,code:a})=>{if("10000"===a){const{signInfo:a}=O(e.productFactor);a.schema.forEach((e=>{"eleSign"===e.name&&e.columns.forEach((a=>{e.required&&ye.value.sign.push(a.code),"1"===a.code?pe.value.agent.isSign=!0:"2"===a.code?pe.value.holder.isSign=!0:"3"===a.code?pe.value.insured.isSign=!0:"4"===a.code?pe.value.holder.isShareSign=!0:"5"===a.code&&(pe.value.insured.isShareSign=!0)})),"riskNotificationCopy"===e.name&&(he.value.text=e.remark,ye.value.scribing=e.required,e.columns.forEach((e=>{"1"===e.code?he.value.type="handle":he.value.type="auto"}))),"customerFace"===e.name&&e.columns.forEach((a=>{e.required&&ye.value.verify.push(a.code),"1"===a.code?pe.value.holder.isVerify=!0:"2"===a.code&&(pe.value.insured.isVerify=!0)}))}))}}))})();const e=l.get("verifyData");if(e){const{serialNo:a,certNo:i,name:s}=e;U({certiNo:i,orderNo:te||se,serialNo:a,tenantId:X,userName:s}).then((e=>{const{code:a,data:i}=e;"10000"===a&&(fe.remove("verifyData"),Se())}))}})),(e,a)=>{const i=L,s=x,t=T,r=D;return d(),u("div",F,[c(i),f("div",$,[c(s,{type:"warning",title:"尊敬的客户，本次投保需要进行身份认证",content:"本产品投保需要对投保人、被保人进行实名认证，您购买本产品的累计总保费已超过20万，按监管要求，需要提供投保人、被保人、指定受益人证件影像，本产品非本人投保且带身故责任、需对投保人、被保人（成人）的投保意愿进行签字确认。"})]),f("div",J,[!v(ne)||v(pe).holder.isShareSign?(d(),p(C,{key:0,ref_key:"holderSignRef",ref:ve,"order-detail":v(ue),"sign-string":v(pe).holder.signData,"show-sign":v(ne)?v(pe).holder.isShareSign:v(pe).holder.isSign,"show-verify":v(pe).holder.isVerify,"file-list":v(pe).holder.fileList,"personal-info":v(pe).holder.personalInfo,title:"投保人",onHandleSign:a[0]||(a[0]=e=>((e,a,i)=>{var s;H(e,a,null==(s=ue.value)?void 0:s.id,X,i)})("HOLDER",e,v(pe).holder.personalInfo.id))},null,8,["order-detail","sign-string","show-sign","show-verify","file-list","personal-info"])):h("",!0)]),v(ye).scribing?(d(),p(t,g({key:0},v(he),{title:"为了保障您的权益请抄录以下声明内容",onOnSubmit:Ie}),null,16)):h("",!0),f("div",Y,[c(r,{type:"primary",onClick:me},{default:y((()=>[m("确定")])),_:1})])])}}});export{K as default};
