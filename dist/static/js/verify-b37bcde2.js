import{d as e,r as a,G as i,y as s,N as n,Z as t,b as r,c as l,e as o,w as d,i as u,$ as c,f,a0 as v,Y as g,h as p,j as h,g as m,V as y,C as S,a1 as b,a2 as I,u as w,a as j,K as C,a3 as N,o as k,s as O,U as L,a4 as V,a5 as T,a6 as E,a7 as _,n as x,T as D,D as U,P as R,a8 as B,a9 as P,aa as A,W as q,m as M,ab as Y,B as F,ac as G,ad as H}from"./index-a31e6503.js";import{a as $,q as J}from"./product-ac5b37aa.js";import{n as W}from"./nextStep-0c11df28.js";import{g as K,i as X}from"./trial-ad8f3e9a.js";import{u as Z}from"./useAttachment-5f86f034.js";import{S as z,f as Q,a as ee,s as ae}from"./verify-ab951346.js";import{u as ie}from"./useOrder-c4b9a14b.js";import{M as se}from"./product-585b0e6f.js";import{t as ne}from"./PayInfo-0ca4b425.js";import{P as te,B as re}from"./constants-7afb7c3d.js";import{c as le}from"./scribing-660e1b5c.js";import"./core-66276e3e.js";import"./constant-8927d485.js";import"./utils-7fa53ddf.js";import"./infoCollection-6ba8eba8.js";import"./trial-75de91fa.js";import"./merge-c5599fa4.js";import"./keysIn-a287568b.js";import"./isObjectLike-a9798079.js";import"./_getTag-7f09858e.js";import"./debounce-6981b306.js";import"./phoneVerify-57e1f6d1.js";import"./index-b42c4bd0.js";import"./useDicData-ed9ab26d.js";import"./bankCard-a091a110.js";const oe={class:"com-sign-part"},de={class:"people"},ue={class:"name"},ce={key:0,class:"verify-item"},fe=u("div",{class:"label"},"证件号码",-1),ve={class:"no"},ge={class:"sign-status"},pe={class:"status"},he=["src"],me={key:1,class:"sign-desc"},ye={class:"sign-body"},Se={class:"date"},be={class:"file"},Ie=e({name:"signPart"}),we=e({...Ie,props:{signString:{default:""},personalInfo:{default:()=>({})},fileList:{},title:{default:""},showSign:{type:Boolean,default:!1},showVerify:{type:Boolean,default:!1},showShareSign:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1}},emits:["handleVerify","handleSign"],setup(e,{expose:w,emit:j}){const C=e,N=a({}),k=a(""),O=a([]),L=a({});a(!0);const V=a(!1),T=a(0),{fileList:E}=Z(L,O),_=e=>`${e}`===S.CERT,x=i((()=>s().format("YYYY-MM-DD"))),D=()=>{var e,a;j("handleVerify",null==(e=N.value)?void 0:e.name,null==(a=N.value)?void 0:a.certNo)},U=()=>{V.value=!1},R=a(),B=()=>{R.value&&R.value.rewrite()},P=()=>{C.disabled||R.value&&R.value.openSign()},A=e=>{j("handleSign",e)};return w({validateSign:()=>new Promise(((e,a)=>{k.value?e(!0):a(new Error(`请${C.title}完成签名后，去支付`))})),validateVerify:()=>new Promise(((e,a)=>{var i;(null==(i=C.personalInfo)?void 0:i.isCert)!==g.YES?a(new Error(`请${C.title}完成认证后，去支付`)):e(!0)}))}),n((()=>C.signString),(()=>{k.value=C.signString}),{immediate:!0}),n((()=>C.personalInfo),(()=>{N.value=C.personalInfo}),{deep:!0,immediate:!0}),(e,a)=>{const i=b,s=I,n=t("AttachmentList"),S=t("FilePreview");return r(),l("div",oe,[o(s,{title:e.title,class:"card"},{extra:d((()=>{var a,i,s,n;return[u("div",de,[u("div",ue,c(null==(a=f(N))?void 0:a.name),1),e.showVerify&&_(null==(i=f(N))?void 0:i.certType)?(r(),l("div",{key:0,class:v(["status",{verified:(null==(s=f(N))?void 0:s.isCert)===f(g).YES}])},c((null==(n=f(N))?void 0:n.isCert)===f(g).YES?"已认证":"待认证"),3)):p("",!0)])]})),default:d((()=>{var a,s,n,t;return[e.showVerify&&(null==(a=f(N))?void 0:a.certNo)?(r(),l("div",ce,[fe,u("div",ve,c(null==(s=f(N))?void 0:s.certNo),1),(null==(n=f(N))?void 0:n.isCert)!==f(g).YES&&_(null==(t=f(N))?void 0:t.certType)?(r(),l("div",{key:0,class:"action",onClick:D},[h(" 去认证 "),o(i,{name:"right_arrow",class:"icon"})])):p("",!0)])):p("",!0)]})),_:1},8,["title"]),e.showSign?(r(),m(s,{key:0,title:`${e.title}签名`,"show-icon":!1,class:"sign-card","show-line":!1},{extra:d((()=>[u("div",ge,[u("div",pe,c(f(k)?"已签名":"未签名"),1),e.disabled?p("",!0):(r(),l("div",{key:0,class:"resign",onClick:B},"重签"))])])),default:d((()=>{var e;return[o(z,{ref_key:"signRef",ref:R,modelValue:f(k),"onUpdate:modelValue":a[0]||(a[0]=e=>y(k)?k.value=e:null),class:"sign",onSubmitSign:A},{signImg:d((({data:e})=>[u("div",{class:"sign-board",onClick:P},[e?(r(),l("img",{key:0,src:e,class:"sign-img",alt:""},null,8,he)):(r(),l("span",me,"请签名"))])])),_:1},8,["modelValue"]),u("div",ye,[u("div",Se,"签名日期： "+c(f(x)),1),u("div",be,[(null==(e=f(E))?void 0:e.length)?(r(),m(n,{key:0,"attachment-list":f(E),"pre-text":"签名将被用于以下文件：",onPreviewFile:a[1]||(a[1]=e=>(e=>{T.value=e,V.value=!0})(e))},null,8,["attachment-list"])):p("",!0)])])]})),_:1},8,["title"])):p("",!0),f(V)?(r(),m(S,{key:1,show:f(V),"onUpdate:show":a[2]||(a[2]=e=>y(V)?V.value=e:null),"content-list":f(E),"is-only-view":"","active-index":f(T),text:"关闭",onOnCloseFilePreviewByMask:U},null,8,["show","content-list","active-index"])):p("",!0)])}}}),je=1,Ce=2,Ne=3;const ke={class:"long-verify"},Oe={class:"header"},Le={class:"verify-content"},Ve={class:"footer-button footer-bar"},Te=u("div",{class:"text"},"刷新",-1),Ee=e({__name:"verify",setup(e){const i=w(),s=j(),{productCode:t="",tenantId:c,agentCode:v="",agencyCode:y,saleChannelId:S,saleUserId:I,orderNo:Z,orderCode:z,extraInfo:oe,isShare:de,insurerCode:ue,preview:ce}=i.query;let fe={};try{fe=JSON.parse(decodeURIComponent(oe))}catch(Ye){}const ve=ie(),ge=`${window.origin}/baseInsurance/long/phoneVerify?${C.stringify({...i.query,orderNo:z||Z})}`,pe=new N({source:"localStorage"});a({});const he=a({}),me=a(),ye=a(),Se=a(),be=a({holder:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""},insured:{fileList:[],personalInfo:[],isSign:!1,isVerify:!1,isShareSign:!1,signData:{}},agent:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""}}),Ie=a({text:"",type:"",signInfo:""}),Ee=a({text:"",type:"",signInfo:""}),_e=(e,a)=>{let i=window.location.href;i=i.includes("orderCode")?i:i.replace("orderNo","orderCode"),ee({callbackUrl:i,certiNo:a,faceAuthMode:"TENCENT",userName:e,tenantId:c}).then((({code:i,data:s})=>{if("10000"===i){const{originalUrl:i,serialNo:n}=s;window.location.href=i,O.set("verifyData",{serialNo:n,certNo:a,name:e})}}))},xe=(e,a,i)=>{var s;ae(e,a,null==(s=ve.value)?void 0:s.id,c,i)},De=a({sign:[],verify:[],scribing:""}),Ue=()=>{if(ce)return void x(te.SIGN,i.query);const e=[];me.value&&De.value.sign.includes("1")&&e.push(me.value.validateSign()),ye.value&&((de?De.value.sign.includes("4"):De.value.sign.includes("2"))&&e.push(ye.value.validateSign()),De.value.verify.includes("1")&&e.push(ye.value.validateVerify())),Se.value&&((de?De.value.sign.includes("5"):De.value.sign.includes("3"))&&e.push(...(Se.value||[]).map((e=>e.validateSign()))),De.value.verify.includes("2")&&e.push(...(Se.value||[]).map((e=>e.validateVerify())))),Promise.all(e).then((e=>{!De.value.scribing||Ie.value.signInfo?Z&&K({orderNo:z||Z,saleUserId:I,tenantId:c}).then((({code:e,data:a})=>{"10000"===e&&U.confirm({title:"提示",message:"请确认信息填写无误后，再进行支付"}).then((()=>{Object.assign(ve.value,{extInfo:{...ve.value.extInfo,buttonCode:re.SIGN,pageCode:te.SIGN}}),W(ve.value,((e,a)=>{a===R.JUMP_URL&&(window.location.href=e.paymentUrl)}))}))})):D("请先完成风险抄录")})).catch((e=>{D(e.message)}))},Re=a(),Be=()=>{me.value&&De.value.sign.includes("1")&&me.value.validateSign().then((()=>{Re.value&&Re.value.handleShare()})).catch((()=>{D("请完成代理人签字后进行分享")}))},Pe=(e=!1)=>{Z&&K({orderNo:z||Z,tenantId:c}).then((({code:a,data:i})=>{var s,n,t;"10000"===a&&(e&&((null==(s=null==i?void 0:i.holder)?void 0:s.isCert)===g.NO||(null==i?void 0:i.insuredList.some((e=>e.isCert===g.NO)))?D("用户未完身份认证及签字"):(null==i?void 0:i.tenantOrderAttachmentList.find((e=>e.category===B.ELECTRIC_SIGN&&e.objectType===P.HOLDER)))&&(null==i?void 0:i.tenantOrderAttachmentList.find((e=>e.category===B.ELECTRIC_SIGN&&e.objectType===P.INSURED)))||D("用户未完身份认证及签字")),Object.assign(ve.value,i),be.value.holder.personalInfo=i.holder,be.value.insured.personalInfo=i.insuredList,Object.assign(Ee.value,{type:A[i.extInfo.transcriptionType],signInfo:null==(t=null==(n=i.riskTranscriptionList)?void 0:n[0])?void 0:t.thumbnail}),i.tenantOrderAttachmentList.forEach((e=>{e.objectType===je?be.value.holder.signData=e.fileBase64:e.objectType===Ne?be.value.agent.signData=e.fileBase64:e.objectType===Ce&&(be.value.insured.signData[e.objectId]=e.fileBase64)})))}))},Ae=()=>{Pe(!0)},qe=a({imgUrl:"",desc:"",title:"",link:ge}),Me=e=>{const{type:a,text:n}=Ie.value;"handle"===a?s.push({path:"scribing",query:{...i.query,text:n,orderId:ve.value.id}}):le({content:n,image:e,orderNo:Z,tenantId:c,transcriptionType:H.AUTO}).then((({code:e})=>{"10000"===e&&Pe()}))};return n([()=>Ee.value,()=>Ie.value],(()=>{Object.assign(Ie.value,Ee.value)}),{deep:!0,immediate:!0}),k((()=>{$({productCode:t,tenantId:c}).then((({data:e,code:a})=>{if("10000"===a){const{wxShareConfig:a,showWXShare:i,title:s,desc:n,image:t}=(null==e?void 0:e.PRODUCT_LIST)||{};i?Object.assign(qe.value,{...a,imgUrl:a.image,isShare:i}):Object.assign(qe.value,{title:s,desc:n,imgUrl:t,isShare:i}),e.BASIC_INFO&&e.BASIC_INFO.themeType&&q(e.BASIC_INFO.themeType)}})),J({productCode:t}).then((({code:e,data:a})=>{var i;if("10000"===e){const{productMaterialMap:e}=(null==(i=a.productInsureMaterialVOList)?void 0:i[0])||{};(Object.values(e||{})||[]).flat().filter((e=>e.materialType===se.SIGN)).forEach((e=>{e.noticeObject===Ne?be.value.agent.fileList.push(e):e.noticeObject===je?be.value.holder.fileList.push(e):e.noticeObject===Ce&&be.value.insured.fileList.push(e)}))}})),X({productCode:t,isTenant:!ce}).then((({data:e,code:a})=>{var i;if("10000"===a){he.value=e;const{productFactor:a}=(null==(i=e.productPlanInsureVOList)?void 0:i[0])||{},{signInfo:s}=ne(a);s.schema.forEach((e=>{"eleSign"===e.name&&e.columns.forEach((a=>{e.required&&De.value.sign.push(a.code),"1"===a.code?be.value.agent.isSign=!0:"2"===a.code?be.value.holder.isSign=!0:"3"===a.code?be.value.insured.isSign=!0:"4"===a.code?be.value.holder.isShareSign=!0:"5"===a.code&&(be.value.insured.isShareSign=!0)})),"riskNotificationCopy"===e.name&&(Ee.value.text=e.remark,console.log("schema",e),De.value.scribing=e.required,e.columns.forEach((e=>{"1"===e.code?Ee.value.type="handle":Ee.value.type="auto"}))),"customerFace"===e.name&&e.columns.forEach((a=>{e.required&&De.value.verify.push(a.code),"1"===a.code?be.value.holder.isVerify=!0:"2"===a.code&&(be.value.insured.isVerify=!0)}))}))}})),Pe();const e=O.get("verifyData");if(e){const{serialNo:a,certNo:i,name:s}=e;Q({certiNo:i,orderNo:z||Z,serialNo:a,tenantId:c,userName:s}).then((e=>{const{code:a,data:i}=e;"10000"===a&&(pe.remove("verifyData"),Pe())}))}})),(e,a)=>{const i=M,s=Y,n=b,t=F,c=G;return r(),l("div",ke,[o(i),u("div",Oe,[o(s,{type:"warning",title:"尊敬的客户，本次投保需要进行身份认证",content:"本产品投保需要对投保人、被保人进行实名认证，您购买本产品的累计总保费已超过20万，按监管要求，需要提供投保人、被保人、指定受益人证件影像，本产品非本人投保且带身故责任、需对投保人、被保人（成人）的投保意愿进行签字确认。"})]),u("div",Le,[o(we,{ref_key:"agentSignRef",ref:me,"order-detail":f(ve),"sign-string":f(be).agent.signData,"show-sign":f(be).agent.isSign,"show-verify":f(be).agent.isVerify,"file-list":f(be).agent.fileList,"personal-info":f(be).agent.personalInfo,disabled:!!f(de),title:"代理人",onHandleSign:a[0]||(a[0]=e=>xe("AGENT",e))},null,8,["order-detail","sign-string","show-sign","show-verify","file-list","personal-info","disabled"]),!f(de)||f(be).holder.isShareSign?(r(),m(we,{key:0,ref_key:"holderSignRef",ref:ye,"order-detail":f(ve),"sign-string":f(be).holder.signData,"show-sign":f(de)?f(be).holder.isShareSign:f(be).holder.isSign,"show-verify":f(be).holder.isVerify,"file-list":f(be).holder.fileList,"personal-info":f(be).holder.personalInfo,title:"投保人",onHandleSign:a[1]||(a[1]=e=>xe("HOLDER",e,f(be).holder.personalInfo.id)),onHandleVerify:_e},null,8,["order-detail","sign-string","show-sign","show-verify","file-list","personal-info"])):p("",!0),!f(de)||f(be).insured.isShareSign?(r(!0),l(L,{key:1},V(f(be).insured.personalInfo||[],(e=>(r(),m(we,{key:e.id,ref_for:!0,ref_key:"insuredSignRef",ref:Se,"data-source":[],"order-detail":f(ve),"sign-string":f(be).insured.signData[e.id],"show-sign":f(de)?f(be).insured.isShareSign:f(be).insured.isSign,"show-verify":f(be).insured.isVerify,"file-list":f(be).insured.fileList,"personal-info":e||{},title:"被保人",onHandleSign:a=>xe("INSURED",a,e.id),onHandleVerify:_e},null,8,["order-detail","sign-string","show-sign","show-verify","file-list","personal-info","onHandleSign"])))),128)):p("",!0)]),u("div",Ve,[u("div",{class:"refresh-btn",onClick:Ae},[u("div",null,[o(n,{name:"refresh"})]),Te]),!f(de)&&f(T)()?(r(),m(_,E({key:0,ref_key:"shareRef",ref:Re},f(qe)),{default:d((()=>[o(t,{plain:"",type:"primary",class:"share-btn",onClick:Be},{default:d((()=>[h("分享")])),_:1})])),_:1},16)):p("",!0),o(t,{type:"primary",class:"submit-btn",onClick:Ue},{default:d((()=>[h("确认支付")])),_:1})]),f(De).scribing?(r(),m(c,E({key:0},f(Ie),{title:"为了保障您的权益请抄录以下声明内容",onOnSubmit:Me}),null,16)):p("",!0)])}}});export{Ee as default};
