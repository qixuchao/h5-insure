import{d as e,h as a,g as i,bx as s,bS as t,i as r,z as n,av as o,af as l,o as d,c as u,b as c,a as f,u as p,l as v,q as g,a0 as h,w as m,a8 as y,aB as b,T as j,bN as I,s as S,bT as N,aa as O,bK as L,bU as x,am as T,bV as D}from"./index-a701edf7.js";import{c as k}from"./product-ad97da6e.js";import{g as E,m as V}from"./trial-be4721b4.js";import{_ as C,N as q}from"./notice-85ad535c.js";import{u as w}from"./useOrder-0f74fb68.js";import{M as R}from"./product-585b0e6f.js";import{f as H,s as U,a as _}from"./verify-b8d06411.js";import{t as A}from"./index-873f5512.js";import"./PayInfo-01655823.js";import{P as B}from"./constants-71331306.js";import{c as G}from"./scribing-3ed7631a.js";import{p as M}from"./utils-0af605ab.js";import"./useAttachment-35fb6d62.js";import"./utils-e08fe015.js";import"./infoCollection-c01830c2.js";import"./trial-d97dbb4f.js";import"./index-a521a3ec.js";import"./merge-e7788e50.js";import"./keysIn-131bbce9.js";import"./isObjectLike-a9798079.js";import"./_getTag-0507d0b1.js";import"./debounce-6981b306.js";import"./phoneVerify-307a6997.js";import"./index-f8d021e2.js";import"./useDicData-c5252af3.js";import"./bankCard-3afe4cad.js";const P={class:"long-verify"},z={class:"header"},F={class:"verify-content"},$={class:"footer-button"},J=e({__name:"holderSign",setup(e){const J=a(),K=i(),{productCode:Q="",tenantId:W,agentCode:X="",agencyCode:Y,saleChannelId:Z,saleUserId:ee,orderNo:ae,orderCode:ie,extraInfo:se,isShare:te,insurerCode:re,preview:ne}=J.query;let oe={};try{oe=JSON.parse(decodeURIComponent(se))}catch(be){}const le=w(),de=`${window.origin}/baseInsurance/long/phoneVerify?${s.stringify({...J.query,orderNo:ie||ae})}`,ue=new t({source:"localStorage"}),ce=r(),fe=r({holder:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""},insured:{fileList:[],personalInfo:[],isSign:!1,isVerify:!1,isShareSign:!1,signData:{}},agent:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""}}),pe=r({}),ve=r({}),ge=r({sign:[],verify:[],scribing:""}),he=()=>{if(ne)return void b(B.SIGN,J.query);const e=[];ce.value&&((te?ge.value.sign.includes("4"):ge.value.sign.includes("2"))&&e.push(ce.value.validateSign()),ge.value.verify.includes("1")&&e.push(ce.value.validateVerify())),Promise.all(e).then((e=>{!ge.value.scribing||pe.value.status?_({bizObjectId:[le.value.holder.id],bizObjectType:I.HOLDER,orderId:le.value.id,tenantId:W}).then((({code:e,data:a})=>{"10000"===e&&a&&K.push({path:S.sign,query:J.query})})):j("请先完成风险抄录")})).catch((e=>{j(e.message)}))},me=()=>{ae&&E({orderNo:ie||ae,tenantId:W}).then((({code:e,data:a})=>{var i,s,t,r;"10000"===e&&(Object.assign(le.value,a),fe.value.holder.personalInfo=a.holder,fe.value.insured.personalInfo=a.insuredList,Object.assign(ve.value,{type:N[a.extInfo.transcriptionType],signInfo:null==(s=null==(i=a.riskTranscriptionList)?void 0:i[0])?void 0:s.uri,text:null==(r=null==(t=a.riskTranscriptionList)?void 0:t[0])?void 0:r.content,status:!!a.extInfo.transcriptionStatus}))}))};r({imgUrl:"",desc:"",title:"",link:de});const ye=e=>{const{type:a,text:i}=pe.value,s={...J.query,orderNo:ie||ae,text:i,orderId:le.value.id};"handle"===a?K.push({path:"scribing",query:s}):G({content:i,image:e,orderNo:ie||ae,tenantId:W,transcriptionType:D.AUTO}).then((({code:e})=>{"10000"===e&&me()}))};return n([()=>ve.value,()=>pe.value],(()=>{Object.assign(pe.value,{type:ve.value.type||pe.value.type,text:ve.value.text||pe.value.text,status:ve.value.status||pe.value.status,signInfo:ve.value.signInfo||pe.value.signInfo})}),{deep:!0,immediate:!0}),o((()=>{(async()=>{var e,a,i,s;let t={};const{code:r,data:n}=await E({orderNo:ie||ae,tenantId:W});"10000"===r&&(Object.assign(le.value,n),fe.value.holder.personalInfo={...n.holder,isCert:1},t=M(n.insuredList[0].productList),Object.assign(ve.value,{type:N[n.extInfo.transcriptionType],signInfo:null==(a=null==(e=n.riskTranscriptionList)?void 0:e[0])?void 0:a.uri,text:null==(s=null==(i=n.riskTranscriptionList)?void 0:i[0])?void 0:s.content,status:!!n.extInfo.transcriptionStatus}),n.tenantOrderAttachmentList.forEach((e=>{e.objectType===q.HOlDER?fe.value.holder.signData=e.fileBase64:e.objectType===q.AGENT?fe.value.agent.signData=e.fileBase64:e.objectType===q.INSURED&&(fe.value.insured.signData[e.objectId]=e.fileBase64)}))),k({productCodeList:[]}).then((({code:e,data:a})=>{var i;if("10000"===e){const{productMaterialMap:e}=(null==(i=a.productMaterialPlanVOList)?void 0:i[0])||{};(Object.values(e||{})||[]).flat().filter((e=>e.materialType===R.SIGN)).forEach((e=>{e.noticeObject===q.AGENT?fe.value.agent.fileList.push(e):e.noticeObject===q.HOlDER?fe.value.holder.fileList.push(e):e.noticeObject===q.INSURED&&fe.value.insured.fileList.push(e)}))}})),V(t).then((({data:e,code:a})=>{if("10000"===a){const{signInfo:a}=A(e.productFactor);a.schema.forEach((e=>{"eleSign"===e.name&&e.columns.forEach((a=>{e.required&&ge.value.sign.push(a.code),"1"===a.code?fe.value.agent.isSign=!0:"2"===a.code?fe.value.holder.isSign=!0:"3"===a.code?fe.value.insured.isSign=!0:"4"===a.code?fe.value.holder.isShareSign=!0:"5"===a.code&&(fe.value.insured.isShareSign=!0)})),"riskNotificationCopy"===e.name&&(pe.value.text=e.remark,ge.value.scribing=e.required,e.columns.forEach((e=>{"1"===e.code?pe.value.type="handle":pe.value.type="auto"}))),"customerFace"===e.name&&e.columns.forEach((a=>{e.required&&ge.value.verify.push(a.code),"1"===a.code?fe.value.holder.isVerify=!0:"2"===a.code&&(fe.value.insured.isVerify=!0)}))}))}}))})();const e=l.get("verifyData");if(e){const{serialNo:a,certNo:i,name:s}=e;H({certiNo:i,orderNo:ie||ae,serialNo:a,tenantId:W,userName:s}).then((e=>{const{code:a,data:i}=e;"10000"===a&&(ue.remove("verifyData"),me())}))}})),(e,a)=>{const i=O,s=L,t=x,r=T;return d(),u("div",P,[c(i),f("div",z,[c(s,{type:"warning",title:"尊敬的客户，本次投保需要进行身份认证",content:"本产品投保需要对投保人、被保人进行实名认证，您购买本产品的累计总保费已超过20万，按监管要求，需要提供投保人、被保人、指定受益人证件影像，本产品非本人投保且带身故责任、需对投保人、被保人（成人）的投保意愿进行签字确认。"})]),f("div",F,[!p(te)||p(fe).holder.isShareSign?(d(),v(C,{key:0,ref_key:"holderSignRef",ref:ce,"order-detail":p(le),"sign-string":p(fe).holder.signData,"show-sign":p(te)?p(fe).holder.isShareSign:p(fe).holder.isSign,"show-verify":p(fe).holder.isVerify,"file-list":p(fe).holder.fileList,"personal-info":p(fe).holder.personalInfo,title:"投保人",onHandleSign:a[0]||(a[0]=e=>((e,a,i)=>{var s;U(e,a,null==(s=le.value)?void 0:s.id,W,i)})("HOLDER",e,p(fe).holder.personalInfo.id)),onHandleVerify:e.doVerify},null,8,["order-detail","sign-string","show-sign","show-verify","file-list","personal-info","onHandleVerify"])):g("",!0)]),p(ge).scribing?(d(),v(t,h({key:0},p(pe),{title:"为了保障您的权益请抄录以下声明内容",onOnSubmit:ye}),null,16)):g("",!0),f("div",$,[c(r,{type:"primary",onClick:he},{default:m((()=>[y("确定")])),_:1})])])}}});export{J as default};
