import{d as e,r as t,u as a,a as i,z as r,o as s,a1 as o,R as n,c as l,A as u,F as d,i as c,w as m,j as p,g as f,h as I,e as h,f as v,E as k,U as g,n as P,as as R,T as O,at as y,ak as L,G as b,C as V,P as C,p as D}from"./index-b419c4de.js";import{l as S}from"./index-4a2f5da3.js";import{_ as T}from"./TrialButton-3370bf79.js";import{u as x,b as w,p as M}from"./trial-92a4c937.js";import{P as A}from"./index-27de7c4f.js";import{u as _}from"./useOrder-7e4863e8.js";import{f as j}from"./utils-314965b3.js";import{t as E}from"./utils-f99858fa.js";import{P as F,B as N}from"./constants-7afb7c3d.js";import{n as B}from"./nextStep-1ae186ea.js";import{T as q}from"./index-ba41fd7f.js";const K=(e,t,a)=>{var i,r,s,o;const n=e,{holder:l}=a,u=a.insuredList[0],d=(t||"").split("_");if(d.length<2)return t;if(S.exports.isNaN(Number(d[1])))return t;if(d[1]-=1,1===n.exemptFlag){if("to"===d[0]){let e=0;1===n.exemptType?(null==(i=null==l?void 0:l.personVO)?void 0:i.birthday)&&(e=parseInt(""+((new Date).getTime()-new Date(null==(r=l.personVO)?void 0:r.birthday).getTime())/31536e6,10)):2===n.exemptType&&(null==(s=null==u?void 0:u.personVO)?void 0:s.birthday)&&(e=parseInt(""+(+(new Date).getTime()-new Date(null==(o=u.personVO)?void 0:o.birthday).getTime())/31536e6,10)),d[1]=+d[1]-e}d[0]="year"}return d.join("_")};const U={class:"header"},H={class:"header-title"},$=e({name:"TrialPop"});var G=b(e({...$,props:{dataSource:{default:()=>[]},productInfo:{default:()=>({productCode:"",productName:"",insurerCode:"",tenantId:""})},shareInfo:{default:()=>({})},tenantProductDetail:{default:()=>({})},hideBenefit:{type:Boolean,default:!1},hidePopupButton:{type:Boolean,default:!1},title:{default:"算一算保费"},defaultData:{default:null}},setup(e,{expose:b}){const $=e,G="试算中...",z=t(null),J=a();i();const{tenantId:Q,templateId:W,preview:X}=J.query,Y=r({loading:!1,show:!1,select:{},list:[],userData:{},riskIsInsure:{},submitData:{},riskVOList:[{}],mainRiskVO:{},ifPersonalInfoSuccess:!1,trialMsg:"",trialResultPremium:0,trialResult:{premium:0,amount:0},isAniShow:!1,defaultValue:null,isAutoChange:!1,planIndex:0,isSkipFirstTrial:!1,hadSkipFirstTrial:!1}),Z=_(),ee=t(),te=t(),ae=(e={},t={},a={})=>{var i;const r={...a},{tenantOrderHolder:s,tenantOrderInsuredList:o}=j({holder:null==(i=Y.submitData.holder)?void 0:i.personVO,insuredList:(Y.submitData.insuredVOList||[]).map((e=>e.personVO))});console.log("submitData",Y.submitData),console.log("tenantOrderHolder",s),console.log("tenantOrderInsuredList",o);const n=Y.submitData.insuredVOList.map((e=>{var t,a;return null==(a=null==(t=e.productPlanVOList)?void 0:t[0])?void 0:a.riskVOList})).flat(),l={tenantId:Q,riskList:n,riskPremium:t,productId:e.id};return r.extInfo.iseeBizNo=ee.value,r.productCode=e.productCode,r.commencementTime=r.insuranceStartDate,r.expiryDate=r.insuranceEndDate,r.premium=Y.trialResultPremium,r.orderAmount=Y.trialResultPremium,r.orderRealAmount=Y.trialResultPremium,r.tenantOrderHolder=s,r.tenantOrderInsuredList=o.map((t=>({...t,certType:t.certType||V.CERT,certNo:(t.certNo||"").toLocaleUpperCase(),planCode:$.dataSource.planCode,tenantOrderProductList:[{premium:Y.trialResultPremium,productCode:e.productCode,productName:e.productName,planCode:$.dataSource.planCode,tenantOrderRiskList:E(l)}]}))),console.log("nextStepParams",r),r},ie=t(),re=e=>{var t;Y.trialResultPremium&&(null==(t=z.value)||t.validate().then((()=>{Object.assign(Z.value,{extInfo:{...Z.value.extInfo,buttonCode:N.TRIAL_PREMIUM,pageCode:F.TRIAL_PREMIUM,templateId:W}});const t=ae($.productInfo,ie.value,Z.value);B(t,((t,a)=>{a===C.JUMP_PAGE&&(te.value.link=`${window.location.href}&isShare=1&orderNo=${t.orderNo}`,e())})),console.log("---- validate success ----")})))},se=()=>{console.log("---close"),Y.show=!1,Y.loading=!1},oe=t({}),ne=()=>{var e,t;Y.riskIsInsure={},null==(t=null==(e=null==$?void 0:$.dataSource)?void 0:e.insureProductRiskVOList)||t.forEach((e=>{var t;const a=null==(t=$.dataSource.productRiskRelationVOList)?void 0:t.find((t=>t.collocationRiskId===e.riskId));a&&(Y.riskIsInsure[e.riskCode]={selected:"2",data:null,relation:a})}))};S.exports.debounce((async()=>{if(console.log(">>>>>调用试算<<<<<"),Y.ifPersonalInfoSuccess){if(Y.submitData.productCode=$.productInfo.productCode,Y.submitData.tenantId=$.productInfo.tenantId,Y.riskVOList=Y.riskVOList.map((e=>(e=>{var t,a,i,r;const s=null==(t=$.dataSource.insureProductRiskVOList)?void 0:t.find((t=>e.riskId===t.riskId));if(s&&1!==s.mainRiskFlag){const t=null==(i=null==(a=$.dataSource)?void 0:a.productRiskRelationVOList)?void 0:i.find((e=>e.collocationRiskId===s.riskId));if(t){const a=null==(r=Y.riskVOList)?void 0:r.find((e=>e.riskId===t.riskId));A.forEach((t=>{t.ruleKey&&s.productRiskInsureLimitVO&&a&&(1===s.productRiskInsureLimitVO[t.ruleKey]&&(e[t.valueKey]=a[t.valueKey]),3===s.productRiskInsureLimitVO[t.ruleKey]&&(1!==s.exemptFlag?e[t.valueKey]=K(s,a[t.valueKey],Y.submitData):e[t.valueKey]=K(s,a[t.ruleValueKey],Y.submitData)))}))}}return e})(e))),Y.submitData.insuredVOList&&Y.submitData.insuredVOList.forEach((e=>{e.productPlanVOList=[{insurerCode:$.productInfo.insurerCode,planCode:$.dataSource.planCode,riskVOList:Y.riskVOList}]})),Y.isSkipFirstTrial&&!Y.hadSkipFirstTrial)return void(Y.hadSkipFirstTrial=!0);console.log(">>>数据构建<<<",Y.submitData);const e=S.exports.cloneDeep(Y.submitData);await(async(e,t=!0)=>{Y.trialMsg=G,Y.trialResultPremium=0,Y.loading=!0;let a=!1;if(t){const{code:t}=await x(e);a="10000"===t}!a&&t||($.hideBenefit||w(e).then((e=>{e.data&&e.code===R&&(oe.value=e.data)})).finally((()=>{Y.loading=!1})),M(e).then((e=>{var t,a;if(e.data&&e.code===R){(null==(t=null==e?void 0:e.data)?void 0:t.errorInfo)&&O(`${null==(a=null==e?void 0:e.data)?void 0:a.errorInfo}`),Y.trialMsg="",Y.trialResultPremium=e.data.premium,Y.trialResult=e.data;const i={};e.data.riskPremiumDetailVOList&&e.data.riskPremiumDetailVOList.length&&e.data.riskPremiumDetailVOList.forEach((e=>{i[e.riskCode]={premium:e.premium,amount:e.amount}})),ie.value=i}})).finally((()=>{Y.loading=!1})))})(e)}}),300);const le=()=>{Y.isAniShow=!1},ue=()=>{Y.trialMsg=G,Y.trialResultPremium=0,Y.loading=!0},de=e=>{Y.trialMsg="",Y.trialResultPremium=e.premium,Y.trialResult=e,Y.loading=!1};s((()=>{ne()})),o((()=>{Y.loading=!0})),n((()=>Y.show),(e=>{e&&(Y.select={},Y.list=[],Y.userData={},Y.riskIsInsure={},Y.submitData={},Y.riskVOList=[{}],Y.mainRiskVO={},Y.ifPersonalInfoSuccess=!1,Y.trialMsg="",Y.trialResultPremium=0,ne())}));const ce=()=>{Y.show=!0,Y.isAniShow=!0,Y.isSkipFirstTrial=!0,Y.hadSkipFirstTrial=!1};return b({open:ce,close:se,getTrialSuccessFlag:()=>Y.trialResultPremium>0}),n((()=>Y.riskIsInsure),(e=>{}),{deep:!0,immediate:!0}),n((()=>$.shareInfo),(()=>{te.value=$.shareInfo}),{deep:!0,immediate:!0}),(t,a)=>{const i=y,r=L;return l(),u(g,null,[e.hidePopupButton?I("",!0):(l(),u("div",{key:0,class:d(`trial-button ${t.$attrs.class}`)},[c(T,{"is-share":te.value.isShare,premium:f(Y).trialResultPremium,"share-info":te.value,"loading-text":f(Y).trialMsg,"plan-code":$.dataSource.planCode,"payment-frequency":f(Y).mainRiskVO.paymentFrequency+"","tenant-product-detail":e.tenantProductDetail,onHandleClick:ce},{default:m((()=>[p("立即投保")])),_:1},8,["is-share","premium","share-info","loading-text","plan-code","payment-frequency","tenant-product-detail"])],2)),f(Y).isAniShow||f(Y).show?(l(),h(r,{key:1,class:d(`com-trial-wrap ${t.$attrs.class}`),show:f(Y).show,closeable:!1,onClose:se,onClosed:le},{default:m((()=>[c(q,{"data-source":e.dataSource,"share-info":e.shareInfo,"is-trial":"","product-info":e.productInfo,"tenant-product-detail":e.tenantProductDetail,"hide-benefit":e.hideBenefit,onTrialStart:ue,onTrialEnd:de},{trialHead:m((()=>[v("div",U,[v("span",H,k(e.title),1),c(i,{name:"cross",onClick:a[0]||(a[0]=e=>f(Y).show=!1)})])])),trialBtn:m((({trialData:t,riskPremium:a})=>[c(T,{"is-share":te.value.isShare,premium:null==a?void 0:a.premium,"share-info":te.value,"loading-text":f(Y).trialMsg,"plan-code":$.dataSource.planCode,"payment-frequency":f(Y).mainRiskVO.paymentFrequency+"","tenant-product-detail":e.tenantProductDetail,"handle-share":re,onHandleClick:e=>(e=>{if(Y.submitData=e,X)P(F.TRIAL_PREMIUM,J.query);else if(Y.trialResultPremium){Object.assign(Z.value,{extInfo:{...Z.value.extInfo,buttonCode:N.TRIAL_PREMIUM,pageCode:F.TRIAL_PREMIUM,templateId:W}});const e=ae($.productInfo,ie.value,Z.value);B(e,((e,t)=>{t===C.JUMP_PAGE&&D(e.nextPageCode,{...J.query,orderNo:e.orderNo})})),console.log("---- validate success ----"),Y.loading=!1,Y.show=!0,Y.isAniShow=!0}})(t)},{default:m((()=>[p("立即投保")])),_:2},1032,["is-share","premium","share-info","loading-text","plan-code","payment-frequency","tenant-product-detail","onHandleClick"])])),_:1},8,["data-source","share-info","product-info","tenant-product-detail","hide-benefit"])])),_:1},8,["class","show"])):I("",!0)],64)}}}),[["__scopeId","data-v-5673d032"]]);export{G as T};
