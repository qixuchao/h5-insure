import{d as e,h as a,g as i,bD as s,c2 as n,i as t,av as r,o,c as l,b as d,a as u,u as c,w as f,a8 as v,aC as g,T as p,bk as h,aa as m,bZ as y,an as b,a6 as S,c3 as I,bc as j,c4 as C}from"./index-2b9d0680.js";import{b as O}from"./product-08531ce5.js";import{i as E,g as L}from"./trial-965388ea.js";import{_ as N,N as T}from"./notice-5995fec1.js";import{u as D}from"./useOrder-ad5f75e9.js";import{M as V}from"./product-585b0e6f.js";import{s as w,a as R}from"./verify-4fba2709.js";import"./bankCard-06890d2f.js";import{P as k,a as q}from"./constants-71331306.js";import"./useAttachment-588b5d0a.js";import"./utils-e47be992.js";import"./infoCollection-0e6a7bcb.js";import"./trial-564daf23.js";const x={class:"long-verify"},A={class:"header"},G={class:"verify-content"},_={class:"footer-button"},U=e({__name:"agentSign",setup(e){const U=a(),H=i(),{productCode:M="",tenantId:B,agentCode:P="",agencyCode:z,saleChannelId:F,saleUserId:$,orderNo:J,orderCode:Z,extraInfo:K,isShare:Q,insurerCode:W,preview:X}=U.query;let Y={};try{Y=JSON.parse(decodeURIComponent(K))}catch(fe){}const ee=D(),ae=`${window.origin}/baseInsurance/long/phoneVerify?${s.stringify({...U.query,orderNo:Z||J})}`;new n({source:"localStorage"});const ie=t({}),se=t(),ne=t(),te=t(),re=t({holder:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""},insured:{fileList:[],personalInfo:[],isSign:!1,isVerify:!1,isShareSign:!1,signData:{}},agent:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""}}),oe=t({}),le=t({}),de=t({sign:[],verify:[],scribing:""}),ue=()=>{if(X)return void g(k.SIGN,U.query);const e=[];se.value&&de.value.sign.includes("1")&&e.push(se.value.validateSign()),ne.value&&((Q?de.value.sign.includes("4"):de.value.sign.includes("2"))&&e.push(ne.value.validateSign()),de.value.verify.includes("1")&&e.push(ne.value.validateVerify())),te.value&&((Q?de.value.sign.includes("5"):de.value.sign.includes("3"))&&e.push(...(te.value||[]).map((e=>e.validateSign()))),de.value.verify.includes("2")&&e.push(...(te.value||[]).map((e=>e.validateVerify())))),Promise.all(e).then((e=>{R({bizObjectId:[],bizObjectType:3,orderId:ee.value.id,tenantId:B}).then((({code:e,data:a})=>{"10000"===e&&a&&H.push({path:q.sign,query:U.query})}))})).catch((e=>{p(e.message)}))};t();t({imgUrl:"",desc:"",title:"",link:ae});const ce=()=>{O({productCode:M}).then((({code:e,data:a})=>{var i;if("10000"===e){const{productMaterialMap:e}=(null==(i=a.productInsureMaterialVOList)?void 0:i[0])||{};(Object.values(e||{})||[]).flat().filter((e=>e.materialType===V.SIGN)).forEach((e=>{e.noticeObject===T.AGENT?re.value.agent.fileList.push(e):e.noticeObject===T.HOlDER?re.value.holder.fileList.push(e):e.noticeObject===T.INSURED&&re.value.insured.fileList.push(e)}))}})),E({productCode:M,isTenant:!X}).then((({data:e,code:a})=>{var i;if("10000"===a){ie.value=e;const{productFactor:a}=(null==(i=e.productPlanInsureVOList)?void 0:i[0])||{},{signInfo:s}=h(a);s.schema.forEach((e=>{"eleSign"===e.name&&e.columns.forEach((a=>{e.required&&de.value.sign.push(a.code),"1"===a.code?re.value.agent.isSign=!0:"2"===a.code?re.value.holder.isSign=!0:"3"===a.code?re.value.insured.isSign=!0:"4"===a.code?re.value.holder.isShareSign=!0:"5"===a.code&&(re.value.insured.isShareSign=!0)})),"riskNotificationCopy"===e.name&&(oe.value.text=e.remark,de.value.scribing=e.required,e.columns.forEach((e=>{"1"===e.code?oe.value.type="handle":oe.value.type="auto"}))),"customerFace"===e.name&&e.columns.forEach((a=>{e.required&&de.value.verify.push(a.code),"1"===a.code?re.value.holder.isVerify=!0:"2"===a.code&&(re.value.insured.isVerify=!0)}))}))}})),((e=!1)=>{J&&L({orderNo:Z||J,tenantId:B}).then((({code:a,data:i})=>{var s,n,t,r,o;"10000"===a&&(e&&((null==(s=null==i?void 0:i.holder)?void 0:s.isCert)===S.NO||(null==i?void 0:i.insuredList.some((e=>e.isCert===S.NO)))?p("用户未完身份认证及签字"):(null==i?void 0:i.tenantOrderAttachmentList.find((e=>e.category===I.ELECTRIC_SIGN&&e.objectType===j.HOLDER)))&&(null==i?void 0:i.tenantOrderAttachmentList.find((e=>e.category===I.ELECTRIC_SIGN&&e.objectType===j.INSURED)))||p("用户未完身份认证及签字")),Object.assign(ee.value,i),re.value.holder.personalInfo=i.holder,re.value.insured.personalInfo=i.insuredList,Object.assign(le.value,{type:C[i.extInfo.transcriptionType],signInfo:null==(t=null==(n=i.riskTranscriptionList)?void 0:n[0])?void 0:t.uri,text:null==(o=null==(r=i.riskTranscriptionList)?void 0:r[0])?void 0:o.content,status:!!i.extInfo.transcriptionStatus}),i.tenantOrderAttachmentList.forEach((e=>{e.objectType===T.HOlDER?re.value.holder.signData=e.fileBase64:e.objectType===T.AGENT?re.value.agent.signData=e.fileBase64:e.objectType===T.INSURED&&(re.value.insured.signData[e.objectId]=e.fileBase64)})))}))})()};return r((()=>{ce()})),(e,a)=>{const i=m,s=y,n=b;return o(),l("div",x,[d(i),u("div",A,[d(s,{type:"warning",title:"尊敬的客户，本次投保需要进行身份认证",content:"本产品投保需要对投保人、被保人进行实名认证，您购买本产品的累计总保费已超过20万，按监管要求，需要提供投保人、被保人、指定受益人证件影像，本产品非本人投保且带身故责任、需对投保人、被保人（成人）的投保意愿进行签字确认。"})]),u("div",G,[d(N,{ref_key:"agentSignRef",ref:se,"order-detail":c(ee),"sign-string":c(re).agent.signData,"show-sign":c(re).agent.isSign,"show-verify":c(re).agent.isVerify,"file-list":c(re).agent.fileList,"personal-info":c(re).agent.personalInfo,disabled:!!c(Q),title:"代理人",onHandleSign:a[0]||(a[0]=e=>((e,a,i)=>{var s;w(e,a,null==(s=ee.value)?void 0:s.id,B,i)})("AGENT",e))},null,8,["order-detail","sign-string","show-sign","show-verify","file-list","personal-info","disabled"])]),u("div",_,[d(n,{type:"primary",onClick:ue},{default:f((()=>[v("确定")])),_:1})])])}}});export{U as default};
