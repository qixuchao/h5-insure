import{reactive as e,onBeforeMount as t,onMounted as a,watch as i}from"vue";import{d as r}from"./debounce-6981b306.js";import{c as l}from"./cloneDeep-6abacc69.js";import{u as n,a as o,G as u,T as s}from"./index-d66a20d8.js";import{_ as d}from"./TrialButton-4937b12b.js";import{u as c,b as m,p}from"./trial-0ac61dce.js";import{P as v}from"./index-973d3f66.js";import{i as f,T as h}from"./index-88f21684.js";import{u as k}from"./useOrder-d2812e23.js";const y=(e,t,a)=>{const i=e,{holder:r}=a,l=a.insuredList[0],n=(t||"").split("_");if(n.length<2)return t;if(f(Number(n[1])))return t;if(n[1]-=1,1===i.exemptFlag){if("to"===n[0]){let e=0;1===i.exemptType?(null==r?void 0:r.birthday)&&(e=parseInt(""+((new Date).getTime()-new Date(r.birthday).getTime())/31536e6,10)):2===i.exemptType&&(null==l?void 0:l.birthday)&&(e=parseInt(""+(+(new Date).getTime()-new Date(l.birthday).getTime())/31536e6,10)),n[1]=+n[1]-e}n[0]="year"}return n.join("_")};const I={class:"pop-header"},P={class:"header-title"},g=vue.defineComponent({name:"TrialPop"}),C=vue.defineComponent({...g,props:{dataSource:{default:()=>[]},productInfo:{default:()=>({productCode:"",productName:"",insurerCode:"",tenantId:"",planList:[]})},shareInfo:{default:()=>({})},tenantProductDetail:{default:()=>({})},hideBenefit:{type:Boolean,default:!1},hidePopupButton:{type:Boolean,default:!1},title:{default:"算一算保费"},defaultData:{default:null},currentOrderDetail:{default:null}},setup(f,{expose:g}){const C=f,D="试算中...",V=vue.ref(null),S=n();o(),S.query;const R=e({loading:!1,show:!1,select:{},list:[],userData:{},riskIsInsure:{},submitData:{},riskVOList:[{}],mainRiskVO:{},ifPersonalInfoSuccess:!1,trialMsg:"",trialResultPremium:0,trialResult:{initialPremium:0,initialAmount:0},isAniShow:!1,defaultValue:null,isAutoChange:!1,planIndex:0,isSkipFirstTrial:!1,hadSkipFirstTrial:!1}),b=vue.ref(),w=k();vue.ref();const L=vue.ref(),O=vue.ref(),T=()=>{console.log("---close"),R.show=!1,R.loading=!1},x=vue.ref({}),B=()=>{var e,t;R.riskIsInsure={},null==(t=null==(e=null==C?void 0:C.dataSource)?void 0:e.insureProductRiskVOList)||t.forEach((e=>{var t;const a=null==(t=C.dataSource.productRiskRelationVOList)?void 0:t.find((t=>t.collocationRiskId===e.riskId));a&&(R.riskIsInsure[e.riskCode]={selected:"2",data:null,relation:a})}))};r((async()=>{if(console.log(">>>>>调用试算<<<<<"),R.ifPersonalInfoSuccess){if(R.submitData.productCode=C.productInfo.productCode,R.submitData.tenantId=C.productInfo.tenantId,R.riskVOList=R.riskVOList.map((e=>(e=>{var t,a,i,r;const l=null==(t=C.dataSource.insureProductRiskVOList)?void 0:t.find((t=>e.riskId===t.riskId));if(l&&1!==l.mainRiskFlag){const t=null==(i=null==(a=C.dataSource)?void 0:a.productRiskRelationVOList)?void 0:i.find((e=>e.collocationRiskId===l.riskId));if(t){const a=null==(r=R.riskVOList)?void 0:r.find((e=>e.riskId===t.riskId));v.forEach((t=>{t.ruleKey&&l.productRiskInsureLimitVO&&a&&(1===l.productRiskInsureLimitVO[t.ruleKey]&&(e[t.valueKey]=a[t.valueKey]),3===l.productRiskInsureLimitVO[t.ruleKey]&&(1!==l.exemptFlag?e[t.valueKey]=y(l,a[t.valueKey],R.submitData):e[t.valueKey]=y(l,a[t.ruleValueKey],R.submitData)))}))}}return e})(e))),R.submitData.insuredVOList&&R.submitData.insuredVOList.forEach((e=>{e.productPlanVOList=[{insurerCode:C.productInfo.insurerCode,planCode:C.dataSource.planCode,riskVOList:R.riskVOList}]})),R.isSkipFirstTrial&&!R.hadSkipFirstTrial)return void(R.hadSkipFirstTrial=!0);console.log(">>>数据构建<<<",R.submitData);const e=l(R.submitData);await(async(e,t=!0)=>{R.trialMsg=D,R.trialResultPremium=0,R.loading=!0;let a=!1;if(t){const{code:t}=await c(e);a="10000"===t}!a&&t||(C.hideBenefit||m(e).then((e=>{e.data&&e.code===u&&(x.value=e.data)})).finally((()=>{R.loading=!1})),p(e).then((e=>{var t,a;if(e.data&&e.code===u){(null==(t=null==e?void 0:e.data)?void 0:t.errorInfo)&&s(`${null==(a=null==e?void 0:e.data)?void 0:a.errorInfo}`),R.trialMsg="",R.trialResultPremium=e.data.initialPremium,R.trialResult=e.data;const i={};e.data.riskPremiumDetailVOList&&e.data.riskPremiumDetailVOList.length&&e.data.riskPremiumDetailVOList.forEach((e=>{i[e.riskCode]={initialPremium:e.initialPremium,initialAmount:e.initialAmount}})),O.value=i}})).finally((()=>{R.loading=!1})))})(e)}}),300);const F=()=>{R.isAniShow=!1},N=()=>{R.trialMsg=D,R.trialResultPremium=0,R.loading=!0},E=e=>{R.trialMsg="",R.trialResultPremium=e.initialPremium,R.trialResult=e,R.loading=!1};t((()=>{B()})),a((()=>{R.loading=!0})),i((()=>C.currentOrderDetail),(e=>{b.value=e||w.value}),{deep:!0,immediate:!0});const M=vue.ref();i((()=>C.tenantProductDetail),(()=>{var e,t,a;const i=((null==(e=null==C?void 0:C.tenantProductDetail)?void 0:e.PREMIUM)||[]).find((e=>{var t;return!e.planCode||e.planCode===(null==(t=null==C?void 0:C.dataSource)?void 0:t.planCode)}))||{};M.value=null==(a=null==(t=(i.data||[]).sort(((e,t)=>+t.paymentFrequency-+e.paymentFrequency)))?void 0:t[0])?void 0:a.paymentFrequency}),{deep:!0,immediate:!0}),i((()=>R.show),(e=>{e&&(R.select={},R.list=[],R.userData={},R.riskIsInsure={},R.submitData={},R.riskVOList=[{}],R.mainRiskVO={},R.ifPersonalInfoSuccess=!1,R.trialMsg="",R.trialResultPremium=0,B())}));const j=()=>{R.show=!0,R.isAniShow=!0,R.isSkipFirstTrial=!0,R.hadSkipFirstTrial=!1};return g({open:j,close:T,getTrialSuccessFlag:()=>R.trialResultPremium>0}),i((()=>C.shareInfo),(()=>{L.value=C.shareInfo}),{deep:!0,immediate:!0}),(e,t)=>{const a=vue.resolveComponent("van-icon"),i=vue.resolveComponent("ProPopup");return vue.openBlock(),vue.createElementBlock(vue.Fragment,null,[e.hidePopupButton?vue.createCommentVNode("",!0):(vue.openBlock(),vue.createElementBlock("div",{key:0,class:vue.normalizeClass(`trial-button ${e.$attrs.class}`)},[vue.createVNode(d,{"is-share":L.value.isShare,premium:vue.unref(R).trialResultPremium,"share-info":L.value,"loading-text":"","plan-code":C.dataSource.planCode,"payment-frequency":M.value,"tenant-product-detail":e.tenantProductDetail,onHandleClick:j},{default:vue.withCtx((()=>[vue.createTextVNode("立即投保")])),_:1},8,["is-share","premium","share-info","plan-code","payment-frequency","tenant-product-detail"])],2)),vue.unref(R).isAniShow||vue.unref(R).show?(vue.openBlock(),vue.createBlock(i,{key:1,class:vue.normalizeClass(`com-trial-wrap ${e.$attrs.class}`),show:vue.unref(R).show,closeable:!1,onClose:T,onClosed:F},{default:vue.withCtx((()=>[vue.createVNode(h,{ref_key:"insureInfosRef",ref:V,"data-source":e.dataSource,"share-info":e.shareInfo,"is-trial":"","product-info":e.productInfo,"tenant-product-detail":e.tenantProductDetail,"hide-benefit":e.hideBenefit,"default-data":e.defaultData,"default-order":b.value,onTrialStart:N,onTrialEnd:E},{trialHead:vue.withCtx((()=>[vue.createElementVNode("div",I,[vue.createElementVNode("span",P,vue.toDisplayString(e.title),1),vue.createVNode(a,{name:"cross",onClick:t[0]||(t[0]=e=>vue.unref(R).show=!1)})])])),trialBtn:vue.withCtx((t=>[vue.renderSlot(e.$slots,"trialBtn",vue.normalizeProps(vue.guardReactiveProps(t)),(()=>{var a,i,r,l,n,o;return[vue.createVNode(d,{"is-share":L.value.isShare,premium:null==(a=t.riskPremium)?void 0:a.initialPremium,"share-info":L.value,"loading-text":vue.unref(R).trialMsg,"plan-code":C.dataSource.planCode,"payment-frequency":(null==(o=null==(n=null==(l=null==(r=null==(i=t.trialData)?void 0:i.insuredList)?void 0:r[0].productList)?void 0:l[0].riskList)?void 0:n[0])?void 0:o.paymentFrequency)+"","tenant-product-detail":e.tenantProductDetail,"handle-share":e=>((e,t)=>{V.value.onShare(e)})(e,t.trialData),disabled:!!vue.unref(R).trialMsg,onHandleClick:e=>(t.trialData,void V.value.onNext())},{default:vue.withCtx((()=>[vue.createTextVNode("立即投保")])),_:2},1032,["is-share","premium","share-info","loading-text","plan-code","payment-frequency","tenant-product-detail","handle-share","disabled","onHandleClick"])]}))])),_:3},8,["data-source","share-info","product-info","tenant-product-detail","hide-benefit","default-data","default-order"])])),_:3},8,["class","show"])):vue.createCommentVNode("",!0)],64)}}});export{C as _};
