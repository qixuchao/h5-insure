import{d as e,i as t,h as i,j as s,aP as o,aQ as a,k as r,aR as u,l as d,o as l,c as n,b as c,w as p,v,u as m,p as f,f as L,ap as R,aS as I}from"./index-6005e057.js";import k from"./index-8eb3d5f2.js";import{g as j,s as C,i as b,m as h}from"./trial-3b493004.js";import g from"./SelectRiskList-d4331e70.js";import{_ as w}from"./TrialButton-45bf00a6.js";import{R as y}from"./trial-23bf8d8b.js";import{u as q}from"./useOrder-d0f60ac4.js";import{p as P,a as x}from"./utils-f08c6b57.js";import{q as O}from"./createProposal-b894c26c.js";import{g as _,t as N}from"./util-c7e3c85e.js";import{f as T,a as A}from"./findLastIndex-76015964.js";import"./InsureInfos-bf99ee8b.js";import"./index-99edd7b3.js";import"./infoCollection-ac659251.js";import"./index-ffb2bd72.js";import"./PolicyInfo-228ab539.js";import"./questionnaire-42dcb602.js";import"./product-7bbf9c44.js";import"./constants-6ad2f07c.js";import"./utils-4e970874.js";import"./nextStep-688f92e5.js";import"./core-b3a3aa15.js";import"./format-31cde443.js";import"./index-0285c309.js";import"./utils-a2578b76.js";const M={class:"page-trial-wrap"},S=e({name:"trial"}),B=e({...S,setup(e){const S=t(),B=i(),{productCode:V,orderNo:D,tenantId:E,proposalId:K,proposalInsuredId:H,productClass:z,showPersonInfo:F}=S.query,U=s({}),Q=s({productList:[]}),$=s([]),G=s({}),J=s(),W=s(),X=s(),Y=q({extInfo:{buttonCode:o.TRIAL_PREMIUM,pageCode:a.TRIAL_PREMIUM}}),Z=_(),ee=s(),te=s(),ie=s(),se=s(1),oe=r((()=>se.value===y.MAIN_RISK?"添加主险":"添加附加险")),ae=s(!1),re=()=>{h(Q.value).then((({code:e,data:t})=>{if("10000"===e){const{productDetailResList:e,productFactor:i}=t;if(ie.value=i,Q.value=x(e),Z){const e=((null==i?void 0:i[2])||[]).map((e=>e.code)),t=N(Z,e);ee.value=R(t),te.value=Object.assign(Y.value,{insuredList:[t]})}const s={};e.forEach((e=>{s[e.productCode]=e})),U.value=s}}))},ue=()=>{ae.value=!1},de=e=>{if(se.value===y.MAIN_RISK){Q.value.productList.push(...e);const t=e.map((e=>e.productCode));J.value.getProductDefaultValue(t)}else{const t=Q.value.productList.find((e=>e.productCode===W.value)),i=e.map((e=>({riskCode:e,riskType:y.RIDER_RISK,mainRiskCode:G.value.riskCode}))),s=T(t.mergeRiskReqList,(e=>e.riskCode===G.value.riskCode)),o=A(t.mergeRiskReqList,(e=>e.mainRiskCode===G.value.riskCode));let a=s;-1!==o&&(a=o),t.mergeRiskReqList=[...t.mergeRiskReqList.slice(0,a+1),...i,...t.mergeRiskReqList.slice(a+1,t.mergeRiskReqList.length)],J.value.getRiderRiskDefaultValue(W.value,e,G.value.riskCode,t.mergeRiskReqList)}re(),ae.value=!1},le=(e,t,i)=>{ae.value=!0,se.value=y.RIDER_RISK,$.value=i,G.value=t,W.value=e},ne=e=>{ae.value=!0,se.value=y.MAIN_RISK,$.value=e},ce=(e,t,i)=>{U.value[e],i?(U.value[e].productPlanInsureVOList[0].insureProductRiskVOList=U.value[e].productPlanInsureVOList[0].insureProductRiskVOList.filter((e=>e.riskCode!==t)),Q.value.productList=Q.value.productList.map((i=>(i.productCode===e&&(i.mergeRiskReqList=i.mergeRiskReqList.filter((e=>e.riskCode!==t))),i)))):(Q.value.productList=Q.value.productList.filter((t=>t.productCode!==e)),re())},pe=()=>{J.value.onNext((async e=>{var t;const i=R(e),s=["id","relationToHolder","beneficiaryList","guardian","insuredBeneficiaryType"];D||Object.keys(null==(t=i.insuredList)?void 0:t[0]).reduce(((e,t)=>{var o,a,r,u,d,l,n,c;return!(null==(a=null==(o=i.insuredList)?void 0:o[0])?void 0:a[t])&&(null==(r=ee.value)?void 0:r[t])&&(i.insuredList[0][t]=null==(u=ee.value)?void 0:u[t]),!s.includes(t)&&(null==(l=null==(d=i.insuredList)?void 0:d[0])?void 0:l[t])&&(e[t]=null==(c=null==(n=i.insuredList)?void 0:n[0])?void 0:c[t]),e}),i.holder),i.extInfo&&(i.extInfo.iseeBizNo=X.value),i.operateOption={withBeneficiaryInfo:!0,withHolderInfo:!0,withInsuredInfo:!0,withAttachmentInfo:!0,withProductInfo:!0};const{code:o,data:a}=await C(i);"10000"===o&&B.push({path:I.questionNotice,query:{...S.query,orderNo:a}})}))};return u((()=>{D?j({orderNo:D,tenantId:E}).then((({code:e,data:t})=>{"10000"===e&&(te.value=t,Y.value=t,Q.value=P(t.insuredList[0].productList),re())})):K?O({id:K,tenantId:E}).then((({code:e,data:t})=>{if("10000"===e){const{holder:e,insuredList:i}=t,s=(V||"").split(",");let o=[];const a=(i||[]).filter((e=>e.id===+H)).map((e=>({...e,relationToHolder:null,productList:e.productList.filter((e=>!!s.includes(e.productCode)&&(o=e.occupationCodeList,!0)))})));a[0].occupationCodeList=o,Object.assign(Y.value,{renewFlag:"",holder:e,tenantId:E,proposalId:K,insuredList:a}),te.value=Y.value,Q.value=P(Y.value.insuredList[0].productList),re()}})):b({productCode:V,isTenant:!1}).then((({data:e,code:t})=>{var i,s,o;if("10000"===t&&(U.value[`${V}`]=e,ie.value=null==(s=null==(i=null==e?void 0:e.productPlanInsureVOList)?void 0:i[0])?void 0:s.productFactor,Q.value=x([e]),Z)){const e=null==(o=ie.value)?void 0:o[2].map((e=>e.code)),t=[N(Z,e)];ee.value=R(t[0]),te.value=Object.assign(Y.value,{insuredList:t})}}))})),d((()=>{setTimeout((async()=>{X.value=window.getIseeBiz&&await window.getIseeBiz()}),1500)})),(e,t)=>(l(),n("div",M,[c(k,{ref_key:"trialRef",ref:J,"product-collection":m(U),"default-data":m(te),"product-factor":m(ie),"product-risk-code-map":m(Q),"is-trial":"","hide-benefit":"","show-person-info":!!m(F),onAddRisk:le,onAddMainRisk:ne,onDeleteRisk:ce},{trialBtn:p((({riskPremium:e})=>[c(w,{premium:null==e?void 0:e.initialPremium,onHandleClick:pe},{label:p((()=>[v(" 首年总保费 ")])),_:2},1032,["premium"])])),_:1},8,["product-collection","default-data","product-factor","product-risk-code-map","show-person-info"]),m(ae)?(l(),f(g,{key:0,type:m(se),"product-class":m(z),show:m(ae),"insured-list":m($),title:m(oe),"current-product-code":m(W),"main-risk-code":m(G).riskCode,"select-list":m(Q).productList,onCancel:ue,onConfirm:de},null,8,["type","product-class","show","insured-list","title","current-product-code","main-risk-code","select-list"])):L("",!0)]))}});export{B as default};
