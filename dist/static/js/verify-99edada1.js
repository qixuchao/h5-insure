import{d as e,r as i,K as a,v as s,Q as n,b as t,c as l,y as o,i as r,w as d,f as c,z as u,g as f,A as g,Y as v,h,j as p,e as m,a1 as y,C as S,a9 as w,bf as I,u as b,a as C,al as j,o as _,R as k,U as N,aS as V,aw as x,bs as E,D as L,T as D,bt as O,B as T}from"./index-2d842534.js";import{a as P,q as R}from"./product-88b44517.js";import{n as U}from"./nextStep-716e9628.js";import{c as B,i as Y}from"./trial-49d69061.js";import{u as A}from"./useAttachment-53eab87d.js";import{_ as H,f as M,s as F}from"./verify-f62b9a6a.js";import{u as $}from"./useOrder-2cdfd9fe.js";import{O as G}from"./order-2be47657.js";import{t as q}from"./ProRenderFormWithCard.vue_vue_type_style_index_0_scoped_true_lang-2dff19f2.js";/* empty css              */import"./bankCard-7cdef5f5.js";import{p as W}from"./pageJump-5c5e251c.js";import{B as J,P as z}from"./constants-7afb7c3d.js";import"./pdfh5-008ca364.js";import"./core-f7e61596.js";import"./constant-c3f28a3b.js";import"./utils-247a517d.js";import"./infoCollection-267e9288.js";import"./trial-acc7211d.js";import"./phoneVerify-3e3faf04.js";import"./keysIn-3ff85984.js";import"./isObjectLike-a9798079.js";const K={class:"com-sign-part"},Q={class:"people"},X={class:"name"},Z={key:0,class:"verify-item"},ee=c("div",{class:"label"},"证件号码",-1),ie={class:"no"},ae={class:"sign-status"},se={class:"status"},ne=["disabled"],te=["src"],le={key:1,class:"sign-desc"},oe={class:"sign-body"},re={class:"date"},de={class:"file"},ce=e({name:"signPart"}),ue=e({...ce,props:{signString:{default:""},personalInfo:{default:()=>({})},fileList:null,title:{default:""},showSign:{type:Boolean,default:!1},showVerify:{type:Boolean,default:!1},showShareSign:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1}},emits:["handleVerify","handleSign"],setup(e,{expose:b,emit:C}){const j=e,_=i({}),k=i(""),N=i([]),V=i({});i(!0);const x=i(!1),E=i(0),{fileList:L}=A(V,N),D=e=>`${e}`===S.CERT,O=a((()=>s().format("YYYY-MM-DD"))),T=()=>{var e,i;C("handleVerify",null==(e=_.value)?void 0:e.name,null==(i=_.value)?void 0:i.certNo)},P=()=>{x.value=!1},R=i(),U=()=>{R.value&&R.value.rewrite()},B=()=>{j.disabled||R.value&&R.value.openSign()},Y=e=>{C("handleSign",e)};return b({validateSign:()=>new Promise(((e,i)=>{k.value?e(!0):i(new Error(`请${j.title}成签名后，去支付`))})),validateVerify:()=>new Promise(((e,i)=>{var a,s;(null==(s=null==(a=j.personalInfo)?void 0:a.extInfo)?void 0:s.isCert)!==v.YES?i(new Error(`请${j.title}完成认证后，去支付`)):e(!0)}))}),n((()=>j.signString),(()=>{k.value=j.signString}),{immediate:!0}),n((()=>j.personalInfo),(()=>{_.value=j.personalInfo}),{deep:!0,immediate:!0}),(i,a)=>{const s=w,n=I,S=t("AttachmentList"),b=t("FilePreview");return l(),o("div",K,[r(n,{title:e.title,class:"card"},{extra:d((()=>{var i,a,s,n,t,r;return[c("div",Q,[c("div",X,u(null==(i=f(_))?void 0:i.name),1),e.showVerify&&D(null==(a=f(_))?void 0:a.certType)?(l(),o("div",{key:0,class:g(["status",{verified:(null==(n=null==(s=f(_))?void 0:s.extInfo)?void 0:n.isCert)===f(v).YES}])},u((null==(r=null==(t=f(_))?void 0:t.extInfo)?void 0:r.isCert)===f(v).YES?"已认证":"待认证"),3)):h("",!0)])]})),default:d((()=>{var i,a,n,t,d;return[e.showVerify&&(null==(i=f(_))?void 0:i.certNo)?(l(),o("div",Z,[ee,c("div",ie,u(null==(a=f(_))?void 0:a.certNo),1),(null==(t=null==(n=f(_))?void 0:n.extInfo)?void 0:t.isCert)!==f(v).YES&&D(null==(d=f(_))?void 0:d.certType)?(l(),o("div",{key:0,class:"action",onClick:T},[p(" 去认证 "),r(s,{name:"right_arrow",class:"icon"})])):h("",!0)])):h("",!0)]})),_:1},8,["title"]),e.showSign?(l(),m(n,{key:0,title:`${e.title}签名`,"show-icon":!1,class:"sign-card","show-line":!1},{extra:d((()=>[c("div",ae,[c("div",se,u(f(k)?"已签名":"未签名"),1),c("div",{disabled:e.disabled,class:"resign",onClick:U},"重签",8,ne)])])),default:d((()=>{var e;return[r(H,{ref_key:"signRef",ref:R,modelValue:f(k),"onUpdate:modelValue":a[0]||(a[0]=e=>y(k)?k.value=e:null),class:"sign",onSubmitSign:Y},{signImg:d((({data:e})=>[c("div",{class:"sign-board",onClick:B},[e?(l(),o("img",{key:0,src:e,class:"sign-img",alt:""},null,8,te)):(l(),o("span",le,"请签名"))])])),_:1},8,["modelValue"]),c("div",oe,[c("div",re,"签名日期： "+u(f(O)),1),c("div",de,[(null==(e=f(L))?void 0:e.length)?(l(),m(S,{key:0,"attachment-list":f(L),"pre-text":"签名将被用于以下文件：",onPreviewFile:a[1]||(a[1]=e=>(e=>{E.value=e,x.value=!0})(e))},null,8,["attachment-list"])):h("",!0)])])]})),_:1},8,["title"])):h("",!0),f(x)?(l(),m(b,{key:1,show:f(x),"onUpdate:show":a[2]||(a[2]=e=>y(x)?x.value=e:null),"content-list":f(L),"is-only-view":"","active-index":f(E),text:"关闭",onOnCloseFilePreviewByMask:P},null,8,["show","content-list","active-index"])):h("",!0)])}}}),fe=2,ge=1,ve=2,he=3;const pe={class:"long-verify"},me={class:"header"},ye={class:"verify-content"},Se={class:"footer-button footer-bar"},we=c("div",{class:"text"},"刷新",-1),Ie=e({__name:"verify",setup(e){const a=b();C();const{productCode:s="",tenantId:n,agentCode:u="",agencyCode:g,saleChannelId:v,saleUserId:y,orderNo:S,orderCode:I,extraInfo:A,isShare:H,insurerCode:K,preview:Q}=a.query;let X={};try{X=JSON.parse(decodeURIComponent(A))}catch(_e){}const Z=$(),ee=`${window.origin}/baseInsurance/long/phoneVerify${window.location.search}`,ie=new j({source:"localStorage"});i({});const ae=i({}),se=()=>{},ne=i(),te=i(),le=i(),oe=i({holder:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""},insured:{fileList:[],personalInfo:[],isSign:!1,isVerify:!1,isShareSign:!1,signData:{}},agent:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""}}),re=(e,i)=>{let a=window.location.href;a=a.includes("orderCode")?a:a.replace("orderNo","orderCode"),M({callbackUrl:a,certiNo:i,faceAuthMode:"TENCENT",userName:e,tenantId:n}).then((({code:a,data:s})=>{if("10000"===a){const{originalUrl:a,serialNo:n}=s;window.location.href=a,ie.set("verifyData",{serialNo:n,certNo:i,name:e})}}))},de=(e,i,a)=>{var s;F(e,i,null==(s=Z.value)?void 0:s.id,n,a)},ce=()=>{Promise.all([ne.value.validateSign()]).then((e=>{B({orderNo:I||S,saleUserId:y,tenantId:n}).then((({code:e,data:i})=>{"10000"===e&&([G.PENDING,G.PAYMENT_FAILED,G.UNDER_WRITING_SUCCESS].includes(i.orderStatus)?W("paymentResult",{...a.query,orderNo:I||S}):L.confirm({title:"提示",message:"请确认信息填写无误后，再进行支付"}).then((()=>{Object.assign(Z.value,{extInfo:{...Z.value.extInfo,buttonCode:J.SIGN,pageCode:z.SIGN}}),U(Z.value,((e,i)=>{}))})))}))})).catch((e=>{D(e.message)}))},Ie=i(),be=()=>{ne.value.validateSign().then((()=>{Ie.value&&Ie.value.handleShare()})).catch((()=>{D("请完成代理人签字后进行分享")}))},Ce=i({imgUrl:"",desc:"",title:"",link:ee}),je=()=>{P({productCode:s,tenantId:n,isTenant:!Q}).then((({data:e,code:i})=>{var a;if("10000"===i){let i={};if(null==(a=null==e?void 0:e.PRODUCT_LIST)?void 0:a.wxShareConfig){const{title:a,desc:s,image:n}=(null==e?void 0:e.PRODUCT_LIST.wxShareConfig)||{},[t=""]=n||[];i={title:a,desc:s,image:t}}else{const{title:a,desc:s,image:n}=(null==e?void 0:e.PRODUCT_LIST)||{};i={title:a,desc:s,image:n}}Object.assign(Ce.value,i)}})),R({productCode:s}).then((({code:e,data:i})=>{var a;if("10000"===e){const{productMaterialMap:e}=(null==(a=i.productInsureMaterialVOList)?void 0:a[0])||{};(Object.values(e)||[]).flat().filter((e=>e.materialType===fe)).forEach((e=>{e.noticeObject===he?oe.value.agent.fileList.push(e):e.noticeObject===ge?oe.value.holder.fileList.push(e):e.noticeObject===ve&&oe.value.insured.fileList.push(e)}))}})),Y({productCode:s,isTenant:!Q}).then((({data:e,code:i})=>{var a;if("10000"===i){ae.value=e;const{productFactor:i}=(null==(a=e.productPlanInsureVOList)?void 0:a[0])||{},{signInfo:s}=q(i);s.schema.forEach((e=>{"eleSign"===e.name&&e.columns.forEach((e=>{"1"===e.code?oe.value.agent.isSign=!0:"2"===e.code?oe.value.holder.isSign=!0:"3"===e.code?oe.value.insured.isSign=!0:"4"===e.code?oe.value.holder.isShareSign=!0:"5"===e.code&&(oe.value.insured.isShareSign=!0)})),"customerFace"===e.name&&e.columns.forEach((e=>{"1"===e.code?oe.value.holder.isVerify=!0:"2"===e.code&&(oe.value.insured.isVerify=!0)}))}))}})),B({orderNo:I||S,tenantId:n}).then((({code:e,data:i})=>{"10000"===e&&(Object.assign(Z.value,i),oe.value.holder.personalInfo=i.tenantOrderHolder,oe.value.insured.personalInfo=i.tenantOrderInsuredList,i.tenantOrderAttachmentList.forEach((e=>{e.objectType===ge?oe.value.holder.signData=e.fileBase64:e.objectType===he?oe.value.agent.signData=e.fileBase64:e.objectType===ve&&(oe.value.insured.signData[e.objectId]=e.fileBase64)})))}))};return _((()=>{je()})),(e,i)=>{const a=O,s=w,n=T,u=t("ProPageWrap");return l(),m(u,null,{default:d((()=>[c("div",pe,[c("div",me,[r(a,{type:"warning",title:"尊敬的客户，本次投保需要进行身份认证",content:"本产品投保需要对投保人、被保人进行实名认证，您购买本产品的累计总保费已超过20万，按监管要求，需要提供投保人、被保人、指定受益人证件影像，本产品非本人投保且带身故责任、需对投保人、被保人（成人）的投保意愿进行签字确认。"})]),c("div",ye,[r(ue,{ref_key:"agentSignRef",ref:ne,"data-source":[],"order-detail":f(Z),"sign-string":f(oe).agent.signData,"show-sign":f(oe).agent.isSign,"show-verify":f(oe).agent.isVerify,"show-share-sign":f(oe).agent.isShareSign,"file-list":f(oe).agent.fileList,"personal-info":f(oe).agent.personalInfo,disabled:!!f(H),title:"代理人",onHandleSign:i[0]||(i[0]=e=>de("AGENT",e))},null,8,["order-detail","sign-string","show-sign","show-verify","show-share-sign","file-list","personal-info","disabled"]),r(ue,{ref_key:"holderSignRef",ref:te,"data-source":[],"order-detail":f(Z),"sign-string":f(oe).holder.signData,"show-sign":f(oe).holder.isSign,"show-verify":f(oe).holder.isVerify,"show-share-sign":f(oe).holder.isShareSign,"file-list":f(oe).holder.fileList,"personal-info":f(oe).holder.personalInfo,title:"投保人",onHandleSign:i[1]||(i[1]=e=>de("HOLDER",e,f(oe).holder.personalInfo.id)),onHandleVerify:re},null,8,["order-detail","sign-string","show-sign","show-verify","show-share-sign","file-list","personal-info"]),(l(!0),o(k,null,N(f(oe).insured.personalInfo||[],(e=>(l(),m(ue,{key:e.id,ref_for:!0,ref_key:"insuredSignRef",ref:le,"data-source":[],"order-detail":f(Z),"sign-string":f(oe).insured.signData[e.id],"show-sign":f(oe).insured.isSign,"show-verify":f(oe).insured.isVerify,"show-share-sign":f(oe).insured.isShareSign,"file-list":f(oe).insured.fileList,"personal-info":e||{},title:"被保人",onHandleSign:i=>de("INSURED",i,e.id),onHandleVerify:re},null,8,["order-detail","sign-string","show-sign","show-verify","show-share-sign","file-list","personal-info","onHandleSign"])))),128))]),c("div",Se,[c("div",{class:"refresh-btn",onClick:se},[c("div",null,[r(s,{name:"refresh"})]),we]),f(H)?h("",!0):(l(),m(V,x({key:0,ref_key:"shareRef",ref:Ie},f(Ce)),{default:d((()=>[r(n,{plain:"",type:"primary",class:"share-btn",onClick:E(be,["stop"])},{default:d((()=>[p("分享")])),_:1},8,["onClick"])])),_:1},16)),r(n,{type:"primary",class:"submit-btn",onClick:ce},{default:d((()=>[p("提交")])),_:1})])])])),_:1})}}});export{Ie as default};
