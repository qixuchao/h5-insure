import{d as e,i,h as s,cd as a,c4 as n,j as o,bc as t,l as r,o as d,c as l,b as c,a as u,u as f,F as g,s as m,p,f as v,w as h,v as S,q as b,cR as y,bj as j,bb as I,cP as w,cQ as N,c3 as D,bd as L,T as E,bN as O,a$ as V,cS as q,b3 as C}from"./index-169b3a9c.js";import{b as R}from"./product-ef29c4d1.js";import{g as U,m as _}from"./trial-9e8fc728.js";import{_ as P}from"./SignPart-4c3e48f0.js";import{u as B}from"./useOrder-a1deeced.js";import{N as T}from"./notice-544087e3.js";import"./PolicyInfo-85c122ae.js";import{p as k}from"./utils-6a2a3f5a.js";import{g as $}from"./utils-662b4495.js";import{i as x}from"./core-a9483ea2.js";import{_ as z}from"./MessagePopup-c23bc6cb.js";import{q as M}from"./qianming-ece13dd4.js";import"./index-09e1bc02.js";import"./cloneDeep-35e7d1d1.js";import"./utils-2d4d3df3.js";import"./createProposal-e3e73c74.js";import"./trial-f98d9b73.js";import"./infoCollection-151ddca3.js";const F={class:"long-verify"},A={class:"header"},H={class:"verify-content"},G={class:"footer-button footer-bar"},J={class:"content-inner"},Q=["src"],W=u("h4",null,"本次签名已完成",-1),K=u("p",null,"感谢您对本次投保的签字确认，后续流程由销售人员在您的配合下进行",-1),X=e({__name:"insuredSign",setup(e){const X=i(),Y=s(),{tenantId:Z,orderNo:ee,orderCode:ie,extraInfo:se,isShare:ae,insurerCode:ne,preview:oe}=X.query;let te={};try{te=JSON.parse(decodeURIComponent(se))}catch(he){}const re=B(),[de,le]=a(!1),ce=`${window.origin}/baseInsurance/long/phoneVerify?${n.stringify({...X.query,orderNo:ie||ee})}`,ue=o(),fe=o({holder:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""},insured:{fileList:[],personalInfo:[],isSign:!1,isVerify:!1,isShareSign:!1,signData:{},compositionSign:""},agent:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""}}),ge=(e,i,s)=>{var a;y(e,i,null==(a=re.value)?void 0:a.id,Z,s).then((({code:e,message:i})=>{"10000"===e&&ee&&U({orderNo:ie||ee,tenantId:Z}).then((({code:e,data:i})=>{if("10000"===e){const e={};i.tenantOrderAttachmentList.forEach((i=>{i.objectType===T.INSURED&&(30===i.category?e[i.objectId]?e[i.objectId].push(i.fileBase64):e[i.objectId]=[i.fileBase64]:21===i.category&&(fe.value.insured.compositionSign=i.uri))})),fe.value.insured.signData=e}}))}))},me=o({sign:[],verify:[],scribing:""}),pe=()=>{if(oe)return void j(I.SIGN,X.query);const e=[];ue.value&&((ae?me.value.sign.includes("5"):me.value.sign.includes("3"))&&e.push(...(ue.value||[]).map((e=>e.validateSign()))),me.value.verify.includes("2")&&e.push(...(ue.value||[]).map((e=>e.validateVerify())))),Promise.all(e).then((e=>{w({bizObjectId:re.value.insuredList.map((e=>e.id)),bizObjectType:N.INSURED,orderId:re.value.id,tenantId:Z,shareFlag:ae?1:2}).then((({code:e,data:i})=>{if("10000"===e&&i){if(ae)return le(!0),void setTimeout((()=>{x?D.closeWindow():window.close()}),2e3);Y.push({path:L.sign,query:X.query})}}))})).catch((e=>{E(e.message)}))};o({imgUrl:"",desc:"",title:"",link:ce});t((()=>{(async()=>{let e={};const{code:i,data:s}=await U({orderNo:ie||ee,tenantId:Z});"10000"===i&&(Object.assign(re.value,s),fe.value.insured.personalInfo=s.insuredList.map((e=>(e.isCert=1,e))),e=k(s.insuredList[0].productList),s.tenantOrderAttachmentList.forEach((e=>{e.objectType===T.INSURED&&e.objectId&&(30===e.category?fe.value.insured.signData[e.objectId]?fe.value.insured.signData[e.objectId].push(e.fileBase64):fe.value.insured.signData[e.objectId]=[e.fileBase64]:21===e.category&&(fe.value.insured.compositionSign=e.uri))}))),R(e).then((({code:e,data:i})=>{var s;if("10000"===e){const{signMaterialMap:e}=(null==(s=i.productMaterialPlanVOList)?void 0:s[1])||{};(Object.values(e||[]).flat()||[]).forEach((e=>{e.noticeObject===T.INSURED&&fe.value.insured.fileList.push({attachmentName:e.materialName,attachmentList:[{...e,materialSource:$(`${null==e?void 0:e.materialSource}`,null==e?void 0:e.materialContent)}]})}))}})),_(e).then((({data:e,code:i})=>{if("10000"===i){const{signInfo:i}=O(e.productFactor);i.schema.forEach((e=>{"eleSign"===e.name&&e.columns.forEach((i=>{e.required&&me.value.sign.push(i.code),"1"===i.code?fe.value.agent.isSign=!0:"2"===i.code?fe.value.holder.isSign=!0:"3"===i.code?fe.value.insured.isSign=!0:"4"===i.code?fe.value.holder.isShareSign=!0:"5"===i.code&&(fe.value.insured.isShareSign=!0)}))}))}}))})()}));const ve=o();return r((()=>{setTimeout((async()=>{ve.value=window.getIseeBiz&&await window.getIseeBiz()}),1500)})),(e,i)=>{var s,a,n,o;const t=V,r=q,y=C;return d(),l("div",F,[c(t),u("div",A,[c(r,{type:"warning",content:(null==(a=null==(s=f(fe).insured.personalInfo)?void 0:s[0])?void 0:a.name)&&`本人${null==(o=null==(n=f(fe).insured.personalInfo)?void 0:n[0])?void 0:o.name}已阅读并同意签署《电子投保单》（投保信息确认）`},null,8,["content"])]),u("div",H,[!f(ae)||f(fe).insured.isShareSign?(d(!0),l(g,{key:0},m(f(fe).insured.personalInfo||[],(e=>(d(),p(P,{key:e.id,ref_for:!0,ref_key:"insuredSignRef",ref:ue,"data-source":[],"order-detail":f(re),"sign-string":f(fe).insured.signData[e.id],"show-sign":f(ae)?f(fe).insured.isShareSign:f(fe).insured.isSign,"show-verify":f(fe).insured.isVerify,"file-list":f(fe).insured.fileList,"personal-info":e||{},"composition-sign":f(fe).insured.compositionSign,title:"被保险人",onHandleSign:i=>ge("INSURED",i,e.id)},null,8,["order-detail","sign-string","show-sign","show-verify","file-list","personal-info","composition-sign","onHandleSign"])))),128)):v("",!0)]),u("div",G,[c(y,{type:"primary",class:"submit-btn",onClick:pe},{default:h((()=>[S("确定")])),_:1})]),c(z,{modelValue:f(de),"onUpdate:modelValue":i[0]||(i[0]=e=>b(de)?de.value=e:null),onClose:i[1]||(i[1]=e=>f(le)(!1))},{default:h((()=>[u("div",J,[u("img",{src:f(M),alt:"",class:"header-img"},null,8,Q),W,K])])),_:1},8,["modelValue"])])}}});export{X as default};
