import{ref as e,reactive as t,watch as r,onBeforeMount as a}from"vue";import{_ as o,a as i,u as n,aY as l,n as u,aZ as s,aV as d,a7 as c,a_ as v}from"./index-d66a20d8.js";import{i as p,p as m}from"./trial-0ac61dce.js";import{q as f}from"./createProposal-edb2e0a1.js";import{P as k,I as C}from"./trial-b3f7bf73.js";import"./pdfh5-e588f83d.js";const g={key:0,class:"part-card"},V={key:1,class:"part-card"},y={class:"risk-content"},h={key:0,class:"risk"},I={key:1,class:"plan-risk"},N={class:"footer-bar van-safe-area-bottom"},P={class:"trial-result"},L={class:"result-num"},O={class:"trial-operate"},B={key:0,class:"retrial-tip"};var b=o(vue.defineComponent({__name:"index",setup(o){var b;const T=i(),_=n(),{agentCode:R="test",agencyCode:D="",tenantId:x=9991000007,insurerCode:F="99",proposalId:w,saleChannelId:E}=_.query;let{productCode:j="MMBBSF",templateId:A=1}=_.query;const q=e({personVO:{occupationCodeList:[]}}),S=e({insuredCode:"",personVO:{occupationCodeList:[]}}),U=e({}),M=e({}),Y=e({}),z=e(null),H=e({}),J=t({currentPlan:"",riskBaseInfo:{},holderFactor:[],insuredFactor:[],riskData:[],riskPlanData:[],trialResult:{},canTrial:!0,retrialTip:!1,enumList:{},ageRange:[],collapseName:["1"],insuredRiskList:[],currentRiskList:[]});w&&(j=null==(b=_.query||{})?void 0:b.productCenterCode),vue.provide("premium",H.value),l().get("userInfo");const K=()=>{J.retrialTip=!1},W=()=>{u({agencyId:D,saleUserId:R,saleChannelId:E,tenantId:x,venderCode:J.riskBaseInfo.insurerCode,orderDataSource:1,proposalId:w,extInfo:{templateId:+(A||1),pageCode:"premiumTrial",iseeBizNo:window.iseeBiz,buttonCode:s.premiumTrial},tenantOrderHolder:{extInfo:{}},tenantOrderInsuredList:[{extInfo:{},tenantOrderProductList:[{productCode:J.riskBaseInfo.productCode||"",productName:J.riskBaseInfo.productName||"",premium:J.trialResult.premium||0,tenantOrderRiskList:J.insuredRiskList}]}]}).then((({code:e,data:t})=>{"10000"===e&&"jumpToPage"===t.pageAction.pageAction&&T.push({path:d[t.pageAction.data.nextPageCode],query:{insurerCode:J.riskBaseInfo.insurerCode,templateId:A,..._.query,productCategory:J.riskBaseInfo.productCategory,orderNo:t.pageAction.data.orderNo}})}))},Z=()=>{const e=JSON.parse(JSON.stringify(U.value[J.currentPlan])),t=Object.values(e).find((e=>1===e.riskType)),r=Object.values(e).map((e=>{const r=e;return((e,t)=>{var r,a,o,i;const n=e;if("3"===n.chargePeriod){const e=(t.chargePeriod||"").split("_");if(e[1]-=1,1===n.exemptFlag){if("to"===e[0]){let t=0;1===n.exemptType?(null==(r=q.value.personVO)?void 0:r.birthday)&&(t=parseInt(""+(+new Date-new Date(null==(a=q.value.personVO)?void 0:a.birthday))/31536e6,10)):2===n.exemptType&&(null==(o=S.value.personVO)?void 0:o.birthday)&&(t=parseInt(""+(+new Date-new Date(null==(i=S.value.personVO)?void 0:i.birthday))/31536e6,10)),e[1]=e[1]-t}e[0]="year",n.coveragePeriod=e.join("_")}n.chargePeriod=e.join("_")}})(r,t),r.liabilityVOList=(r.liabilityVOList||[]).filter((e=>1===e.optionalFlag||e.liabilityAttributeValue&&"-1"!==e.liabilityAttributeValue)).map((e=>{const t=e;return"0"===t.liabilityAttributeValue&&(t.liabilityAttributeValue=""),t})),r})),a={holder:q.value,productCode:J.riskBaseInfo.productCode,insuredVOList:[{...S.value,productPlanVOList:[{planCode:J.currentPlan||"",insurerCode:J.riskBaseInfo.insurerCode,riskVOList:r}]}]};m({...a}).then((({code:e,data:t})=>{if("10000"===e){J.retrialTip=!1,J.trialResult=t,J.canTrial=!1;const e={},r=(t=[])=>{(t||[]).forEach((t=>{var a;e[t.riskCode]=t,(null==(a=t.riskPremiumDetailVOList)?void 0:a.length)&&r(t.riskPremiumDetailVOList)}))};r(t.riskPremiumDetailVOList),((e,t)=>{J.insuredRiskList=e.map((e=>{var r,a;return{initialAmount:null==(r=t[e.riskCode])?void 0:r.amount,amountUnit:1,annuityDrawFrequency:e.annuityDrawDate,annuityDrawType:e.annuityDrawType,paymentFrequency:e.paymentFrequency,paymentPeriod:e.chargePeriod.split("_")[1],paymentPeriodType:k[e.chargePeriod.split("_")[0]],insurancePeriodType:C["to_life"===e.coveragePeriod?"to_life":e.coveragePeriod.split("_")[0]],insurancePeriodValue:Number.isNaN(+e.coveragePeriod.split("_")[1])?0:e.coveragePeriod.split("_")[1],riskCode:e.riskCode,riskType:e.riskType,riskName:e.riskName,extInfo:{riskId:e.riskId,copy:e.copy},initialPremium:null==(a=t[e.riskCode])?void 0:a.premium,liabilityDetails:e.liabilityVOList.map((e=>({liabilityCode:e.liabilityCode,liabilityName:e.liabilityName,refundMethod:e.liabilityAttributeValue}))),productId:J.riskBaseInfo.id}}))})(a.insuredVOList[0].productPlanVOList[0].riskVOList,e),Object.assign(H.value,e)}}))},G=()=>{var e,t,r,a,o;Promise.all([null==(t=null==(e=M.value)?void 0:e.validateForm)?void 0:t.call(e),null==(a=null==(r=Y.value)?void 0:r.validateForm)?void 0:a.call(r),null==(o=z.value)?void 0:o.validate()]).then((()=>{Z()}),(e=>{var t;(null==e?void 0:e.length)&&(null==(t=null==z?void 0:z.value)||t.scrollToField(e[0].name))}))},Q=()=>{p({productCode:j,source:w?2:1}).then((({code:e,data:t})=>{var r,a,o,i;"10000"===e&&(J.riskBaseInfo=t.productBasicInfoVO,(t.productRelationPlanVOList.length?t.productRelationPlanVOList:t.productRiskVoList[0].riskDetailVOList||[]).forEach(((e,t)=>{0===t&&(J.currentPlan=e.planCode||"0"),w||Object.assign(U.value,{[e.planCode||t]:{}})})),w&&(o=J.riskBaseInfo.productCategory,i=J.riskBaseInfo.insurerCode,v({productCategory:o,venderCode:i}).then((e=>{var t;"10000"===e.code&&(A=null==(t=e.data)?void 0:t.id)}))),J.riskData=(null==(r=t.productRiskVoList[0])?void 0:r.riskDetailVOList)||[],J.riskPlanData=t.productRelationPlanVOList||[],w&&(a=t.productBasicInfoVO.id,f({id:w,tenantId:x}).then((({code:e,data:t})=>{var r;if("10000"===e){const{proposalInsuredProductList:e=[],...o}=(null==(r=t.proposalInsuredList)?void 0:r[0])||{};Object.assign(q.value.personVO,t.proposalHolder);const i=e.find((e=>e.productId===a));Object.assign(S.value.personVO,o,{occupationCodeList:(null==i?void 0:i.occupationCodeList)||[]});const n={};((null==i?void 0:i.proposalProductRiskList)||[]).forEach((e=>{n[e.riskId]=e})),Object.assign(U.value,{0:n})}}))))})).finally((()=>{}))},X=e=>{J.holderFactor=e.holderFactorList,J.insuredFactor=e.insuredFactorList,J.ageRange=e.ageRange};return r([()=>U.value,()=>q.value,()=>S.value],(e=>{e&&!J.canTrial&&(J.canTrial=!0,J.retrialTip=!0)}),{deep:!0}),a((()=>{Q(),c({dictCodeList:["RISK_PAYMENT_PERIOD","RISK_INSURANCE_PERIOD"]}).then((({code:e,data:t})=>{if("10000"===e){const e={};t.forEach((t=>{e[t.dictCode]=t.dictItemList})),J.enumList=e}}))})),(e,t)=>{const r=vue.resolveComponent("ProTitle"),a=vue.resolveComponent("PersonalInfo"),o=vue.resolveComponent("RiskList"),i=vue.resolveComponent("VanForm"),n=vue.resolveComponent("ProTabButton"),l=vue.resolveComponent("VanTab"),u=vue.resolveComponent("VanTabs"),s=vue.resolveComponent("van-collapse-item"),d=vue.resolveComponent("van-collapse"),c=vue.resolveComponent("VanButton"),v=vue.resolveComponent("ProPageWrap");return vue.openBlock(),vue.createBlock(v,{class:"page-trial-wrapper"},{default:vue.withCtx((()=>{var e,v,p;return[vue.unref(J).holderFactor.length?(vue.openBlock(),vue.createElementBlock("div",g,[vue.createVNode(r,{title:"投保人"}),vue.createVNode(a,{ref_key:"holderRef",ref:M,"insured-code":null==(e=vue.unref(J).riskBaseInfo)?void 0:e.insurerCode,"form-info":vue.unref(q).personVO,"factor-list":vue.unref(J).holderFactor,"age-range":vue.unref(J).ageRange},null,8,["insured-code","form-info","factor-list","age-range"])])):vue.createCommentVNode("",!0),vue.unref(J).insuredFactor.length?(vue.openBlock(),vue.createElementBlock("div",V,[vue.createVNode(r,{title:"被保人"}),vue.createVNode(a,{ref_key:"insuredRef",ref:Y,"insured-code":null==(v=vue.unref(J).riskBaseInfo)?void 0:v.insurerCode,"form-info":vue.unref(S).personVO,"factor-list":vue.unref(J).insuredFactor,"age-range":vue.unref(J).ageRange},null,8,["insured-code","form-info","factor-list","age-range"])])):vue.createCommentVNode("",!0),vue.createElementVNode("div",y,[vue.createVNode(d,{modelValue:vue.unref(J).collapseName,"onUpdate:modelValue":t[1]||(t[1]=e=>vue.unref(J).collapseName=e)},{default:vue.withCtx((()=>[vue.createVNode(s,{name:"1"},{title:vue.withCtx((()=>[vue.createVNode(r,{title:"投保方案"})])),default:vue.withCtx((()=>[vue.unref(J).riskData.length&&vue.unref(U)[0]?(vue.openBlock(),vue.createElementBlock("div",h,[vue.createVNode(i,{ref_key:"riskFormRef",ref:z,"input-align":"right","error-message-align":"right"},{default:vue.withCtx((()=>[vue.createVNode(o,{"risk-info":vue.unref(U)[0],enums:vue.unref(J).enumList,"origin-data":vue.unref(J).riskData,"pick-factor":X},null,8,["risk-info","enums","origin-data"])])),_:1},512)])):vue.createCommentVNode("",!0),vue.unref(J).riskPlanData.length?(vue.openBlock(),vue.createElementBlock("div",I,[vue.createVNode(i,{ref_key:"riskFormRef",ref:z,"input-align":"right","error-message-align":"right"},{default:vue.withCtx((()=>[vue.createVNode(u,{active:vue.unref(J).currentPlan,"onUpdate:active":t[0]||(t[0]=e=>vue.unref(J).currentPlan=e)},{default:vue.withCtx((()=>[(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,null,vue.renderList(vue.unref(J).riskPlanData,(e=>(vue.openBlock(),vue.createBlock(l,{key:e.planCode,name:e.planCode,title:e.planName},{title:vue.withCtx((()=>[vue.createVNode(n,{title:e.planName,active:vue.unref(J).currentPlan===e.planCode},null,8,["title","active"])])),default:vue.withCtx((()=>{var t;return[e.planCode===vue.unref(J).currentPlan?(vue.openBlock(),vue.createBlock(o,{key:0,"risk-info":vue.unref(U)[e.planCode],enums:vue.unref(J).enumList,"origin-data":null==(t=e.productRiskVoList)?void 0:t[0].riskDetailVOList,"pick-factor":X},null,8,["risk-info","enums","origin-data"])):vue.createCommentVNode("",!0)]})),_:2},1032,["name","title"])))),128))])),_:1},8,["active"])])),_:1},512)])):vue.createCommentVNode("",!0)])),_:1})])),_:1},8,["modelValue"])]),vue.createElementVNode("div",N,[vue.createElementVNode("span",P,[vue.createTextVNode("总保费"),vue.createElementVNode("span",L,vue.toDisplayString((vue.unref(J).retrialTip?0:(null==(p=vue.unref(J).trialResult)?void 0:p.premium)||0).toLocaleString("hanidec",{style:"currency",currency:"CNY"})),1)]),vue.createElementVNode("div",O,[vue.unref(J).retrialTip?(vue.openBlock(),vue.createElementBlock("div",B,[vue.createTextVNode(" 条件更改后，需要重新试算 "),vue.createElementVNode("span",{class:"close-icon",onClick:K})])):vue.createCommentVNode("",!0),vue.unref(J).canTrial?(vue.openBlock(),vue.createBlock(c,{key:1,type:"primary",onClick:G},{default:vue.withCtx((()=>[vue.createTextVNode("去试算")])),_:1})):(vue.openBlock(),vue.createBlock(c,{key:2,type:"primary",onClick:W},{default:vue.withCtx((()=>[vue.createTextVNode("立即投保")])),_:1}))])])]})),_:1})}}}),[["__scopeId","data-v-1acad142"]]);export{b as default};
