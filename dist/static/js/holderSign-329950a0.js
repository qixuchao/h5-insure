import{d as e,h as a,g as i,bH as s,cj as t,i as r,z as n,av as o,af as l,o as d,c as u,b as c,a as f,u as v,l as p,q as g,a0 as h,w as m,a8 as y,aC as b,T as S,ck as I,bk as j,aa as N,c8 as O,cl as x,an as L,cm as T}from"./index-f532db20.js";import{c as D}from"./product-779e0114.js";import{g as k,m as E}from"./trial-90f2cd38.js";import{_ as C}from"./SignPart-cdec1851.js";import{u as q}from"./useOrder-b0c04caa.js";import{M as w}from"./product-585b0e6f.js";import{N as V}from"./notice-33e6eedd.js";import{f as R,s as A,b as U}from"./verify-bb927323.js";import"./PolicyInfo-b798c202.js";import{P as H,a as P}from"./constants-f30769e1.js";import{c as _}from"./scribing-72085487.js";import{a as G}from"./utils-0af605ab.js";import"./useAttachment-b4b1b247.js";import"./utils-9100ff3d.js";import"./infoCollection-07eb5a4d.js";import"./trial-c35f920c.js";import"./index-f2f98a6b.js";const M={class:"long-verify"},B={class:"header"},F={class:"verify-content"},$={class:"footer-button"},z=e({__name:"holderSign",setup(e){const z=a(),J=i(),{productCode:K="",tenantId:Q,agentCode:W="",agencyCode:X,saleChannelId:Y,saleUserId:Z,orderNo:ee,orderCode:ae,extraInfo:ie,isShare:se,insurerCode:te,preview:re}=z.query;let ne={};try{ne=JSON.parse(decodeURIComponent(ie))}catch(ye){}const oe=q(),le=`${window.origin}/baseInsurance/long/phoneVerify?${s.stringify({...z.query,orderNo:ae||ee})}`,de=new t({source:"localStorage"}),ue=r(),ce=r({holder:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""},insured:{fileList:[],personalInfo:[],isSign:!1,isVerify:!1,isShareSign:!1,signData:{}},agent:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""}}),fe=r({}),ve=r({}),pe=r({sign:[],verify:[],scribing:""}),ge=()=>{if(re)return void b(H.SIGN,z.query);const e=[];ue.value&&((se?pe.value.sign.includes("4"):pe.value.sign.includes("2"))&&e.push(ue.value.validateSign()),pe.value.verify.includes("1")&&e.push(ue.value.validateVerify())),Promise.all(e).then((e=>{!pe.value.scribing||fe.value.status?U(oe.value).then((({code:e,data:a})=>{"10000"===e&&J.push({path:P.payAuth,query:z.query})})):S("请先完成风险抄录")})).catch((e=>{S(e.message)}))},he=()=>{ee&&k({orderNo:ae||ee,tenantId:Q}).then((({code:e,data:a})=>{var i,s,t,r;"10000"===e&&(Object.assign(oe.value,a),ce.value.holder.personalInfo=a.holder,Object.assign(ve.value,{type:I[a.extInfo.transcriptionType],signInfo:null==(s=null==(i=a.riskTranscriptionList)?void 0:i[0])?void 0:s.uri,text:null==(r=null==(t=a.riskTranscriptionList)?void 0:t[0])?void 0:r.content,status:!!a.extInfo.transcriptionStatus}))}))};r({imgUrl:"",desc:"",title:"",link:le});const me=e=>{const{type:a,text:i}=fe.value,s={...z.query,orderNo:ae||ee,text:i,orderId:oe.value.id};"handle"===a?J.push({path:"scribing",query:s}):_({content:i,image:e,orderNo:ae||ee,tenantId:Q,transcriptionType:T.AUTO}).then((({code:e})=>{"10000"===e&&he()}))};return n([()=>ve.value,()=>fe.value],(()=>{Object.assign(fe.value,{type:ve.value.type||fe.value.type,text:ve.value.text||fe.value.text,status:ve.value.status||fe.value.status,signInfo:ve.value.signInfo||fe.value.signInfo})}),{deep:!0,immediate:!0}),o((()=>{(async()=>{var e,a,i,s;let t={};const{code:r,data:n}=await k({orderNo:ae||ee,tenantId:Q});"10000"===r&&(Object.assign(oe.value,n),ce.value.holder.personalInfo={...n.holder,isCert:1},t=G(n.insuredList[0].productList),Object.assign(ve.value,{type:I[n.extInfo.transcriptionType],signInfo:null==(a=null==(e=n.riskTranscriptionList)?void 0:e[0])?void 0:a.uri,text:null==(s=null==(i=n.riskTranscriptionList)?void 0:i[0])?void 0:s.content,status:!!n.extInfo.transcriptionStatus}),n.tenantOrderAttachmentList.forEach((e=>{e.objectType===V.HOlDER?ce.value.holder.signData=e.fileBase64:e.objectType===V.AGENT?ce.value.agent.signData=e.fileBase64:e.objectType===V.INSURED&&(ce.value.insured.signData[e.objectId]=e.fileBase64)}))),D(t).then((({code:e,data:a})=>{var i;if("10000"===e){const{productMaterialMap:e}=(null==(i=a.productMaterialPlanVOList)?void 0:i[0])||{};(Object.values(e||{})||[]).flat().filter((e=>e.materialType===w.SIGN)).forEach((e=>{e.noticeObject===V.AGENT?ce.value.agent.fileList.push(e):e.noticeObject===V.HOlDER?ce.value.holder.fileList.push(e):e.noticeObject===V.INSURED&&ce.value.insured.fileList.push(e)}))}})),E(t).then((({data:e,code:a})=>{if("10000"===a){const{signInfo:a}=j(e.productFactor);a.schema.forEach((e=>{"eleSign"===e.name&&e.columns.forEach((a=>{e.required&&pe.value.sign.push(a.code),"1"===a.code?ce.value.agent.isSign=!0:"2"===a.code?ce.value.holder.isSign=!0:"3"===a.code?ce.value.insured.isSign=!0:"4"===a.code?ce.value.holder.isShareSign=!0:"5"===a.code&&(ce.value.insured.isShareSign=!0)})),"riskNotificationCopy"===e.name&&(fe.value.text=e.remark,pe.value.scribing=e.required,e.columns.forEach((e=>{"1"===e.code?fe.value.type="handle":fe.value.type="auto"}))),"customerFace"===e.name&&e.columns.forEach((a=>{e.required&&pe.value.verify.push(a.code),"1"===a.code?ce.value.holder.isVerify=!0:"2"===a.code&&(ce.value.insured.isVerify=!0)}))}))}}))})();const e=l.get("verifyData");if(e){const{serialNo:a,certNo:i,name:s}=e;R({certiNo:i,orderNo:ae||ee,serialNo:a,tenantId:Q,userName:s}).then((e=>{const{code:a,data:i}=e;"10000"===a&&(de.remove("verifyData"),he())}))}})),(e,a)=>{const i=N,s=O,t=x,r=L;return d(),u("div",M,[c(i),f("div",B,[c(s,{type:"warning",title:"尊敬的客户，本次投保需要进行身份认证",content:"本产品投保需要对投保人、被保人进行实名认证，您购买本产品的累计总保费已超过20万，按监管要求，需要提供投保人、被保人、指定受益人证件影像，本产品非本人投保且带身故责任、需对投保人、被保人（成人）的投保意愿进行签字确认。"})]),f("div",F,[!v(se)||v(ce).holder.isShareSign?(d(),p(C,{key:0,ref_key:"holderSignRef",ref:ue,"order-detail":v(oe),"sign-string":v(ce).holder.signData,"show-sign":v(se)?v(ce).holder.isShareSign:v(ce).holder.isSign,"show-verify":v(ce).holder.isVerify,"file-list":v(ce).holder.fileList,"personal-info":v(ce).holder.personalInfo,title:"投保人",onHandleSign:a[0]||(a[0]=e=>((e,a,i)=>{var s;A(e,a,null==(s=oe.value)?void 0:s.id,Q,i)})("HOLDER",e,v(ce).holder.personalInfo.id))},null,8,["order-detail","sign-string","show-sign","show-verify","file-list","personal-info"])):g("",!0)]),v(pe).scribing?(d(),p(t,h({key:0},v(fe),{title:"为了保障您的权益请抄录以下声明内容",onOnSubmit:me}),null,16)):g("",!0),f("div",$,[c(r,{type:"primary",onClick:ge},{default:m((()=>[y("确定")])),_:1})])])}}});export{z as default};
