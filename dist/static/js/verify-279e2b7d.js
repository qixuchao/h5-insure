import{ref as e,computed as n,watch as t,onBeforeMount as i}from"vue";import{h as r,Y as o,C as a,u as s,o as l,E as u,l as d,H as c,I as f,j as V,D as v,b as m,T as g,a0 as p,J as h,v as y}from"./index-deb4ddfb.js";/* empty css              */import{a as S,q as N}from"./product-c166a0f6.js";import{n as C}from"./nextStep-0d38f4c6.js";import{g as k,i as w}from"./trial-90e504aa.js";import{u as I}from"./useAttachment-3dae9e30.js";import{_ as E,f as b,a as B,s as j}from"./verify-3179c315.js";import{u as L}from"./useOrder-d6d1fc9b.js";import{t as x}from"./PayInfo-e8550347.js";import{P as D,B as O}from"./constants-7afb7c3d.js";import"./pdfh5-e588f83d.js";import"./core-5f3b09dd.js";import"./constant-8927d485.js";import"./utils-f063477c.js";import"./infoCollection-f930e52f.js";import"./trial-a75330fd.js";import"./merge-e7788e50.js";import"./keysIn-131bbce9.js";import"./isObjectLike-a9798079.js";import"./_getTag-d5b47d26.js";import"./debounce-6981b306.js";import"./phoneVerify-8d7afc24.js";import"./useDicData-48f91541.js";import"./bankCard-1cedc592.js";const T={class:"com-sign-part"},_={class:"people"},P={class:"name"},R={key:0,class:"verify-item"},U=Vue.createElementVNode("div",{class:"label"},"证件号码",-1),A={class:"no"},M={class:"sign-status"},F={class:"status"},H=["src"],Y={key:1,class:"sign-desc"},q={class:"sign-body"},G={class:"date"},$={class:"file"},J=Vue.defineComponent({name:"signPart"}),z=Vue.defineComponent({...J,props:{signString:{default:""},personalInfo:{default:()=>({})},fileList:{},title:{default:""},showSign:{type:Boolean,default:!1},showVerify:{type:Boolean,default:!1},showShareSign:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1}},emits:["handleVerify","handleSign"],setup(i,{expose:s,emit:l}){const u=i,d=e({}),c=e(""),f=e([]),V=e({});e(!0);const v=e(!1),m=e(0),{fileList:g}=I(V,f),p=e=>`${e}`===a.CERT,h=n((()=>r().format("YYYY-MM-DD"))),y=()=>{var e,n;l("handleVerify",null==(e=d.value)?void 0:e.name,null==(n=d.value)?void 0:n.certNo)},S=()=>{v.value=!1},N=e(),C=()=>{N.value&&N.value.rewrite()},k=()=>{u.disabled||N.value&&N.value.openSign()},w=e=>{l("handleSign",e)};return s({validateSign:()=>new Promise(((e,n)=>{c.value?e(!0):n(new Error(`请${u.title}完成签名后，去支付`))})),validateVerify:()=>new Promise(((e,n)=>{var t;(null==(t=u.personalInfo)?void 0:t.isCert)!==o.YES?n(new Error(`请${u.title}完成认证后，去支付`)):e(!0)}))}),t((()=>u.signString),(()=>{c.value=u.signString}),{immediate:!0}),t((()=>u.personalInfo),(()=>{d.value=u.personalInfo}),{deep:!0,immediate:!0}),(e,n)=>{const t=Vue.resolveComponent("ProSvg"),i=Vue.resolveComponent("ProCard"),r=Vue.resolveComponent("AttachmentList"),a=Vue.resolveComponent("FilePreview");return Vue.openBlock(),Vue.createElementBlock("div",T,[Vue.createVNode(i,{title:e.title,class:"card"},{extra:Vue.withCtx((()=>{var n,t,i,r;return[Vue.createElementVNode("div",_,[Vue.createElementVNode("div",P,Vue.toDisplayString(null==(n=Vue.unref(d))?void 0:n.name),1),e.showVerify&&p(null==(t=Vue.unref(d))?void 0:t.certType)?(Vue.openBlock(),Vue.createElementBlock("div",{key:0,class:Vue.normalizeClass(["status",{verified:(null==(i=Vue.unref(d))?void 0:i.isCert)===Vue.unref(o).YES}])},Vue.toDisplayString((null==(r=Vue.unref(d))?void 0:r.isCert)===Vue.unref(o).YES?"已认证":"待认证"),3)):Vue.createCommentVNode("",!0)])]})),default:Vue.withCtx((()=>{var n,i,r,a;return[e.showVerify&&(null==(n=Vue.unref(d))?void 0:n.certNo)?(Vue.openBlock(),Vue.createElementBlock("div",R,[U,Vue.createElementVNode("div",A,Vue.toDisplayString(null==(i=Vue.unref(d))?void 0:i.certNo),1),(null==(r=Vue.unref(d))?void 0:r.isCert)!==Vue.unref(o).YES&&p(null==(a=Vue.unref(d))?void 0:a.certType)?(Vue.openBlock(),Vue.createElementBlock("div",{key:0,class:"action",onClick:y},[Vue.createTextVNode(" 去认证 "),Vue.createVNode(t,{name:"right_arrow",class:"icon"})])):Vue.createCommentVNode("",!0)])):Vue.createCommentVNode("",!0)]})),_:1},8,["title"]),e.showSign?(Vue.openBlock(),Vue.createBlock(i,{key:0,title:`${e.title}签名`,"show-icon":!1,class:"sign-card","show-line":!1},{extra:Vue.withCtx((()=>[Vue.createElementVNode("div",M,[Vue.createElementVNode("div",F,Vue.toDisplayString(Vue.unref(c)?"已签名":"未签名"),1),e.disabled?Vue.createCommentVNode("",!0):(Vue.openBlock(),Vue.createElementBlock("div",{key:0,class:"resign",onClick:C},"重签"))])])),default:Vue.withCtx((()=>{var e;return[Vue.createVNode(E,{ref_key:"signRef",ref:N,modelValue:Vue.unref(c),"onUpdate:modelValue":n[0]||(n[0]=e=>Vue.isRef(c)?c.value=e:null),class:"sign",onSubmitSign:w},{signImg:Vue.withCtx((({data:e})=>[Vue.createElementVNode("div",{class:"sign-board",onClick:k},[e?(Vue.openBlock(),Vue.createElementBlock("img",{key:0,src:e,class:"sign-img",alt:""},null,8,H)):(Vue.openBlock(),Vue.createElementBlock("span",Y,"请签名"))])])),_:1},8,["modelValue"]),Vue.createElementVNode("div",q,[Vue.createElementVNode("div",G,"签名日期： "+Vue.toDisplayString(Vue.unref(h)),1),Vue.createElementVNode("div",$,[(null==(e=Vue.unref(g))?void 0:e.length)?(Vue.openBlock(),Vue.createBlock(r,{key:0,"attachment-list":Vue.unref(g),"pre-text":"签名将被用于以下文件：",onPreviewFile:n[1]||(n[1]=e=>(e=>{m.value=e,v.value=!0})(e))},null,8,["attachment-list"])):Vue.createCommentVNode("",!0)])])]})),_:1},8,["title"])):Vue.createCommentVNode("",!0),Vue.unref(v)?(Vue.openBlock(),Vue.createBlock(a,{key:1,show:Vue.unref(v),"onUpdate:show":n[2]||(n[2]=e=>Vue.isRef(v)?v.value=e:null),"content-list":Vue.unref(g),"is-only-view":"","active-index":Vue.unref(m),text:"关闭",onOnCloseFilePreviewByMask:S},null,8,["show","content-list","active-index"])):Vue.createCommentVNode("",!0)])}}}),W=2,X=1,K=2,Q=3;const Z={class:"long-verify"},ee={class:"header"},ne={class:"verify-content"},te={class:"footer-button footer-bar"},ie=Vue.createElementVNode("div",{class:"text"},"刷新",-1),re=Vue.defineComponent({__name:"verify",setup(n){const t=s(),{productCode:r="",tenantId:a,agentCode:I="",agencyCode:E,saleChannelId:T,saleUserId:_,orderNo:P,orderCode:R,extraInfo:U,isShare:A,insurerCode:M,preview:F}=t.query;let H={};try{H=JSON.parse(decodeURIComponent(U))}catch(ge){}const Y=L(),q=`${window.origin}/baseInsurance/long/phoneVerify?${l.stringify({...t.query,orderNo:R||P})}`;console.log("shareLink",q);const G=new u({source:"localStorage"});e({});const $=e({}),J=e(),re=e(),oe=e(),ae=e({holder:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""},insured:{fileList:[],personalInfo:[],isSign:!1,isVerify:!1,isShareSign:!1,signData:{}},agent:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""}}),se=(e,n)=>{let t=window.location.href;t=t.includes("orderCode")?t:t.replace("orderNo","orderCode"),B({callbackUrl:t,certiNo:n,faceAuthMode:"TENCENT",userName:e,tenantId:a}).then((({code:t,data:i})=>{if("10000"===t){const{originalUrl:t,serialNo:r}=i;window.location.href=t,d.set("verifyData",{serialNo:r,certNo:n,name:e})}}))},le=(e,n,t)=>{var i;j(e,n,null==(i=Y.value)?void 0:i.id,a,t)},ue=e({sign:[],verify:[]}),de=()=>{if(F)return void V(D.SIGN,t.query);const e=[];J.value&&ue.value.sign.includes("1")&&e.push(J.value.validateSign()),re.value&&((A?ue.value.sign.includes("4"):ue.value.sign.includes("2"))&&e.push(re.value.validateSign()),ue.value.verify.includes("1")&&e.push(re.value.validateVerify())),oe.value&&((A?ue.value.sign.includes("5"):ue.value.sign.includes("3"))&&e.push(...(oe.value||[]).map((e=>e.validateSign()))),ue.value.verify.includes("2")&&e.push(...(oe.value||[]).map((e=>e.validateVerify())))),Promise.all(e).then((e=>{P&&k({orderNo:R||P,saleUserId:_,tenantId:a}).then((({code:e,data:n})=>{"10000"===e&&v.confirm({title:"提示",message:"请确认信息填写无误后，再进行支付"}).then((()=>{Object.assign(Y.value,{extInfo:{...Y.value.extInfo,buttonCode:O.SIGN,pageCode:D.SIGN}}),C(Y.value,((e,n)=>{n===m.JUMP_URL&&(window.location.href=e.paymentUrl)}))}))}))})).catch((e=>{g(e.message)}))},ce=e(),fe=()=>{J.value.validateSign().then((()=>{ce.value&&ce.value.handleShare()})).catch((()=>{g("请完成代理人签字后进行分享")}))},Ve=(e=!1)=>{P&&k({orderNo:R||P,tenantId:a}).then((({code:n,data:t})=>{var i;"10000"===n&&(e&&((null==(i=null==t?void 0:t.holder)?void 0:i.isCert)===o.NO||(null==t?void 0:t.insuredList.some((e=>e.isCert===o.NO)))?g("用户未完身份认证及签字"):(null==t?void 0:t.tenantOrderAttachmentList.find((e=>e.category===p.ELECTRIC_SIGN&&e.objectType===h.HOLDER)))&&(null==t?void 0:t.tenantOrderAttachmentList.find((e=>e.category===p.ELECTRIC_SIGN&&e.objectType===h.INSURED)))||g("用户未完身份认证及签字")),Object.assign(Y.value,t),ae.value.holder.personalInfo=t.holder,ae.value.insured.personalInfo=t.insuredList,t.tenantOrderAttachmentList.forEach((e=>{e.objectType===X?ae.value.holder.signData=e.fileBase64:e.objectType===Q?ae.value.agent.signData=e.fileBase64:e.objectType===K&&(ae.value.insured.signData[e.objectId]=e.fileBase64)})))}))},ve=()=>{Ve(!0)},me=e({imgUrl:"",desc:"",title:"",link:q});return i((()=>{S({productCode:r,tenantId:a}).then((({data:e,code:n})=>{if("10000"===n){const{wxShareConfig:n,showWXShare:t,title:i,desc:r,image:o}=(null==e?void 0:e.PRODUCT_LIST)||{};t?Object.assign(me.value,{...n,imgUrl:n.image,isShare:t}):Object.assign(me.value,{title:i,desc:r,imgUrl:o,isShare:t}),e.BASIC_INFO&&e.BASIC_INFO.themeType&&y(e.BASIC_INFO.themeType)}})),N({productCode:r}).then((({code:e,data:n})=>{var t;if("10000"===e){const{productMaterialMap:e}=(null==(t=n.productInsureMaterialVOList)?void 0:t[0])||{};(Object.values(e||{})||[]).flat().filter((e=>e.materialType===W)).forEach((e=>{e.noticeObject===Q?ae.value.agent.fileList.push(e):e.noticeObject===X?ae.value.holder.fileList.push(e):e.noticeObject===K&&ae.value.insured.fileList.push(e)}))}})),w({productCode:r,isTenant:!F}).then((({data:e,code:n})=>{var t;if("10000"===n){$.value=e;const{productFactor:n}=(null==(t=e.productPlanInsureVOList)?void 0:t[0])||{},{signInfo:i}=x(n);i.schema.forEach((e=>{"eleSign"===e.name&&e.columns.forEach((n=>{e.required&&ue.value.sign.push(n.code),"1"===n.code?ae.value.agent.isSign=!0:"2"===n.code?ae.value.holder.isSign=!0:"3"===n.code?ae.value.insured.isSign=!0:"4"===n.code?ae.value.holder.isShareSign=!0:"5"===n.code&&(ae.value.insured.isShareSign=!0)})),"customerFace"===e.name&&e.columns.forEach((n=>{e.required&&ue.value.verify.push(n.code),"1"===n.code?ae.value.holder.isVerify=!0:"2"===n.code&&(ae.value.insured.isVerify=!0)}))}))}})),Ve();const e=d.get("verifyData");if(e){const{serialNo:n,certNo:t,name:i}=e;b({certiNo:t,orderNo:R||P,serialNo:n,tenantId:a,userName:i}).then((e=>{const{code:n,data:t}=e;"10000"===n&&(G.remove("verifyData"),Ve())}))}})),(e,n)=>{const t=Vue.resolveComponent("ProNavigator"),i=Vue.resolveComponent("ProMessage"),r=Vue.resolveComponent("ProSvg"),o=Vue.resolveComponent("van-button");return Vue.openBlock(),Vue.createElementBlock("div",Z,[Vue.createVNode(t),Vue.createElementVNode("div",ee,[Vue.createVNode(i,{type:"warning",title:"尊敬的客户，本次投保需要进行身份认证",content:"本产品投保需要对投保人、被保人进行实名认证，您购买本产品的累计总保费已超过20万，按监管要求，需要提供投保人、被保人、指定受益人证件影像，本产品非本人投保且带身故责任、需对投保人、被保人（成人）的投保意愿进行签字确认。"})]),Vue.createElementVNode("div",ne,[Vue.createVNode(z,{ref_key:"agentSignRef",ref:J,"order-detail":Vue.unref(Y),"sign-string":Vue.unref(ae).agent.signData,"show-sign":Vue.unref(ae).agent.isSign,"show-verify":Vue.unref(ae).agent.isVerify,"file-list":Vue.unref(ae).agent.fileList,"personal-info":Vue.unref(ae).agent.personalInfo,disabled:!!Vue.unref(A),title:"代理人",onHandleSign:n[0]||(n[0]=e=>le("AGENT",e))},null,8,["order-detail","sign-string","show-sign","show-verify","file-list","personal-info","disabled"]),!Vue.unref(A)||Vue.unref(ae).holder.isShareSign?(Vue.openBlock(),Vue.createBlock(z,{key:0,ref_key:"holderSignRef",ref:re,"order-detail":Vue.unref(Y),"sign-string":Vue.unref(ae).holder.signData,"show-sign":Vue.unref(A)?Vue.unref(ae).holder.isShareSign:Vue.unref(ae).holder.isSign,"show-verify":Vue.unref(ae).holder.isVerify,"file-list":Vue.unref(ae).holder.fileList,"personal-info":Vue.unref(ae).holder.personalInfo,title:"投保人",onHandleSign:n[1]||(n[1]=e=>le("HOLDER",e,Vue.unref(ae).holder.personalInfo.id)),onHandleVerify:se},null,8,["order-detail","sign-string","show-sign","show-verify","file-list","personal-info"])):Vue.createCommentVNode("",!0),!Vue.unref(A)||Vue.unref(ae).insured.isShareSign?(Vue.openBlock(!0),Vue.createElementBlock(Vue.Fragment,{key:1},Vue.renderList(Vue.unref(ae).insured.personalInfo||[],(e=>(Vue.openBlock(),Vue.createBlock(z,{key:e.id,ref_for:!0,ref_key:"insuredSignRef",ref:oe,"data-source":[],"order-detail":Vue.unref(Y),"sign-string":Vue.unref(ae).insured.signData[e.id],"show-sign":Vue.unref(A)?Vue.unref(ae).insured.isShareSign:Vue.unref(ae).insured.isSign,"show-verify":Vue.unref(ae).insured.isVerify,"file-list":Vue.unref(ae).insured.fileList,"personal-info":e||{},title:"被保人",onHandleSign:n=>le("INSURED",n,e.id),onHandleVerify:se},null,8,["order-detail","sign-string","show-sign","show-verify","file-list","personal-info","onHandleSign"])))),128)):Vue.createCommentVNode("",!0)]),Vue.createElementVNode("div",te,[Vue.createElementVNode("div",{class:"refresh-btn",onClick:ve},[Vue.createElementVNode("div",null,[Vue.createVNode(r,{name:"refresh"})]),ie]),!Vue.unref(A)&&Vue.unref(c)()?(Vue.openBlock(),Vue.createBlock(f,Vue.mergeProps({key:0,ref_key:"shareRef",ref:ce},Vue.unref(me),{onClick:Vue.withModifiers(fe,["stop"])}),{default:Vue.withCtx((()=>[Vue.createVNode(o,{plain:"",type:"primary",class:"share-btn"},{default:Vue.withCtx((()=>[Vue.createTextVNode("分享")])),_:1})])),_:1},16,["onClick"])):Vue.createCommentVNode("",!0),Vue.createVNode(o,{type:"primary",class:"submit-btn",onClick:de},{default:Vue.withCtx((()=>[Vue.createTextVNode("确认支付")])),_:1})])])}}});export{re as default};
