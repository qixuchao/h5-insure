import{d as e,i as a,h as i,c5 as t,cV as s,j as n,k as r,ah as o,E as l,bc as d,b4 as u,cW as c,l as v,o as f,c as p,b as h,a as g,u as m,p as y,f as b,a8 as I,w as S,v as j,bj as O,bb as N,T as L,cX as E,aX as w,y as x,cN as D,cO as T,cY as C,cP as k,bO as q,a_ as R,cQ as V,cZ as P,b3 as H,c_ as _}from"./index-f0eeebf3.js";import{b as z}from"./product-cdee3bc1.js";import{g as U,m as $}from"./trial-1b895186.js";import{_ as A}from"./SignPart-9dbd2b13.js";import{u as B}from"./useOrder-d7f47ae5.js";import{N as M}from"./notice-e6bf3253.js";import"./PolicyInfo-3ba190b9.js";import{c as F}from"./scribing-dc6a0890.js";import{p as X}from"./utils-34fdd675.js";import{g as Y}from"./utils-ac733c3b.js";import"./index-f6735a41.js";import"./cloneDeep-325f4dfb.js";import"./utils-48889deb.js";import"./createProposal-7e896f2e.js";import"./trial-22c49f2c.js";import"./infoCollection-f557585c.js";const G={class:"long-verify"},J={class:"header"},Q={class:"verify-content"},W={class:"footer-button"},Z=e({__name:"holderSign",setup(e){const Z=a(),K=i(),{productCode:ee="",tenantId:ae,agentCode:ie="",agencyCode:te,saleChannelId:se,saleUserId:ne,orderNo:re,orderCode:oe,extraInfo:le,isShare:de,insurerCode:ue,preview:ce}=Z.query;let ve={};try{ve=JSON.parse(decodeURIComponent(le))}catch(Ee){}const fe=B(),pe=`${window.origin}/baseInsurance/long/phoneVerify?${t.stringify({...Z.query,orderNo:oe||re})}`,he=new s({source:"localStorage"}),ge=n(),me=n({holder:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:[]},insured:{fileList:[],personalInfo:[],isSign:!1,isVerify:!1,isShareSign:!1,signData:{}},agent:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""}}),ye=n({}),be=n({}),Ie=n({sign:[],verify:[],scribing:""}),Se=r((()=>{var e,a;const{age:i,relationToHolder:t,id:s}=(null==(a=null==(e=me.value.insured)?void 0:e.personalInfo)?void 0:a[0])||{};return`${t}`===o.CERT||i<18})),je=()=>{if(ce)return void O(N.SIGN,Z.query);const e=[];ge.value&&((de?Ie.value.sign.includes("4"):Ie.value.sign.includes("2"))&&e.push(ge.value.validateSign()),Ie.value.verify.includes("1")&&e.push(ge.value.validateVerify())),Promise.all(e).then((e=>{!Ie.value.scribing||ye.value.status?E(fe.value).then((({code:e,data:a})=>{"10000"===e&&(a.authStatus===`${w.YES}`?K.push({path:x.payAuth,query:Z.query}):Promise.all([D({bizObjectId:[fe.value.holder.id],bizObjectType:T.HOLDER,orderId:fe.value.id,tenantId:ae}),Se.value&&D({bizObjectId:[fe.value.insuredList[0].id],bizObjectType:T.INSURED,orderId:fe.value.id,tenantId:ae})]).then((e=>{if("10000"===e[0].code){if(de)return void L("已完成");K.push({path:x.sign,query:Z.query})}})))})):L("请先完成风险抄录")})).catch((e=>{L(e.message)}))},Oe=()=>{re&&U({orderNo:oe||re,tenantId:ae}).then((({code:e,data:a})=>{var i,t,s,n;if("10000"===e){const e=[];a.tenantOrderAttachmentList.forEach((a=>{a.objectType===M.HOlDER&&30===a.category&&e.push(a.fileBase64)})),me.value.holder.signData=e,Object.assign(be.value,{type:C[a.extInfo.transcriptionType],signInfo:null==(t=null==(i=a.riskTranscriptionList)?void 0:i[0])?void 0:t.uri,text:null==(n=null==(s=a.riskTranscriptionList)?void 0:s[0])?void 0:n.content,status:!!a.extInfo.transcriptionStatus})}}))};n({imgUrl:"",desc:"",title:"",link:pe});const Ne=e=>{const{type:a,text:i}=ye.value,t={...Z.query,orderNo:oe||re,text:i,orderId:fe.value.id};"handle"===a?K.push({path:"scribing",query:t}):F({content:i,image:e,orderNo:oe||re,tenantId:ae,transcriptionType:_.AUTO}).then((({code:e})=>{"10000"===e&&Oe()}))};l([()=>be.value,()=>ye.value],(()=>{Object.assign(ye.value,{type:be.value.type||ye.value.type,text:be.value.text||ye.value.text,status:be.value.status||ye.value.status,signInfo:be.value.signInfo||ye.value.signInfo})}),{deep:!0,immediate:!0}),d((()=>{(async()=>{var e,a,i,t;let s={};const{code:n,data:r}=await U({orderNo:oe||re,tenantId:ae});"10000"===n&&(Object.assign(fe.value,r),me.value.holder.personalInfo={...r.holder,isCert:1},me.value.insured.personalInfo=r.insuredList.map((e=>(e.isCert=1,e))),s=X(r.insuredList[0].productList),Object.assign(be.value,{type:C[r.extInfo.transcriptionType],signInfo:null==(a=null==(e=r.riskTranscriptionList)?void 0:e[0])?void 0:a.uri,text:null==(t=null==(i=r.riskTranscriptionList)?void 0:i[0])?void 0:t.content,status:!!r.extInfo.transcriptionStatus}),fe.value.tenantOrderAttachmentList.forEach((e=>{e.objectType===M.HOlDER&&30===e.category&&me.value.holder.signData.push(e.fileBase64)}))),z(s).then((({code:e,data:a})=>{var i;if("10000"===e){const{signMaterialMap:e}=(null==(i=a.productMaterialPlanVOList)?void 0:i[1])||{};(Object.values(e||{}).flat()||[]).forEach((e=>{e.noticeObject===M.HOlDER&&me.value.holder.fileList.push({attachmentName:e.materialName,attachmentList:[{...e,materialSource:Y(`${null==e?void 0:e.materialSource}`,null==e?void 0:e.materialContent)}]})}))}})),$(s).then((({data:e,code:a})=>{if("10000"===a){const{signInfo:a}=q(e.productFactor);a.schema.forEach((e=>{"eleSign"===e.name&&e.columns.forEach((a=>{e.required&&Ie.value.sign.push(a.code),"1"===a.code?me.value.agent.isSign=!0:"2"===a.code?me.value.holder.isSign=!0:"3"===a.code?me.value.insured.isSign=!0:"4"===a.code?me.value.holder.isShareSign=!0:"5"===a.code&&(me.value.insured.isShareSign=!0)})),"riskNotificationCopy"===e.name&&(ye.value.text=e.remark,Ie.value.scribing=e.required,e.columns.forEach((e=>{"1"===e.code?ye.value.type="handle":ye.value.type="auto"}))),"customerFace"===e.name&&e.columns.forEach((a=>{e.required&&Ie.value.verify.push(a.code),"1"===a.code?me.value.holder.isVerify=!0:"2"===a.code&&(me.value.insured.isVerify=!0)}))}))}}))})();const e=u.get("verifyData");if(e){const{serialNo:a,certNo:i,name:t}=e;c({certiNo:i,orderNo:oe||re,serialNo:a,tenantId:ae,userName:t}).then((e=>{const{code:a,data:i}=e;"10000"===a&&(he.remove("verifyData"),Oe())}))}}));const Le=n();return v((()=>{setTimeout((async()=>{Le.value=window.getIseeBiz&&await window.getIseeBiz()}),1500)})),(e,a)=>{const i=R,t=V,s=P,n=H;return f(),p("div",G,[h(i),g("div",J,[h(t,{type:"warning",title:"尊敬的客户，本次投保需要进行身份认证",content:"本产品投保需要对投保人、被保险人进行实名认证，您购买本产品的累计总保费已超过20万，按监管要求，需要提供投保人、被保险人、指定受益人证件影像，本产品非本人投保且带身故责任、需对投保人、被保险人（成人）的投保意愿进行签名确认。"})]),g("div",Q,[!m(de)||m(me).holder.isShareSign?(f(),y(A,{key:0,ref_key:"holderSignRef",ref:ge,"order-detail":m(fe),"sign-string":m(me).holder.signData,"show-sign":m(de)?m(me).holder.isShareSign:m(me).holder.isSign,"show-verify":m(me).holder.isVerify,"file-list":m(me).holder.fileList,"personal-info":m(me).holder.personalInfo,title:"投保人",onHandleSign:a[0]||(a[0]=e=>((e,a,i)=>{var t,s,n,r;const o=[k(e,a,null==(t=fe.value)?void 0:t.id,ae,i)],{id:l}=(null==(n=null==(s=me.value.insured)?void 0:s.personalInfo)?void 0:n[0])||{};Se.value&&o.push(k("INSURED",a,null==(r=fe.value)?void 0:r.id,ae,l)),Promise.all(o).then((e=>{Oe()}))})("HOLDER",e,m(me).holder.personalInfo.id))},null,8,["order-detail","sign-string","show-sign","show-verify","file-list","personal-info"])):b("",!0)]),m(Ie).scribing?(f(),y(s,I({key:0},m(ye),{title:"为了保障您的权益请抄录以下声明内容",onOnSubmit:Ne}),null,16)):b("",!0),g("div",W,[h(n,{type:"primary",onClick:je},{default:S((()=>[j("确定")])),_:1})])])}}});export{Z as default};
