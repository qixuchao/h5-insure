import{d as e,i as r,aU as t,aO as s,o as i,l as o,w as n,a as l,b as a,u,a8 as d,_ as c,aA as p,am as m,r as L,c0 as v,z as f,c as h,m as k,F as C,n as V,aw as g,e as I,bf as b,ap as y,aq as O,c1 as S,bR as P,at as T,au as _,b1 as R,j as M,q as j,aF as D,aG as E,c2 as w,p as x,E as A,T as N,az as U,c3 as H,g as F,h as Y,c4 as q,av as $,bV as B,k as z,c5 as W,al as G,ak as J,aM as K,aE as Q,aJ as X,ax as Z}from"./index-8adcf781.js";import{A as ee}from"./index-9565e95e.js";import{_ as re,e as te,f as se,P as ie,d as oe,h as ne}from"./index-418b3936.js";import{d as le}from"./debounce-6981b306.js";import{l as ae}from"./lodash-c78e74d9.js";import{P as ue,u as de}from"./ProductTips-8c0e5df6.js";import"./PayInfo-49e70372.js";import{a as ce,b as pe,c as me}from"./createProposal-adc23a71.js";import{e as Le,c as ve,j as fe}from"./trial-4664166c.js";import{_ as he}from"./index-d22ff548.js";import{_ as ke}from"./index-a556636a.js";import{_ as Ce}from"./empty-ae586b6c.js";import{a as Ve,b as ge}from"./format-b5e9d8b9.js";import{R as Ie,a as be}from"./product-585b0e6f.js";import"./keysIn-131bbce9.js";import"./isObjectLike-a9798079.js";import"./_getTag-0507d0b1.js";import"./phoneVerify-d0716a19.js";import"./merge-e7788e50.js";import"./index-54fb4308.js";import"./useDicData-6e736c53.js";import"./bankCard-1d10c001.js";import"./cloneDeep-5d541e55.js";import"./TrialButton-ecfcb6bf.js";import"./index-34b05f2f.js";import"./config-98e8d477.js";import"./useOrder-d39898d7.js";const ye={class:"trial-button"};var Oe=c(e({__name:"TrialPopup",props:{productCode:{default:""},productName:{default:""}},emits:["finish"],setup(e,{expose:c,emit:L}){const v=e,f=r(null);t(s,{insuredFactorCodes:["hasSocialInsurance","occupationCodeList"],holderFactorCodes:["birthday","gender","hasSocialInsurance","occupationCodeList"]});const h=(e,r)=>{const{holder:t,insuredList:s,productCode:i}=e||{},{productList:o,...n}=(null==s?void 0:s[0])||{},{riskList:l,...a}=o.find((e=>i===e.productCode))||(null==o?void 0:o[0])||{},u=p(null==r?void 0:r.riskPremiumDetailVOList)?null==r?void 0:r.riskPremiumDetailVOList.reduce(((e,r)=>(e[r.riskCode]={initialPremium:r.initialPremium,initialAmount:r.initialAmount,unitAmount:r.unitAmount,unitPremium:r.unitPremium},e)),{}):{},d=(l||[]).map((e=>{var r,t,s,i;return{...e,unitPremium:null==(r=null==u?void 0:u[e.riskCode])?void 0:r.unitPremium,unitAmount:null==(t=null==u?void 0:u[e.riskCode])?void 0:t.unitAmount,initialPremium:null==(s=null==u?void 0:u[e.riskCode])?void 0:s.initialPremium,initialAmount:null==(i=null==u?void 0:u[e.riskCode])?void 0:i.initialAmount}}));return{productCode:i,holder:t,insuredPersonVO:n,insuredProductInfo:{productCode:i,...a,productName:v.productName,occupationCodeList:null==n?void 0:n.occupationCodeList,riskList:d}}};return c({...["open","close"].reduce(((e,r)=>(e[r]=(...e)=>{var t;null==(t=f.value)||t[r](...e)},e)),{}),formatData:h}),(e,r)=>{const t=m;return i(),o(he,{ref_key:"trialRef",ref:f,"hide-benefit":"","hide-popup-button":"",title:"选择保障方案",class:"proposal-trial","product-info":{productCode:e.productCode},"tenant-product-detail":{}},{trialBtn:n((e=>[l("div",ye,[a(t,{disabled:!u(f).getTrialSuccessFlag(),type:"primary",onClick:r=>(({trialData:e,riskPremium:r,personalInfoRef:t})=>"function"==typeof(null==t?void 0:t.canTrail)&&t.canTrail()?L("finish",h({...e,productCode:v.productCode},r)):"function"==typeof(null==t?void 0:t.validate)&&t.validate())(e)},{default:n((()=>[d("确定")])),_:2},1032,["disabled","onClick"])])])),_:1},8,["product-info"])}}}),[["__scopeId","data-v-976d8210"]]);const Se={class:"com-risk-list-wrapper"},Pe=(e=>(T("data-v-7d3c3028"),e=e(),_(),e))((()=>l("div",{class:"popup-title"},"选择附加险",-1))),Te={class:"risk-list"},_e={class:"cell-title"},Re={class:"title"},Me={class:"footer-button"};var je=c(e({__name:"index",props:{riskList:{default:()=>[]},show:{type:Boolean,default:!1},collocationList:{default:()=>[]},disabled:{default:()=>[]},modelValue:{default:()=>[]}},emits:["finished","close","update:modelValue"],setup(e,{emit:t}){const s=e,c=r([]),p=r([]),T=r([...s.disabled]),_=L({show:s.show,currentChecked:[...s.modelValue]}),R=e=>{var r,t,i;if(T.value.includes(e))return;((e,r)=>{if(!s.collocationList.length)return r?void(_.currentChecked=[]):void _.currentChecked.push(e);let t=_.currentChecked,i=T.value;r?(s.collocationList.forEach((r=>{e===r.riskId&&(2===r.collocationType?t=t.filter((t=>t!==r.collocationRiskId||t!==e)):3===r.collocationType?(t=t.filter((r=>r!==e)),i=i.filter((e=>e!==r.collocationRiskId))):t=t.filter((r=>r!==e)))})),_.currentChecked=t,T.value=i):(s.collocationList.forEach((s=>{e===s.riskId&&(r||(2===s.collocationType?t.push(s.collocationRiskId):3===s.collocationType&&i.push(s.collocationRiskId),t.push(e)))})),_.currentChecked.push(...t),T.value=i)})(e,_.currentChecked.includes(e)),null==(i=null==(t=null==(r=null==c?void 0:c.value)?void 0:r[e])?void 0:t.toggle)||i.call(t)},M=()=>{t("close")},j=()=>{const e=s.riskList.filter((e=>_.currentChecked.includes(e.id)));t("update:modelValue",[...new Set(p.value)]),t("finished",e,T.value),t("close")};return v((()=>{c.value=[]})),f((()=>_.currentChecked),(e=>{p.value=e}),{deep:!0,immediate:!0}),f((()=>s.modelValue),(e=>{p.value=e||[],T.value.push(...e||[])}),{deep:!0,immediate:!0}),(e,r)=>{const t=b,s=y,L=O,v=S,f=m,D=P;return i(),h("div",Se,[a(D,{show:u(_).show,"onUpdate:show":r[1]||(r[1]=e=>u(_).show=e),title:"选择附加险","show-footer":"",round:"",position:"bottom",closeable:"",onClose:M},{default:n((()=>[Pe,l("div",Te,[a(v,{modelValue:u(p),"onUpdate:modelValue":r[0]||(r[0]=e=>k(p)?p.value=e:null)},{default:n((()=>[a(L,{inset:""},{default:n((()=>[(i(!0),h(C,null,V(e.riskList,(e=>(i(),o(s,{key:e.id,title:e.riskName,disabled:u(T).includes(e.id),onClick:r=>R(e.id)},{"right-icon":n((()=>[a(t,{ref_for:!0,ref:r=>u(c)[e.id]=r,shape:"square",disabled:u(T).includes(e.id),name:e.id,onClick:g((r=>R(e.id)),["stop"])},null,8,["disabled","name","onClick"])])),title:n((()=>[l("div",_e,[l("div",Re,I(e.riskName),1)])])),_:2},1032,["title","disabled","onClick"])))),128))])),_:1})])),_:1},8,["modelValue"])]),l("div",Me,[a(f,{type:"primary",disabled:!u(_).currentChecked.length,block:"",onClick:j},{default:n((()=>[d("确认")])),_:1},8,["disabled"])])])),_:1},8,["show"])])}}}),[["__scopeId","data-v-7d3c3028"]]);const De=e=>(T("data-v-308cc88c"),e=e(),_(),e),Ee={class:"com-product-list-wrapper"},we={class:"risk-item-wrapper"},xe={class:"content"},Ae={class:"risk-factor"},Ne={class:"factor"},Ue={class:"factor-value"},He=De((()=>l("span",{class:"factor-name"}," 保额(元) ",-1))),Fe={class:"factor"},Ye={class:"factor-value"},qe=De((()=>l("span",{class:"factor-name"}," 保障期间 ",-1))),$e={class:"factor"},Be={class:"factor-value"},ze=De((()=>l("span",{class:"factor-name"}," 交费期间 ",-1))),We={class:"operate-bar-wrap"},Ge={class:"risk-premium"},Je={class:"premium"},Ke={key:0,class:"operate-bar"},Qe=e({name:"ProductList"});var Xe=c(e({...Qe,props:{productRiskList:{default:()=>[]},productInfo:{default:()=>({})},productData:{default:()=>({})},pickProductPremium:{type:Function,default:()=>{}},productNum:{default:0},errorMsg:{default:""},productIndex:{},currentSelectInsure:{default:0}},emits:["deleteRisk","updateRisk","addRiderRisk"],setup(e,{emit:t}){const s=e,[c,p]=R(),m=r({checkedList:[],disabledList:[],riderRiskList:[],mainRiskData:{},totalPremium:0,currentRiskRecord:{},productRiskList:[]}),L=M((()=>{var e,r;return(null==(r=null==(e=s.productData)?void 0:e.productRiskVoList)?void 0:r[0].riskDetailVOList.filter((e=>1===e.collocationType)))||[]}));M((()=>{var e,r;const t=s.productRiskList.map((e=>e.riskId)),i=((null==(r=null==(e=s.productData)?void 0:e.productRiskVoList)?void 0:r[0].riskDetailVOList)||[]).filter((e=>t.includes(e.id)&&1===e.collocationType));return L.value.length-i.length}));const v=M((()=>e=>{var r,t;const i=(null==(t=null==(r=s.productData)?void 0:r.productRiskVoList)?void 0:t[0].riskDetailVOList.find((r=>r.id!==e)))||{};let o=!1;return o=!!s.productNum||2===i.riskType&&1===i.collocationType,o})),k=M((()=>{var e,r;return(null==(r=null==(e=s.productData)?void 0:e.productRiskVoList)?void 0:r[0].riskDetailVOList.find((e=>1===e.riskType)))||{}})),g=M((()=>k.value.collocationVOList||[])),b=(e,r)=>{const i=e.map((e=>e.id)).filter((e=>!m.value.disabledList.includes(e)));t("addRiderRisk",i,s.productInfo)};return f((()=>s.productInfo),(e=>{let r=0;(e.riskList||[]).forEach((e=>{r+=e.initialPremium})),m.value.totalPremium=r}),{deep:!0,immediate:!0}),f((()=>s.productRiskList),(e=>{const r=[],t=[],s=[];(e||[]).forEach((e=>{1===e.riskType?r.unshift(e):(t.push(e.riskId),s.push(e.riskId),r.push(e))})),m.value.disabledList=t,m.value.checkedList=s,m.value.productRiskList=r}),{deep:!0,immediate:!0}),(e,r)=>{const f=D,k=E;return i(),h("div",Ee,[(i(!0),h(C,null,V(u(m).productRiskList,(r=>{var c,p;return i(),h("div",{key:r.riskId},[l("div",we,[a(f,{"risk-type":r.riskType,title:r.riskName,class:"no-border"},null,8,["risk-type","title"]),l("div",xe,[l("div",Ae,[l("div",Ne,[l("span",Ue,I((null==(c=r.initialAmount)?void 0:c.toLocaleString())||"-"),1),He]),l("div",Fe,[l("span",Ye,I(u(Ve)(r.coveragePeriod)||"-"),1),qe]),l("div",$e,[l("span",Be,I(u(ge)(r.chargePeriod)||"-"),1),ze])]),l("div",We,[l("div",Ge,[d(" 保费:"),l("span",Je,I(!e.errorMsg&&r.initialPremium?`￥${null==(p=r.initialPremium)?void 0:p.toLocaleString()}`:"-"),1)]),2!==r.riskType?(i(),h("div",Ke,[e.currentSelectInsure>0||u(v)(r.riskId)&&e.productIndex>0?(i(),o(k,{key:0,round:32,class:"border",onClick:e=>{t("deleteRisk",r,s.productInfo)}},{default:n((()=>[d("删除")])),_:2},1032,["onClick"])):j("",!0),a(k,{activated:"",onClick:e=>{t("updateRisk",r,s.productInfo)}},{default:n((()=>[d("修改")])),_:2},1032,["onClick"])])):j("",!0)])])])])})),128)),u(c)?(i(),o(je,{key:0,modelValue:u(m).checkedList,"onUpdate:modelValue":r[0]||(r[0]=e=>u(m).checkedList=e),show:u(c),disabled:u(m).disabledList,"risk-list":u(L),"collocation-list":u(g),onFinished:b,onClose:r[1]||(r[1]=e=>u(p)(!1))},null,8,["modelValue","show","disabled","risk-list","collocation-list"])):j("",!0),a(ue,{"error-msg":e.errorMsg},null,8,["error-msg"])])}}}),[["__scopeId","data-v-308cc88c"]]);const Ze=e=>(T("data-v-21e2f380"),e=e(),_(),e),er={class:"insurer-list"},rr=["onClick"],tr=Ze((()=>l("span",{class:"insure-name"},"被保人",-1))),sr={key:0,class:"insure-relate"},ir={key:1,class:"insure-relate"},or=["onClick"],nr=Ze((()=>l("div",{class:"gap"},null,-1))),lr=Ze((()=>l("span",null,"+",-1))),ar=e({name:"InsurerSelect"});var ur=c(e({...ar,props:{insurerList:{default:()=>[]},config:{default:()=>{}},canChangeSelect:{type:Boolean,default:()=>!0}},emits:["listChange","currentChange","add","delete","validateTab"],setup(e,{expose:t,emit:s}){const o=e,n=r(),a=r(),c=r({currentSelected:0}),p=r(o.insurerList),m=(e=!1)=>{A((()=>{var r;null==(r=n.value[c.value.currentSelected])||r.scrollIntoView({behavior:"smooth",block:"nearest",inline:"start"}),0===c.value.currentSelected?a.value.scrollLeft=0:e&&c.value.currentSelected>=3&&(a.value.scrollLeft=a.value.scrollWidth)}))};w((()=>{m(!0)}));const L=e=>{var r;if((null==e?void 0:e.personVO)&&(null==(r=null==e?void 0:e.personVO)?void 0:r.relationToMainInsured)){const r=Ie.find((r=>{var t;return r.value===`${null==(t=null==e?void 0:e.personVO)?void 0:t.relationToMainInsured}`}));if(r)return r.label}return"关系"},v=()=>!(!p.value[c.value.currentSelected].productList||p.value[c.value.currentSelected].productList.length<=0),k=()=>{v()?s("validateTab",(()=>{p.value.push({}),c.value.currentSelected=p.value.length-1,s("add",{},p.value.length-1)})):N("请确认信息是否录入完整!")};return f((()=>o.insurerList.length),(()=>{p.value=o.insurerList,m()}),{deep:!0,immediate:!0}),t({updateInsurer:(e,r)=>{}}),(e,r)=>(i(),h("div",er,[l("div",{ref_key:"tabsRef",ref:a,class:"list"},[(i(!0),h(C,null,V(u(p),((e,r)=>(i(),h("div",{ref_for:!0,ref_key:"tabRef",ref:n,key:`insure_${r}`,class:x("insure-box "+(r===u(c).currentSelected?"selected":"")),onClick:e=>((e,r)=>{v()?o.canChangeSelect&&s("validateTab",(()=>{c.value.currentSelected=r,s("currentChange",r),m()})):N("请确认信息是否录入完整!")})(0,r)},[tr,0===r?(i(),h("span",sr,"本人")):(i(),h("span",ir,I(L(e)),1)),r>0?(i(),h("div",{key:2,class:"delete-btn",onClick:e=>((e,r)=>{e.preventDefault(),e.stopPropagation(),e.cancelBubble=!0,U.confirm({message:"确定要删除该被保人吗？"}).then((()=>{s("delete",r,(()=>{r<c.value.currentSelected?(c.value.currentSelected-=1,s("currentChange",c.value.currentSelected)):r===c.value.currentSelected&&(c.value.currentSelected=0,s("currentChange",0))}))})).catch((()=>{}))})(e,r)},"×",8,or)):j("",!0)],10,rr)))),128))],512),l("div",{class:"operate"},[nr,l("div",{class:"add-btn",onClick:k},[lr,d(" 被保人")])])]))}}),[["__scopeId","data-v-21e2f380"]]);const dr={class:"proposal-header"},cr={key:0,class:"container"},pr=(e=>(T("data-v-79175678"),e=e(),_(),e))((()=>l("div",{class:"title-tip-icon"},"投保人信息",-1))),mr={key:0,class:"operate-bar"},Lr={key:0,class:"operate-bar"},vr={class:"footer-bar"},fr={class:"trial-result"},hr={class:"result-num"},kr={class:"trial-operate"},Cr=e({name:"CreateProposal"});var Vr=c(e({...Cr,setup(e){const t=[{name:"保存修改"},{name:"另存为新计划书"}],s=H();R();const[c,v]=R(),g=r({holder:{},insuredList:[{name:"",gender:"",birthday:"",productList:[]}],proposalName:"",totalPremium:0,relationUserType:2}),b=F(),y=Y(),O=de(),S={},{productCode:P,id:T,preview:_}=y.query,D=["age","gender","birthday","hasSocialInsurance","occupationCodeList"],x=r(null),ue=L({selectedProductCodeList:[],selectedProductList:[],insuredPersonVO:{},insurerList:[],currentProductCode:"",holder:{},productList:[],productCollection:{},productErrorMap:{},defaultData:null,currentSelectInsure:0,isLoading:!1}),he=r(!1),Ve=r(null),ge=r(null),ye=r(null),Se=(e,r,t)=>e?+e<18?"投保人年龄不得小于18周岁":"":"请输入投保人年龄";M((()=>{var e;return(null==(e=ue.insurerList[ue.currentSelectInsure])?void 0:e.productList)?ue.insurerList[ue.currentSelectInsure].productList.map((e=>e.productCode)).filter((e=>Boolean(e))):[]}));const Pe=()=>ue.insurerList[ue.currentSelectInsure].productList.map((e=>e.productCode)).filter((e=>Boolean(e))),Te=M((()=>{const{productPlanInsureVOList:e}=ue.productCollection[P]||{},[{insureProductRiskVOList:r=[]}={}]=e||[],{riskInsureLimitVO:t}=(null==r?void 0:r.find((e=>1===e.riskType)))||{};return null==t?void 0:t.sexLimit})),_e=M((()=>"-1"!==Te.value&&Te.value?q.filter((e=>Te.value===e.value)):q)),Re=M((()=>{var e;return(null==(e=ue.productCollection)?void 0:e[ue.currentProductCode])||{}})),Me=e=>(e.insuredList=e.insuredList.map((e=>(e.productList=e.productList.map((e=>(e.riskList=e.riskList.map((e=>({...e,initialPremium:e.unitPremium||e.initialPremium,initialAmount:e.unitAmount||e.initialAmount}))),e))),e))),e),je=M((()=>{var e,r;return(null==(r=null==(e=Re.value)?void 0:e.productPlanInsureVOList)?void 0:r[0])||{}}));M((()=>{var e,r,t;return null==(t=null==(r=null==(e=Re.value)?void 0:e.productPlanInsureVOList)?void 0:r[0])?void 0:t.multiInsuredConfigVO}));const De=M((()=>!he.value||Boolean(Object.values(ue.productErrorMap).join("")))),Ee=M((()=>"1"!=`${_}`)),we=M((()=>ue.insurerList.reduce(((e,r)=>+(r.productList.reduce(((e,r)=>+e+ +r.riskList.reduce(((e,r)=>+e+ +(r.initialPremium||0)),0)),0)+ +e)),0))),xe=e=>{var r,t;const s=[null==(r=ge.value)?void 0:r.validate()];if(0===ue.currentSelectInsure){if(1===ue.insurerList[0].personVO.relationToHolder&&ue.insurerList[0].personVO.age<18||1!==ue.insurerList[0].personVO.relationToHolder&&ue.holder.age<18)return void N("投保人年龄不得小于18周岁");s.push(null==(t=ye.value)?void 0:t.validate())}Promise.all(s).then((()=>{e()})).catch((e=>{N("请确认信息是否录入完整!")}))},Ae=()=>{const e=ue.insurerList.findIndex((({personVO:e})=>e.relationToMainInsured===+be.MATE));return Ie.map((r=>r.value===be.SELF||r.value===be.MATE&&e>=0&&e!==ue.currentSelectInsure?{...r,disabled:!0}:{...r}))},Ne=(e,r="")=>{ue.productErrorMap[e]=r},Ue=e=>{const r=ue.insurerList[ue.currentSelectInsure].productList.findIndex((r=>r.productCode===e.productCode)),t={...e.insuredProductInfo,nanoid:K(),productName:S[e.productCode]};if(-1===r)return ue.insurerList[ue.currentSelectInsure].productList.push(t),!1;const s=ue.insurerList[ue.currentSelectInsure].productList[r],{riskList:i,...o}=t;ue.insurerList[ue.currentSelectInsure].productList[r]={...t,...o,riskList:p(i)?i.map((e=>({...s.riskList.find((r=>r.riskCode===e.riskCode)),...e}))):[]}},He=e=>{var r;Object.assign(ue.holder,e.holder),0===ue.currentSelectInsure&&(e.insuredPersonVO.relationToHolder=ue.insurerList[ue.currentSelectInsure].personVO.relationToHolder),ue.insurerList[ue.currentSelectInsure]&&Object.assign(ue.insurerList[ue.currentSelectInsure].personVO,e.insuredPersonVO),Ue(e),Ne(e.productCode),he.value=!0,null==(r=x.value)||r.close()},Fe=()=>{var e;const r=[null==(e=ge.value)?void 0:e.validate()];Promise.all(r).then((()=>{O.setProposalInfo(g.value),O.setExcludeProduct(Pe()),O.setInsuredPersonVO(ue.insurerList[ue.currentSelectInsure].personVO),b.push({path:"/proposalListSelect",query:{isCreateProposal:"1"}})})).catch((e=>{N("请确认被保人信息是否录入完整!")}))},Ye=e=>{const r=Me(e);fe(r,{isCustomError:!0}).then((({code:e,data:t,message:s})=>{var i;e===Z&&t?((null==t?void 0:t.errorInfo)&&N(`${null==t?void 0:t.errorInfo}`),p(t.riskPremiumDetailVOList)&&Ue(null==(i=x.value)?void 0:i.formatData(r,t)),Ne(r.productCode),he.value=!0):Ne(r.productCode,s)}))},qe=e=>{e&&(ue.insurerList[ue.currentSelectInsure].personVO.age=G(new Date).diff(e,"year"))},$e=e=>{e&&(ue.holder.age=G(new Date).diff(e,"year"))},Be=e=>{const{value:r}=e;let t={age:30,birthday:G().subtract(30,"year").format("YYYY-MM-DD"),gender:+J.MALE};[be.MATE,be.CHILD].includes(r)?t={age:r===be.MATE?ue.insurerList[0].personVO.age:0,birthday:r===be.MATE?ue.insurerList[0].personVO.birthday:G().subtract(28,"day").format("YYYY-MM-DD"),gender:r===be.MATE?1==+ue.insurerList[0].personVO.gender?2:1:+J.MALE}:be.PARENT===r&&(t={age:+ue.insurerList[0].personVO.age+18,birthday:G(ue.insurerList[0].personVO.birthday).subtract(18,"year").format("YYYY-MM-DD"),gender:+J.MALE}),Object.assign(ue.insurerList[ue.currentSelectInsure].personVO,t)},ze=()=>{ue.insurerList[ue.currentSelectInsure].personVO.birthday=""},We=()=>{if(0===ue.currentSelectInsure){const e=ue.insurerList.findIndex((e=>!(!e||!e.personVO)&&+e.personVO.relationToMainInsured==+be.MATE));-1!==e&&(ue.insurerList[e].personVO.gender=1==+ue.insurerList[0].personVO.gender?2:1)}},Ge=()=>{ue.holder.birthday=""},Je=e=>{ce(e).then((({code:e,data:r})=>{"10000"===e&&p(r)&&r.reduce(((e,r)=>(e[r.productCode]=r,S[r.productCode]=r.productName,e)),ue.productCollection)})).finally((()=>{}))},Ke=()=>{if(1==+ue.insurerList[0].personVO.relationToHolder){const{relationToHolder:e,relationToMainInsured:r,productList:t,...s}=ue.insurerList[0].personVO;return T&&(s.id=ue.holder.id),s}return ue.holder},Qe=e=>0===e&&2==+ue.insurerList[e].personVO.relationToHolder?{...ue.insurerList[e].personVO,relationToHolder:null}:ue.insurerList[e].personVO,Ze=async(e,r=!1)=>{if(!p(e))return;const{code:t,data:s}=await Le({calcProductFactorList:e,...ue.insurerList[ue.currentSelectInsure]&&ue.insurerList[ue.currentSelectInsure].personVO||{}},{isCustomError:!r});"10000"===t&&s&&p(s)&&s.forEach((e=>{const{holder:t,insuredList:s,productCode:i}=e,{productList:o,...n}=(s||[])[0]||{},[{riskList:l=[],...a}={}]=o||[],u={productCode:i,...a,riskList:l};r&&(ue.insurerList[ue.currentSelectInsure]&&Object.assign(ue.insurerList[ue.currentSelectInsure].personVO,n,{relationToHolder:1}),Object.assign(ue.holder,t)),s.forEach(((e,r)=>{const{productList:t,...s}=e;0===ue.insurerList.length&&(s.relationToMainInsured||(s.relationToMainInsured=be.SELF),ue.insurerList.push({productList:t.map((e=>({...e,productCode:i}))),personVO:s}))}));const d=Pe().findIndex((e=>e===i));d>-1?ue.productList[d]=u:ue.productList.push(u),A((()=>{Ye({...e,holder:{...Ke()},insuredList:[{...Qe(ue.currentSelectInsure),productList:o}]})}))}))},er=e=>ue.insurerList[ue.currentSelectInsure].productList.filter((r=>r.productCode===e)).map((({productCode:e,riskList:r})=>{const{productPlanInsureVOList:t}=ue.productCollection[e]||{},[{insureProductRiskVOList:s}={}]=t||[];return{productCode:e,riskEditVOList:p(r)?r.filter((e=>1===e.riskType)).map((({riskCode:e})=>({insureProductRiskVO:{...(null==s?void 0:s.find((r=>r.riskCode===e)))||{}}}))):[]}})),rr=e=>(ue.insurerList[ue.currentSelectInsure].productList.find((r=>r.productCode===e)),{holder:{...Ke()},insuredList:[{...Qe(ue.currentSelectInsure),productList:ue.insurerList[ue.currentSelectInsure].productList}],productCode:e}),tr=(e,r)=>{const t=r;U.confirm({message:"确认删除该险种？"}).then((()=>{1===e.riskType?ue.insurerList[ue.currentSelectInsure].productList=ue.insurerList[ue.currentSelectInsure].productList.filter((e=>e.productCode!==t.productCode)).map((e=>({...e,nanoid:K()}))):t.riskList=t.riskList.filter((r=>r.riskId!==e.riskId)),Ne(t.productCode)}))},sr=(e,r)=>{var t,s;const i=null==(t=e.insuredList)?void 0:t[0],o=(null==(s=i.productList)?void 0:s.find((e=>e.productCode===r)))||{};return i.occupationClass=null==o?void 0:o.occupationClass,i.occupationCodeList=null==o?void 0:o.occupationCodeList,i.productList=i.productList.filter((e=>e.productCode===r)),e},ir=(e,r)=>{var t;ue.currentProductCode=r.productCode;const s=Me(ae.exports.cloneDeep(rr(r.productCode)));ue.defaultData=[sr(s,r.productCode)],null==(t=x.value)||t.open()},or=e=>{var r,t,s;if(ue.insurerList.some((e=>0===e.productList.length)))return void N("请先添加产品");const i=[null==(r=Ve.value)?void 0:r.validate(),null==(t=ge.value)?void 0:t.validate()];if(0===ue.currentSelectInsure){if(1===ue.insurerList[0].personVO.relationToHolder&&ue.insurerList[0].personVO.age<18||1!==ue.insurerList[0].personVO.relationToHolder&&ue.holder.age<18)return void N("投保人年龄不得小于18周岁");i.push(null==(s=ye.value)?void 0:s.validate())}Promise.all(i).then((()=>{ue.isLoading=!0,me({holder:{...Ke()},insuredList:ue.insurerList.map(((e,r)=>({...Qe(r),productList:e.productList.map((e=>({...e,productName:S[e.productCode]})))}))),proposalName:ue.insuredPersonVO.proposalName,totalPremium:we.value,relationUserType:2,id:e}).then((e=>{const{code:r,data:t}=e||{};"10000"===r&&(O.$reset(),b.push({path:"/compositionProposal",query:{id:t,preview:_}}))})).catch((()=>{ue.isLoading=!1}))}))},nr=()=>{T?v(!0):or(T)},lr=(e,r)=>{or(r?void 0:T)},ar=e=>{var r;ue.currentSelectInsure=e,(null==(r=ue.insurerList[e])?void 0:r.productList.length)>0?Je(ue.insurerList[e].productList.map((({productCode:e})=>({productCode:e})))):ue.productCollection={}},Cr=(e,r)=>{if(ue.insurerList.length-1===r){const t=ue.insurerList.findIndex((e=>!(!e||!e.personVO)&&+e.personVO.relationToMainInsured==+be.MATE));ue.insurerList[r]={...e,personVO:{age:t<0?ue.insurerList[0].personVO.age:0,birthday:t<0?ue.insurerList[0].personVO.birthday:G().subtract(28,"day").format("YYYY-MM-DD"),relationToMainInsured:t<0?be.MATE:be.CHILD,gender:t<0?1==+ue.insurerList[0].personVO.gender?2:1:J.MALE},productList:[]}}ue.currentSelectInsure=r,ue.productCollection={}},Vr=(e,r)=>{ue.insurerList.splice(e,1),null==r||r()};return f([()=>D.map((e=>ue.insurerList[ue.currentSelectInsure]?ue.insurerList[ue.currentSelectInsure].personVO[e]:"")),()=>ue.currentSelectInsure],(([e,r],[t,s])=>{e.join(",")!==t.join(",")&&r===s&&(console.log(r,"被保人条件变动",s),p(Object.keys(ue.productCollection))&&Pe().forEach((e=>(async e=>{try{const{code:r,data:t,message:s}=await ve({calcProductFactorList:er(e),...ue.insurerList[ue.currentSelectInsure].personVO},{isCustomError:!0});"10000"===r&&p(t)?(ue.insurerList[ue.currentSelectInsure].productList.forEach((({productCode:e,riskList:r})=>{const{productRiskDyInsureFactorVOList:s}=t[0]||t.find((r=>r.productCode===e))||{};r.forEach((e=>{const r=s.find((r=>r.riskCode===e.riskCode));Object.assign(e,{...e,...r})}))})),Ye(rr(e)),Ne(e)):Ne(e,s)}catch(r){console.log("Error",r)}})(e))))}),{deep:!0}),f((()=>ue.selectedProductCodeList),le((e=>{if(p(e)){console.log("选择的产品变动了",e,ae.exports.cloneDeep(ue.insurerList)),Ze(e.map((e=>({productCode:e}))));const r=Object.keys(ue.productCollection),t=null==e?void 0:e.filter((e=>!r.includes(e)));p(t)&&Je(null==t?void 0:t.map((e=>({productCode:e}))))}})),{deep:!0}),w((()=>{const{selectedProduct:e,selectedProductList:r}=O.$state;ue.selectedProductList=r,ue.selectedProductCodeList=p(e)?e:[]})),$((()=>{if(B(),P){const e=[{productCode:P}];Je(e),Ze(e,!0)}T&&(((e={})=>{pe(e).then((({code:e,data:r})=>{if("10000"===e&&r){const{insuredList:e,holder:t,proposalName:s}=r||{},[{productList:i,...o}]=e||[];ue.holder=t,ue.insuredPersonVO={...o,proposalName:s};let n=!1;ue.insurerList=e.map(((e,r)=>{const{productList:t,...s}=e;return 0===r&&(s.relationToHolder=s.relationToHolder?1:2,$e(ue.holder.birthday)),{productList:t.filter((e=>(n||1===e.shelfStatus||(n=!0),1===e.shelfStatus))),personVO:s}})),n&&N("计划书中存在已下架产品，请重新生成计划书"),Je(i.filter((e=>1===e.shelfStatus)).map((e=>({productCode:e.productCode})))),ue.productList=i}}))})({id:T}),he.value=!0);const e=(T?"编辑":"创建")+"计划书";y.meta.title=e,document.title=e})),(e,r)=>{const p=oe,L=ne,f=Q,g=E,b=m,y=ee,O=z("ProPageWrap"),S=X;return i(),o(S,{"theme-vars":u(s)},{default:n((()=>[a(O,{class:"page-create-wrapper"},{default:n((()=>{var e;return[l("div",dr,[a(p,{ref_key:"formRef",ref:Ve,class:"mb20",model:u(ue).insuredPersonVO},{default:n((()=>[a(u(re),{modelValue:u(ue).insuredPersonVO.proposalName,"onUpdate:modelValue":r[0]||(r[0]=e=>u(ue).insuredPersonVO.proposalName=e),class:"ra20",label:"计划书名称",name:"proposalName",maxlength:20},null,8,["modelValue"])])),_:1},8,["model"]),a(ur,{config:u(ue),"insurer-list":u(ue).insurerList,"can-change-select":!0,onValidateTab:xe,onCurrentChange:ar,onAdd:Cr,onDelete:Vr},null,8,["config","insurer-list"])]),u(ue).insurerList[u(ue).currentSelectInsure]?(i(),h("div",cr,[a(f,{title:"被保人信息",class:"com-pro-form-with-card com-card-body-no-padding insure-containe","show-divider":!1},{default:n((()=>[a(p,{ref_key:"insuredFormRef",ref:ge,model:u(ue).insurerList[u(ue).currentSelectInsure]},{default:n((()=>[a(u(re),{modelValue:u(ue).insurerList[u(ue).currentSelectInsure].personVO.name,"onUpdate:modelValue":r[1]||(r[1]=e=>u(ue).insurerList[u(ue).currentSelectInsure].personVO.name=e),label:"姓名",name:"name",maxlength:20,required:""},null,8,["modelValue"]),0!==u(ue).currentSelectInsure&&u(ue).insurerList[u(ue).currentSelectInsure]?(i(),o(L,{key:0,modelValue:u(ue).insurerList[u(ue).currentSelectInsure].personVO.relationToMainInsured,"onUpdate:modelValue":r[2]||(r[2]=e=>u(ue).insurerList[u(ue).currentSelectInsure].personVO.relationToMainInsured=e),label:"与主被保人关系","is-default-selected":!0,name:"relationToMainInsured",columns:Ae(),required:"",onConfirm:Be},null,8,["modelValue","columns"])):j("",!0),a(u(re),{modelValue:u(ue).insurerList[u(ue).currentSelectInsure].personVO.age,"onUpdate:modelValue":r[4]||(r[4]=e=>u(ue).insurerList[u(ue).currentSelectInsure].personVO.age=e),class:"age-field-wrap",name:"age",label:"年龄",type:"digit",maxlength:3,required:"",onChange:ze},{extra:n((()=>[a(u(te),{modelValue:u(ue).insurerList[u(ue).currentSelectInsure].personVO.birthday,"onUpdate:modelValue":[r[3]||(r[3]=e=>u(ue).insurerList[u(ue).currentSelectInsure].personVO.birthday=e),qe],class:"birthday-field-wrap",label:"出生日期",name:"birthday"},null,8,["modelValue"])])),_:1},8,["modelValue"]),a(u(se),{modelValue:u(ue).insurerList[u(ue).currentSelectInsure].personVO.gender,"onUpdate:modelValue":r[5]||(r[5]=e=>u(ue).insurerList[u(ue).currentSelectInsure].personVO.gender=e),label:"性别",name:"gender",columns:u(_e),disabled:+u(ue).insurerList[u(ue).currentSelectInsure].personVO.relationToMainInsured==+u(be).MATE,required:"",onChange:We},null,8,["modelValue","columns","disabled"])])),_:1},8,["model"]),0===u(ue).currentSelectInsure?(i(),h(C,{key:0},[pr,a(p,{ref_key:"holderFormRef",ref:ye,model:u(ue).holder,class:"insure-container"},{default:n((()=>[a(u(se),{modelValue:u(ue).insurerList[0].personVO.relationToHolder,"onUpdate:modelValue":r[6]||(r[6]=e=>u(ue).insurerList[0].personVO.relationToHolder=e),label:"投被保人是同一人",columns:u(W),required:""},null,8,["modelValue","columns"]),2===u(ue).insurerList[0].personVO.relationToHolder?(i(),h(C,{key:0},[a(u(re),{modelValue:u(ue).holder.name,"onUpdate:modelValue":r[7]||(r[7]=e=>u(ue).holder.name=e),name:"name",label:"姓名",maxlength:20,required:""},null,8,["modelValue"]),a(u(re),{modelValue:u(ue).holder.age,"onUpdate:modelValue":r[9]||(r[9]=e=>u(ue).holder.age=e),class:"age-field-wrap",name:"age",label:"年龄",type:"digit",maxlength:3,required:"",rules:[{required:!0,message:"请输入年龄"},{trigger:"onChange",validator:Se}],onChange:Ge},{extra:n((()=>[a(u(te),{modelValue:u(ue).holder.birthday,"onUpdate:modelValue":[r[8]||(r[8]=e=>u(ue).holder.birthday=e),$e],class:"birthday-field-wrap",label:"出生日期",name:"birthday"},null,8,["modelValue"])])),_:1},8,["modelValue","rules"]),a(u(se),{modelValue:u(ue).holder.gender,"onUpdate:modelValue":r[10]||(r[10]=e=>u(ue).holder.gender=e),label:"性别",name:"gender",columns:u(q),required:""},null,8,["modelValue","columns"])],64)):j("",!0)])),_:1},8,["model"])],64)):j("",!0)])),_:1}),a(u(ie),{ref:"productFormRef",title:"保障计划",class:"product-container"},{default:n((()=>{var e;return[u(ue).insurerList[u(ue).currentSelectInsure].productList.length>0?(i(!0),h(C,{key:0},V(u(ue).insurerList[u(ue).currentSelectInsure].productList,((e,r)=>(i(),o(f,{key:`${e.nanoid}_${r}_${e.productCode}`,class:"product-item-card","show-line":!1,"show-divider":!1},{default:n((()=>{var t;return[a(Xe,{"product-risk-list":e.riskList,"product-info":e,"product-num":(null==(t=u(ue).insurerList[u(ue).currentSelectInsure].productList)?void 0:t.length)-1,"product-data":u(ue).productCollection[e.productCode],"error-msg":u(ue).productErrorMap[e.productCode],"product-index":r,"current-select-insure":u(ue).currentSelectInsure,onUpdateRisk:ir,onDeleteRisk:tr},null,8,["product-risk-list","product-info","product-num","product-data","error-msg","product-index","current-select-insure"])]})),_:2},1024)))),128)):(i(),h(C,{key:1},[u(Ee)?(i(),h("div",mr,[(null==(e=u(ue).insurerList[u(ue).currentSelectInsure].productList)?void 0:e.length)<=0?(i(),o(ke,{key:0,"empty-img":u(Ce),title:"该成员还未配置产品，去添加吧！","empty-class":"empty-select"},null,8,["empty-img"])):j("",!0),a(g,{activated:"",round:34,onClick:Fe},{default:n((()=>[d("添加产品")])),_:1})])):j("",!0)],64))]})),_:1},512),u(Ee)&&u(ue).insurerList[u(ue).currentSelectInsure].productList.length>0?(i(),h("div",Lr,[a(g,{activated:"",round:34,onClick:Fe},{default:n((()=>[d("添加产品")])),_:1})])):j("",!0)])):j("",!0),l("div",vr,[l("span",fr,[d("总保费"),l("span",hr,I(u(De)?"-":`￥${null==(e=u(we))?void 0:e.toLocaleString()}`),1)]),l("div",kr,[a(b,{disabled:u(De)||u(ue).isLoading,loading:u(ue).isLoading,"loading-type":"spinner",type:"primary",onClick:nr},{default:n((()=>[d("保存并预览")])),_:1},8,["disabled","loading"])])]),a(y,{show:u(c),"onUpdate:show":r[11]||(r[11]=e=>k(c)?c.value=e:null),actions:t,"cancel-text":"取消","close-on-click-action":"",onCancel:r[12]||(r[12]=e=>u(v)(!1)),onSelect:lr},null,8,["show"]),a(Oe,{ref_key:"trialPopupRef",ref:x,"data-source":u(je),"product-code":u(ue).currentProductCode,"default-data":u(ue).defaultData,onFinish:He},null,8,["data-source","product-code","default-data"])]})),_:1})])),_:1},8,["theme-vars"])}}}),[["__scopeId","data-v-79175678"]]);export{Vr as default};
