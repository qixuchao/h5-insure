import{d as e,i,h as a,c5 as s,cW as o,j as n,k as t,ah as r,E as l,bc as d,b4 as u,cX as c,l as v,o as p,c as f,b as g,a as h,u as m,p as y,f as b,a8 as I,w as S,v as j,bj as O,bb as w,T as N,cY as T,aY as x,y as L,cO as D,cP as E,c4 as C,cZ as k,cQ as q,bO as R,a$ as V,cR as $,c_ as P,b3 as z,c$ as H}from"./index-83a8b446.js";import{g as U,m as _}from"./trial-e48acfbd.js";import{_ as A}from"./SignPart-b63aa187.js";import{u as B}from"./useOrder-5d8cb7c9.js";import{N as F}from"./notice-8819bd7b.js";import"./PolicyInfo-9498e98e.js";import{c as Y}from"./scribing-0c63db55.js";import{p as W}from"./utils-89a8b2ff.js";import{i as G}from"./core-3b1d23d8.js";import"./index-340d107b.js";import"./cloneDeep-d236c69c.js";import"./utils-1b63caf2.js";import"./createProposal-4bee1c8e.js";import"./trial-166a0af0.js";import"./utils-7bac2bc5.js";import"./infoCollection-207a44bb.js";const J={class:"long-verify"},Q={class:"header"},X={class:"verify-content"},Z={class:"footer-button"},K=e({__name:"holderSign",setup(e){const K=i(),M=a(),{productCode:ee="",tenantId:ie,agentCode:ae="",agencyCode:se,saleChannelId:oe,saleUserId:ne,orderNo:te,orderCode:re,extraInfo:le,isShare:de,insurerCode:ue,preview:ce}=K.query;let ve={};try{ve=JSON.parse(decodeURIComponent(le))}catch(Te){}const pe=B(),fe=`${window.origin}/baseInsurance/long/phoneVerify?${s.stringify({...K.query,orderNo:re||te})}`,ge=new o({source:"localStorage"}),he=n(),me=n({holder:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:[],compositionSign:""},insured:{fileList:[],personalInfo:[],isSign:!1,isVerify:!1,isShareSign:!1,signData:{},compositionSign:""},agent:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:"",compositionSign:""}}),ye=n({}),be=n({}),Ie=n({sign:[],verify:[],scribing:""}),Se=t((()=>{var e,i;const{age:a,relationToHolder:s,id:o}=(null==(i=null==(e=me.value.insured)?void 0:e.personalInfo)?void 0:i[0])||{};return`${s}`===r.CERT||a<18})),je=()=>{if(ce)return void O(w.SIGN,K.query);const e=[];he.value&&((de?Ie.value.sign.includes("4"):Ie.value.sign.includes("2"))&&e.push(he.value.validateSign()),Ie.value.verify.includes("1")&&e.push(he.value.validateVerify())),Promise.all(e).then((e=>{!Ie.value.scribing||ye.value.status?T(pe.value).then((({code:e,data:i})=>{"10000"===e&&(i.authStatus===`${x.YES}`?M.push({path:L.payAuth,query:K.query}):Promise.all([D({bizObjectId:[pe.value.holder.id],bizObjectType:E.HOLDER,orderId:pe.value.id,tenantId:ie,shareFlag:de?1:2}),Se.value&&D({bizObjectId:[pe.value.insuredList[0].id],bizObjectType:E.INSURED,orderId:pe.value.id,tenantId:ie})]).then((e=>{if("10000"===e[0].code){if(de)return N("本次签名已完成"),void setTimeout((()=>{G?C.closeWindow():window.close()}),1500);M.push({path:L.sign,query:K.query})}})))})):N("请先完成风险抄录")})).catch((e=>{N(e.message)}))},Oe=()=>{te&&U({orderNo:re||te,tenantId:ie}).then((({code:e,data:i})=>{var a,s,o,n;if("10000"===e){const e=[];i.tenantOrderAttachmentList.forEach((i=>{i.objectType===F.HOlDER&&(30===i.category?e.push(i.fileBase64):21===i.category&&(me.value.holder.compositionSign=i.uri))})),me.value.holder.signData=e,Object.assign(be.value,{type:k[i.extInfo.transcriptionType],signInfo:null==(s=null==(a=i.riskTranscriptionList)?void 0:a[0])?void 0:s.uri,text:null==(n=null==(o=i.riskTranscriptionList)?void 0:o[0])?void 0:n.content,status:!!i.extInfo.transcriptionStatus})}}))};n({imgUrl:"",desc:"",title:"",link:fe});const we=e=>{const{type:i,text:a}=ye.value,s={...K.query,orderNo:re||te,text:a,orderId:pe.value.id};"handle"===i?M.push({path:"scribing",query:s}):Y({content:a,image:e,orderNo:re||te,tenantId:ie,transcriptionType:H.AUTO}).then((({code:e})=>{"10000"===e&&Oe()}))};l([()=>be.value,()=>ye.value],(()=>{Object.assign(ye.value,{type:be.value.type||ye.value.type,text:be.value.text||ye.value.text,status:be.value.status||ye.value.status,signInfo:be.value.signInfo||ye.value.signInfo})}),{deep:!0,immediate:!0}),d((()=>{(async()=>{var e,i,a,s;let o={};const{code:n,data:t}=await U({orderNo:re||te,tenantId:ie});"10000"===n&&(Object.assign(pe.value,t),me.value.holder.personalInfo={...t.holder,name:"是固定改过的",isCert:1},me.value.insured.personalInfo=t.insuredList.map((e=>(e.isCert=1,e))),o=W(t.insuredList[0].productList),Object.assign(be.value,{type:k[t.extInfo.transcriptionType],signInfo:null==(i=null==(e=t.riskTranscriptionList)?void 0:e[0])?void 0:i.uri,text:null==(s=null==(a=t.riskTranscriptionList)?void 0:a[0])?void 0:s.content,status:!!t.extInfo.transcriptionStatus}),pe.value.tenantOrderAttachmentList.forEach((e=>{e.objectType===F.HOlDER&&(30===e.category?me.value.holder.signData.push(e.fileBase64):21===e.category&&(me.value.holder.compositionSign=e.uri))}))),_(o).then((({data:e,code:i})=>{if("10000"===i){const{signInfo:i}=R(e.productFactor);i.schema.forEach((e=>{"eleSign"===e.name&&e.columns.forEach((i=>{e.required&&Ie.value.sign.push(i.code),"1"===i.code?me.value.agent.isSign=!0:"2"===i.code?me.value.holder.isSign=!0:"3"===i.code?me.value.insured.isSign=!0:"4"===i.code?me.value.holder.isShareSign=!0:"5"===i.code&&(me.value.insured.isShareSign=!0)})),"riskNotificationCopy"===e.name&&(ye.value.text=e.remark,Ie.value.scribing=e.required,e.columns.forEach((e=>{"1"===e.code?ye.value.type="handle":ye.value.type="auto"}))),"customerFace"===e.name&&e.columns.forEach((i=>{e.required&&Ie.value.verify.push(i.code),"1"===i.code?me.value.holder.isVerify=!0:"2"===i.code&&(me.value.insured.isVerify=!0)}))}))}}))})();const e=u.get("verifyData");if(e){const{serialNo:i,certNo:a,name:s}=e;c({certiNo:a,orderNo:re||te,serialNo:i,tenantId:ie,userName:s}).then((e=>{const{code:i,data:a}=e;"10000"===i&&(ge.remove("verifyData"),Oe())}))}}));const Ne=n();return v((()=>{setTimeout((async()=>{Ne.value=window.getIseeBiz&&await window.getIseeBiz()}),1500)})),(e,i)=>{var a,s,o;const n=V,t=$,r=P,l=z;return p(),f("div",J,[g(n),h("div",Q,[g(t,{type:"warning",content:(null==(a=m(me).holder.personalInfo)?void 0:a.name)&&`本人${null==(s=m(me).holder.personalInfo)?void 0:s.name}已阅读并同意签署《电子投保单》（投保信息确认）、《人身保险投保提示书》、《免责说明书》、《产品说明书》（一年期以上产品）、《风险告知问卷》（万能型产品）、《风险承受能力测评问卷》（万能型产品）。请投保人：${null==(o=m(me).holder.personalInfo)?void 0:o.name}签名确认。`},null,8,["content"])]),h("div",X,[!m(de)||m(me).holder.isShareSign?(p(),y(A,{key:0,ref_key:"holderSignRef",ref:he,"order-detail":m(pe),"sign-string":m(me).holder.signData,"show-sign":m(de)?m(me).holder.isShareSign:m(me).holder.isSign,"show-verify":m(me).holder.isVerify,"file-list":m(me).holder.fileList,"personal-info":m(me).holder.personalInfo,"composition-sign":m(me).holder.compositionSign,title:"投保人",onHandleSign:i[0]||(i[0]=e=>((e,i,a)=>{var s,o,n,t;const r=[q(e,i,null==(s=pe.value)?void 0:s.id,ie,a)],{id:l}=(null==(n=null==(o=me.value.insured)?void 0:o.personalInfo)?void 0:n[0])||{};Se.value&&r.push(q("INSURED",i,null==(t=pe.value)?void 0:t.id,ie,l)),Promise.all(r).then((e=>{Oe()}))})("HOLDER",e,m(me).holder.personalInfo.id))},null,8,["order-detail","sign-string","show-sign","show-verify","file-list","personal-info","composition-sign"])):b("",!0)]),m(Ie).scribing?(p(),y(r,I({key:0},m(ye),{title:"为了保障您的权益请抄录以下声明内容",onOnSubmit:we}),null,16)):b("",!0),h("div",Z,[g(l,{type:"primary",onClick:je},{default:S((()=>[j("确定")])),_:1})])])}}});export{K as default};
