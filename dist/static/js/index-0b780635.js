import{d as e,r as a,u as t,a as i,A as r,o as s,Z as l,V as o,b as n,c as d,F as u,e as c,w as m,j as p,f,h,g as v,i as k,E as y,k as b,ar as I,as as g,$ as j,ah as P,a$ as D,aQ as S,T as R}from"./index-aba19b63.js";import{d as L}from"./debounce-6981b306.js";import{c as O}from"./cloneDeep-f5e28e96.js";import{_ as V}from"./TrialButton-f8aaca38.js";import{u as C,b as x,p as w}from"./trial-04ccd671.js";import{a as T}from"./index-ee6d6392.js";import{i as F,T as _}from"./index-a5dd8b26.js";import{u as B}from"./useOrder-c52515f6.js";import"./isObjectLike-a9798079.js";import"./keysIn-b1e7a5ec.js";import"./_getTag-5c78de73.js";import"./index-0a18ee42.js";import"./infoCollection-d525b41a.js";import"./merge-84cb998c.js";import"./index-1b33d495.js";import"./ProRenderFormWithCard.vue_vue_type_style_index_0_scoped_true_lang-0b76c604.js";import"./phoneVerify-ed80a6d8.js";/* empty css              */import"./index-77332320.js";import"./useDicData-d20faf56.js";import"./bankCard-e403b462.js";import"./index-c03e7c1d.js";import"./index-07fe932c.js";import"./empty-ae586b6c.js";import"./box-title-58650290.js";import"./index-332aea5e.js";import"./trial-5a0125d5.js";import"./utils-67b294ce.js";import"./createProposal-6263cfc9.js";import"./constants-7afb7c3d.js";import"./nextStep-502de4c5.js";import"./core-8dfefd77.js";import"./constant-8927d485.js";const M=(e,a,t)=>{const i=e,{holder:r}=t,s=t.insuredList[0],l=(a||"").split("_");if(l.length<2)return a;if(F(Number(l[1])))return a;if(l[1]-=1,1===i.exemptFlag){if("to"===l[0]){let e=0;1===i.exemptType?(null==r?void 0:r.birthday)&&(e=parseInt(""+((new Date).getTime()-new Date(r.birthday).getTime())/31536e6,10)):2===i.exemptType&&(null==s?void 0:s.birthday)&&(e=parseInt(""+(+(new Date).getTime()-new Date(s.birthday).getTime())/31536e6,10)),l[1]=+l[1]-e}l[0]="year"}return l.join("_")};const q={class:"pop-header"},A={class:"header-title"},K=e({name:"TrialPop"}),$=e({...K,props:{dataSource:{default:()=>[]},productInfo:{default:()=>({productCode:"",productName:"",insurerCode:"",tenantId:"",planList:[]})},shareInfo:{default:()=>({})},tenantProductDetail:{default:()=>({})},hideBenefit:{type:Boolean,default:!1},hidePopupButton:{type:Boolean,default:!1},title:{default:"算一算保费"},defaultData:{default:null},currentOrderDetail:{default:null}},setup(e,{expose:F}){const K=e,$="试算中...",E=a(null),H=t();i(),H.query;const N=r({loading:!1,show:!1,select:{},list:[],userData:{},riskIsInsure:{},submitData:{},riskVOList:[{}],mainRiskVO:{},ifPersonalInfoSuccess:!1,trialMsg:"",trialResultPremium:0,trialResult:{initialPremium:0,initialAmount:0},isAniShow:!1,defaultValue:null,isAutoChange:!1,planIndex:0,isSkipFirstTrial:!1,hadSkipFirstTrial:!1}),Q=a(),U=B();a();const W=a(),Z=a(),z=()=>{console.log("---close"),N.show=!1,N.loading=!1},G=a({}),J=()=>{var e,a;N.riskIsInsure={},null==(a=null==(e=null==K?void 0:K.dataSource)?void 0:e.insureProductRiskVOList)||a.forEach((e=>{var a;const t=null==(a=K.dataSource.productRiskRelationVOList)?void 0:a.find((a=>a.collocationRiskId===e.riskId));t&&(N.riskIsInsure[e.riskCode]={selected:"2",data:null,relation:t})}))};L((async()=>{if(console.log(">>>>>调用试算<<<<<"),N.ifPersonalInfoSuccess){if(N.submitData.productCode=K.productInfo.productCode,N.submitData.tenantId=K.productInfo.tenantId,N.riskVOList=N.riskVOList.map((e=>(e=>{var a,t,i,r;const s=null==(a=K.dataSource.insureProductRiskVOList)?void 0:a.find((a=>e.riskId===a.riskId));if(s&&1!==s.mainRiskFlag){const a=null==(i=null==(t=K.dataSource)?void 0:t.productRiskRelationVOList)?void 0:i.find((e=>e.collocationRiskId===s.riskId));if(a){const t=null==(r=N.riskVOList)?void 0:r.find((e=>e.riskId===a.riskId));T.forEach((a=>{a.ruleKey&&s.productRiskInsureLimitVO&&t&&(1===s.productRiskInsureLimitVO[a.ruleKey]&&(e[a.valueKey]=t[a.valueKey]),3===s.productRiskInsureLimitVO[a.ruleKey]&&(1!==s.exemptFlag?e[a.valueKey]=M(s,t[a.valueKey],N.submitData):e[a.valueKey]=M(s,t[a.ruleValueKey],N.submitData)))}))}}return e})(e))),N.submitData.insuredVOList&&N.submitData.insuredVOList.forEach((e=>{e.productPlanVOList=[{insurerCode:K.productInfo.insurerCode,planCode:K.dataSource.planCode,riskVOList:N.riskVOList}]})),N.isSkipFirstTrial&&!N.hadSkipFirstTrial)return void(N.hadSkipFirstTrial=!0);console.log(">>>数据构建<<<",N.submitData);const e=O(N.submitData);await(async(e,a=!0)=>{N.trialMsg=$,N.trialResultPremium=0,N.loading=!0;let t=!1;if(a){const{code:a}=await C(e);t="10000"===a}!t&&a||(K.hideBenefit||x(e).then((e=>{e.data&&e.code===S&&(G.value=e.data)})).finally((()=>{N.loading=!1})),w(e).then((e=>{var a,t;if(e.data&&e.code===S){(null==(a=null==e?void 0:e.data)?void 0:a.errorInfo)&&R(`${null==(t=null==e?void 0:e.data)?void 0:t.errorInfo}`),N.trialMsg="",N.trialResultPremium=e.data.initialPremium,N.trialResult=e.data;const i={};e.data.riskPremiumDetailVOList&&e.data.riskPremiumDetailVOList.length&&e.data.riskPremiumDetailVOList.forEach((e=>{i[e.riskCode]={initialPremium:e.initialPremium,initialAmount:e.initialAmount}})),Z.value=i}})).finally((()=>{N.loading=!1})))})(e)}}),300);const X=()=>{N.isAniShow=!1},Y=()=>{N.trialMsg=$,N.trialResultPremium=0,N.loading=!0},ee=e=>{N.trialMsg="",N.trialResultPremium=e.initialPremium,N.trialResult=e,N.loading=!1};s((()=>{J()})),l((()=>{N.loading=!0})),o((()=>K.currentOrderDetail),(e=>{Q.value=e||U.value}),{deep:!0,immediate:!0});const ae=a();o((()=>K.tenantProductDetail),(()=>{var e,a,t;const i=((null==(e=null==K?void 0:K.tenantProductDetail)?void 0:e.PREMIUM)||[]).find((e=>{var a;return!e.planCode||e.planCode===(null==(a=null==K?void 0:K.dataSource)?void 0:a.planCode)}))||{};ae.value=null==(t=null==(a=(i.data||[]).sort(((e,a)=>+a.paymentFrequency-+e.paymentFrequency)))?void 0:a[0])?void 0:t.paymentFrequency}),{deep:!0,immediate:!0}),o((()=>N.show),(e=>{e&&(N.select={},N.list=[],N.userData={},N.riskIsInsure={},N.submitData={},N.riskVOList=[{}],N.mainRiskVO={},N.ifPersonalInfoSuccess=!1,N.trialMsg="",N.trialResultPremium=0,J())}));const te=()=>{N.show=!0,N.isAniShow=!0,N.isSkipFirstTrial=!0,N.hadSkipFirstTrial=!1};return F({open:te,close:z,getTrialSuccessFlag:()=>N.trialResultPremium>0}),o((()=>K.shareInfo),(()=>{W.value=K.shareInfo}),{deep:!0,immediate:!0}),(a,t)=>{const i=P,r=D;return n(),d(j,null,[e.hidePopupButton?h("",!0):(n(),d("div",{key:0,class:u(`trial-button ${a.$attrs.class}`)},[c(V,{"is-share":W.value.isShare,premium:f(N).trialResultPremium,"share-info":W.value,"loading-text":"","plan-code":K.dataSource.planCode,"payment-frequency":ae.value,"tenant-product-detail":e.tenantProductDetail,onHandleClick:te},{default:m((()=>[p("立即投保")])),_:1},8,["is-share","premium","share-info","plan-code","payment-frequency","tenant-product-detail"])],2)),f(N).isAniShow||f(N).show?(n(),v(r,{key:1,class:u(`com-trial-wrap ${a.$attrs.class}`),show:f(N).show,closeable:!1,onClose:z,onClosed:X},{default:m((()=>[c(_,{ref_key:"insureInfosRef",ref:E,"data-source":e.dataSource,"share-info":e.shareInfo,"is-trial":"","product-info":e.productInfo,"tenant-product-detail":e.tenantProductDetail,"hide-benefit":e.hideBenefit,"default-data":e.defaultData,"default-order":Q.value,onTrialStart:Y,onTrialEnd:ee},{trialHead:m((()=>[k("div",q,[k("span",A,y(e.title),1),c(i,{name:"cross",onClick:t[0]||(t[0]=e=>f(N).show=!1)})])])),trialBtn:m((t=>[b(a.$slots,"trialBtn",I(g(t)),(()=>{var a,i,r,s,l,o;return[c(V,{"is-share":W.value.isShare,premium:null==(a=t.riskPremium)?void 0:a.initialPremium,"share-info":W.value,"loading-text":f(N).trialMsg,"plan-code":K.dataSource.planCode,"payment-frequency":(null==(o=null==(l=null==(s=null==(r=null==(i=t.trialData)?void 0:i.insuredList)?void 0:r[0].productList)?void 0:s[0].riskList)?void 0:l[0])?void 0:o.paymentFrequency)+"","tenant-product-detail":e.tenantProductDetail,"handle-share":e=>((e,a)=>{E.value.onShare(e)})(e,t.trialData),disabled:!!f(N).trialMsg,onHandleClick:e=>(t.trialData,void E.value.onNext())},{default:m((()=>[p("立即投保")])),_:2},1032,["is-share","premium","share-info","loading-text","plan-code","payment-frequency","tenant-product-detail","handle-share","disabled","onHandleClick"])]}))])),_:3},8,["data-source","share-info","product-info","tenant-product-detail","hide-benefit","default-data","default-order"])])),_:3},8,["class","show"])):h("",!0)],64)}}});export{$ as default};
