import{ref as e,computed as n,watch as t,onBeforeMount as i}from"vue";import{h as r,Y as a,C as o,u as s,o as l,E as u,l as v,H as d,I as c,j as f,D as m,b as g,T as p,a0 as h,J as y,v as S}from"./index-d66a20d8.js";/* empty css              */import{a as N,q as C}from"./product-d1af8bd8.js";import{n as V}from"./nextStep-3971c3a9.js";import{g as k,i as w}from"./trial-0ac61dce.js";import{u as b}from"./useAttachment-2f6cf69c.js";import{_ as I,f as E,a as B,s as j}from"./verify-c7e58246.js";import{u as L}from"./useOrder-d2812e23.js";import{t as x}from"./PayInfo-b4b67b23.js";import{P as D,B as O}from"./constants-7afb7c3d.js";import"./pdfh5-e588f83d.js";import"./core-15eeb464.js";import"./constant-8927d485.js";import"./utils-57fec98c.js";import"./infoCollection-e6a8a0ee.js";import"./trial-b3f7bf73.js";import"./merge-e7788e50.js";import"./keysIn-131bbce9.js";import"./isObjectLike-a9798079.js";import"./_getTag-d5b47d26.js";import"./debounce-6981b306.js";import"./phoneVerify-a37057a4.js";import"./useDicData-b539129e.js";import"./bankCard-54e59047.js";const T={class:"com-sign-part"},_={class:"people"},P={class:"name"},R={key:0,class:"verify-item"},U=vue.createElementVNode("div",{class:"label"},"证件号码",-1),A={class:"no"},M={class:"sign-status"},F={class:"status"},H=["src"],Y={key:1,class:"sign-desc"},q={class:"sign-body"},G={class:"date"},$={class:"file"},J=vue.defineComponent({name:"signPart"}),z=vue.defineComponent({...J,props:{signString:{default:""},personalInfo:{default:()=>({})},fileList:{},title:{default:""},showSign:{type:Boolean,default:!1},showVerify:{type:Boolean,default:!1},showShareSign:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1}},emits:["handleVerify","handleSign"],setup(i,{expose:s,emit:l}){const u=i,v=e({}),d=e(""),c=e([]),f=e({});e(!0);const m=e(!1),g=e(0),{fileList:p}=b(f,c),h=e=>`${e}`===o.CERT,y=n((()=>r().format("YYYY-MM-DD"))),S=()=>{var e,n;l("handleVerify",null==(e=v.value)?void 0:e.name,null==(n=v.value)?void 0:n.certNo)},N=()=>{m.value=!1},C=e(),V=()=>{C.value&&C.value.rewrite()},k=()=>{u.disabled||C.value&&C.value.openSign()},w=e=>{l("handleSign",e)};return s({validateSign:()=>new Promise(((e,n)=>{d.value?e(!0):n(new Error(`请${u.title}完成签名后，去支付`))})),validateVerify:()=>new Promise(((e,n)=>{var t;(null==(t=u.personalInfo)?void 0:t.isCert)!==a.YES?n(new Error(`请${u.title}完成认证后，去支付`)):e(!0)}))}),t((()=>u.signString),(()=>{d.value=u.signString}),{immediate:!0}),t((()=>u.personalInfo),(()=>{v.value=u.personalInfo}),{deep:!0,immediate:!0}),(e,n)=>{const t=vue.resolveComponent("ProSvg"),i=vue.resolveComponent("ProCard"),r=vue.resolveComponent("AttachmentList"),o=vue.resolveComponent("FilePreview");return vue.openBlock(),vue.createElementBlock("div",T,[vue.createVNode(i,{title:e.title,class:"card"},{extra:vue.withCtx((()=>{var n,t,i,r;return[vue.createElementVNode("div",_,[vue.createElementVNode("div",P,vue.toDisplayString(null==(n=vue.unref(v))?void 0:n.name),1),e.showVerify&&h(null==(t=vue.unref(v))?void 0:t.certType)?(vue.openBlock(),vue.createElementBlock("div",{key:0,class:vue.normalizeClass(["status",{verified:(null==(i=vue.unref(v))?void 0:i.isCert)===vue.unref(a).YES}])},vue.toDisplayString((null==(r=vue.unref(v))?void 0:r.isCert)===vue.unref(a).YES?"已认证":"待认证"),3)):vue.createCommentVNode("",!0)])]})),default:vue.withCtx((()=>{var n,i,r,o;return[e.showVerify&&(null==(n=vue.unref(v))?void 0:n.certNo)?(vue.openBlock(),vue.createElementBlock("div",R,[U,vue.createElementVNode("div",A,vue.toDisplayString(null==(i=vue.unref(v))?void 0:i.certNo),1),(null==(r=vue.unref(v))?void 0:r.isCert)!==vue.unref(a).YES&&h(null==(o=vue.unref(v))?void 0:o.certType)?(vue.openBlock(),vue.createElementBlock("div",{key:0,class:"action",onClick:S},[vue.createTextVNode(" 去认证 "),vue.createVNode(t,{name:"right_arrow",class:"icon"})])):vue.createCommentVNode("",!0)])):vue.createCommentVNode("",!0)]})),_:1},8,["title"]),e.showSign?(vue.openBlock(),vue.createBlock(i,{key:0,title:`${e.title}签名`,"show-icon":!1,class:"sign-card","show-line":!1},{extra:vue.withCtx((()=>[vue.createElementVNode("div",M,[vue.createElementVNode("div",F,vue.toDisplayString(vue.unref(d)?"已签名":"未签名"),1),e.disabled?vue.createCommentVNode("",!0):(vue.openBlock(),vue.createElementBlock("div",{key:0,class:"resign",onClick:V},"重签"))])])),default:vue.withCtx((()=>{var e;return[vue.createVNode(I,{ref_key:"signRef",ref:C,modelValue:vue.unref(d),"onUpdate:modelValue":n[0]||(n[0]=e=>vue.isRef(d)?d.value=e:null),class:"sign",onSubmitSign:w},{signImg:vue.withCtx((({data:e})=>[vue.createElementVNode("div",{class:"sign-board",onClick:k},[e?(vue.openBlock(),vue.createElementBlock("img",{key:0,src:e,class:"sign-img",alt:""},null,8,H)):(vue.openBlock(),vue.createElementBlock("span",Y,"请签名"))])])),_:1},8,["modelValue"]),vue.createElementVNode("div",q,[vue.createElementVNode("div",G,"签名日期： "+vue.toDisplayString(vue.unref(y)),1),vue.createElementVNode("div",$,[(null==(e=vue.unref(p))?void 0:e.length)?(vue.openBlock(),vue.createBlock(r,{key:0,"attachment-list":vue.unref(p),"pre-text":"签名将被用于以下文件：",onPreviewFile:n[1]||(n[1]=e=>(e=>{g.value=e,m.value=!0})(e))},null,8,["attachment-list"])):vue.createCommentVNode("",!0)])])]})),_:1},8,["title"])):vue.createCommentVNode("",!0),vue.unref(m)?(vue.openBlock(),vue.createBlock(o,{key:1,show:vue.unref(m),"onUpdate:show":n[2]||(n[2]=e=>vue.isRef(m)?m.value=e:null),"content-list":vue.unref(p),"is-only-view":"","active-index":vue.unref(g),text:"关闭",onOnCloseFilePreviewByMask:N},null,8,["show","content-list","active-index"])):vue.createCommentVNode("",!0)])}}}),W=2,X=1,K=2,Q=3;const Z={class:"long-verify"},ee={class:"header"},ne={class:"verify-content"},te={class:"footer-button footer-bar"},ie=vue.createElementVNode("div",{class:"text"},"刷新",-1),re=vue.defineComponent({__name:"verify",setup(n){const t=s(),{productCode:r="",tenantId:o,agentCode:b="",agencyCode:I,saleChannelId:T,saleUserId:_,orderNo:P,orderCode:R,extraInfo:U,isShare:A,insurerCode:M,preview:F}=t.query;let H={};try{H=JSON.parse(decodeURIComponent(U))}catch(pe){}const Y=L(),q=`${window.origin}/baseInsurance/long/phoneVerify?${l.stringify({...t.query,orderNo:R||P})}`;console.log("shareLink",q);const G=new u({source:"localStorage"});e({});const $=e({}),J=e(),re=e(),ae=e(),oe=e({holder:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""},insured:{fileList:[],personalInfo:[],isSign:!1,isVerify:!1,isShareSign:!1,signData:{}},agent:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""}}),se=(e,n)=>{let t=window.location.href;t=t.includes("orderCode")?t:t.replace("orderNo","orderCode"),B({callbackUrl:t,certiNo:n,faceAuthMode:"TENCENT",userName:e,tenantId:o}).then((({code:t,data:i})=>{if("10000"===t){const{originalUrl:t,serialNo:r}=i;window.location.href=t,v.set("verifyData",{serialNo:r,certNo:n,name:e})}}))},le=(e,n,t)=>{var i;j(e,n,null==(i=Y.value)?void 0:i.id,o,t)},ue=e({sign:[],verify:[]}),ve=()=>{if(F)return void f(D.SIGN,t.query);const e=[];J.value&&ue.value.sign.includes("1")&&e.push(J.value.validateSign()),re.value&&((A?ue.value.sign.includes("4"):ue.value.sign.includes("2"))&&e.push(re.value.validateSign()),ue.value.verify.includes("1")&&e.push(re.value.validateVerify())),ae.value&&((A?ue.value.sign.includes("5"):ue.value.sign.includes("3"))&&e.push(...(ae.value||[]).map((e=>e.validateSign()))),ue.value.verify.includes("2")&&e.push(...(ae.value||[]).map((e=>e.validateVerify())))),Promise.all(e).then((e=>{P&&k({orderNo:R||P,saleUserId:_,tenantId:o}).then((({code:e,data:n})=>{"10000"===e&&m.confirm({title:"提示",message:"请确认信息填写无误后，再进行支付"}).then((()=>{Object.assign(Y.value,{extInfo:{...Y.value.extInfo,buttonCode:O.SIGN,pageCode:D.SIGN}}),V(Y.value,((e,n)=>{n===g.JUMP_URL&&(window.location.href=e.paymentUrl)}))}))}))})).catch((e=>{p(e.message)}))},de=e(),ce=()=>{J.value.validateSign().then((()=>{de.value&&de.value.handleShare()})).catch((()=>{p("请完成代理人签字后进行分享")}))},fe=(e=!1)=>{P&&k({orderNo:R||P,tenantId:o}).then((({code:n,data:t})=>{var i;"10000"===n&&(e&&((null==(i=null==t?void 0:t.holder)?void 0:i.isCert)===a.NO||(null==t?void 0:t.insuredList.some((e=>e.isCert===a.NO)))?p("用户未完身份认证及签字"):(null==t?void 0:t.tenantOrderAttachmentList.find((e=>e.category===h.ELECTRIC_SIGN&&e.objectType===y.HOLDER)))&&(null==t?void 0:t.tenantOrderAttachmentList.find((e=>e.category===h.ELECTRIC_SIGN&&e.objectType===y.INSURED)))||p("用户未完身份认证及签字")),Object.assign(Y.value,t),oe.value.holder.personalInfo=t.holder,oe.value.insured.personalInfo=t.insuredList,t.tenantOrderAttachmentList.forEach((e=>{e.objectType===X?oe.value.holder.signData=e.fileBase64:e.objectType===Q?oe.value.agent.signData=e.fileBase64:e.objectType===K&&(oe.value.insured.signData[e.objectId]=e.fileBase64)})))}))},me=()=>{fe(!0)},ge=e({imgUrl:"",desc:"",title:"",link:q});return i((()=>{N({productCode:r,tenantId:o}).then((({data:e,code:n})=>{if("10000"===n){const{wxShareConfig:n,showWXShare:t,title:i,desc:r,image:a}=(null==e?void 0:e.PRODUCT_LIST)||{};t?Object.assign(ge.value,{...n,imgUrl:n.image,isShare:t}):Object.assign(ge.value,{title:i,desc:r,imgUrl:a,isShare:t}),e.BASIC_INFO&&e.BASIC_INFO.themeType&&S(e.BASIC_INFO.themeType)}})),C({productCode:r}).then((({code:e,data:n})=>{var t;if("10000"===e){const{productMaterialMap:e}=(null==(t=n.productInsureMaterialVOList)?void 0:t[0])||{};(Object.values(e||{})||[]).flat().filter((e=>e.materialType===W)).forEach((e=>{e.noticeObject===Q?oe.value.agent.fileList.push(e):e.noticeObject===X?oe.value.holder.fileList.push(e):e.noticeObject===K&&oe.value.insured.fileList.push(e)}))}})),w({productCode:r,isTenant:!F}).then((({data:e,code:n})=>{var t;if("10000"===n){$.value=e;const{productFactor:n}=(null==(t=e.productPlanInsureVOList)?void 0:t[0])||{},{signInfo:i}=x(n);i.schema.forEach((e=>{"eleSign"===e.name&&e.columns.forEach((n=>{e.required&&ue.value.sign.push(n.code),"1"===n.code?oe.value.agent.isSign=!0:"2"===n.code?oe.value.holder.isSign=!0:"3"===n.code?oe.value.insured.isSign=!0:"4"===n.code?oe.value.holder.isShareSign=!0:"5"===n.code&&(oe.value.insured.isShareSign=!0)})),"customerFace"===e.name&&e.columns.forEach((n=>{e.required&&ue.value.verify.push(n.code),"1"===n.code?oe.value.holder.isVerify=!0:"2"===n.code&&(oe.value.insured.isVerify=!0)}))}))}})),fe();const e=v.get("verifyData");if(e){const{serialNo:n,certNo:t,name:i}=e;E({certiNo:t,orderNo:R||P,serialNo:n,tenantId:o,userName:i}).then((e=>{const{code:n,data:t}=e;"10000"===n&&(G.remove("verifyData"),fe())}))}})),(e,n)=>{const t=vue.resolveComponent("ProNavigator"),i=vue.resolveComponent("ProMessage"),r=vue.resolveComponent("ProSvg"),a=vue.resolveComponent("van-button");return vue.openBlock(),vue.createElementBlock("div",Z,[vue.createVNode(t),vue.createElementVNode("div",ee,[vue.createVNode(i,{type:"warning",title:"尊敬的客户，本次投保需要进行身份认证",content:"本产品投保需要对投保人、被保人进行实名认证，您购买本产品的累计总保费已超过20万，按监管要求，需要提供投保人、被保人、指定受益人证件影像，本产品非本人投保且带身故责任、需对投保人、被保人（成人）的投保意愿进行签字确认。"})]),vue.createElementVNode("div",ne,[vue.createVNode(z,{ref_key:"agentSignRef",ref:J,"order-detail":vue.unref(Y),"sign-string":vue.unref(oe).agent.signData,"show-sign":vue.unref(oe).agent.isSign,"show-verify":vue.unref(oe).agent.isVerify,"file-list":vue.unref(oe).agent.fileList,"personal-info":vue.unref(oe).agent.personalInfo,disabled:!!vue.unref(A),title:"代理人",onHandleSign:n[0]||(n[0]=e=>le("AGENT",e))},null,8,["order-detail","sign-string","show-sign","show-verify","file-list","personal-info","disabled"]),!vue.unref(A)||vue.unref(oe).holder.isShareSign?(vue.openBlock(),vue.createBlock(z,{key:0,ref_key:"holderSignRef",ref:re,"order-detail":vue.unref(Y),"sign-string":vue.unref(oe).holder.signData,"show-sign":vue.unref(A)?vue.unref(oe).holder.isShareSign:vue.unref(oe).holder.isSign,"show-verify":vue.unref(oe).holder.isVerify,"file-list":vue.unref(oe).holder.fileList,"personal-info":vue.unref(oe).holder.personalInfo,title:"投保人",onHandleSign:n[1]||(n[1]=e=>le("HOLDER",e,vue.unref(oe).holder.personalInfo.id)),onHandleVerify:se},null,8,["order-detail","sign-string","show-sign","show-verify","file-list","personal-info"])):vue.createCommentVNode("",!0),!vue.unref(A)||vue.unref(oe).insured.isShareSign?(vue.openBlock(!0),vue.createElementBlock(vue.Fragment,{key:1},vue.renderList(vue.unref(oe).insured.personalInfo||[],(e=>(vue.openBlock(),vue.createBlock(z,{key:e.id,ref_for:!0,ref_key:"insuredSignRef",ref:ae,"data-source":[],"order-detail":vue.unref(Y),"sign-string":vue.unref(oe).insured.signData[e.id],"show-sign":vue.unref(A)?vue.unref(oe).insured.isShareSign:vue.unref(oe).insured.isSign,"show-verify":vue.unref(oe).insured.isVerify,"file-list":vue.unref(oe).insured.fileList,"personal-info":e||{},title:"被保人",onHandleSign:n=>le("INSURED",n,e.id),onHandleVerify:se},null,8,["order-detail","sign-string","show-sign","show-verify","file-list","personal-info","onHandleSign"])))),128)):vue.createCommentVNode("",!0)]),vue.createElementVNode("div",te,[vue.createElementVNode("div",{class:"refresh-btn",onClick:me},[vue.createElementVNode("div",null,[vue.createVNode(r,{name:"refresh"})]),ie]),!vue.unref(A)&&vue.unref(d)()?(vue.openBlock(),vue.createBlock(c,vue.mergeProps({key:0,ref_key:"shareRef",ref:de},vue.unref(ge),{onClick:vue.withModifiers(ce,["stop"])}),{default:vue.withCtx((()=>[vue.createVNode(a,{plain:"",type:"primary",class:"share-btn"},{default:vue.withCtx((()=>[vue.createTextVNode("分享")])),_:1})])),_:1},16,["onClick"])):vue.createCommentVNode("",!0),vue.createVNode(a,{type:"primary",class:"submit-btn",onClick:ve},{default:vue.withCtx((()=>[vue.createTextVNode("确认支付")])),_:1})])])}}});export{re as default};
