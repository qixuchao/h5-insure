import{reactive as e,onBeforeMount as t,onMounted as a,watch as i}from"vue";import{d as r}from"./debounce-6981b306.js";import{c as l}from"./cloneDeep-6abacc69.js";import{u as n,a as o,G as u,T as s}from"./index-deb4ddfb.js";import{_ as d}from"./TrialButton-46a442f7.js";import{u as c,b as m,p}from"./trial-90e504aa.js";import{P as f}from"./index-9ba6d482.js";import{i as V,T as h}from"./index-83ab55b1.js";import{u as v}from"./useOrder-d6d1fc9b.js";const k=(e,t,a)=>{const i=e,{holder:r}=a,l=a.insuredList[0],n=(t||"").split("_");if(n.length<2)return t;if(V(Number(n[1])))return t;if(n[1]-=1,1===i.exemptFlag){if("to"===n[0]){let e=0;1===i.exemptType?(null==r?void 0:r.birthday)&&(e=parseInt(""+((new Date).getTime()-new Date(r.birthday).getTime())/31536e6,10)):2===i.exemptType&&(null==l?void 0:l.birthday)&&(e=parseInt(""+(+(new Date).getTime()-new Date(l.birthday).getTime())/31536e6,10)),n[1]=+n[1]-e}n[0]="year"}return n.join("_")};const y={class:"pop-header"},I={class:"header-title"},P=Vue.defineComponent({name:"TrialPop"}),g=Vue.defineComponent({...P,props:{dataSource:{default:()=>[]},productInfo:{default:()=>({productCode:"",productName:"",insurerCode:"",tenantId:"",planList:[]})},shareInfo:{default:()=>({})},tenantProductDetail:{default:()=>({})},hideBenefit:{type:Boolean,default:!1},hidePopupButton:{type:Boolean,default:!1},title:{default:"算一算保费"},defaultData:{default:null},currentOrderDetail:{default:null}},setup(V,{expose:P}){const g=V,C="试算中...",D=Vue.ref(null),b=n();o(),b.query;const S=e({loading:!1,show:!1,select:{},list:[],userData:{},riskIsInsure:{},submitData:{},riskVOList:[{}],mainRiskVO:{},ifPersonalInfoSuccess:!1,trialMsg:"",trialResultPremium:0,trialResult:{initialPremium:0,initialAmount:0},isAniShow:!1,defaultValue:null,isAutoChange:!1,planIndex:0,isSkipFirstTrial:!1,hadSkipFirstTrial:!1}),R=Vue.ref(),w=v();Vue.ref();const L=Vue.ref(),O=Vue.ref(),T=()=>{console.log("---close"),S.show=!1,S.loading=!1},x=Vue.ref({}),B=()=>{var e,t;S.riskIsInsure={},null==(t=null==(e=null==g?void 0:g.dataSource)?void 0:e.insureProductRiskVOList)||t.forEach((e=>{var t;const a=null==(t=g.dataSource.productRiskRelationVOList)?void 0:t.find((t=>t.collocationRiskId===e.riskId));a&&(S.riskIsInsure[e.riskCode]={selected:"2",data:null,relation:a})}))};r((async()=>{if(console.log(">>>>>调用试算<<<<<"),S.ifPersonalInfoSuccess){if(S.submitData.productCode=g.productInfo.productCode,S.submitData.tenantId=g.productInfo.tenantId,S.riskVOList=S.riskVOList.map((e=>(e=>{var t,a,i,r;const l=null==(t=g.dataSource.insureProductRiskVOList)?void 0:t.find((t=>e.riskId===t.riskId));if(l&&1!==l.mainRiskFlag){const t=null==(i=null==(a=g.dataSource)?void 0:a.productRiskRelationVOList)?void 0:i.find((e=>e.collocationRiskId===l.riskId));if(t){const a=null==(r=S.riskVOList)?void 0:r.find((e=>e.riskId===t.riskId));f.forEach((t=>{t.ruleKey&&l.productRiskInsureLimitVO&&a&&(1===l.productRiskInsureLimitVO[t.ruleKey]&&(e[t.valueKey]=a[t.valueKey]),3===l.productRiskInsureLimitVO[t.ruleKey]&&(1!==l.exemptFlag?e[t.valueKey]=k(l,a[t.valueKey],S.submitData):e[t.valueKey]=k(l,a[t.ruleValueKey],S.submitData)))}))}}return e})(e))),S.submitData.insuredVOList&&S.submitData.insuredVOList.forEach((e=>{e.productPlanVOList=[{insurerCode:g.productInfo.insurerCode,planCode:g.dataSource.planCode,riskVOList:S.riskVOList}]})),S.isSkipFirstTrial&&!S.hadSkipFirstTrial)return void(S.hadSkipFirstTrial=!0);console.log(">>>数据构建<<<",S.submitData);const e=l(S.submitData);await(async(e,t=!0)=>{S.trialMsg=C,S.trialResultPremium=0,S.loading=!0;let a=!1;if(t){const{code:t}=await c(e);a="10000"===t}!a&&t||(g.hideBenefit||m(e).then((e=>{e.data&&e.code===u&&(x.value=e.data)})).finally((()=>{S.loading=!1})),p(e).then((e=>{var t,a;if(e.data&&e.code===u){(null==(t=null==e?void 0:e.data)?void 0:t.errorInfo)&&s(`${null==(a=null==e?void 0:e.data)?void 0:a.errorInfo}`),S.trialMsg="",S.trialResultPremium=e.data.initialPremium,S.trialResult=e.data;const i={};e.data.riskPremiumDetailVOList&&e.data.riskPremiumDetailVOList.length&&e.data.riskPremiumDetailVOList.forEach((e=>{i[e.riskCode]={initialPremium:e.initialPremium,initialAmount:e.initialAmount}})),O.value=i}})).finally((()=>{S.loading=!1})))})(e)}}),300);const F=()=>{S.isAniShow=!1},N=()=>{S.trialMsg=C,S.trialResultPremium=0,S.loading=!0},E=e=>{S.trialMsg="",S.trialResultPremium=e.initialPremium,S.trialResult=e,S.loading=!1};t((()=>{B()})),a((()=>{S.loading=!0})),i((()=>g.currentOrderDetail),(e=>{R.value=e||w.value}),{deep:!0,immediate:!0});const M=Vue.ref();i((()=>g.tenantProductDetail),(()=>{var e,t,a;const i=((null==(e=null==g?void 0:g.tenantProductDetail)?void 0:e.PREMIUM)||[]).find((e=>{var t;return!e.planCode||e.planCode===(null==(t=null==g?void 0:g.dataSource)?void 0:t.planCode)}))||{};M.value=null==(a=null==(t=(i.data||[]).sort(((e,t)=>+t.paymentFrequency-+e.paymentFrequency)))?void 0:t[0])?void 0:a.paymentFrequency}),{deep:!0,immediate:!0}),i((()=>S.show),(e=>{e&&(S.select={},S.list=[],S.userData={},S.riskIsInsure={},S.submitData={},S.riskVOList=[{}],S.mainRiskVO={},S.ifPersonalInfoSuccess=!1,S.trialMsg="",S.trialResultPremium=0,B())}));const j=()=>{S.show=!0,S.isAniShow=!0,S.isSkipFirstTrial=!0,S.hadSkipFirstTrial=!1};return P({open:j,close:T,getTrialSuccessFlag:()=>S.trialResultPremium>0}),i((()=>g.shareInfo),(()=>{L.value=g.shareInfo}),{deep:!0,immediate:!0}),(e,t)=>{const a=Vue.resolveComponent("van-icon"),i=Vue.resolveComponent("ProPopup");return Vue.openBlock(),Vue.createElementBlock(Vue.Fragment,null,[e.hidePopupButton?Vue.createCommentVNode("",!0):(Vue.openBlock(),Vue.createElementBlock("div",{key:0,class:Vue.normalizeClass(`trial-button ${e.$attrs.class}`)},[Vue.createVNode(d,{"is-share":L.value.isShare,premium:Vue.unref(S).trialResultPremium,"share-info":L.value,"loading-text":"","plan-code":g.dataSource.planCode,"payment-frequency":M.value,"tenant-product-detail":e.tenantProductDetail,onHandleClick:j},{default:Vue.withCtx((()=>[Vue.createTextVNode("立即投保")])),_:1},8,["is-share","premium","share-info","plan-code","payment-frequency","tenant-product-detail"])],2)),Vue.unref(S).isAniShow||Vue.unref(S).show?(Vue.openBlock(),Vue.createBlock(i,{key:1,class:Vue.normalizeClass(`com-trial-wrap ${e.$attrs.class}`),show:Vue.unref(S).show,closeable:!1,onClose:T,onClosed:F},{default:Vue.withCtx((()=>[Vue.createVNode(h,{ref_key:"insureInfosRef",ref:D,"data-source":e.dataSource,"share-info":e.shareInfo,"is-trial":"","product-info":e.productInfo,"tenant-product-detail":e.tenantProductDetail,"hide-benefit":e.hideBenefit,"default-data":e.defaultData,"default-order":R.value,onTrialStart:N,onTrialEnd:E},{trialHead:Vue.withCtx((()=>[Vue.createElementVNode("div",y,[Vue.createElementVNode("span",I,Vue.toDisplayString(e.title),1),Vue.createVNode(a,{name:"cross",onClick:t[0]||(t[0]=e=>Vue.unref(S).show=!1)})])])),trialBtn:Vue.withCtx((t=>[Vue.renderSlot(e.$slots,"trialBtn",Vue.normalizeProps(Vue.guardReactiveProps(t)),(()=>{var a,i,r,l,n,o;return[Vue.createVNode(d,{"is-share":L.value.isShare,premium:null==(a=t.riskPremium)?void 0:a.initialPremium,"share-info":L.value,"loading-text":Vue.unref(S).trialMsg,"plan-code":g.dataSource.planCode,"payment-frequency":(null==(o=null==(n=null==(l=null==(r=null==(i=t.trialData)?void 0:i.insuredList)?void 0:r[0].productList)?void 0:l[0].riskList)?void 0:n[0])?void 0:o.paymentFrequency)+"","tenant-product-detail":e.tenantProductDetail,"handle-share":e=>((e,t)=>{D.value.onShare(e)})(e,t.trialData),disabled:!!Vue.unref(S).trialMsg,onHandleClick:e=>(t.trialData,void D.value.onNext())},{default:Vue.withCtx((()=>[Vue.createTextVNode("立即投保")])),_:2},1032,["is-share","premium","share-info","loading-text","plan-code","payment-frequency","tenant-product-detail","handle-share","disabled","onHandleClick"])]}))])),_:3},8,["data-source","share-info","product-info","tenant-product-detail","hide-benefit","default-data","default-order"])])),_:3},8,["class","show"])):Vue.createCommentVNode("",!0)],64)}}});export{g as _};
