import{d as e,k as a,i,h as t,r as s,l as r,at as l,T as u,z as o,ar as d,O as n,o as c,c as p,g as f,a as v,b as m,u as k,n as L,s as h,F as y,f as I,w as g,e as C,au as R,a8 as P,_ as b,av as D,aw as O,ax as V,ay as T,az as S,aA as M,aB as w,aC as _,aD as j,ap as E,aq as A}from"./index-dc5ec44c.js";import{d as N}from"./debounce-6981b306.js";import{c as F}from"./cloneDeep-5d541e55.js";import{_ as x}from"./InsureInfos-9b569f61.js";import{P as $}from"./index-dae080f5.js";import{b as B,R as U,a as q}from"./trial-ce912ff9.js";import{H as K,P as Q,B as H}from"./constants-f9677f84.js";import{u as z,b as G,p as J,c as W,d as X,e as Y}from"./trial-7511f230.js";import{u as Z}from"./useOrder-055f3aa3.js";import{t as ee}from"./utils-c770f39f.js";import{n as ae}from"./nextStep-66a8620e.js";const ie=(e,a)=>{const i=[],t={};return null==e||e.forEach((e=>{t[e.riskId]=e})),null==a||a.forEach((e=>{var a,s,r,l;const{collocationType:u,collocationRiskId:o,riskId:d}=e;switch(u){case 2:{const e=null==(a=t[d])?void 0:a.riskName,r=null==(s=t[o])?void 0:s.riskName;i.push(`${e} 和 ${r} 必须同时投保`);break}case 3:{const e=null==(r=t[d])?void 0:r.riskName,a=null==(l=t[o])?void 0:l.riskName;i.push(`${e} 和 ${a} 不能同时投保`);break}}})),i};const te=e=>(E("data-v-8691e138"),e=e(),A(),e),se={class:"com-body"},re={class:"trial-body"},le={class:"container"},ue={class:"container"},oe={key:0,class:"product-list"},de={class:"operate-bar"},ne=["onClick"],ce=["onClick"],pe={class:"premium-item"},fe=te((()=>v("span",{class:"label"},"首期保费",-1))),ve={class:"price"},me={key:1,class:"add-main-risk"},ke=te((()=>v("div",{class:"empty"},null,-1))),Le=e({name:"TrialBody"});var he=b(e({...Le,props:{selfKey:{default:""},dataSource:{default:()=>[]},productInfo:{default:()=>({productCode:"",productName:"",insurerCode:"",tenantId:"",planList:[]})},tenantProductDetail:{default:()=>({})},hideBenefit:{type:Boolean,default:!1},hidePopupButton:{type:Boolean,default:!1},title:{default:"算一算保费"},defaultData:{default:null},isTrial:{type:Boolean,default:!1},defaultOrder:{default:()=>({})},productCollection:{default:()=>({})},productFactor:{default:()=>({})}},emits:["trialStart","trialEnd","update:userData","closeCustomerPopoup","addRisk","addMainRisk","deleteRisk"],setup(e,{expose:b,emit:E}){const A=e,te=a(null),Le=i();t();const{tenantId:he,templateId:ye,preview:Ie}=Le.query,ge=a(),Ce=s({loading:!1,show:!1,select:{},list:[],userData:{},riskIsInsure:{},submitData:{},riskList:{},mainRiskVO:{},ifPersonalInfoSuccess:!1,trialMsg:"",trialResultPremium:0,trialResult:{initialPremium:0,initialAmount:0},isAniShow:!1,defaultValue:null,isAutoChange:!1,planIndex:0,isSkipFirstTrial:!1,hadSkipFirstTrial:!1,isQuerying:!1,currentPlanCode:""}),Re=Z();a();const Pe=a(),be=a(A.dataSource),De=a([]),Oe=a(),Ve=a(),Te=r((()=>{var e,a;return![B.SINGLE_PRODUCT,B.TWO_PRODUCT].includes(null==(a=null==(e=Object.values(A.productCollection))?void 0:e[0])?void 0:a.productClass)})),Se=()=>{E("addMainRisk",Ce.userData.insuredList)},Me=e=>{const{holder:a,insuredList:i}=e||{};a&&(Ce.submitData.holder=a),i&&i.length>0&&i.forEach(((e,a)=>{var i;Ce.submitData.insuredList&&Ce.submitData.insuredList.length>a?Ce.submitData.insuredList[a]=e:((null==(i=Ce.submitData)?void 0:i.insuredList)||(Ce.submitData.insuredList=[]),Ce.submitData.insuredList.push(e))}))},we=r((()=>A.productInfo.planList&&A.productInfo.planList.length>2)),_e=(e,a)=>{if(e){const i=["birthday","age","gender","id"];a.includes("occupationCodeList")&&i.push("occupationClass"),Object.keys(e).forEach((t=>{[...a,...i].includes(t)||(e[t]=null)}))}},je=(e,a=(e=>!0))=>O(e)?e.filter(a).map((e=>e.code)):[],Ee=()=>{console.log("--current plan = ",be.value),console.log("---current submit = ",Ce.submitData);const e=F(Ce.submitData);if(!we.value)return e;const{1:a,2:i,3:t}=be.value.productFactor||{};if(e.holder&&_e(e.holder,je(a)),e.insuredList){const a=["productList","beneficiaryList"],s=je(i,(e=>"2"!==String(e.subModuleType))),r=je(i,(e=>"2"===String(e.subModuleType))),l=O(r),u=je(t),o=O(u);e.insuredList.forEach(((e,i)=>{var t,d,n;_e(e,[...i>=1&&l?r:s,...a,...o?["insuredBeneficiaryType"]:[]]),(null==(t=e.beneficiaryList)?void 0:t.length)>0&&(o?e.beneficiaryList.forEach((e=>_e(e,u))):e.beneficiaryList.length=0),e.planCode=be.value.planCode;const c=(null==(n=null==(d=e.productList)?void 0:d[0])?void 0:n.riskList)||[],p=be.value.insureProductRiskVOList||[];if(c.length&&p){const a=c.filter((e=>null!==p.find((a=>a.riskCode===e.riskCode))));e.productList[0].riskList=a}}))}return e},Ae=a({}),Ne=["annuityDrawDate","coveragePeriod","chargePeriod","paymentFrequency"],Fe=a({}),xe=N((async(e,a=!0)=>{Ce.trialMsg="试算中...",Ce.trialResultPremium=0,Ce.loading=!0,E("trialStart");let i=!1;if(a){const{code:a}=await z(e);i="10000"===a}!i&&a||(Ce.isQuerying=!0,A.hideBenefit||G(e).then((e=>{e.data&&e.code===l&&(Ae.value=e.data)})).finally((()=>{Ce.loading=!1})),J(e).then((({code:a,data:i})=>{var t,s;i&&a===l&&((null==i?void 0:i.errorInfo)&&u(`${null==i?void 0:i.errorInfo}`),Ce.trialMsg="",Ce.trialResultPremium=i.initialPremium,Ce.trialResult=i,null==(s=null==(t=i.insuredPremiumList)?void 0:t[0])||s.productPremiumList.forEach((e=>{Fe.value[e.productCode]=e.riskPremiumDetailVOList})),E("trialEnd",i,e))})).finally((()=>{Ce.loading=!1,Ce.isQuerying=!1})))}),500),$e=N((async()=>{var e,a,i,t;const{productCode:s,productName:r}=A.productInfo||{};if(Ce.ifPersonalInfoSuccess||(null==(a=null==(e=ge.value)?void 0:e.canTrail)?void 0:a.call(e))){Ce.submitData.tenantId=A.productInfo.tenantId,(null==(i=Ce.submitData.insuredList)?void 0:i.length)&&(Ce.submitData.insuredList=null==(t=Ce.submitData)?void 0:t.insuredList.map((e=>({...e,productList:null==e?void 0:e.productList.map((e=>({...e,productName:r,riskList:Ce.riskList[e.productCode]})))}))));const e=Ee();console.log(">>>数据构建<<<",e),await xe(e)}}),300),Be=async e=>{console.log("人的信息更改了"),Me(e),Ce.ifPersonalInfoSuccess=!0,console.log("处理第一被保人修改的dy变化"),$e()};r((()=>{var e;return((null==(e=Ce.userData)?void 0:e.insuredList)||[]).map((e=>e.birthday)).join(",")})),o((()=>{var e;return((null==(e=Ce.userData)?void 0:e.insuredList)||[]).map((e=>e.birthday)).join(",")}),N((async e=>{if(e){const e=Ce.userData.insuredList.filter((e=>e.birthday))||[];if(!e.length)return;const a=Object.keys(Oe.value).map((e=>({productCode:e,planCode:"",riskEditVOList:Oe.value[e].productPlanInsureVOList[0].insureProductRiskVOList.map((e=>({insureProductRiskVO:e})))})));await W({calcProductFactorList:a,insuredVOList:e,holderVO:Ce.userData.holder})}})),{});const Ue=async(e,a,i)=>{if(a){const t=F(e);delete t.insurancePeriodValueList,delete t.paymentFrequencyList,delete t.paymentPeriodValueList;if(Ne.indexOf(a.key)>=0&&`${a.oldValue}`!=`${a.newValue}`){const s={};switch(a.key){case"annuityDrawDate":s.changeType=3;break;case"coveragePeriod":s.changeType=2;break;case"chargePeriod":s.changeType=1;break;case"paymentFrequency":s.changeType=4}const r=((e,a,i)=>{var t;return null==(t=Oe.value[e].productPlanInsureVOList)?void 0:t[0].insureProductRiskVOList.filter((e=>{const{paymentPeriodRule:t,paymentTypeRule:s,insurancePeriodRule:r}=e.productRiskInsureLimitVO;return i===U.MAIN_RISK&&e.mainRiskCode===a&&([t,s,r].includes(q.MAIN_RISK_SAME)||[t,s,r].includes(q.MAIN_RISK_1))?e:e.riskCode===a}))})(i,e.riskCode,e.riskType),l=(r||[]).map((a=>a.riskCode!==e.riskCode?{insureProductRiskVO:a,insureRiskEditReqVO:null}:{insureProductRiskVO:a,insureRiskEditReqVO:{riskId:e.riskId,riskCode:e.riskCode,...t,...s}}));if(!Ce.isAutoChange){Ce.isQuerying=!0;const e=Ce.userData.insuredList.filter((e=>e.birthday))||[];if(!e.length)return!1;await W({calcProductFactorList:[{planCode:be.value.planCode,productCode:i,riskEditVOList:l}],insuredVOList:e,holderVO:Ce.userData.holder}),Ce.isQuerying=!1;return!0}Ce.isAutoChange=!1}}return!0},qe=e=>{Ce.userData=e,Ce.defaultValue=e},Ke=async e=>{var a;if(A.defaultData){const e=A.defaultData.find((e=>e.productCode===A.productInfo.productCode))||A.defaultData[0];qe(e),Me(null==(a=A.defaultData)?void 0:a[0])}else De.value.push(be.value.planCode),await(async()=>{var e;const a=await Y({calcProductFactor:{productCode:null==(e=Object.keys(A.productCollection))?void 0:e[0]}});a.data&&qe(a.data)})()};d((()=>{var e,a;Ce.select={},Ce.list=[],Ce.userData={},Ce.riskIsInsure={},Ce.submitData={},Ce.riskList={},Ce.mainRiskVO={},Ce.ifPersonalInfoSuccess=!1,Ce.trialMsg="",Ce.trialResultPremium=0,Ce.riskIsInsure={},null==(a=null==(e=be.value)?void 0:e.insureProductRiskVOList)||a.forEach((e=>{var a;const i=null==(a=be.value.productRiskRelationVOList)?void 0:a.find((a=>a.collocationRiskId===e.riskId));i&&(Ce.riskIsInsure[e.riskCode]={selected:"2",data:null,relation:i})}))})),n((()=>{be.value=A.dataSource,Ce.loading=!0,Ce.show=!0,Ce.isAniShow=!0,Ce.isSkipFirstTrial=!0,Ce.hadSkipFirstTrial=!1}));return b({getTrialSuccessFlag:()=>Ce.trialResultPremium>0,getRiderRiskDefaultValue:async(e,a,i)=>{var t,s,r,l;const u=Ce.riskList[e].find((e=>e.riskCode===i)),{code:o,data:d}=await X({holder:Ce.userData.holder,insuredList:Ce.userData.insuredList,calcRiskDefaultFactorVO:{mainRiskInfo:u,riskCode:a}});if("10000"===o){let u=!1,o=0;o=1===(null==(t=Ce.riskList[e])?void 0:t.length)?1:Ce.riskList[e].findIndex(((t,s)=>{if(t.riskCode===i)u=!0;else if(u&&a.riskType===U.MAIN_RISK)return u;return s+1===Ce.riskList[e].length})),Ce.defaultValue.insuredList[0].productList=null==(l=null==(r=null==(s=Ce.defaultValue)?void 0:s.insuredList)?void 0:r[0])?void 0:l.productList.map((a=>(e===a.productCode&&(a.riskList=[...a.riskList.slice(0,o),d,...a.riskList.slice(o,a.riskList.length)]),a)))}},getProductDefaultValue:async e=>{const{code:a,data:i}=await Y({calcProductFactor:{productCode:e},holderVO:Ce.userData.holder,insuredVOList:Ce.userData.insuredList});if("10000"===a){const e=i.insuredList[0].productList[0];Ce.defaultValue.insuredList[0].productList.push(e)}},validate:()=>ge.value.validate(!1),validateTrialFields:()=>ge.value.validateTrialFields(),validateHolder:e=>{var a;return null==(a=ge.value)?void 0:a.validateHolder(e)},getUserData:()=>({...Ce.userData}),onShare:e=>{var a;Ce.trialResultPremium&&(null==(a=te.value)||a.validate().then((()=>{Object.assign(Re.value,A.defaultOrder,{extInfo:{...Re.value.extInfo,buttonCode:H.TRIAL_PREMIUM,pageCode:Q.TRIAL_PREMIUM,templateId:ye}});const a=ee(A.productInfo,Ce.trialResult,Re.value);ae(a,((a,i)=>{i===T.JUMP_PAGE&&(Pe.value.link=`${window.location.href}&isShare=1&orderNo=${a.orderNo}`,e())})),console.log("---- validate success ----")})))},onNext:()=>{var e;const{productCode:a,productName:i}=A.productInfo;Ie?V(Q.TRIAL_PREMIUM,Le.query):Ce.trialResultPremium&&(null==(e=te.value)||e.validate().then((()=>{Object.assign(Re.value,A.defaultOrder,{extInfo:{templateId:ye,...Re.value.extInfo,...A.defaultOrder.extInfo||{},buttonCode:H.TRIAL_PREMIUM,pageCode:Q.TRIAL_PREMIUM}});const e=ee({...Ee(),productCode:a,productName:i},Ce.trialResult,Re.value);ae(e,((e,a)=>{a===T.JUMP_PAGE&&S(e.nextPageCode,{...Le.query,orderNo:e.orderNo})})),console.log("---- validate success ----")})),Ce.loading=!1,Ce.show=!0,Ce.isAniShow=!0)},dealMixData:Ee}),o((()=>Ce.riskIsInsure),(e=>{}),{deep:!0,immediate:!0}),o((()=>Ce.userData),(e=>{if(e){const{holder:a,insuredList:i}=e||{},t={holder:a,insuredList:i};Object.assign(Ce.submitData,t),E("update:userData",t)}}),{deep:!0}),o((()=>A.dataSource),(e=>{be.value=e}),{deep:!0,immediate:!0}),o((()=>A.productCollection),((e,a)=>{console.log("val",e,a),Object.keys(e||{}).length&&!Ce.defaultValue&&Ke(),Oe.value=e}),{deep:!0,immediate:!0}),o((()=>A.productFactor),(e=>{Ve.value=e}),{deep:!0,immediate:!0}),o((()=>A.defaultData),(e=>{Ce.defaultValue=e}),{deep:!0,immediate:!0}),(e,a)=>{var i,t;const s=M,r=w,l=_,u=j;return c(),p("div",se,[f(e.$slots,"trialHead",{},void 0,!0),v("div",re,[m(K,{labels:k(ie)((null==(i=be.value)?void 0:i.insureProductRiskVOList)||[],be.value.productRiskRelationVOList)},null,8,["labels"]),v("div",le,[Ve.value?(c(),L($,{ref_key:"personalInfoRef",ref:ge,key:be.value.planCode,modelValue:k(Ce).userData,"onUpdate:modelValue":a[0]||(a[0]=e=>k(Ce).userData=e),"is-trial":e.isTrial,"product-factor":Ve.value,"multi-insured-config":null==(t=be.value)?void 0:t.multiInsuredConfigVO,onTrailChange:Be},null,8,["modelValue","is-trial","product-factor","multi-insured-config"])):h("",!0)]),f(e.$slots,"middleInfo",{},void 0,!0),m(s,{size:"large"}),v("div",ue,[m(r,{title:"保障计划",class:"insurePlan","show-divider":!1}),Object.keys(Oe.value).length?(c(),p("div",oe,[(c(!0),p(y,null,I(Object.keys(Oe.value),((e,a)=>(c(),p("div",{key:e,class:"product-item"},[(c(!0),p(y,null,I(Oe.value[e].productPlanInsureVOList[0].insureProductRiskVOList||[],((i,t)=>{var s,r,u,o,d,n,f,L,y;return c(),p("div",{key:`${e}-${i.riskCode}`,class:"risk-item"},[m(l,{title:i.riskName,"risk-type":i.riskType},{default:g((()=>[v("div",de,[i.riskType===k(U).MAIN_RISK?(c(),p("div",{key:0,class:"add-risk btn",onClick:a=>((e,a)=>{const i=Ce.riskList[e].find((e=>e.riskCode===a));E("addRisk",e,i,Ce.userData.insuredList)})(e,i.riskCode)}," +附加险 ",8,ne)):h("",!0),v("div",{class:"delete-risk btn",onClick:a=>((e,a,i)=>{D.confirm({message:"删除后将无法恢复，是否需要删除该产品？"}).then((()=>{E("deleteRisk",e,i,a)}))})(e,i.mainRiskCode,i.riskCode)}," 删除 ",8,ce)])])),_:2},1032,["title","risk-type"]),m(x,{ref_for:!0,ref_key:"insureInfosRef",ref:te,"origin-data":i,"product-factor":be.value.productFactor,"default-value":k(Ce).defaultValue?null==(n=null==(d=null==(o=null==(u=null==(r=null==(s=k(Ce).defaultValue)?void 0:s.insuredList)?void 0:r[0])?void 0:u.productList)?void 0:o[a])?void 0:d.riskList)?void 0:n[t]:null,"trial-result":k(Ce).trialResult,onTrialChange:(a,i)=>(async(e,a,i)=>{var t,s,r;(null==(s=null==(t=Ce.riskList)?void 0:t[i])?void 0:s.find((a=>a.riskCode===e.riskCode)))?Ce.riskList[i]=Ce.riskList[i].map((a=>a.riskCode===e.riskCode?e:a)):(null==(r=Ce.riskList[i])?void 0:r.length)?Ce.riskList[i].push(e):Ce.riskList[i]=[e],await Ue(e,a,i)&&(console.log("标准险种的信息回传",e),$e())})(a,i,e)},null,8,["origin-data","product-factor","default-value","trial-result","onTrialChange"]),v("div",pe,[fe,v("span",ve,"¥"+C(k(R)((null==(y=null==(L=null==(f=Fe.value)?void 0:f[e])?void 0:L[t])?void 0:y.initialPremium)||"0"))+"元",1)])])})),128))])))),128))])):h("",!0),k(Te)?(c(),p("div",me,[m(u,{activated:"",onClick:Se},{default:g((()=>[P("+新增主险")])),_:1})])):h("",!0)]),ke]),f(e.$slots,"trialBtn",{trialData:k(Ce).submitData,riskPremium:k(Ce).trialResult,loading:k(Ce).isQuerying,personalInfoRef:ge.value},void 0,!0)])}}}),[["__scopeId","data-v-8691e138"]]);export{he as T};
