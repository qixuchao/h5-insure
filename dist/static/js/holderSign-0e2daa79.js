import{d as e,i as a,h as i,bY as s,bP as o,cG as n,j as t,k as r,ah as l,E as d,aR as u,aJ as c,cH as f,l as p,o as v,c as g,b as h,a as m,u as y,p as I,f as S,a8 as b,w as j,v as w,q as O,aY as N,aQ as L,T,cy as x,cz as E,cI as q,aB as C,y as D,bO as k,cJ as V,bv as R,aE as P,cB as z,cK as H,aI as U,cA as _,cL as B}from"./index-2cd6533c.js";import{g as $,m as A}from"./trial-d4f61e37.js";import{_ as F}from"./SignPart-234436fe.js";import{u as J}from"./useOrder-2a7889a8.js";import{N as Y}from"./notice-8f4bc18f.js";import"./PolicyInfo-f179e114.js";import{c as G}from"./scribing-af6d60f6.js";import{p as K}from"./utils-6f9a4840.js";import{i as M}from"./core-4be363af.js";import{_ as Q}from"./MessagePopup-5c5351d2.js";import{q as W}from"./qianming-ece13dd4.js";import"./index-b7dd12ef.js";import"./utils-75e7582c.js";import"./createProposal-023fa395.js";import"./trial-ff92f49f.js";import"./utils-2b5f715d.js";import"./infoCollection-ee8e29ff.js";const X={class:"long-verify"},Z={class:"header"},ee={class:"verify-content"},ae={class:"footer-button"},ie={class:"content-inner"},se=["src"],oe=m("h4",null,"本次签名已完成",-1),ne=m("p",null,"感谢您对本次投保的签字确认，后续流程由销售人员在您的配合下进行",-1),te=e({__name:"holderSign",setup(e){const te=a(),re=i(),[le,de]=s(!1),{productCode:ue="",tenantId:ce,agentCode:fe="",agencyCode:pe,saleChannelId:ve,saleUserId:ge,orderNo:he,orderCode:me,extraInfo:ye,isShare:Ie,insurerCode:Se,preview:be}=te.query;let je={};try{je=JSON.parse(decodeURIComponent(ye))}catch(ze){}const we=J(),Oe=`${window.origin}/baseInsurance/long/phoneVerify?${o.stringify({...te.query,orderNo:me||he})}`,Ne=new n({source:"localStorage"}),Le=t(),Te=t({holder:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:[],compositionSign:""},insured:{fileList:[],personalInfo:[],isSign:!1,isVerify:!1,isShareSign:!1,signData:{},compositionSign:""},agent:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:"",compositionSign:""}}),xe=t({}),Ee=t({}),qe=t({sign:[],verify:[],scribing:""}),Ce=r((()=>{var e,a;const{age:i,relationToHolder:s,id:o}=(null==(a=null==(e=Te.value.insured)?void 0:e.personalInfo)?void 0:a[0])||{};return`${s}`===l.CERT||i<18})),De=()=>{if(be)return void N(L.SIGN,te.query);const e=[];Le.value&&((Ie?qe.value.sign.includes("4"):qe.value.sign.includes("2"))&&e.push(Le.value.validateSign()),qe.value.verify.includes("1")&&e.push(Le.value.validateVerify())),Promise.all(e).then((e=>{!qe.value.scribing||xe.value.status?Promise.all([x({bizObjectId:[we.value.holder.id],bizObjectType:E.HOLDER,orderId:we.value.id,tenantId:ce,shareFlag:Ie?1:2}),Ce.value&&x({bizObjectId:[we.value.insuredList[0].id],bizObjectType:E.INSURED,orderId:we.value.id,tenantId:ce})]).then((e=>{"10000"===e[0].code&&q(we.value).then((({code:e,data:a})=>{if("10000"===e)if(a.authStatus===`${C.YES}`)re.push({path:D.payAuth,query:te.query});else{if(Ie)return de(!0),void setTimeout((()=>{M?k.closeWindow():window.close()}),1500);re.push({path:D.sign,query:te.query})}}))})):T("请先完成风险抄录")})).catch((e=>{T(e.message)}))},ke=()=>{he&&$({orderNo:me||he,tenantId:ce}).then((({code:e,data:a})=>{var i,s,o,n;if("10000"===e){const e=[];a.tenantOrderAttachmentList.forEach((a=>{a.objectType===Y.HOlDER&&(30===a.category?e.push(a.fileBase64):21===a.category&&(Te.value.holder.compositionSign=a.uri))})),Te.value.holder.signData=e,Object.assign(Ee.value,{type:V[a.extInfo.transcriptionType],signInfo:null==(s=null==(i=a.riskTranscriptionList)?void 0:i[0])?void 0:s.uri,text:null==(n=null==(o=a.riskTranscriptionList)?void 0:o[0])?void 0:n.content,status:!!a.extInfo.transcriptionStatus})}}))},Ve=(e,a,i)=>new Promise(((s,o)=>{var n;_(e,a,null==(n=we.value)?void 0:n.id,ce,i).then((({code:e,message:a})=>{"10000"===e?s():o(a)})).catch((e=>{o(e)}))}));t({imgUrl:"",desc:"",title:"",link:Oe});const Re=e=>{const{type:a,text:i}=xe.value,s={...te.query,orderNo:me||he,text:i,orderId:we.value.id};"handle"===a?re.push({path:"scribing",query:s}):G({content:i,image:e,orderNo:me||he,tenantId:ce,transcriptionType:B.AUTO}).then((({code:e})=>{"10000"===e&&ke()}))};d([()=>Ee.value,()=>xe.value],(()=>{Object.assign(xe.value,{type:Ee.value.type||xe.value.type,text:Ee.value.text||xe.value.text,status:Ee.value.status||xe.value.status,signInfo:Ee.value.signInfo||xe.value.signInfo})}),{deep:!0,immediate:!0}),u((()=>{(async()=>{var e,a,i,s;let o={};const{code:n,data:t}=await $({orderNo:me||he,tenantId:ce});"10000"===n&&(Object.assign(we.value,t),Te.value.holder.personalInfo={...t.holder,isCert:1},Te.value.insured.personalInfo=t.insuredList.map((e=>(e.isCert=1,e))),o=K(t.insuredList[0].productList),Object.assign(Ee.value,{type:V[t.extInfo.transcriptionType],signInfo:null==(a=null==(e=t.riskTranscriptionList)?void 0:e[0])?void 0:a.uri,text:null==(s=null==(i=t.riskTranscriptionList)?void 0:i[0])?void 0:s.content,status:!!t.extInfo.transcriptionStatus}),we.value.tenantOrderAttachmentList.forEach((e=>{e.objectType===Y.HOlDER&&(30===e.category?Te.value.holder.signData.push(e.fileBase64):21===e.category&&(Te.value.holder.compositionSign=e.uri))}))),A(o).then((({data:e,code:a})=>{if("10000"===a){const{signInfo:a}=R(e.productFactor);a.schema.forEach((e=>{"eleSign"===e.name&&e.columns.forEach((a=>{e.required&&qe.value.sign.push(a.code),"1"===a.code?Te.value.agent.isSign=!0:"2"===a.code?Te.value.holder.isSign=!0:"3"===a.code?Te.value.insured.isSign=!0:"4"===a.code?Te.value.holder.isShareSign=!0:"5"===a.code&&(Te.value.insured.isShareSign=!0)})),"riskNotificationCopy"===e.name&&(xe.value.text=e.remark,qe.value.scribing=e.required,e.columns.forEach((e=>{"1"===e.code?xe.value.type="handle":xe.value.type="auto"}))),"customerFace"===e.name&&e.columns.forEach((a=>{e.required&&qe.value.verify.push(a.code),"1"===a.code?Te.value.holder.isVerify=!0:"2"===a.code&&(Te.value.insured.isVerify=!0)}))}))}}))})();const e=c.get("verifyData");if(e){const{serialNo:a,certNo:i,name:s}=e;f({certiNo:i,orderNo:me||he,serialNo:a,tenantId:ce,userName:s}).then((e=>{const{code:a,data:i}=e;"10000"===a&&(Ne.remove("verifyData"),ke())}))}}));const Pe=t();return p((()=>{setTimeout((async()=>{Pe.value=window.getIseeBiz&&await window.getIseeBiz()}),1500)})),(e,a)=>{var i,s,o;const n=P,t=z,r=H,l=U;return v(),g("div",X,[h(n),m("div",Z,[h(t,{type:"warning",content:(null==(i=y(Te).holder.personalInfo)?void 0:i.name)&&`本人${null==(s=y(Te).holder.personalInfo)?void 0:s.name}已阅读并同意签署《电子投保单》（投保信息确认）、《人身保险投保提示书》、《免责说明书》、《产品说明书》（一年期以上产品）、《风险告知问卷》（万能型产品）、《风险承受能力测评问卷》（新型产品）。请投保人：${null==(o=y(Te).holder.personalInfo)?void 0:o.name}签名确认。`},null,8,["content"])]),m("div",ee,[!y(Ie)||y(Te).holder.isShareSign?(v(),I(F,{key:0,ref_key:"holderSignRef",ref:Le,"order-detail":y(we),"sign-string":y(Te).holder.signData,"show-sign":y(Ie)?y(Te).holder.isShareSign:y(Te).holder.isSign,"show-verify":y(Te).holder.isVerify,"file-list":y(Te).holder.fileList,"personal-info":y(Te).holder.personalInfo,"composition-sign":y(Te).holder.compositionSign,title:"投保人",onHandleSign:a[0]||(a[0]=e=>((e,a,i)=>{var s,o;const n=[Ve(e,a,i)];null==(o=null==(s=Te.value.insured)?void 0:s.personalInfo)||o[0],Ce.value&&n.push(Ve("INSURED",a,i)),Promise.all(n).then((e=>{ke()}),(e=>{T(e[0])}))})("HOLDER",e,y(Te).holder.personalInfo.id))},null,8,["order-detail","sign-string","show-sign","show-verify","file-list","personal-info","composition-sign"])):S("",!0)]),y(qe).scribing?(v(),I(r,b({key:0},y(xe),{title:"为了保障您的权益请抄录以下声明内容",onOnSubmit:Re}),null,16)):S("",!0),m("div",ae,[h(l,{type:"primary",onClick:De},{default:j((()=>[w("确定")])),_:1})]),h(Q,{modelValue:y(le),"onUpdate:modelValue":a[1]||(a[1]=e=>O(le)?le.value=e:null),onClose:a[2]||(a[2]=e=>y(de)(!1))},{default:j((()=>[m("div",ie,[m("img",{src:y(W),alt:"",class:"header-img"},null,8,se),oe,ne])])),_:1},8,["modelValue"])])}}});export{te as default};
