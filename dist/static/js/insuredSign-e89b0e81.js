import{d as e,i as a,h as i,c5 as s,j as t,bc as n,l as r,o,c as d,b as l,a as c,u,F as f,s as g,p,f as m,w as v,v as h,cP as S,bj as b,bb as y,cN as j,cO as I,T as w,bd as N,bO as D,a_ as L,cY as O,b3 as E}from"./index-2ac8b6d6.js";import{b as C}from"./product-32d5105d.js";import{g as R,m as U}from"./trial-4ea734ea.js";import{_ as V}from"./SignPart-5d8cda77.js";import{u as _}from"./useOrder-1ad926ad.js";import{N as q}from"./notice-5f7f68ca.js";import"./PolicyInfo-ab4c8e92.js";import{p as P}from"./utils-44c69232.js";import{g as k}from"./utils-ab4832aa.js";import"./index-4f09c6ab.js";import"./cloneDeep-ea85aaaa.js";import"./utils-48a9b4f8.js";import"./createProposal-1f031c3d.js";import"./trial-cb24e467.js";import"./infoCollection-4aaf49a5.js";const B={class:"long-verify"},T={class:"header"},x={class:"verify-content"},z={class:"footer-button footer-bar"},M=e({__name:"insuredSign",setup(e){const M=a(),$=i(),{tenantId:A,orderNo:F,orderCode:H,extraInfo:G,isShare:J,insurerCode:Y,preview:K}=M.query;let Q={};try{Q=JSON.parse(decodeURIComponent(G))}catch(ne){}const W=_(),X=`${window.origin}/baseInsurance/long/phoneVerify?${s.stringify({...M.query,orderNo:H||F})}`,Z=t(),ee=t({holder:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""},insured:{fileList:[],personalInfo:[],isSign:!1,isVerify:!1,isShareSign:!1,signData:{}},agent:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""}}),ae=(e,a,i)=>{var s;S(e,a,null==(s=W.value)?void 0:s.id,A,i).then((()=>{F&&R({orderNo:H||F,tenantId:A}).then((({code:e,data:a})=>{if("10000"===e){const e={};a.tenantOrderAttachmentList.forEach((a=>{a.objectType===q.INSURED&&30===a.category&&e[a.objectId].push(a.fileBase64)})),ee.value.insured.signData=e}}))}))},ie=t({sign:[],verify:[],scribing:""}),se=()=>{if(K)return void b(y.SIGN,M.query);const e=[];Z.value&&((J?ie.value.sign.includes("5"):ie.value.sign.includes("3"))&&e.push(...(Z.value||[]).map((e=>e.validateSign()))),ie.value.verify.includes("2")&&e.push(...(Z.value||[]).map((e=>e.validateVerify())))),Promise.all(e).then((e=>{j({bizObjectId:W.value.insuredList.map((e=>e.id)),bizObjectType:I.INSURED,orderId:W.value.id,tenantId:A}).then((({code:e,data:a})=>{if("10000"===e&&a){if(J)return void w("已完成");$.push({path:N.sign,query:M.query})}}))})).catch((e=>{w(e.message)}))};t({imgUrl:"",desc:"",title:"",link:X});n((()=>{(async()=>{let e={};const{code:a,data:i}=await R({orderNo:H||F,tenantId:A});"10000"===a&&(Object.assign(W.value,i),ee.value.insured.personalInfo=i.insuredList.map((e=>(e.isCert=1,e))),e=P(i.insuredList[0].productList),i.tenantOrderAttachmentList.forEach((e=>{e.objectType===q.INSURED&&30===e.category&&e.objectId&&(ee.value.insured.signData[e.objectId]?ee.value.insured.signData[e.objectId].push(e.fileBase64):ee.value.insured.signData[e.objectId]=[e.fileBase64])}))),C(e).then((({code:e,data:a})=>{var i;if("10000"===e){const{signMaterialMap:e}=(null==(i=a.productMaterialPlanVOList)?void 0:i[1])||{};(Object.values(e||[]).flat()||[]).forEach((e=>{e.noticeObject===q.INSURED&&ee.value.insured.fileList.push({attachmentName:e.materialName,attachmentList:[{...e,materialSource:k(`${null==e?void 0:e.materialSource}`,null==e?void 0:e.materialContent)}]})}))}})),U(e).then((({data:e,code:a})=>{if("10000"===a){const{signInfo:a}=D(e.productFactor);a.schema.forEach((e=>{"eleSign"===e.name&&e.columns.forEach((a=>{e.required&&ie.value.sign.push(a.code),"1"===a.code?ee.value.agent.isSign=!0:"2"===a.code?ee.value.holder.isSign=!0:"3"===a.code?ee.value.insured.isSign=!0:"4"===a.code?ee.value.holder.isShareSign=!0:"5"===a.code&&(ee.value.insured.isShareSign=!0)}))}))}}))})()}));const te=t();return r((()=>{setTimeout((async()=>{te.value=window.getIseeBiz&&await window.getIseeBiz()}),1500)})),(e,a)=>{const i=L,s=O,t=E;return o(),d("div",B,[l(i),c("div",T,[l(s,{type:"warning",title:"尊敬的客户，本次投保需要进行身份认证",content:"本产品投保需要对投保人、被保人进行实名认证，您购买本产品的累计总保费已超过20万，按监管要求，需要提供投保人、被保人、指定受益人证件影像，本产品非本人投保且带身故责任、需对投保人、被保人（成人）的投保意愿进行签字确认。"})]),c("div",x,[!u(J)||u(ee).insured.isShareSign?(o(!0),d(f,{key:0},g(u(ee).insured.personalInfo||[],(e=>(o(),p(V,{key:e.id,ref_for:!0,ref_key:"insuredSignRef",ref:Z,"data-source":[],"order-detail":u(W),"sign-string":u(ee).insured.signData[e.id],"show-sign":u(J)?u(ee).insured.isShareSign:u(ee).insured.isSign,"show-verify":u(ee).insured.isVerify,"file-list":u(ee).insured.fileList,"personal-info":e||{},title:"被保人",onHandleSign:a=>ae("INSURED",a,e.id)},null,8,["order-detail","sign-string","show-sign","show-verify","file-list","personal-info","onHandleSign"])))),128)):m("",!0)]),c("div",z,[l(t,{type:"primary",class:"submit-btn",onClick:se},{default:v((()=>[h("确定")])),_:1})])])}}});export{M as default};
