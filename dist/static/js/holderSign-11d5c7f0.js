import{d as e,i as a,h as i,c5 as s,cV as n,j as t,k as o,ah as r,E as l,bc as d,b4 as u,cW as c,l as v,o as f,c as p,b as h,a as g,u as y,p as m,f as I,a8 as S,w as b,v as j,bj as O,bb as w,T as N,cX as T,aY as x,y as L,cN as D,cO as E,c4 as C,cY as k,cP as q,bO as R,a$ as V,cQ as P,cZ as $,b3 as z,c_ as H}from"./index-824426db.js";import{g as U,m as _}from"./trial-6e3873a5.js";import{_ as A}from"./SignPart-d51dd6bd.js";import{u as B}from"./useOrder-2bcca4fa.js";import{N as F}from"./notice-66df984a.js";import"./PolicyInfo-25821647.js";import{c as Y}from"./scribing-9f7f3f37.js";import{p as W}from"./utils-c8984476.js";import{i as G}from"./core-3df39fa7.js";import"./index-b0acceca.js";import"./cloneDeep-e3e0ad29.js";import"./utils-7262f34f.js";import"./createProposal-ada646f4.js";import"./trial-99f0e965.js";import"./utils-93edb18c.js";import"./infoCollection-6fea64b6.js";const J={class:"long-verify"},Q={class:"header"},X={class:"verify-content"},Z={class:"footer-button"},K=e({__name:"holderSign",setup(e){const K=a(),M=i(),{productCode:ee="",tenantId:ae,agentCode:ie="",agencyCode:se,saleChannelId:ne,saleUserId:te,orderNo:oe,orderCode:re,extraInfo:le,isShare:de,insurerCode:ue,preview:ce}=K.query;let ve={};try{ve=JSON.parse(decodeURIComponent(le))}catch(Te){}const fe=B(),pe=`${window.origin}/baseInsurance/long/phoneVerify?${s.stringify({...K.query,orderNo:re||oe})}`,he=new n({source:"localStorage"}),ge=t(),ye=t({holder:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:[]},insured:{fileList:[],personalInfo:[],isSign:!1,isVerify:!1,isShareSign:!1,signData:{}},agent:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""}}),me=t({}),Ie=t({}),Se=t({sign:[],verify:[],scribing:""}),be=o((()=>{var e,a;const{age:i,relationToHolder:s,id:n}=(null==(a=null==(e=ye.value.insured)?void 0:e.personalInfo)?void 0:a[0])||{};return`${s}`===r.CERT||i<18})),je=()=>{if(ce)return void O(w.SIGN,K.query);const e=[];ge.value&&((de?Se.value.sign.includes("4"):Se.value.sign.includes("2"))&&e.push(ge.value.validateSign()),Se.value.verify.includes("1")&&e.push(ge.value.validateVerify())),Promise.all(e).then((e=>{!Se.value.scribing||me.value.status?T(fe.value).then((({code:e,data:a})=>{"10000"===e&&(a.authStatus===`${x.YES}`?M.push({path:L.payAuth,query:K.query}):Promise.all([D({bizObjectId:[fe.value.holder.id],bizObjectType:E.HOLDER,orderId:fe.value.id,tenantId:ae,shareFlag:de?1:2}),be.value&&D({bizObjectId:[fe.value.insuredList[0].id],bizObjectType:E.INSURED,orderId:fe.value.id,tenantId:ae})]).then((e=>{if("10000"===e[0].code){if(de)return N("本次签名已完成"),void setTimeout((()=>{G?C.closeWindow():window.close()}),1500);M.push({path:L.sign,query:K.query})}})))})):N("请先完成风险抄录")})).catch((e=>{N(e.message)}))},Oe=()=>{oe&&U({orderNo:re||oe,tenantId:ae}).then((({code:e,data:a})=>{var i,s,n,t;if("10000"===e){const e=[];a.tenantOrderAttachmentList.forEach((a=>{a.objectType===F.HOlDER&&30===a.category&&e.push(a.fileBase64)})),ye.value.holder.signData=e,Object.assign(Ie.value,{type:k[a.extInfo.transcriptionType],signInfo:null==(s=null==(i=a.riskTranscriptionList)?void 0:i[0])?void 0:s.uri,text:null==(t=null==(n=a.riskTranscriptionList)?void 0:n[0])?void 0:t.content,status:!!a.extInfo.transcriptionStatus})}}))};t({imgUrl:"",desc:"",title:"",link:pe});const we=e=>{const{type:a,text:i}=me.value,s={...K.query,orderNo:re||oe,text:i,orderId:fe.value.id};"handle"===a?M.push({path:"scribing",query:s}):Y({content:i,image:e,orderNo:re||oe,tenantId:ae,transcriptionType:H.AUTO}).then((({code:e})=>{"10000"===e&&Oe()}))};l([()=>Ie.value,()=>me.value],(()=>{Object.assign(me.value,{type:Ie.value.type||me.value.type,text:Ie.value.text||me.value.text,status:Ie.value.status||me.value.status,signInfo:Ie.value.signInfo||me.value.signInfo})}),{deep:!0,immediate:!0}),d((()=>{(async()=>{var e,a,i,s;let n={};const{code:t,data:o}=await U({orderNo:re||oe,tenantId:ae});"10000"===t&&(Object.assign(fe.value,o),ye.value.holder.personalInfo={...o.holder,isCert:1},ye.value.insured.personalInfo=o.insuredList.map((e=>(e.isCert=1,e))),n=W(o.insuredList[0].productList),Object.assign(Ie.value,{type:k[o.extInfo.transcriptionType],signInfo:null==(a=null==(e=o.riskTranscriptionList)?void 0:e[0])?void 0:a.uri,text:null==(s=null==(i=o.riskTranscriptionList)?void 0:i[0])?void 0:s.content,status:!!o.extInfo.transcriptionStatus}),fe.value.tenantOrderAttachmentList.forEach((e=>{e.objectType===F.HOlDER&&30===e.category&&ye.value.holder.signData.push(e.fileBase64)}))),_(n).then((({data:e,code:a})=>{if("10000"===a){const{signInfo:a}=R(e.productFactor);a.schema.forEach((e=>{"eleSign"===e.name&&e.columns.forEach((a=>{e.required&&Se.value.sign.push(a.code),"1"===a.code?ye.value.agent.isSign=!0:"2"===a.code?ye.value.holder.isSign=!0:"3"===a.code?ye.value.insured.isSign=!0:"4"===a.code?ye.value.holder.isShareSign=!0:"5"===a.code&&(ye.value.insured.isShareSign=!0)})),"riskNotificationCopy"===e.name&&(me.value.text=e.remark,Se.value.scribing=e.required,e.columns.forEach((e=>{"1"===e.code?me.value.type="handle":me.value.type="auto"}))),"customerFace"===e.name&&e.columns.forEach((a=>{e.required&&Se.value.verify.push(a.code),"1"===a.code?ye.value.holder.isVerify=!0:"2"===a.code&&(ye.value.insured.isVerify=!0)}))}))}}))})();const e=u.get("verifyData");if(e){const{serialNo:a,certNo:i,name:s}=e;c({certiNo:i,orderNo:re||oe,serialNo:a,tenantId:ae,userName:s}).then((e=>{const{code:a,data:i}=e;"10000"===a&&(he.remove("verifyData"),Oe())}))}}));const Ne=t();return v((()=>{setTimeout((async()=>{Ne.value=window.getIseeBiz&&await window.getIseeBiz()}),1500)})),(e,a)=>{var i,s,n;const t=V,o=P,r=$,l=z;return f(),p("div",J,[h(t),g("div",Q,[h(o,{type:"warning",content:(null==(i=y(ye).holder.personalInfo)?void 0:i.name)&&`本人${null==(s=y(ye).holder.personalInfo)?void 0:s.name}已阅读并同意签署《电子投保单》（投保信息确认）、《人身保险投保提示书》、《免责说明书》、《产品说明书》（一年期以上产品）、《风险告知问卷》（万能型产品）、《风险承受能力测评问卷》（万能型产品）。请投保人：${null==(n=y(ye).holder.personalInfo)?void 0:n.name}签名确认。`},null,8,["content"])]),g("div",X,[!y(de)||y(ye).holder.isShareSign?(f(),m(A,{key:0,ref_key:"holderSignRef",ref:ge,"order-detail":y(fe),"sign-string":y(ye).holder.signData,"show-sign":y(de)?y(ye).holder.isShareSign:y(ye).holder.isSign,"show-verify":y(ye).holder.isVerify,"file-list":y(ye).holder.fileList,"personal-info":y(ye).holder.personalInfo,title:"投保人",onHandleSign:a[0]||(a[0]=e=>((e,a,i)=>{var s,n,t,o;const r=[q(e,a,null==(s=fe.value)?void 0:s.id,ae,i)],{id:l}=(null==(t=null==(n=ye.value.insured)?void 0:n.personalInfo)?void 0:t[0])||{};be.value&&r.push(q("INSURED",a,null==(o=fe.value)?void 0:o.id,ae,l)),Promise.all(r).then((e=>{Oe()}))})("HOLDER",e,y(ye).holder.personalInfo.id))},null,8,["order-detail","sign-string","show-sign","show-verify","file-list","personal-info"])):I("",!0)]),y(Se).scribing?(f(),m(r,S({key:0},y(me),{title:"为了保障您的权益请抄录以下声明内容",onOnSubmit:we}),null,16)):I("",!0),g("div",Z,[h(l,{type:"primary",onClick:je},{default:b((()=>[j("确定")])),_:1})])])}}});export{K as default};
