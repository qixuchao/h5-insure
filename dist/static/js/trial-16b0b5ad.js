import{d as e,i as t,h as i,j as s,ba as o,bb as a,k as r,bc as d,l as u,o as l,c as n,b as c,w as p,v as m,u as f,p as v,f as R,bd as L}from"./index-114ccce9.js";import I from"./index-5ab75c14.js";import{g as k,s as j,i as b,m as C}from"./trial-23de6708.js";import h from"./SelectRiskList-c592dd4c.js";import{_ as g}from"./TrialButton-30c099c2.js";import{R as w}from"./trial-ae1b3ae0.js";import{u as y}from"./useOrder-ea6f9a6b.js";import{p as q,a as P}from"./utils-c22e4098.js";import{q as x}from"./createProposal-ce8a0907.js";import{g as O,t as _}from"./util-401b6734.js";import{f as N,a as T}from"./findLastIndex-07fc6f46.js";import{c as A}from"./cloneDeep-a6761d45.js";import"./InsureInfos-1b1b9b13.js";import"./index-e08bd64e.js";import"./infoCollection-5941fb7b.js";import"./index-ed71eff9.js";import"./PolicyInfo-5f36d3b2.js";import"./questionnaire-42dcb602.js";import"./product-7bbf9c44.js";import"./constants-6ad2f07c.js";import"./utils-559755fb.js";import"./nextStep-318437f5.js";import"./core-11e91544.js";import"./format-31cde443.js";import"./index-113e1f8a.js";import"./utils-d5b6d04c.js";const M={class:"page-trial-wrap"},B=e({name:"trial"}),D=e({...B,setup(e){const B=t(),D=i(),{productCode:S,orderNo:V,tenantId:E,proposalId:K,proposalInsuredId:H,productClass:z,showPersonInfo:F}=B.query,U=s({}),$=s({productList:[]}),G=s([]),J=s({}),Q=s(),W=s(),X=s(),Y=y({extInfo:{buttonCode:o.TRIAL_PREMIUM,pageCode:a.TRIAL_PREMIUM}}),Z=O(),ee=s(),te=s(),ie=s(1),se=r((()=>ie.value===w.MAIN_RISK?"添加主险":"添加附加险")),oe=s(!1),ae=()=>{C($.value).then((({code:e,data:t})=>{if("10000"===e){const{productDetailResList:e,productFactor:i}=t;if(te.value=i,$.value=P(e),Z){const e=null==i?void 0:i[2].map((e=>e.code)),t=_(Z,e);ee.value=Object.assign(Y.value,{insuredList:t})}const s={};e.forEach((e=>{s[e.productCode]=e})),U.value=s}}))},re=()=>{oe.value=!1},de=e=>{if(ie.value===w.MAIN_RISK){$.value.productList.push(...e);const t=e.map((e=>e.productCode));Q.value.getProductDefaultValue(t)}else{const t=$.value.productList.find((e=>e.productCode===W.value)),i=e.map((e=>({riskCode:e,riskType:w.RIDER_RISK,mainRiskCode:J.value.riskCode}))),s=N(t.mergeRiskReqList,(e=>e.riskCode===J.value.riskCode)),o=T(t.mergeRiskReqList,(e=>e.mainRiskCode===J.value.riskCode));let a=s;-1!==o&&(a=o),t.mergeRiskReqList=[...t.mergeRiskReqList.slice(0,a+1),...i,...t.mergeRiskReqList.slice(a+1,t.mergeRiskReqList.length)],Q.value.getRiderRiskDefaultValue(W.value,e,J.value.riskCode,t.mergeRiskReqList)}ae(),oe.value=!1},ue=(e,t,i)=>{oe.value=!0,ie.value=w.RIDER_RISK,G.value=i,J.value=t,W.value=e},le=e=>{oe.value=!0,ie.value=w.MAIN_RISK,G.value=e},ne=(e,t,i)=>{U.value[e],i?(U.value[e].productPlanInsureVOList[0].insureProductRiskVOList=U.value[e].productPlanInsureVOList[0].insureProductRiskVOList.filter((e=>e.riskCode!==t)),$.value.productList=$.value.productList.map((i=>(i.productCode===e&&(i.mergeRiskReqList=i.mergeRiskReqList.filter((e=>e.riskCode!==t))),i)))):($.value.productList=$.value.productList.filter((t=>t.productCode!==e)),ae())},ce=()=>{Q.value.onNext((async e=>{var t;const i=A(e),s=["id","relationToHolder","beneficiaryList","guardian","insuredBeneficiaryType"];V||Object.keys(null==(t=i.insuredList)?void 0:t[0]).reduce(((e,t)=>{var o,a,r,d;return!s.includes(t)&&(null==(a=null==(o=i.insuredList)?void 0:o[0])?void 0:a[t])&&(e[t]=null==(d=null==(r=i.insuredList)?void 0:r[0])?void 0:d[t]),e}),i.holder),i.extInfo&&(i.extInfo.iseeBizNo=X.value),i.operateOption={withBeneficiaryInfo:!0,withHolderInfo:!0,withInsuredInfo:!0,withAttachmentInfo:!0,withProductInfo:!0};const{code:o,data:a}=await j(i);"10000"===o&&D.push({path:L.questionNotice,query:{...B.query,orderNo:a}})}))};return d((()=>{V?k({orderNo:V,tenantId:E}).then((({code:e,data:t})=>{"10000"===e&&(ee.value=t,Y.value=t,$.value=q(t.insuredList[0].productList),ae())})):K?x({id:K,tenantId:E}).then((({code:e,data:t})=>{if("10000"===e){const{holder:e,insuredList:i}=t,s=(S||"").split(",");let o=[];const a=(i||[]).filter((e=>e.id===+H)).map((e=>({...e,relationToHolder:null,productList:e.productList.filter((e=>!!s.includes(e.productCode)&&(o=e.occupationCodeList,!0)))})));a[0].occupationCodeList=o,Object.assign(Y.value,{renewFlag:"",holder:e,tenantId:E,proposalId:K,insuredList:a}),ee.value=Y.value,$.value=q(Y.value.insuredList[0].productList),ae()}})):b({productCode:S,isTenant:!1}).then((({data:e,code:t})=>{var i,s,o;if("10000"===t&&(U.value[`${S}`]=e,te.value=null==(s=null==(i=null==e?void 0:e.productPlanInsureVOList)?void 0:i[0])?void 0:s.productFactor,$.value=P([e]),Z)){const e=null==(o=te.value)?void 0:o[2].map((e=>e.code)),t=[_(Z,e)];ee.value=Object.assign(Y.value,{insuredList:t})}}))})),u((()=>{setTimeout((async()=>{X.value=window.getIseeBiz&&await window.getIseeBiz()}),1500)})),(e,t)=>(l(),n("div",M,[c(I,{ref_key:"trialRef",ref:Q,"product-collection":f(U),"default-data":f(ee),"product-factor":f(te),"product-risk-code-map":f($),"is-trial":"","hide-benefit":"","show-person-info":!!f(F),onAddRisk:ue,onAddMainRisk:le,onDeleteRisk:ne},{trialBtn:p((({riskPremium:e})=>[c(g,{premium:null==e?void 0:e.initialPremium,onHandleClick:ce},{label:p((()=>[m(" 首年总保费 ")])),_:2},1032,["premium"])])),_:1},8,["product-collection","default-data","product-factor","product-risk-code-map","show-person-info"]),f(oe)?(l(),v(h,{key:0,type:f(ie),"product-class":f(z),show:f(oe),"insured-list":f(G),title:f(se),"current-product-code":f(W),"main-risk-code":f(J).riskCode,"select-list":f($).productList,onCancel:re,onConfirm:de},null,8,["type","product-class","show","insured-list","title","current-product-code","main-risk-code","select-list"])):R("",!0)]))}});export{D as default};
