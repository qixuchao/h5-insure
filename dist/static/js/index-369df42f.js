import{d as e,i,h as a,g as t,r as s,j as r,ax as l,T as u,z as o,av as d,O as n,o as c,c as p,f,a as v,b as m,u as k,l as L,q as y,F as h,n as g,w as C,e as I,ay as R,a8 as b,_ as D,az as P,aA as O,aB as V,aC as T,aD as S,aE as w,aF as M,aG as j,at as _,au as E}from"./index-a701edf7.js";import{d as F}from"./debounce-6981b306.js";import{c as A}from"./cloneDeep-5d541e55.js";import{_ as N}from"./InsureInfos-01f2e7bf.js";import{P as x}from"./index-cbfdf47e.js";import{P as $,R as B,b as U}from"./trial-d97dbb4f.js";import{H as q,P as K,B as Q}from"./constants-bbd2c2de.js";import{u as H,b as z,p as G,c as J,d as W,e as X}from"./trial-be4721b4.js";import{u as Y}from"./useOrder-0f74fb68.js";import{t as Z}from"./utils-516e2719.js";import{n as ee}from"./nextStep-53012c09.js";const ie=(e,i)=>{const a=[],t={};return null==e||e.forEach((e=>{t[e.riskId]=e})),null==i||i.forEach((e=>{var i,s,r,l;const{collocationType:u,collocationRiskId:o,riskId:d}=e;switch(u){case 2:{const e=null==(i=t[d])?void 0:i.riskName,r=null==(s=t[o])?void 0:s.riskName;a.push(`${e} 和 ${r} 必须同时投保`);break}case 3:{const e=null==(r=t[d])?void 0:r.riskName,i=null==(l=t[o])?void 0:l.riskName;a.push(`${e} 和 ${i} 不能同时投保`);break}}})),a};const ae=e=>(_("data-v-09963698"),e=e(),E(),e),te={class:"com-body"},se={class:"trial-body"},re={class:"container"},le={class:"container"},ue={key:0,class:"product-list"},oe={key:0,class:"operate-bar"},de=["onClick"],ne=["onClick"],ce={class:"premium-item"},pe=ae((()=>v("span",{class:"label"},"首期保费",-1))),fe={class:"price"},ve={key:1,class:"add-main-risk"},me=ae((()=>v("div",{class:"empty"},null,-1))),ke=e({name:"TrialBody"});var Le=D(e({...ke,props:{selfKey:{default:""},dataSource:{default:()=>[]},productInfo:{default:()=>({productCode:"",productName:"",insurerCode:"",tenantId:"",planList:[]})},tenantProductDetail:{default:()=>({})},hideBenefit:{type:Boolean,default:!1},hidePopupButton:{type:Boolean,default:!1},title:{default:"算一算保费"},defaultData:{default:null},isTrial:{type:Boolean,default:!1},defaultOrder:{default:()=>({})},productCollection:{default:()=>({})},productFactor:{default:()=>({})}},emits:["trialStart","trialEnd","update:userData","closeCustomerPopoup","addRisk","addMainRisk","deleteRisk"],setup(e,{expose:D,emit:_}){const E=e,ae=i(null),ke=a();t();const{tenantId:Le,templateId:ye,preview:he}=ke.query,ge=i(),Ce=s({loading:!1,show:!1,select:{},list:[],userData:{},riskIsInsure:{},submitData:{},riskList:{},mainRiskVO:{},ifPersonalInfoSuccess:!1,trialMsg:"",trialResultPremium:0,trialResult:{initialPremium:0,initialAmount:0},isAniShow:!1,defaultValue:null,isAutoChange:!1,planIndex:0,isSkipFirstTrial:!1,hadSkipFirstTrial:!1,isQuerying:!1,currentPlanCode:""}),Ie=Y();i();const Re=i(),be=i(E.dataSource),De=i([]),Pe=i(),Oe=i(),Ve=r((()=>{var e,i;return![$.SINGLE_PRODUCT,$.TWO_PRODUCT].includes(null==(i=null==(e=Object.values(E.productCollection))?void 0:e[0])?void 0:i.productClass)})),Te=()=>{_("addMainRisk",Ce.userData.insuredList)},Se=e=>{const{holder:i,insuredList:a}=e||{};i&&(Ce.submitData.holder=i),a&&a.length>0&&a.forEach(((e,i)=>{var a;Ce.submitData.insuredList&&Ce.submitData.insuredList.length>i?Ce.submitData.insuredList[i]=e:((null==(a=Ce.submitData)?void 0:a.insuredList)||(Ce.submitData.insuredList=[]),Ce.submitData.insuredList.push(e))}))},we=r((()=>E.productInfo.planList&&E.productInfo.planList.length>2)),Me=(e,i)=>{if(e){const a=["birthday","age","gender","id"];i.includes("occupationCodeList")&&a.push("occupationClass"),Object.keys(e).forEach((t=>{[...i,...a].includes(t)||(e[t]=null)}))}},je=(e,i=(e=>!0))=>O(e)?e.filter(i).map((e=>e.code)):[],_e=()=>{console.log("--current plan = ",be.value),console.log("---current submit = ",Ce.submitData);const e=A(Ce.submitData);if(!we.value)return e;const{1:i,2:a,3:t}=be.value.productFactor||{};if(e.holder&&Me(e.holder,je(i)),e.insuredList){const i=["productList","beneficiaryList"],s=je(a,(e=>"2"!==String(e.subModuleType))),r=je(a,(e=>"2"===String(e.subModuleType))),l=O(r),u=je(t),o=O(u);e.insuredList.forEach(((e,a)=>{var t,d,n;Me(e,[...a>=1&&l?r:s,...i,...o?["insuredBeneficiaryType"]:[]]),(null==(t=e.beneficiaryList)?void 0:t.length)>0&&(o?e.beneficiaryList.forEach((e=>Me(e,u))):e.beneficiaryList.length=0),e.planCode=be.value.planCode;const c=(null==(n=null==(d=e.productList)?void 0:d[0])?void 0:n.riskList)||[],p=be.value.insureProductRiskVOList||[];if(c.length&&p){const i=c.filter((e=>null!==p.find((i=>i.riskCode===e.riskCode))));e.productList[0].riskList=i}}))}return e},Ee=i({}),Fe=["annuityDrawDate","coveragePeriod","chargePeriod","paymentFrequency"],Ae=i({}),Ne=F((async(e,i=!0)=>{Ce.trialMsg="试算中...",Ce.trialResultPremium=0,Ce.loading=!0,_("trialStart");let a=!1;if(i){const{code:i}=await H(e);a="10000"===i}!a&&i||(Ce.isQuerying=!0,E.hideBenefit||z(e).then((e=>{e.data&&e.code===l&&(Ee.value=e.data)})).finally((()=>{Ce.loading=!1})),G(e).then((({code:i,data:a})=>{var t,s;a&&i===l&&((null==a?void 0:a.errorInfo)&&u(`${null==a?void 0:a.errorInfo}`),Ce.trialMsg="",Ce.trialResultPremium=a.initialPremium,Ce.trialResult=a,null==(s=null==(t=a.insuredPremiumList)?void 0:t[0])||s.productPremiumList.forEach((e=>{Ae.value[e.productCode]=e.riskPremiumDetailVOList})),_("trialEnd",a,e))})).finally((()=>{Ce.loading=!1,Ce.isQuerying=!1})))}),500),xe=async()=>{var e,i,a,t;if(Ce.ifPersonalInfoSuccess||(null==(i=null==(e=ge.value)?void 0:e.canTrail)?void 0:i.call(e))){Ce.submitData.tenantId=`${Le}`,(null==(a=Ce.submitData.insuredList)?void 0:a.length)&&(Ce.submitData.insuredList=null==(t=Ce.submitData)?void 0:t.insuredList.map((e=>({...e,productList:null==e?void 0:e.productList.map((e=>({...e,riskList:Ce.riskList[e.productCode]})))}))));const e=_e();console.log(">>>数据构建<<<",e),await Ne(e)}},$e=async e=>{console.log("人的信息更改了"),Se(e),Ce.ifPersonalInfoSuccess=!0,console.log("处理第一被保人修改的dy变化"),xe()};r((()=>{var e;return((null==(e=Ce.userData)?void 0:e.insuredList)||[]).map((e=>e.birthday)).join(",")})),o((()=>{var e;return((null==(e=Ce.userData)?void 0:e.insuredList)||[]).map((e=>e.birthday)).join(",")}),F((async e=>{if(e){const e=Ce.userData.insuredList.filter((e=>e.birthday))||[];if(!e.length)return;const i=Object.keys(Pe.value).map((e=>({productCode:e,planCode:"",riskEditVOList:Pe.value[e].productPlanInsureVOList[0].insureProductRiskVOList.map((e=>({insureProductRiskVO:e})))})));await J({calcProductFactorList:i,insuredVOList:e,holderVO:Ce.userData.holder})}})),{});const Be=async(e,i,a)=>{if(i){const t=A(e);delete t.insurancePeriodValueList,delete t.paymentFrequencyList,delete t.paymentPeriodValueList;if(Fe.indexOf(i.key)>=0&&`${i.oldValue}`!=`${i.newValue}`){const s={};switch(i.key){case"annuityDrawDate":s.changeType=3;break;case"coveragePeriod":s.changeType=2;break;case"chargePeriod":s.changeType=1;break;case"paymentFrequency":s.changeType=4}const r=((e,i,a)=>{var t;return null==(t=Pe.value[e].productPlanInsureVOList)?void 0:t[0].insureProductRiskVOList.filter((e=>{const{paymentPeriodRule:t,paymentTypeRule:s,insurancePeriodRule:r}=e.productRiskInsureLimitVO;return a===B.MAIN_RISK&&e.mainRiskCode===i&&([t,s,r].includes(U.MAIN_RISK_SAME)||[t,s,r].includes(U.MAIN_RISK_1))?e:e.riskCode===i}))})(a,e.riskCode,e.riskType),l=(r||[]).map((i=>i.riskCode!==e.riskCode?{insureProductRiskVO:i,insureRiskEditReqVO:null}:{insureProductRiskVO:i,insureRiskEditReqVO:{riskId:e.riskId,riskCode:e.riskCode,...t,...s}}));if(!Ce.isAutoChange){Ce.isQuerying=!0;const e=Ce.userData.insuredList.filter((e=>e.birthday))||[];if(!e.length)return!1;await J({calcProductFactorList:[{planCode:be.value.planCode,productCode:a,riskEditVOList:l}],insuredVOList:e,holderVO:Ce.userData.holder}),Ce.isQuerying=!1;return!0}Ce.isAutoChange=!1}}return!0},Ue=F((async(e,i,a)=>{var t,s,r;(null==(s=null==(t=Ce.riskList)?void 0:t[a])?void 0:s.find((i=>i.riskCode===e.riskCode)))?Ce.riskList[a]=Ce.riskList[a].map((i=>i.riskCode===e.riskCode?e:i)):(null==(r=Ce.riskList[a])?void 0:r.length)?Ce.riskList[a].push(e):Ce.riskList[a]=[e];await Be(e,i,a)&&(console.log("标准险种的信息回传",e),xe())}),500),qe=e=>{Ce.userData=e,Ce.defaultValue=e},Ke=async e=>{var i;if(E.defaultData){const e=E.defaultData.find((e=>e.productCode===E.productInfo.productCode))||E.defaultData[0];qe(e),Se(null==(i=E.defaultData)?void 0:i[0])}else De.value.push(be.value.planCode),await(async()=>{var e;const i=await X({calcProductFactor:{productCode:null==(e=Object.keys(E.productCollection))?void 0:e[0]}});i.data&&(qe(i.data),Se(i.data))})()};d((()=>{var e,i;Ce.riskIsInsure={},null==(i=null==(e=be.value)?void 0:e.insureProductRiskVOList)||i.forEach((e=>{var i;const a=null==(i=be.value.productRiskRelationVOList)?void 0:i.find((i=>i.collocationRiskId===e.riskId));a&&(Ce.riskIsInsure[e.riskCode]={selected:"2",data:null,relation:a})}))})),n((()=>{be.value=E.dataSource,Ce.loading=!0,Ce.show=!0,Ce.isAniShow=!0,Ce.isSkipFirstTrial=!0,Ce.hadSkipFirstTrial=!1}));return D({getTrialSuccessFlag:()=>Ce.trialResultPremium>0,getRiderRiskDefaultValue:async(e,i,a)=>{var t,s,r,l;const u=Ce.riskList[e].find((e=>e.riskCode===a)),{code:o,data:d}=await W({holder:Ce.userData.holder,insuredList:Ce.userData.insuredList,calcRiskDefaultFactorVO:{mainRiskInfo:u,riskCode:i}});if("10000"===o){let u=!1,o=0;o=1===(null==(t=Ce.riskList[e])?void 0:t.length)?1:Ce.riskList[e].findIndex(((t,s)=>{if(t.riskCode===a)u=!0;else if(u&&i.riskType===B.MAIN_RISK)return u;return s+1===Ce.riskList[e].length})),Ce.defaultValue.insuredList[0].productList=null==(l=null==(r=null==(s=Ce.defaultValue)?void 0:s.insuredList)?void 0:r[0])?void 0:l.productList.map((i=>(e===i.productCode&&(i.riskList=[...i.riskList.slice(0,o),d,...i.riskList.slice(o,i.riskList.length)]),i)))}},getProductDefaultValue:async e=>{const{code:i,data:a}=await X({calcProductFactor:{productCode:e},holderVO:Ce.userData.holder,insuredVOList:Ce.userData.insuredList});if("10000"===i){const e=a.insuredList[0].productList[0];Ce.defaultValue.insuredList[0].productList.push(e)}},validate:()=>ge.value.validate(!1),validateTrialFields:()=>ge.value.validateTrialFields(),validateHolder:e=>{var i;return null==(i=ge.value)?void 0:i.validateHolder(e)},getUserData:()=>({...Ce.userData}),onShare:e=>{var i;Ce.trialResultPremium&&(null==(i=ae.value)||i.validate().then((()=>{Object.assign(Ie.value,E.defaultOrder,{extInfo:{...Ie.value.extInfo,buttonCode:Q.TRIAL_PREMIUM,pageCode:K.TRIAL_PREMIUM,templateId:ye}});const i=Z(E.productInfo,Ce.trialResult,Ie.value);ee(i,((i,a)=>{a===T.JUMP_PAGE&&(Re.value.link=`${window.location.href}&isShare=1&orderNo=${i.orderNo}`,e())})),console.log("---- validate success ----")})))},onNext:e=>{const{productCode:i,productName:a}=E.productInfo;he?V(K.TRIAL_PREMIUM,ke.query):Ce.trialResultPremium&&(Promise.all(ae.value.map((e=>e.validate()))).then((()=>{Object.assign(Ie.value,E.defaultOrder,{extInfo:{templateId:ye,...Ie.value.extInfo,...E.defaultOrder.extInfo||{},buttonCode:Q.TRIAL_PREMIUM,pageCode:K.TRIAL_PREMIUM}});const t=Z({..._e(),productCode:i,productName:a},Ce.trialResult,Ie.value);null==e||e(t),console.log("---- validate success ----")})),Ce.loading=!1,Ce.show=!0,Ce.isAniShow=!0)},dealMixData:_e}),o((()=>Ce.riskIsInsure),(e=>{}),{deep:!0,immediate:!0}),o((()=>Ce.userData),(e=>{if(e){const{holder:i,insuredList:a}=e||{},t={holder:i,insuredList:a};Object.assign(Ce.submitData,t),_("update:userData",t)}}),{immediate:!0,deep:!0}),o((()=>E.dataSource),(e=>{be.value=e}),{deep:!0,immediate:!0}),o((()=>E.productCollection),((e,i)=>{Object.keys(e||{}).length&&!Ce.defaultValue&&Ke(),Pe.value=e}),{deep:!0,immediate:!0}),o((()=>E.productFactor),(e=>{Oe.value=e}),{deep:!0,immediate:!0}),o((()=>E.defaultData),((e,i)=>{JSON.stringify(A(e))!==JSON.stringify(A(i))&&(console.log("value",e,i),Ce.defaultValue=e,Ce.userData=e||{})}),{deep:!0,immediate:!0}),(e,i)=>{var a,t;const s=S,r=w,l=M,u=j;return c(),p("div",te,[f(e.$slots,"trialHead",{},void 0,!0),v("div",se,[m(q,{labels:k(ie)((null==(a=be.value)?void 0:a.insureProductRiskVOList)||[],be.value.productRiskRelationVOList)},null,8,["labels"]),v("div",re,[Oe.value?(c(),L(x,{ref_key:"personalInfoRef",ref:ge,key:be.value.planCode,modelValue:k(Ce).userData,"onUpdate:modelValue":i[0]||(i[0]=e=>k(Ce).userData=e),"is-trial":e.isTrial,"product-factor":Oe.value,"multi-insured-config":null==(t=be.value)?void 0:t.multiInsuredConfigVO,onTrailChange:$e},null,8,["modelValue","is-trial","product-factor","multi-insured-config"])):y("",!0)]),f(e.$slots,"middleInfo",{},void 0,!0),m(s,{size:"large"}),v("div",le,[m(r,{title:"保障计划",class:"insurePlan","show-divider":!1}),Object.keys(Pe.value).length?(c(),p("div",ue,[(c(!0),p(h,null,g(Object.keys(Pe.value),((i,a)=>(c(),p("div",{key:i,class:"product-item"},[(c(!0),p(h,null,g(Pe.value[i].productPlanInsureVOList[0].insureProductRiskVOList||[],((t,s)=>{var r,u,o,d,n,f,L,h,g;return c(),p("div",{key:`${i}-${t.riskCode}`,class:"risk-item"},[m(l,{title:t.riskName,"risk-type":t.riskType},{default:C((()=>[e.isTrial?(c(),p("div",oe,[t.riskType===k(B).MAIN_RISK?(c(),p("div",{key:0,class:"add-risk btn",onClick:e=>((e,i)=>{const a=Ce.riskList[e].find((e=>e.riskCode===i));_("addRisk",e,a,Ce.userData.insuredList)})(i,t.riskCode)}," +附加险 ",8,de)):y("",!0),v("div",{class:"delete-risk btn",onClick:e=>((e,i,a)=>{P.confirm({message:"删除后将无法恢复，是否需要删除该产品？"}).then((()=>{Ce.defaultValue.insuredList[0].productList=i?Ce.defaultValue.insuredList[0].productList.map((i=>(i.productCode!==e&&(i.riskList=i.riskList.filter((e=>e.riskCode!==a))),i))):Ce.defaultValue.insuredList[0].productList.filter((i=>i.productCode!==e)),_("deleteRisk",e,a,i)}))})(i,t.mainRiskCode,t.riskCode)}," 删除 ",8,ne)])):y("",!0)])),_:2},1032,["title","risk-type"]),m(N,{ref_for:!0,ref_key:"insureInfosRef",ref:ae,"origin-data":t,"product-factor":be.value.productFactor,"default-value":k(Ce).defaultValue?null==(f=null==(n=null==(d=null==(o=null==(u=null==(r=k(Ce).defaultValue)?void 0:r.insuredList)?void 0:u[0])?void 0:o.productList)?void 0:d[a])?void 0:n.riskList)?void 0:f[s]:null,"trial-result":k(Ce).trialResult,onTrialChange:(e,a)=>k(Ue)(e,a,i)},null,8,["origin-data","product-factor","default-value","trial-result","onTrialChange"]),v("div",ce,[pe,v("span",fe,"¥"+I(k(R)((null==(g=null==(h=null==(L=Ae.value)?void 0:L[i])?void 0:h[s])?void 0:g.initialPremium)||"0"))+"元",1)])])})),128))])))),128))])):y("",!0),k(Ve)&&e.isTrial?(c(),p("div",ve,[m(u,{activated:"",onClick:Te},{default:C((()=>[b("+新增主险")])),_:1})])):y("",!0)]),me]),f(e.$slots,"trialBtn",{trialData:k(Ce).submitData,riskPremium:k(Ce).trialResult,loading:k(Ce).isQuerying,personalInfoRef:ge.value},void 0,!0)])}}}),[["__scopeId","data-v-09963698"]]);export{Le as T};
