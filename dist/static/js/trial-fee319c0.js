import{d as e,i as o,aP as t,j as a,k as s,l as i,o as l,p as r,w as d,a as u,e as c,b as n,u as p,q as v,c as m,F as f,s as k,v as R,_ as C,T as I,z as L,aQ as h,aR as y,A as b,av as g,aS as j,aT as w,h as T,aU as _,aV as q,aW as P,f as S,aX as N}from"./index-6a1895a4.js";import V from"./index-a739e061.js";import{a as x,b as A,g as M,s as K,i as D,m as O}from"./trial-54998071.js";import{R as B}from"./trial-90c99342.js";import{_ as E}from"./TrialButton-52fe7835.js";import{u as U}from"./useOrder-b9940872.js";import{p as F,a as z}from"./utils-d7a7b0e5.js";import{q as H}from"./createProposal-e2b259e0.js";import{g as $}from"./util-8c9f70d1.js";import{g as Q}from"./utils-74dd674b.js";import{f as W,a as X}from"./findLastIndex-837e608e.js";import{c as G}from"./cloneDeep-fef0fbe5.js";import"./InsureInfos-5795b391.js";import"./index-1ca6073b.js";import"./infoCollection-d891c840.js";import"./index-3e5cbe16.js";import"./PolicyInfo-a5aaff20.js";import"./questionnaire-42dcb602.js";import"./product-7bbf9c44.js";import"./constants-6ad2f07c.js";import"./nextStep-232f1550.js";import"./core-02ebb6d2.js";import"./format-31cde443.js";import"./index-56b2a458.js";import"./utils-e7f76078.js";const J={class:"popup-container"},Y={class:"popup-header"},Z={class:"title"},ee=(e=>(j("data-v-6241eb10"),e=e(),w(),e))((()=>u("p",{class:"tip"},"已为您挑选出以下险种",-1))),oe={class:"search"},te={key:0,class:"risk-list"},ae=e({name:"riskSelect"});var se=C(e({...ae,props:{type:{default:2},show:{type:Boolean,default:!1},title:{},insuredList:{default:()=>[]},mainRiskCode:{default:""},selectList:{default:()=>[]},currentProductCode:{default:""},productClass:{default:""}},emits:["cancel","confirm"],setup(e,{emit:C}){const j=e,w=o(),{insurerCode:T}=w.query,_=t(),q=a([]),P=a([]),S=a([]),N=a(),V=s((()=>j.show)),M=()=>{C("cancel")},K=()=>{var e;if(!(null==(e=q.value)?void 0:e.length))return void I(`暂未添加任何${j.type===B.MAIN_RISK?"主":"附加"}险`);let o=[];o=j.type===B.RIDER_RISK?q.value:P.value.filter((e=>q.value.includes(e.productCode))).map((e=>({productCode:e.productCode,mergeRiskReqList:(e.mainRiskCollocationList||[]).map((e=>({riskCode:e.collocationRiskCode,riskType:e.mainRiskCode?2:1,mainRiskCode:e.mainRiskCode})))}))),C("confirm",o)},D=async()=>{var e;const o={insuredList:j.insuredList,mainRiskCode:j.mainRiskCode,insurerCode:T,productCategory:"",keyword:N.value,selectProductCodes:[],selectRiskCodes:[],filterFlag:(null==(e=j.selectList)?void 0:e.length)?1:2,productClass:j.productClass,branchType:_["branch-type"]};if(o.selectProductCodes=j.selectList.map((e=>(e.productCode===j.currentProductCode&&o.selectRiskCodes.push(...e.mergeRiskReqList.map((e=>e.riskCode))),e.productCode))),j.type===B.MAIN_RISK){const{code:e,data:t}=await x(o);"10000"===e&&(P.value=t)}else{const{code:e,data:t}=await A(o);"10000"===e&&(P.value=t.riskInfoList,S.value=t.collocationInfoResList)}};return i((()=>{D()})),(e,o)=>{const t=L,a=h,s=y,i=b,C=g;return l(),r(C,{show:p(V),"onUpdate:show":o[2]||(o[2]=e=>v(V)?V.value=e:null),class:"popup-risk-select",closeable:!1},{default:d((()=>{var C;return[u("div",J,[u("div",Y,[u("span",{class:"clear-all",onClick:M}," 取消 "),u("span",Z,c(e.title),1),u("span",{class:"close",onClick:K},"确认")]),ee,u("div",oe,[n(t,{modelValue:p(N),"onUpdate:modelValue":o[0]||(o[0]=e=>v(N)?N.value=e:null),placeholder:"请输入产品名称进行搜索",onSearch:D},null,8,["modelValue"])]),(null==(C=p(P))?void 0:C.length)?(l(),m("div",te,[n(s,{modelValue:p(q),"onUpdate:modelValue":o[1]||(o[1]=e=>v(q)?q.value=e:null)},{default:d((()=>[(l(!0),m(f,null,k(p(P),(e=>(l(),r(a,{key:e.riskCode||e.productCode,name:e.riskCode||e.productCode,onClick:()=>{return o=e.riskCode,j.type===B.RIDER_RISK&&(S.value||[]).forEach((e=>{q.value.includes(o)?o===e.relatedRiskCode?(2===e.collocationType&&q.value.push(e.collocationRiskCode),3===e.collocationType&&(q.value.push(o),q.value=q.value.filter((o=>o!==e.collocationRiskCode)))):o===e.collocationRiskCode&&(2===e.collocationType&&q.value.push(e.relatedRiskCode),3===e.collocationType&&(q.value=q.value.filter((o=>o!==e.relatedRiskCode)))):o===e.relatedRiskCode?(2===e.collocationType&&(q.value=q.value.filter((o=>o!==e.collocationRiskCode))),3===e.collocationType&&(q.value.push(o),q.value=q.value.filter((o=>o!==e.collocationRiskCode)))):o===e.collocationRiskCode&&(2===e.collocationType&&(q.value=q.value.filter((o=>o!==e.relatedRiskCode))),3===e.collocationType&&(q.value=q.value.filter((o=>o!==e.relatedRiskCode))))})),void(q.value=[...new Set(q.value)]);var o}},{default:d((()=>[R(c(e.riskName||e.productName),1)])),_:2},1032,["name","onClick"])))),128))])),_:1},8,["modelValue"])])):(l(),r(i,{key:1,title:`暂无关联${e.type===p(B).MAIN_RISK?"主":"附加"}险、请选择其他险种`},null,8,["title"]))])]})),_:1},8,["show"])}}}),[["__scopeId","data-v-6241eb10"]]);const ie={class:"page-trial-wrap"},le=e({name:"trial"}),re=e({...le,setup(e){const t=o(),u=T(),{productCode:c,orderNo:v,tenantId:f,proposalId:k,proposalInsuredId:C,productClass:I}=t.query,{branchType:L}=Q(),h=a({}),y=a({productList:[]}),b=a([]),g=a({}),j=a(),w=a(),x=a(),A=U({extInfo:{buttonCode:_.TRIAL_PREMIUM,pageCode:q.TRIAL_PREMIUM}});$();const J=a(),Y=a(),Z=a(1),ee=s((()=>Z.value===B.MAIN_RISK?"添加主险":"添加附加险")),oe=a(!1),te=()=>{O(y.value).then((({code:e,data:o})=>{if("10000"===e){const{productDetailResList:e,productFactor:t}=o;Y.value=t,y.value=z(e);const a={};e.forEach((e=>{a[e.productCode]=e})),h.value=a}}))},ae=()=>{oe.value=!1},le=e=>{if(Z.value===B.MAIN_RISK){y.value.productList.push(...e);const o=e.map((e=>e.productCode));j.value.getProductDefaultValue(o)}else{const o=y.value.productList.find((e=>e.productCode===w.value)),t=e.map((e=>({riskCode:e,riskType:B.RIDER_RISK,mainRiskCode:g.value.riskCode}))),a=W(o.mergeRiskReqList,(e=>e.riskCode===g.value.riskCode)),s=X(o.mergeRiskReqList,(e=>e.mainRiskCode===g.value.riskCode));let i=a;-1!==s&&(i=s),o.mergeRiskReqList=[...o.mergeRiskReqList.slice(0,i+1),...t,...o.mergeRiskReqList.slice(i+1,o.mergeRiskReqList.length)],j.value.getRiderRiskDefaultValue(w.value,e,g.value.riskCode,o.mergeRiskReqList)}te(),oe.value=!1},re=(e,o,t)=>{oe.value=!0,Z.value=B.RIDER_RISK,b.value=t,g.value=o,w.value=e},de=e=>{oe.value=!0,Z.value=B.MAIN_RISK,b.value=e},ue=(e,o,t)=>{h.value[e],t?(h.value[e].productPlanInsureVOList[0].insureProductRiskVOList=h.value[e].productPlanInsureVOList[0].insureProductRiskVOList.filter((e=>e.riskCode!==o)),y.value.productList=y.value.productList.map((t=>(t.productCode===e&&(t.mergeRiskReqList=t.mergeRiskReqList.filter((e=>e.riskCode!==o))),t)))):(y.value.productList=y.value.productList.filter((o=>o.productCode!==e)),te())},ce=()=>{j.value.onNext((async e=>{var o;const a=G(e),s=["id","relationToHolder","beneficiaryList","guardian","insuredBeneficiaryType"];v||Object.keys(null==(o=a.insuredList)?void 0:o[0]).reduce(((e,o)=>{var t,i,l,r;return!s.includes(o)&&(null==(i=null==(t=a.insuredList)?void 0:t[0])?void 0:i[o])&&(e[o]=null==(r=null==(l=a.insuredList)?void 0:l[0])?void 0:r[o]),e}),a.holder),a.extInfo&&(a.extInfo.iseeBizNo=x.value),a.operateOption={withBeneficiaryInfo:!0,withHolderInfo:!0,withInsuredInfo:!0,withAttachmentInfo:!0,withProductInfo:!0};const{code:i,data:l}=await K(a);"10000"===i&&u.push({path:N.questionNotice,query:{...t.query,orderNo:l}})}))};return P((()=>{v?M({orderNo:v,tenantId:f}).then((({code:e,data:o})=>{"10000"===e&&(J.value=o,A.value=o,y.value=F(o.insuredList[0].productList),te())})):k?H({id:k,tenantId:f}).then((({code:e,data:o})=>{if("10000"===e){const{holder:e,insuredList:t}=o,a=(c||"").split(",");let s=[];const i=(t||[]).filter((e=>e.id===+C)).map((e=>({...e,relationToHolder:null,productList:e.productList.filter((e=>!!a.includes(e.productCode)&&(s=e.occupationCodeList,!0)))})));i[0].occupationCodeList=s,Object.assign(A.value,{renewFlag:"",holder:e,tenantId:f,proposalId:k,insuredList:i}),J.value=A.value,y.value=F(A.value.insuredList[0].productList),te()}})):D({productCode:c,isTenant:!1}).then((({data:e,code:o})=>{var t,a;"10000"===o&&(h.value[`${c}`]=e,Y.value=null==(a=null==(t=null==e?void 0:e.productPlanInsureVOList)?void 0:t[0])?void 0:a.productFactor,y.value=z([e]))}))})),i((()=>{setTimeout((async()=>{x.value=window.getIseeBiz&&await window.getIseeBiz()}),1500)})),(e,o)=>(l(),m("div",ie,[n(V,{ref_key:"trialRef",ref:j,"product-collection":p(h),"default-data":p(J),"product-factor":p(Y),"product-risk-code-map":p(y),"is-trial":"","hide-benefit":"",onAddRisk:re,onAddMainRisk:de,onDeleteRisk:ue},{trialBtn:d((({riskPremium:e})=>[n(E,{premium:null==e?void 0:e.initialPremium,onHandleClick:ce},{label:d((()=>[R(" 首年总保费 ")])),_:2},1032,["premium"])])),_:1},8,["product-collection","default-data","product-factor","product-risk-code-map"]),p(oe)?(l(),r(se,{key:0,type:p(Z),"product-class":p(I),show:p(oe),"insured-list":p(b),title:p(ee),"current-product-code":p(w),"main-risk-code":p(g).riskCode,"select-list":p(y).productList,"branch-type":p(L),onCancel:ae,onConfirm:le},null,8,["type","product-class","show","insured-list","title","current-product-code","main-risk-code","select-list","branch-type"])):S("",!0)]))}});export{re as default};
