import{d as e,i,h as t,g as a,r as s,j as r,aF as l,aG as u,T as o,z as d,aE as n,O as c,o as p,c as f,f as v,a as k,b as m,u as L,l as y,q as h,F as R,n as C,w as I,e as g,aH as D,a8 as P,_ as b,aI as O,aJ as V,aK as T,aL as S,a6 as M,aM as _,aN as E,aO as j,aP as w,aC as A,aD as N}from"./index-8067fbb0.js";import{c as F}from"./cloneDeep-24548d52.js";import{_ as x}from"./InsureInfos-9031a2b9.js";import{P as $}from"./index-5c0b97f6.js";import{P as K,R as q,b as B}from"./trial-67ba3d02.js";import{_ as U,P as Q,B as H}from"./constants-11bb7658.js";import{u as J,c as G,p as z,d as W,e as Y,q as X}from"./trial-c7cbecff.js";import{u as Z}from"./useOrder-3c8c8246.js";import{t as ee}from"./utils-1d02051c.js";import{n as ie}from"./nextStep-7443c833.js";const te=(e,i)=>{const t=[],a={};return null==e||e.forEach((e=>{a[e.riskId]=e})),null==i||i.forEach((e=>{var i,s,r,l;const{collocationType:u,collocationRiskId:o,riskId:d}=e;switch(u){case 2:{const e=null==(i=a[d])?void 0:i.riskName,r=null==(s=a[o])?void 0:s.riskName;t.push(`${e} 和 ${r} 必须同时投保`);break}case 3:{const e=null==(r=a[d])?void 0:r.riskName,i=null==(l=a[o])?void 0:l.riskName;t.push(`${e} 和 ${i} 不能同时投保`);break}}})),t};const ae=e=>(A("data-v-45118ea4"),e=e(),N(),e),se={class:"com-body"},re={class:"trial-body"},le={class:"container"},ue={class:"container"},oe={key:0,class:"product-list"},de={key:0,class:"operate-bar"},ne=["onClick"],ce=["onClick"],pe={class:"premium-item"},fe=ae((()=>k("span",{class:"label"},"首期保费",-1))),ve={class:"price"},ke={key:1,class:"add-main-risk"},me=ae((()=>k("div",{class:"empty"},null,-1))),Le=e({name:"TrialBody"});var ye=b(e({...Le,props:{selfKey:{default:""},dataSource:{default:()=>[]},productInfo:{default:()=>({productCode:"",productName:"",insurerCode:"",tenantId:"",planList:[]})},tenantProductDetail:{default:()=>({})},hideBenefit:{type:Boolean,default:!1},hidePopupButton:{type:Boolean,default:!1},title:{default:"算一算保费"},defaultData:{default:null},isTrial:{type:Boolean,default:!1},defaultOrder:{default:()=>({})},productCollection:{default:()=>({})},productFactor:{default:()=>({})},productRiskCodeMap:{default:()=>({})}},emits:["trialStart","trialEnd","update:userData","closeCustomerPopoup","addRisk","addMainRisk","deleteRisk"],setup(e,{expose:b,emit:A}){const N=e,ae=i(null),Le=t();a();const{tenantId:ye,templateId:he,preview:Re}=Le.query,Ce=i(),Ie=s({loading:!1,show:!1,select:{},list:[],userData:{},riskIsInsure:{},submitData:{},riskList:{},mainRiskVO:{},ifPersonalInfoSuccess:!1,trialMsg:"",trialResultPremium:0,trialResult:{initialPremium:0,initialAmount:0},isAniShow:!1,defaultValue:null,isAutoChange:!1,planIndex:0,isSkipFirstTrial:!1,hadSkipFirstTrial:!1,isQuerying:!1,currentPlanCode:""}),ge=Z();i();const De=i(),Pe=i(N.dataSource),be=i([]),Oe=i(),Ve=i(),Te=i({}),Se=r((()=>{var e;let i=!1;return((null==(e=N.productRiskCodeMap)?void 0:e.productList)||[]).forEach((e=>{e.mergeRiskReqList.find((e=>1===e.exemptType))&&(i=!0)})),i})),Me=i({}),_e=l((async(e,i=!0)=>{Ie.trialMsg="试算中...",Ie.trialResultPremium=0,Ie.loading=!0,A("trialStart");let t=!1;if(i){const{code:i}=await J(e);t="10000"===i}!t&&i||(Ie.isQuerying=!0,N.hideBenefit||G(e).then((e=>{e.data&&e.code===u&&(Me.value=e.data)})).finally((()=>{Ie.loading=!1})),z(e).then((({code:i,data:t})=>{var a,s;t&&i===u&&((null==t?void 0:t.errorInfo)&&o(`${null==t?void 0:t.errorInfo}`),Ie.trialMsg="",Ie.trialResultPremium=t.initialPremium,Ie.trialResult=t,null==(s=null==(a=t.insuredPremiumList)?void 0:a[0])||s.productPremiumList.forEach((e=>{Te.value[e.productCode]=e.riskPremiumDetailVOList})),A("trialEnd",t,e))})).finally((()=>{Ie.loading=!1,Ie.isQuerying=!1})))}),500),Ee=r((()=>{var e,i;return![K.SINGLE_PRODUCT,K.TWO_PRODUCT].includes(null==(i=null==(e=Object.values(N.productCollection))?void 0:e[0])?void 0:i.productClass)})),je=()=>{A("addMainRisk",Ie.userData.insuredList)},we=e=>{const{holder:i,insuredList:t}=e||{};i&&(Ie.submitData.holder=i),t&&t.length>0&&t.forEach(((e,i)=>{var t;Ie.submitData.insuredList&&Ie.submitData.insuredList.length>i?Ie.submitData.insuredList[i]=e:((null==(t=Ie.submitData)?void 0:t.insuredList)||(Ie.submitData.insuredList=[]),Ie.submitData.insuredList.push(e))}))},Ae=r((()=>N.productInfo.planList&&N.productInfo.planList.length>2)),Ne=(e,i)=>{if(e){const t=["birthday","age","gender","id"];i.includes("occupationCodeList")&&t.push("occupationClass"),Object.keys(e).forEach((a=>{[...i,...t].includes(a)||(e[a]=null)}))}},Fe=(e,i=(e=>!0))=>V(e)?e.filter(i).map((e=>e.code)):[],xe=()=>{console.log("--current plan = ",Pe.value),console.log("---current submit = ",Ie.submitData);const e=F(Ie.submitData);if(!Ae.value)return e;const{1:i,2:t,3:a}=Pe.value.productFactor||{};if(e.holder&&Ne(e.holder,Fe(i)),e.insuredList){const i=["productList","beneficiaryList"],s=Fe(t,(e=>"2"!==String(e.subModuleType))),r=Fe(t,(e=>"2"===String(e.subModuleType))),l=V(r),u=Fe(a),o=V(u);e.insuredList.forEach(((e,t)=>{var a,d,n;Ne(e,[...t>=1&&l?r:s,...i,...o?["insuredBeneficiaryType"]:[]]),(null==(a=e.beneficiaryList)?void 0:a.length)>0&&(o?e.beneficiaryList.forEach((e=>Ne(e,u))):e.beneficiaryList.length=0),e.planCode=Pe.value.planCode;const c=(null==(n=null==(d=e.productList)?void 0:d[0])?void 0:n.riskList)||[],p=Pe.value.insureProductRiskVOList||[];if(c.length&&p){const i=c.filter((e=>null!==p.find((i=>i.riskCode===e.riskCode))));e.productList[0].riskList=i}}))}return e},$e=["annuityDrawDate","coveragePeriod","chargePeriod","paymentFrequency"],Ke=async()=>{var e,i,t,a;if(Ie.ifPersonalInfoSuccess||(null==(i=null==(e=Ce.value)?void 0:e.canTrail)?void 0:i.call(e))){Ie.submitData.tenantId=`${ye}`,(null==(t=Ie.submitData.insuredList)?void 0:t.length)&&(Ie.submitData.insuredList=null==(a=Ie.submitData)?void 0:a.insuredList.map((e=>({...e,productList:null==e?void 0:e.productList.map((e=>({...e,riskList:Ie.riskList[e.productCode]})))}))));const e=xe();console.log(">>>数据构建<<<",e),await _e(e)}},qe=async e=>{var i,t,a;console.log("人的信息更改了"),we(e),Ie.ifPersonalInfoSuccess=!0,console.log("处理第一被保人修改的dy变化"),(null==(a=null==(t=null==(i=Ie.userData.insuredList)?void 0:i[0])?void 0:t.productList)?void 0:a.length)&&Ke()};r((()=>{var e;return((null==(e=Ie.userData)?void 0:e.insuredList)||[]).map((e=>e.birthday)).join(",")})),d((()=>{var e;return((null==(e=Ie.userData)?void 0:e.insuredList)||[]).map((e=>e.birthday)).join(",")}),l((async e=>{if(e){const e=Ie.userData.insuredList.filter((e=>e.birthday))||[];if(!e.length)return;const i=Object.keys(Oe.value).map((e=>({productCode:e,planCode:"",riskEditVOList:Oe.value[e].productPlanInsureVOList[0].insureProductRiskVOList.map((e=>({insureProductRiskVO:e})))})));await W({calcProductFactorList:i,insuredVOList:e,holderVO:Ie.userData.holder})}})),{});const Be=async(e,i,t)=>{if(i){const a=F(e);delete a.insurancePeriodValueList,delete a.paymentFrequencyList,delete a.paymentPeriodValueList;if($e.indexOf(i.key)>=0&&`${i.oldValue}`!=`${i.newValue}`){const s={};switch(i.key){case"annuityDrawDate":s.changeType=3;break;case"coveragePeriod":s.changeType=2;break;case"chargePeriod":s.changeType=1;break;case"paymentFrequency":s.changeType=4}const r=((e,i,t)=>{var a,s;let r=null,l=null,u=null,o=null;if(t===q.RIDER_RISK){const t=null==(a=Oe.value[e].productPlanInsureVOList)?void 0:a[0].insureProductRiskVOList.find((e=>e.riskCode===i)),{mainRiskCode:s,productRiskInsureLimitVO:d}=t,{paymentPeriodRule:n,paymentTypeRule:c,insurancePeriodRule:p}=d||{};r=n,l=c,u=p,o=s}return console.log("mainRiskCode",o),null==(s=Oe.value[e].productPlanInsureVOList)?void 0:s[0].insureProductRiskVOList.filter((e=>{if(t===q.MAIN_RISK){const{paymentPeriodRule:i,paymentTypeRule:t,insurancePeriodRule:a}=e.productRiskInsureLimitVO||{};r=i,l=t,u=a}return!(t!==q.MAIN_RISK||e.mainRiskCode!==i||![r,l,u].includes(B.MAIN_RISK_SAME)&&![r,l,u].includes(B.MAIN_RISK_1))||!(t===q.MAIN_RISK||e.riskCode!==i&&e.riskCode!==o||![r,l,u].includes(B.MAIN_RISK_SAME)&&![r,l,u].includes(B.MAIN_RISK_1))||e.riskCode===i}))})(t,e.riskCode,e.riskType).flat();console.log("riskInfoList",r);const l=(r||[]).map((i=>i.riskCode!==e.riskCode?{insureProductRiskVO:i,insureRiskEditReqVO:null}:{insureProductRiskVO:i,insureRiskEditReqVO:{riskId:e.riskId,riskCode:e.riskCode,...a,...s}}));if(!Ie.isAutoChange){Ie.isQuerying=!0;const e=Ie.userData.insuredList.filter((e=>e.birthday))||[];if(!e.length)return!1;await W({calcProductFactorList:[{planCode:Pe.value.planCode,productCode:t,riskEditVOList:l}],insuredVOList:e,holderVO:Ie.userData.holder}),Ie.isQuerying=!1;return!0}Ie.isAutoChange=!1}}return!0},Ue=e=>{Ie.userData=e,Ie.defaultValue=e},Qe=async e=>{var i;if(N.defaultData){const e=N.defaultData.find((e=>e.productCode===N.productInfo.productCode))||N.defaultData[0];Ue(e),we(null==(i=N.defaultData)?void 0:i[0])}else be.value.push(Pe.value.planCode),await(async()=>{var e;const i=await X({calcProductFactorList:[{productCode:null==(e=Object.keys(N.productCollection))?void 0:e[0]}]});i.data&&(Ue(i.data),we(i.data))})()};n((()=>{var e,i;Ie.riskIsInsure={},null==(i=null==(e=Pe.value)?void 0:e.insureProductRiskVOList)||i.forEach((e=>{var i;const t=null==(i=Pe.value.productRiskRelationVOList)?void 0:i.find((i=>i.collocationRiskId===e.riskId));t&&(Ie.riskIsInsure[e.riskCode]={selected:"2",data:null,relation:t})}))})),c((()=>{Pe.value=N.dataSource,Ie.loading=!0,Ie.show=!0,Ie.isAniShow=!0,Ie.isSkipFirstTrial=!0,Ie.hadSkipFirstTrial=!1}));return b({getTrialSuccessFlag:()=>Ie.trialResultPremium>0,getRiderRiskDefaultValue:async(e,i,t)=>{var a,s,r;const l=Ie.riskList[e].find((e=>e.riskCode===t)),{code:u,data:o}=await Y({holder:Ie.userData.holder,insuredList:Ie.userData.insuredList,calcRiskDefaultFactorVO:{mainRiskInfo:l,riskCodeList:i}});if("10000"===u){let t=0;t=Ie.riskList[e].findIndex(((e,t)=>e.riskCode===i[0])),Ie.defaultValue.insuredList[0].productList=null==(r=null==(s=null==(a=Ie.defaultValue)?void 0:a.insuredList)?void 0:s[0])?void 0:r.productList.map((i=>(e===i.productCode&&(i.riskList=[...i.riskList.slice(0,t),...o,...i.riskList.slice(t,i.riskList.length)]),i)))}},getProductDefaultValue:async e=>{const{code:i,data:t}=await X({calcProductFactorList:e.map((e=>({productCode:e}))),holderVO:Ie.userData.holder,insuredVOList:Ie.userData.insuredList});"10000"===i&&(Ie.defaultValue.insuredList[0].productList=t.insuredList[0].productList,Object.assign(Ie.userData,t))},validate:()=>Ce.value.validate(!1),validateTrialFields:()=>Ce.value.validateTrialFields(),validateHolder:e=>{var i;return null==(i=Ce.value)?void 0:i.validateHolder(e)},getUserData:()=>({...Ie.userData}),onShare:e=>{var i;Ie.trialResultPremium&&(null==(i=ae.value)||i.validate().then((()=>{Object.assign(ge.value,N.defaultOrder,{extInfo:{...ge.value.extInfo,buttonCode:H.TRIAL_PREMIUM,pageCode:Q.TRIAL_PREMIUM,templateId:he}});const i=ee(N.productInfo,Ie.trialResult,ge.value);ie(i,((i,t)=>{t===S.JUMP_PAGE&&(De.value.link=`${window.location.href}&isShare=1&orderNo=${i.orderNo}`,e())})),console.log("---- validate success ----")})))},onNext:e=>{const{productCode:i,productName:t}=N.productInfo;Re?T(Q.TRIAL_PREMIUM,Le.query):Ie.trialResultPremium&&(Promise.all(ae.value.map((e=>e.validate()))).then((()=>{Object.assign(ge.value,N.defaultOrder,{extInfo:{templateId:he,...ge.value.extInfo,...N.defaultOrder.extInfo||{},buttonCode:H.TRIAL_PREMIUM,pageCode:Q.TRIAL_PREMIUM}});const a=ee({...xe(),productCode:i,productName:t},Ie.trialResult,ge.value);null==e||e(a),console.log("---- validate success ----")})),Ie.loading=!1,Ie.show=!0,Ie.isAniShow=!0)},dealMixData:xe}),d((()=>Ie.userData),(e=>{if(e){const{holder:i,insuredList:t}=e||{},a={holder:i,insuredList:t};Object.assign(Ie.submitData,a),A("update:userData",a)}}),{immediate:!0,deep:!0}),d((()=>N.dataSource),(e=>{Pe.value=e}),{deep:!0,immediate:!0}),d((()=>N.productCollection),((e,i)=>{Object.keys(e||{}).length&&!Ie.defaultValue&&Qe(),Oe.value=e,Object.keys(e||[]).forEach((i=>{Ie.riskList[i]=e[i].productPlanInsureVOList[0].insureProductRiskVOList.map((e=>(Ie.riskList[i]||[]).find((i=>i.riskCode===e.riskCode))||e))}))}),{deep:!0,immediate:!0}),d((()=>N.productFactor),(e=>{Ve.value=e}),{deep:!0,immediate:!0}),d((()=>N.defaultData),((e,i)=>{JSON.stringify(F(e))!==JSON.stringify(F(i))&&(Ie.defaultValue=e,Ie.userData=e||{})}),{deep:!0,immediate:!0}),(e,i)=>{var t,a,s;const r=_,l=E,u=j,o=w;return p(),f("div",se,[v(e.$slots,"trialHead",{},void 0,!0),k("div",re,[m(U,{labels:L(te)((null==(t=Pe.value)?void 0:t.insureProductRiskVOList)||[],Pe.value.productRiskRelationVOList)},null,8,["labels"]),k("div",le,[(null==(a=Object.keys(Ve.value))?void 0:a.length)?(p(),y($,{ref_key:"personalInfoRef",ref:Ce,key:Pe.value.planCode,modelValue:L(Ie).userData,"onUpdate:modelValue":i[0]||(i[0]=e=>L(Ie).userData=e),"is-holder-exempt":L(Se),"is-trial":e.isTrial,"product-factor":Ve.value,"multi-insured-config":null==(s=Pe.value)?void 0:s.multiInsuredConfigVO,onTrailChange:qe},null,8,["modelValue","is-holder-exempt","is-trial","product-factor","multi-insured-config"])):h("",!0)]),v(e.$slots,"middleInfo",{},void 0,!0),m(r,{size:"large"}),k("div",ue,[m(l,{title:"保障计划",class:"insurePlan","show-divider":!1}),Object.keys(Oe.value).length?(p(),f("div",oe,[(p(!0),f(R,null,C(Object.keys(Oe.value),((i,t)=>(p(),f("div",{key:i,class:"product-item"},[(p(!0),f(R,null,C(Oe.value[i].productPlanInsureVOList[0].insureProductRiskVOList||[],((a,s)=>{var r,l,o,d,n,c,v,y,R;return p(),f("div",{key:`${i}-${a.riskCode}`,class:"risk-item"},[m(u,{title:a.riskName,"risk-type":a.riskType},{default:I((()=>[e.isTrial?(p(),f("div",de,[a.riskType===L(q).MAIN_RISK?(p(),f("div",{key:0,class:"add-risk btn",onClick:e=>((e,i)=>{const t=Ie.riskList[e].find((e=>e.riskCode===i));A("addRisk",e,t,Ie.userData.insuredList)})(i,a.riskCode)}," +附加险 ",8,ne)):h("",!0),k("div",{class:"delete-risk btn",onClick:e=>((e,i,t)=>{O.confirm({message:"删除后将无法恢复，是否需要删除该产品？"}).then((()=>{var a,s;i?(Ie.defaultValue.insuredList[0].productList=Ie.defaultValue.insuredList[0].productList.map((i=>(i.productCode===e&&(i.riskList=i.riskList.filter((e=>e.riskCode!==t))),i))),Ie.userData.insuredList[0].productList=Ie.userData.insuredList[0].productList.map((i=>(i.productCode===e&&(i.riskList=i.riskList.filter((e=>e.riskCode!==t))),i)))):(Ie.defaultValue.insuredList[0].productList=Ie.defaultValue.insuredList[0].productList.filter((i=>i.productCode!==e)),Ie.userData.insuredList[0].productList=Ie.userData.insuredList[0].productList.filter((i=>i.productCode!==e))),(null==(s=null==(a=Ie.userData.insuredList[0])?void 0:a.productList)?void 0:s.length)?_e(Ie.userData):Ie.trialResult={initialPremium:0,initialAmount:0},A("deleteRisk",e,t,i)}))})(i,a.mainRiskCode,a.riskCode)}," 删除 ",8,ce)])):h("",!0)])),_:2},1032,["title","risk-type"]),m(x,{ref_for:!0,ref_key:"insureInfosRef",ref:ae,"origin-data":a,"product-factor":Pe.value.productFactor,"default-value":L(Ie).defaultValue?null==(c=null==(n=null==(d=null==(o=null==(l=null==(r=L(Ie).defaultValue)?void 0:r.insuredList)?void 0:l[0])?void 0:o.productList)?void 0:d[t])?void 0:n.riskList)?void 0:c[s]:null,"trial-result":L(Ie).trialResult,onTrialChange:(e,t)=>(async(e,i,t)=>{var a,s,r;if((null==(s=null==(a=Ie.riskList)?void 0:a[t])?void 0:s.find((i=>i.riskCode===e.riskCode)))?Ie.riskList[t]=Ie.riskList[t].map((i=>i.riskCode===e.riskCode?e:i)):(null==(r=Ie.riskList[t])?void 0:r.length)?Ie.riskList[t].push(e):Ie.riskList[t]=[e],e.exemptFlag!==M.YES&&!(await Be(e,i,t)))return;console.log("标准险种的信息回传",e),Ke()})(e,t,i)},null,8,["origin-data","product-factor","default-value","trial-result","onTrialChange"]),k("div",pe,[fe,k("span",ve,"¥"+g(L(D)((null==(R=null==(y=null==(v=Te.value)?void 0:v[i])?void 0:y[s])?void 0:R.initialPremium)||"0"))+"元",1)])])})),128))])))),128))])):h("",!0),L(Ee)&&e.isTrial?(p(),f("div",ke,[m(o,{activated:"",onClick:je},{default:I((()=>[P("+新增主险")])),_:1})])):h("",!0)]),me]),v(e.$slots,"trialBtn",{trialData:L(Ie).submitData,riskPremium:L(Ie).trialResult,loading:L(Ie).isQuerying,personalInfoRef:Ce.value},void 0,!0)])}}}),[["__scopeId","data-v-45118ea4"]]);export{ye as T};
