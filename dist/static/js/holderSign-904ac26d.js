import{d as e,i as a,h as i,c5 as s,cV as t,j as n,k as r,ah as o,E as l,bc as d,b4 as u,cW as c,l as v,o as f,c as p,b as h,a as g,u as m,p as y,f as b,a8 as I,w as S,v as j,bj as O,bb as N,T as w,cX as L,aY as E,y as T,cN as x,cO as D,c4 as C,cY as k,cP as q,bO as R,a$ as V,cQ as P,cZ as H,b3 as z,c_ as U}from"./index-4d5fa34d.js";import{b as $}from"./product-e6be0572.js";import{g as _,m as A}from"./trial-7f683ad0.js";import{_ as B}from"./SignPart-3ac05ba6.js";import{u as F}from"./useOrder-a6e85070.js";import{N as M}from"./notice-3ea0c903.js";import"./PolicyInfo-6b9907fb.js";import{c as Y}from"./scribing-b0ffb67d.js";import{p as W}from"./utils-f5504a35.js";import{g as G}from"./utils-40b0d14f.js";import{i as J}from"./core-7b92637e.js";import"./index-9bf5c90e.js";import"./cloneDeep-9c9c9929.js";import"./utils-4f369f99.js";import"./createProposal-6ed222b2.js";import"./trial-ed50f9b6.js";import"./infoCollection-5f2115ca.js";const Q={class:"long-verify"},X={class:"header"},Z={class:"verify-content"},K={class:"footer-button"},ee=e({__name:"holderSign",setup(e){const ee=a(),ae=i(),{productCode:ie="",tenantId:se,agentCode:te="",agencyCode:ne,saleChannelId:re,saleUserId:oe,orderNo:le,orderCode:de,extraInfo:ue,isShare:ce,insurerCode:ve,preview:fe}=ee.query;let pe={};try{pe=JSON.parse(decodeURIComponent(ue))}catch(Te){}const he=F(),ge=`${window.origin}/baseInsurance/long/phoneVerify?${s.stringify({...ee.query,orderNo:de||le})}`,me=new t({source:"localStorage"}),ye=n(),be=n({holder:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:[]},insured:{fileList:[],personalInfo:[],isSign:!1,isVerify:!1,isShareSign:!1,signData:{}},agent:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""}}),Ie=n({}),Se=n({}),je=n({sign:[],verify:[],scribing:""}),Oe=r((()=>{var e,a;const{age:i,relationToHolder:s,id:t}=(null==(a=null==(e=be.value.insured)?void 0:e.personalInfo)?void 0:a[0])||{};return`${s}`===o.CERT||i<18})),Ne=()=>{if(fe)return void O(N.SIGN,ee.query);const e=[];ye.value&&((ce?je.value.sign.includes("4"):je.value.sign.includes("2"))&&e.push(ye.value.validateSign()),je.value.verify.includes("1")&&e.push(ye.value.validateVerify())),Promise.all(e).then((e=>{!je.value.scribing||Ie.value.status?L(he.value).then((({code:e,data:a})=>{"10000"===e&&(a.authStatus===`${E.YES}`?ae.push({path:T.payAuth,query:ee.query}):Promise.all([x({bizObjectId:[he.value.holder.id],bizObjectType:D.HOLDER,orderId:he.value.id,tenantId:se,shareFlag:ce?1:2}),Oe.value&&x({bizObjectId:[he.value.insuredList[0].id],bizObjectType:D.INSURED,orderId:he.value.id,tenantId:se})]).then((e=>{if("10000"===e[0].code){if(ce)return w("本次签名已完成"),void setTimeout((()=>{J?C.closeWindow():window.close()}),1500);ae.push({path:T.sign,query:ee.query})}})))})):w("请先完成风险抄录")})).catch((e=>{w(e.message)}))},we=()=>{le&&_({orderNo:de||le,tenantId:se}).then((({code:e,data:a})=>{var i,s,t,n;if("10000"===e){const e=[];a.tenantOrderAttachmentList.forEach((a=>{a.objectType===M.HOlDER&&30===a.category&&e.push(a.fileBase64)})),be.value.holder.signData=e,Object.assign(Se.value,{type:k[a.extInfo.transcriptionType],signInfo:null==(s=null==(i=a.riskTranscriptionList)?void 0:i[0])?void 0:s.uri,text:null==(n=null==(t=a.riskTranscriptionList)?void 0:t[0])?void 0:n.content,status:!!a.extInfo.transcriptionStatus})}}))};n({imgUrl:"",desc:"",title:"",link:ge});const Le=e=>{const{type:a,text:i}=Ie.value,s={...ee.query,orderNo:de||le,text:i,orderId:he.value.id};"handle"===a?ae.push({path:"scribing",query:s}):Y({content:i,image:e,orderNo:de||le,tenantId:se,transcriptionType:U.AUTO}).then((({code:e})=>{"10000"===e&&we()}))};l([()=>Se.value,()=>Ie.value],(()=>{Object.assign(Ie.value,{type:Se.value.type||Ie.value.type,text:Se.value.text||Ie.value.text,status:Se.value.status||Ie.value.status,signInfo:Se.value.signInfo||Ie.value.signInfo})}),{deep:!0,immediate:!0}),d((()=>{(async()=>{var e,a,i,s;let t={};const{code:n,data:r}=await _({orderNo:de||le,tenantId:se});"10000"===n&&(Object.assign(he.value,r),be.value.holder.personalInfo={...r.holder,isCert:1},be.value.insured.personalInfo=r.insuredList.map((e=>(e.isCert=1,e))),t=W(r.insuredList[0].productList),Object.assign(Se.value,{type:k[r.extInfo.transcriptionType],signInfo:null==(a=null==(e=r.riskTranscriptionList)?void 0:e[0])?void 0:a.uri,text:null==(s=null==(i=r.riskTranscriptionList)?void 0:i[0])?void 0:s.content,status:!!r.extInfo.transcriptionStatus}),he.value.tenantOrderAttachmentList.forEach((e=>{e.objectType===M.HOlDER&&30===e.category&&be.value.holder.signData.push(e.fileBase64)}))),$(t).then((({code:e,data:a})=>{var i;if("10000"===e){const{signMaterialMap:e}=(null==(i=a.productMaterialPlanVOList)?void 0:i[1])||{};(Object.values(e||{}).flat()||[]).forEach((e=>{e.noticeObject===M.HOlDER&&be.value.holder.fileList.push({attachmentName:e.materialName,attachmentList:[{...e,materialSource:G(`${null==e?void 0:e.materialSource}`,null==e?void 0:e.materialContent)}]})}))}})),A(t).then((({data:e,code:a})=>{if("10000"===a){const{signInfo:a}=R(e.productFactor);a.schema.forEach((e=>{"eleSign"===e.name&&e.columns.forEach((a=>{e.required&&je.value.sign.push(a.code),"1"===a.code?be.value.agent.isSign=!0:"2"===a.code?be.value.holder.isSign=!0:"3"===a.code?be.value.insured.isSign=!0:"4"===a.code?be.value.holder.isShareSign=!0:"5"===a.code&&(be.value.insured.isShareSign=!0)})),"riskNotificationCopy"===e.name&&(Ie.value.text=e.remark,je.value.scribing=e.required,e.columns.forEach((e=>{"1"===e.code?Ie.value.type="handle":Ie.value.type="auto"}))),"customerFace"===e.name&&e.columns.forEach((a=>{e.required&&je.value.verify.push(a.code),"1"===a.code?be.value.holder.isVerify=!0:"2"===a.code&&(be.value.insured.isVerify=!0)}))}))}}))})();const e=u.get("verifyData");if(e){const{serialNo:a,certNo:i,name:s}=e;c({certiNo:i,orderNo:de||le,serialNo:a,tenantId:se,userName:s}).then((e=>{const{code:a,data:i}=e;"10000"===a&&(me.remove("verifyData"),we())}))}}));const Ee=n();return v((()=>{setTimeout((async()=>{Ee.value=window.getIseeBiz&&await window.getIseeBiz()}),1500)})),(e,a)=>{const i=V,s=P,t=H,n=z;return f(),p("div",Q,[h(i),g("div",X,[h(s,{type:"warning",title:"尊敬的客户，本次投保需要进行身份认证",content:"本产品投保需要对投保人、被保险人进行实名认证，您购买本产品的累计总保费已超过20万，按监管要求，需要提供投保人、被保险人、指定受益人证件影像，本产品非本人投保且带身故责任、需对投保人、被保险人（成人）的投保意愿进行签名确认。"})]),g("div",Z,[!m(ce)||m(be).holder.isShareSign?(f(),y(B,{key:0,ref_key:"holderSignRef",ref:ye,"order-detail":m(he),"sign-string":m(be).holder.signData,"show-sign":m(ce)?m(be).holder.isShareSign:m(be).holder.isSign,"show-verify":m(be).holder.isVerify,"file-list":m(be).holder.fileList,"personal-info":m(be).holder.personalInfo,title:"投保人",onHandleSign:a[0]||(a[0]=e=>((e,a,i)=>{var s,t,n,r;const o=[q(e,a,null==(s=he.value)?void 0:s.id,se,i)],{id:l}=(null==(n=null==(t=be.value.insured)?void 0:t.personalInfo)?void 0:n[0])||{};Oe.value&&o.push(q("INSURED",a,null==(r=he.value)?void 0:r.id,se,l)),Promise.all(o).then((e=>{we()}))})("HOLDER",e,m(be).holder.personalInfo.id))},null,8,["order-detail","sign-string","show-sign","show-verify","file-list","personal-info"])):b("",!0)]),m(je).scribing?(f(),y(t,I({key:0},m(Ie),{title:"为了保障您的权益请抄录以下声明内容",onOnSubmit:Le}),null,16)):b("",!0),g("div",K,[h(n,{type:"primary",onClick:Ne},{default:S((()=>[j("确定")])),_:1})])])}}});export{ee as default};
