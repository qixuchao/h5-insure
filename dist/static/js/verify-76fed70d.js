import{d as e,r as i,L as a,y as s,R as n,b as l,c as t,A as o,i as r,w as d,f as u,E as c,g as f,F as v,Z as g,h,j as p,e as m,a2 as y,C as S,ae as w,bi as I,u as b,aq as C,o as j,U as _,V as k,ay as L,az as O,a9 as N,bv as V,n as x,D as E,P as T,T as D,a3 as R,bw as P,B as U,bx as B,by as H}from"./index-9877cd6a.js";import{a as A,q as F}from"./product-194605f7.js";import{n as M}from"./nextStep-11866f6b.js";import{g as Y,i as q}from"./trial-274dec0b.js";import{u as G}from"./useAttachment-2e33c2b9.js";import{_ as $,f as J,s as W}from"./verify-f790e20f.js";import{u as z}from"./useOrder-72255601.js";import{t as Z}from"./ProRenderFormWithCard.vue_vue_type_style_index_0_scoped_true_lang-89c2db26.js";/* empty css              */import"./bankCard-d0f183b1.js";import{P as K,B as Q}from"./constants-7afb7c3d.js";import"./pdfh5-008ca364.js";import"./core-c8e18846.js";import"./constant-8927d485.js";import"./utils-bf23e4f9.js";import"./infoCollection-743131dd.js";import"./trial-4b33f1a2.js";import"./phoneVerify-7596ef7f.js";import"./_initCloneObject-0663309f.js";import"./isObjectLike-a9798079.js";const X={class:"com-sign-part"},ee={class:"people"},ie={class:"name"},ae={key:0,class:"verify-item"},se=u("div",{class:"label"},"证件号码",-1),ne={class:"no"},le={class:"sign-status"},te={class:"status"},oe=["disabled"],re=["src"],de={key:1,class:"sign-desc"},ue={class:"sign-body"},ce={class:"date"},fe={class:"file"},ve=e({name:"signPart"}),ge=e({...ve,props:{signString:{default:""},personalInfo:{default:()=>({})},fileList:null,title:{default:""},showSign:{type:Boolean,default:!1},showVerify:{type:Boolean,default:!1},showShareSign:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1}},emits:["handleVerify","handleSign"],setup(e,{expose:b,emit:C}){const j=e,_=i({}),k=i(""),L=i([]),O=i({});i(!0);const N=i(!1),V=i(0),{fileList:x}=G(O,L),E=e=>`${e}`===S.CERT,T=a((()=>s().format("YYYY-MM-DD"))),D=()=>{var e,i;C("handleVerify",null==(e=_.value)?void 0:e.name,null==(i=_.value)?void 0:i.certNo)},R=()=>{N.value=!1},P=i(),U=()=>{P.value&&P.value.rewrite()},B=()=>{j.disabled||P.value&&P.value.openSign()},H=e=>{C("handleSign",e)};return b({validateSign:()=>new Promise(((e,i)=>{k.value?e(!0):i(new Error(`请${j.title}完成签名后，去支付`))})),validateVerify:()=>new Promise(((e,i)=>{var a,s;(null==(s=null==(a=j.personalInfo)?void 0:a.extInfo)?void 0:s.isCert)!==g.YES?i(new Error(`请${j.title}完成认证后，去支付`)):e(!0)}))}),n((()=>j.signString),(()=>{k.value=j.signString}),{immediate:!0}),n((()=>j.personalInfo),(()=>{_.value=j.personalInfo}),{deep:!0,immediate:!0}),(i,a)=>{const s=w,n=I,S=l("AttachmentList"),b=l("FilePreview");return t(),o("div",X,[r(n,{title:e.title,class:"card"},{extra:d((()=>{var i,a,s,n,l,r;return[u("div",ee,[u("div",ie,c(null==(i=f(_))?void 0:i.name),1),e.showVerify&&E(null==(a=f(_))?void 0:a.certType)?(t(),o("div",{key:0,class:v(["status",{verified:(null==(n=null==(s=f(_))?void 0:s.extInfo)?void 0:n.isCert)===f(g).YES}])},c((null==(r=null==(l=f(_))?void 0:l.extInfo)?void 0:r.isCert)===f(g).YES?"已认证":"待认证"),3)):h("",!0)])]})),default:d((()=>{var i,a,n,l,d;return[e.showVerify&&(null==(i=f(_))?void 0:i.certNo)?(t(),o("div",ae,[se,u("div",ne,c(null==(a=f(_))?void 0:a.certNo),1),(null==(l=null==(n=f(_))?void 0:n.extInfo)?void 0:l.isCert)!==f(g).YES&&E(null==(d=f(_))?void 0:d.certType)?(t(),o("div",{key:0,class:"action",onClick:D},[p(" 去认证 "),r(s,{name:"right_arrow",class:"icon"})])):h("",!0)])):h("",!0)]})),_:1},8,["title"]),e.showSign?(t(),m(n,{key:0,title:`${e.title}签名`,"show-icon":!1,class:"sign-card","show-line":!1},{extra:d((()=>[u("div",le,[u("div",te,c(f(k)?"已签名":"未签名"),1),u("div",{disabled:e.disabled,class:"resign",onClick:U},"重签",8,oe)])])),default:d((()=>{var e;return[r($,{ref_key:"signRef",ref:P,modelValue:f(k),"onUpdate:modelValue":a[0]||(a[0]=e=>y(k)?k.value=e:null),class:"sign",onSubmitSign:H},{signImg:d((({data:e})=>[u("div",{class:"sign-board",onClick:B},[e?(t(),o("img",{key:0,src:e,class:"sign-img",alt:""},null,8,re)):(t(),o("span",de,"请签名"))])])),_:1},8,["modelValue"]),u("div",ue,[u("div",ce,"签名日期： "+c(f(T)),1),u("div",fe,[(null==(e=f(x))?void 0:e.length)?(t(),m(S,{key:0,"attachment-list":f(x),"pre-text":"签名将被用于以下文件：",onPreviewFile:a[1]||(a[1]=e=>(e=>{V.value=e,N.value=!0})(e))},null,8,["attachment-list"])):h("",!0)])])]})),_:1},8,["title"])):h("",!0),f(N)?(t(),m(b,{key:1,show:f(N),"onUpdate:show":a[2]||(a[2]=e=>y(N)?N.value=e:null),"content-list":f(x),"is-only-view":"","active-index":f(V),text:"关闭",onOnCloseFilePreviewByMask:R},null,8,["show","content-list","active-index"])):h("",!0)])}}}),he=2,pe=1,me=2,ye=3;const Se={class:"long-verify"},we={class:"header"},Ie={class:"verify-content"},be={class:"footer-button footer-bar"},Ce=u("div",{class:"text"},"刷新",-1),je=e({__name:"verify",setup(e){const a=b(),{productCode:s="",tenantId:n,agentCode:c="",agencyCode:v,saleChannelId:y,saleUserId:S,orderNo:I,orderCode:G,extraInfo:$,isShare:X,insurerCode:ee,preview:ie}=a.query;let ae={};try{ae=JSON.parse(decodeURIComponent($))}catch(Ve){}const se=z(),ne=`${window.origin}/baseInsurance/long/phoneVerify${window.location.search}`,le=new C({source:"localStorage"});i({});const te=i({}),oe=i(),re=i(),de=i(),ue=i({holder:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""},insured:{fileList:[],personalInfo:[],isSign:!1,isVerify:!1,isShareSign:!1,signData:{}},agent:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""}}),ce=(e,i)=>{let a=window.location.href;a=a.includes("orderCode")?a:a.replace("orderNo","orderCode"),J({callbackUrl:a,certiNo:i,faceAuthMode:"TENCENT",userName:e,tenantId:n}).then((({code:a,data:s})=>{if("10000"===a){const{originalUrl:a,serialNo:n}=s;window.location.href=a,le.set("verifyData",{serialNo:n,certNo:i,name:e})}}))},fe=(e,i,a)=>{var s;W(e,i,null==(s=se.value)?void 0:s.id,n,a)},ve=i({sign:[],verify:[]}),je=()=>{if(ie)return void x(K.SIGN,a.query);const e=[];oe.value&&ve.value.sign.includes("1")&&e.push(oe.value.validateSign()),re.value&&((X?ve.value.sign.includes("4"):ve.value.sign.includes("2"))&&e.push(re.value.validateSign()),ve.value.verify.includes("1")&&e.push(re.value.validateVerify())),de.value&&((X?ve.value.sign.includes("5"):ve.value.sign.includes("3"))&&e.push(...(de.value||[]).map((e=>e.validateSign()))),ve.value.verify.includes("2")&&e.push(...(de.value||[]).map((e=>e.validateVerify())))),Promise.all(e).then((e=>{I&&Y({orderNo:G||I,saleUserId:S,tenantId:n}).then((({code:e,data:i})=>{"10000"===e&&E.confirm({title:"提示",message:"请确认信息填写无误后，再进行支付"}).then((()=>{Object.assign(se.value,{extInfo:{...se.value.extInfo,buttonCode:Q.SIGN,pageCode:K.SIGN}}),M(se.value,((e,i)=>{i===T.JUMP_URL&&(window.location.href=e.paymentUrl)}))}))}))})).catch((e=>{D(e.message)}))},_e=i(),ke=()=>{oe.value.validateSign().then((()=>{_e.value&&(console.log("234242"),_e.value.handleShare())})).catch((()=>{D("请完成代理人签字后进行分享")}))},Le=(e=!1)=>{I&&Y({orderNo:G||I,tenantId:n}).then((({code:i,data:a})=>{var s,n;"10000"===i&&(e&&((null==(n=null==(s=null==a?void 0:a.tenantOrderHolder)?void 0:s.extInfo)?void 0:n.isCert)===g.NO||(null==a?void 0:a.tenantOrderInsuredList.some((e=>{var i;return(null==(i=e.extInfo)?void 0:i.isCert)===g.NO})))?D("用户未完身份认证及签字"):(null==a?void 0:a.tenantOrderAttachmentList.find((e=>e.category===B.ELECTRIC_SIGN&&e.objectType===H.HOLDER)))&&(null==a?void 0:a.tenantOrderAttachmentList.find((e=>e.category===B.ELECTRIC_SIGN&&e.objectType===H.INSURED)))||D("用户未完身份认证及签字")),Object.assign(se.value,a),ue.value.holder.personalInfo=a.tenantOrderHolder,ue.value.insured.personalInfo=a.tenantOrderInsuredList,a.tenantOrderAttachmentList.forEach((e=>{e.objectType===pe?ue.value.holder.signData=e.fileBase64:e.objectType===ye?ue.value.agent.signData=e.fileBase64:e.objectType===me&&(ue.value.insured.signData[e.objectId]=e.fileBase64)})))}))},Oe=()=>{Le(!0)},Ne=i({imgUrl:"",desc:"",title:"",link:ne});return j((()=>{A({productCode:s,tenantId:n}).then((({data:e,code:i})=>{var a;if("10000"===i){let i={};if(null==(a=null==e?void 0:e.PRODUCT_LIST)?void 0:a.wxShareConfig){const{title:a,desc:s,image:n}=(null==e?void 0:e.PRODUCT_LIST.wxShareConfig)||{},[l=""]=n||[];i={title:a,desc:s,image:l}}else{const{title:a,desc:s,image:n}=(null==e?void 0:e.PRODUCT_LIST)||{};i={title:a,desc:s,image:n}}R(e.BASIC_INFO.themeType),Object.assign(Ne.value,i)}})),F({productCode:s}).then((({code:e,data:i})=>{var a;if("10000"===e){const{productMaterialMap:e}=(null==(a=i.productInsureMaterialVOList)?void 0:a[0])||{};(Object.values(e)||[]).flat().filter((e=>e.materialType===he)).forEach((e=>{e.noticeObject===ye?ue.value.agent.fileList.push(e):e.noticeObject===pe?ue.value.holder.fileList.push(e):e.noticeObject===me&&ue.value.insured.fileList.push(e)}))}})),q({productCode:s,isTenant:!ie}).then((({data:e,code:i})=>{var a;if("10000"===i){te.value=e;const{productFactor:i}=(null==(a=e.productPlanInsureVOList)?void 0:a[0])||{},{signInfo:s}=Z(i);console.log("signInfo",s),s.schema.forEach((e=>{"eleSign"===e.name&&e.columns.forEach((i=>{e.required&&ve.value.sign.push(i.code),"1"===i.code?ue.value.agent.isSign=!0:"2"===i.code?ue.value.holder.isSign=!0:"3"===i.code?ue.value.insured.isSign=!0:"4"===i.code?ue.value.holder.isShareSign=!0:"5"===i.code&&(ue.value.insured.isShareSign=!0)})),"customerFace"===e.name&&e.columns.forEach((i=>{e.required&&ve.value.verify.push(i.code),"1"===i.code?ue.value.holder.isVerify=!0:"2"===i.code&&(ue.value.insured.isVerify=!0)}))}))}})),Le()})),(e,i)=>{const a=P,s=w,n=U,c=l("ProPageWrap");return t(),m(c,null,{default:d((()=>[u("div",Se,[u("div",we,[r(a,{type:"warning",title:"尊敬的客户，本次投保需要进行身份认证",content:"本产品投保需要对投保人、被保人进行实名认证，您购买本产品的累计总保费已超过20万，按监管要求，需要提供投保人、被保人、指定受益人证件影像，本产品非本人投保且带身故责任、需对投保人、被保人（成人）的投保意愿进行签字确认。"})]),u("div",Ie,[r(ge,{ref_key:"agentSignRef",ref:oe,"data-source":[],"order-detail":f(se),"sign-string":f(ue).agent.signData,"show-sign":f(ue).agent.isSign,"show-verify":f(ue).agent.isVerify,"show-share-sign":f(ue).agent.isShareSign,"file-list":f(ue).agent.fileList,"personal-info":f(ue).agent.personalInfo,disabled:!!f(X),title:"代理人",onHandleSign:i[0]||(i[0]=e=>fe("AGENT",e))},null,8,["order-detail","sign-string","show-sign","show-verify","show-share-sign","file-list","personal-info","disabled"]),!f(X)||f(ue).holder.isShareSign?(t(),m(ge,{key:0,ref_key:"holderSignRef",ref:re,"order-detail":f(se),"sign-string":f(ue).holder.signData,"show-sign":f(ue).holder.isSign,"show-verify":f(ue).holder.isVerify,"show-share-sign":f(ue).holder.isShareSign,"file-list":f(ue).holder.fileList,"personal-info":f(ue).holder.personalInfo,title:"投保人",onHandleSign:i[1]||(i[1]=e=>fe("HOLDER",e,f(ue).holder.personalInfo.id)),onHandleVerify:ce},null,8,["order-detail","sign-string","show-sign","show-verify","show-share-sign","file-list","personal-info"])):h("",!0),!f(X)||f(ue).insured.isShareSign?(t(!0),o(_,{key:1},k(f(ue).insured.personalInfo||[],(e=>(t(),m(ge,{key:e.id,ref_for:!0,ref_key:"insuredSignRef",ref:de,"data-source":[],"order-detail":f(se),"sign-string":f(ue).insured.signData[e.id],"show-sign":f(ue).insured.isSign,"show-verify":f(ue).insured.isVerify,"show-share-sign":f(ue).insured.isShareSign,"file-list":f(ue).insured.fileList,"personal-info":e||{},title:"被保人",onHandleSign:i=>fe("INSURED",i,e.id),onHandleVerify:ce},null,8,["order-detail","sign-string","show-sign","show-verify","show-share-sign","file-list","personal-info","onHandleSign"])))),128)):h("",!0)]),u("div",be,[u("div",{class:"refresh-btn",onClick:Oe},[u("div",null,[r(s,{name:"refresh"})]),Ce]),!f(X)&&f(L)()?(t(),m(O,N({key:0,ref_key:"shareRef",ref:_e},f(Ne),{onClick:V(ke,["stop"])}),{default:d((()=>[r(n,{plain:"",type:"primary",class:"share-btn"},{default:d((()=>[p("分享")])),_:1})])),_:1},16,["onClick"])):h("",!0),r(n,{type:"primary",class:"submit-btn",onClick:je},{default:d((()=>[p("确认支付")])),_:1})])])])),_:1})}}});export{je as default};
