import{d as e,r as i,L as a,y as s,R as n,b as t,c as l,A as r,i as o,w as d,f as c,E as u,g as f,F as v,Z as g,h,j as p,e as m,a3 as y,C as S,ab as b,b4 as I,u as w,Q as C,ar as j,o as N,s as _,U as k,V as L,aX as O,aY as V,aa as E,bA as D,n as T,D as x,P as R,T as U,ba as P,aQ as B,a4 as A,bB as F,B as Y}from"./index-ed612364.js";import{a as H,q as M}from"./product-35312852.js";import{n as q}from"./nextStep-ec0a8ac2.js";import{g as G,i as $}from"./trial-c6fc8f4f.js";import{u as W}from"./useAttachment-fc521d2c.js";import{_ as J,f as Q,a as X,s as Z}from"./verify-0e804fdb.js";import{u as z}from"./useOrder-ea3b5489.js";import{t as K}from"./ProRenderFormWithCard.vue_vue_type_style_index_0_scoped_true_lang-f1136a14.js";/* empty css              */import"./useDicData-8cc02ca0.js";import"./bankCard-790d8e1a.js";import{P as ee,B as ie}from"./constants-7afb7c3d.js";import"./pdfh5-008ca364.js";import"./core-b5afee61.js";import"./constant-8927d485.js";import"./utils-08f1d3b2.js";import"./infoCollection-7f914145.js";import"./trial-dc285b40.js";import"./phoneVerify-225d8c5d.js";import"./_initCloneObject-da8458a4.js";import"./isObjectLike-a9798079.js";const ae={class:"com-sign-part"},se={class:"people"},ne={class:"name"},te={key:0,class:"verify-item"},le=c("div",{class:"label"},"证件号码",-1),re={class:"no"},oe={class:"sign-status"},de={class:"status"},ce=["src"],ue={key:1,class:"sign-desc"},fe={class:"sign-body"},ve={class:"date"},ge={class:"file"},he=e({name:"signPart"}),pe=e({...he,props:{signString:{default:""},personalInfo:{default:()=>({})},fileList:null,title:{default:""},showSign:{type:Boolean,default:!1},showVerify:{type:Boolean,default:!1},showShareSign:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1}},emits:["handleVerify","handleSign"],setup(e,{expose:w,emit:C}){const j=e,N=i({}),_=i(""),k=i([]),L=i({});i(!0);const O=i(!1),V=i(0),{fileList:E}=W(L,k),D=e=>`${e}`===S.CERT,T=a((()=>s().format("YYYY-MM-DD"))),x=()=>{var e,i;C("handleVerify",null==(e=N.value)?void 0:e.name,null==(i=N.value)?void 0:i.certNo)},R=()=>{O.value=!1},U=i(),P=()=>{U.value&&U.value.rewrite()},B=()=>{j.disabled||U.value&&U.value.openSign()},A=e=>{C("handleSign",e)};return w({validateSign:()=>new Promise(((e,i)=>{_.value?e(!0):i(new Error(`请${j.title}完成签名后，去支付`))})),validateVerify:()=>new Promise(((e,i)=>{var a;(null==(a=j.personalInfo)?void 0:a.isCert)!==g.YES?i(new Error(`请${j.title}完成认证后，去支付`)):e(!0)}))}),n((()=>j.signString),(()=>{_.value=j.signString}),{immediate:!0}),n((()=>j.personalInfo),(()=>{N.value=j.personalInfo}),{deep:!0,immediate:!0}),(i,a)=>{const s=b,n=I,S=t("AttachmentList"),w=t("FilePreview");return l(),r("div",ae,[o(n,{title:e.title,class:"card"},{extra:d((()=>{var i,a,s,n;return[c("div",se,[c("div",ne,u(null==(i=f(N))?void 0:i.name),1),e.showVerify&&D(null==(a=f(N))?void 0:a.certType)?(l(),r("div",{key:0,class:v(["status",{verified:(null==(s=f(N))?void 0:s.isCert)===f(g).YES}])},u((null==(n=f(N))?void 0:n.isCert)===f(g).YES?"已认证":"待认证"),3)):h("",!0)])]})),default:d((()=>{var i,a,n,t;return[e.showVerify&&(null==(i=f(N))?void 0:i.certNo)?(l(),r("div",te,[le,c("div",re,u(null==(a=f(N))?void 0:a.certNo),1),(null==(n=f(N))?void 0:n.isCert)!==f(g).YES&&D(null==(t=f(N))?void 0:t.certType)?(l(),r("div",{key:0,class:"action",onClick:x},[p(" 去认证 "),o(s,{name:"right_arrow",class:"icon"})])):h("",!0)])):h("",!0)]})),_:1},8,["title"]),e.showSign?(l(),m(n,{key:0,title:`${e.title}签名`,"show-icon":!1,class:"sign-card","show-line":!1},{extra:d((()=>[c("div",oe,[c("div",de,u(f(_)?"已签名":"未签名"),1),e.disabled?h("",!0):(l(),r("div",{key:0,class:"resign",onClick:P},"重签"))])])),default:d((()=>{var e;return[o(J,{ref_key:"signRef",ref:U,modelValue:f(_),"onUpdate:modelValue":a[0]||(a[0]=e=>y(_)?_.value=e:null),class:"sign",onSubmitSign:A},{signImg:d((({data:e})=>[c("div",{class:"sign-board",onClick:B},[e?(l(),r("img",{key:0,src:e,class:"sign-img",alt:""},null,8,ce)):(l(),r("span",ue,"请签名"))])])),_:1},8,["modelValue"]),c("div",fe,[c("div",ve,"签名日期： "+u(f(T)),1),c("div",ge,[(null==(e=f(E))?void 0:e.length)?(l(),m(S,{key:0,"attachment-list":f(E),"pre-text":"签名将被用于以下文件：",onPreviewFile:a[1]||(a[1]=e=>(e=>{V.value=e,O.value=!0})(e))},null,8,["attachment-list"])):h("",!0)])])]})),_:1},8,["title"])):h("",!0),f(O)?(l(),m(w,{key:1,show:f(O),"onUpdate:show":a[2]||(a[2]=e=>y(O)?O.value=e:null),"content-list":f(E),"is-only-view":"","active-index":f(V),text:"关闭",onOnCloseFilePreviewByMask:R},null,8,["show","content-list","active-index"])):h("",!0)])}}}),me=2,ye=1,Se=2,be=3;const Ie={class:"long-verify"},we={class:"header"},Ce={class:"verify-content"},je={class:"footer-button footer-bar"},Ne=c("div",{class:"text"},"刷新",-1),_e=e({__name:"verify",setup(e){const a=w(),{productCode:s="",tenantId:n,agentCode:u="",agencyCode:v,saleChannelId:y,saleUserId:S,orderNo:I,orderCode:W,extraInfo:J,isShare:ae,insurerCode:se,preview:ne}=a.query;let te={};try{te=JSON.parse(decodeURIComponent(J))}catch(Te){}const le=z(),re=`${window.origin}/baseInsurance/long/phoneVerify?${C.stringify({...a.query,orderNo:W||I})}`;console.log("shareLink",re);const oe=new j({source:"localStorage"});i({});const de=i({}),ce=i(),ue=i(),fe=i(),ve=i({holder:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""},insured:{fileList:[],personalInfo:[],isSign:!1,isVerify:!1,isShareSign:!1,signData:{}},agent:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""}}),ge=(e,i)=>{let a=window.location.href;a=a.includes("orderCode")?a:a.replace("orderNo","orderCode"),X({callbackUrl:a,certiNo:i,faceAuthMode:"TENCENT",userName:e,tenantId:n}).then((({code:a,data:s})=>{if("10000"===a){const{originalUrl:a,serialNo:n}=s;window.location.href=a,_.set("verifyData",{serialNo:n,certNo:i,name:e})}}))},he=(e,i,a)=>{var s;Z(e,i,null==(s=le.value)?void 0:s.id,n,a)},_e=i({sign:[],verify:[]}),ke=()=>{if(ne)return void T(ee.SIGN,a.query);const e=[];ce.value&&_e.value.sign.includes("1")&&e.push(ce.value.validateSign()),ue.value&&((ae?_e.value.sign.includes("4"):_e.value.sign.includes("2"))&&e.push(ue.value.validateSign()),_e.value.verify.includes("1")&&e.push(ue.value.validateVerify())),fe.value&&((ae?_e.value.sign.includes("5"):_e.value.sign.includes("3"))&&e.push(...(fe.value||[]).map((e=>e.validateSign()))),_e.value.verify.includes("2")&&e.push(...(fe.value||[]).map((e=>e.validateVerify())))),Promise.all(e).then((e=>{I&&G({orderNo:W||I,saleUserId:S,tenantId:n}).then((({code:e,data:i})=>{"10000"===e&&x.confirm({title:"提示",message:"请确认信息填写无误后，再进行支付"}).then((()=>{Object.assign(le.value,{extInfo:{...le.value.extInfo,buttonCode:ie.SIGN,pageCode:ee.SIGN}}),q(le.value,((e,i)=>{i===R.JUMP_URL&&(window.location.href=e.paymentUrl)}))}))}))})).catch((e=>{U(e.message)}))},Le=i(),Oe=()=>{ce.value.validateSign().then((()=>{Le.value&&Le.value.handleShare()})).catch((()=>{U("请完成代理人签字后进行分享")}))},Ve=(e=!1)=>{I&&G({orderNo:W||I,tenantId:n}).then((({code:i,data:a})=>{var s;"10000"===i&&(e&&((null==(s=null==a?void 0:a.holder)?void 0:s.isCert)===g.NO||(null==a?void 0:a.insuredList.some((e=>e.isCert===g.NO)))?U("用户未完身份认证及签字"):(null==a?void 0:a.tenantOrderAttachmentList.find((e=>e.category===P.ELECTRIC_SIGN&&e.objectType===B.HOLDER)))&&(null==a?void 0:a.tenantOrderAttachmentList.find((e=>e.category===P.ELECTRIC_SIGN&&e.objectType===B.INSURED)))||U("用户未完身份认证及签字")),Object.assign(le.value,a),ve.value.holder.personalInfo=a.holder,ve.value.insured.personalInfo=a.insuredList,a.tenantOrderAttachmentList.forEach((e=>{e.objectType===ye?ve.value.holder.signData=e.fileBase64:e.objectType===be?ve.value.agent.signData=e.fileBase64:e.objectType===Se&&(ve.value.insured.signData[e.objectId]=e.fileBase64)})))}))},Ee=()=>{Ve(!0)},De=i({imgUrl:"",desc:"",title:"",link:re});return N((()=>{H({productCode:s,tenantId:n}).then((({data:e,code:i})=>{if("10000"===i){const{wxShareConfig:i,showWXShare:a,title:s,desc:n,image:t}=(null==e?void 0:e.PRODUCT_LIST)||{};a?Object.assign(De.value,{...i,imgUrl:i.image,isShare:a}):Object.assign(De.value,{title:s,desc:n,imgUrl:t,isShare:a}),e.BASIC_INFO&&e.BASIC_INFO.themeType&&A(e.BASIC_INFO.themeType)}})),M({productCode:s}).then((({code:e,data:i})=>{var a;if("10000"===e){const{productMaterialMap:e}=(null==(a=i.productInsureMaterialVOList)?void 0:a[0])||{};(Object.values(e||{})||[]).flat().filter((e=>e.materialType===me)).forEach((e=>{e.noticeObject===be?ve.value.agent.fileList.push(e):e.noticeObject===ye?ve.value.holder.fileList.push(e):e.noticeObject===Se&&ve.value.insured.fileList.push(e)}))}})),$({productCode:s,isTenant:!ne}).then((({data:e,code:i})=>{var a;if("10000"===i){de.value=e;const{productFactor:i}=(null==(a=e.productPlanInsureVOList)?void 0:a[0])||{},{signInfo:s}=K(i);s.schema.forEach((e=>{"eleSign"===e.name&&e.columns.forEach((i=>{e.required&&_e.value.sign.push(i.code),"1"===i.code?ve.value.agent.isSign=!0:"2"===i.code?ve.value.holder.isSign=!0:"3"===i.code?ve.value.insured.isSign=!0:"4"===i.code?ve.value.holder.isShareSign=!0:"5"===i.code&&(ve.value.insured.isShareSign=!0)})),"customerFace"===e.name&&e.columns.forEach((i=>{e.required&&_e.value.verify.push(i.code),"1"===i.code?ve.value.holder.isVerify=!0:"2"===i.code&&(ve.value.insured.isVerify=!0)}))}))}})),Ve();const e=_.get("verifyData");if(e){const{serialNo:i,certNo:a,name:s}=e;Q({certiNo:a,orderNo:W||I,serialNo:i,tenantId:n,userName:s}).then((e=>{const{code:i,data:a}=e;"10000"===i&&(oe.remove("verifyData"),Ve())}))}})),(e,i)=>{const a=F,s=b,n=Y,u=t("ProPageWrap");return l(),m(u,null,{default:d((()=>[c("div",Ie,[c("div",we,[o(a,{type:"warning",title:"尊敬的客户，本次投保需要进行身份认证",content:"本产品投保需要对投保人、被保人进行实名认证，您购买本产品的累计总保费已超过20万，按监管要求，需要提供投保人、被保人、指定受益人证件影像，本产品非本人投保且带身故责任、需对投保人、被保人（成人）的投保意愿进行签字确认。"})]),c("div",Ce,[o(pe,{ref_key:"agentSignRef",ref:ce,"order-detail":f(le),"sign-string":f(ve).agent.signData,"show-sign":f(ve).agent.isSign,"show-verify":f(ve).agent.isVerify,"file-list":f(ve).agent.fileList,"personal-info":f(ve).agent.personalInfo,disabled:!!f(ae),title:"代理人",onHandleSign:i[0]||(i[0]=e=>he("AGENT",e))},null,8,["order-detail","sign-string","show-sign","show-verify","file-list","personal-info","disabled"]),!f(ae)||f(ve).holder.isShareSign?(l(),m(pe,{key:0,ref_key:"holderSignRef",ref:ue,"order-detail":f(le),"sign-string":f(ve).holder.signData,"show-sign":f(ae)?f(ve).holder.isShareSign:f(ve).holder.isSign,"show-verify":f(ve).holder.isVerify,"file-list":f(ve).holder.fileList,"personal-info":f(ve).holder.personalInfo,title:"投保人",onHandleSign:i[1]||(i[1]=e=>he("HOLDER",e,f(ve).holder.personalInfo.id)),onHandleVerify:ge},null,8,["order-detail","sign-string","show-sign","show-verify","file-list","personal-info"])):h("",!0),!f(ae)||f(ve).insured.isShareSign?(l(!0),r(k,{key:1},L(f(ve).insured.personalInfo||[],(e=>(l(),m(pe,{key:e.id,ref_for:!0,ref_key:"insuredSignRef",ref:fe,"data-source":[],"order-detail":f(le),"sign-string":f(ve).insured.signData[e.id],"show-sign":f(ae)?f(ve).insured.isShareSign:f(ve).insured.isSign,"show-verify":f(ve).insured.isVerify,"file-list":f(ve).insured.fileList,"personal-info":e||{},title:"被保人",onHandleSign:i=>he("INSURED",i,e.id),onHandleVerify:ge},null,8,["order-detail","sign-string","show-sign","show-verify","file-list","personal-info","onHandleSign"])))),128)):h("",!0)]),c("div",je,[c("div",{class:"refresh-btn",onClick:Ee},[c("div",null,[o(s,{name:"refresh"})]),Ne]),!f(ae)&&f(O)()?(l(),m(V,E({key:0,ref_key:"shareRef",ref:Le},f(De),{onClick:D(Oe,["stop"])}),{default:d((()=>[o(n,{plain:"",type:"primary",class:"share-btn"},{default:d((()=>[p("分享")])),_:1})])),_:1},16,["onClick"])):h("",!0),o(n,{type:"primary",class:"submit-btn",onClick:ke},{default:d((()=>[p("确认支付")])),_:1})])])])),_:1})}}});export{_e as default};
