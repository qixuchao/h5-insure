import{_ as e,d as a,u as r,a as t,r as n,z as o,a4 as l,x as s,aa as i,y as d,b as u,q as c,c as m,h as p,f as v,w as y,g as f,s as h,k as I,j as N,t as g,aJ as w,e as b,n as k,X as T,F as C,T as F,a6 as L,K as O,L as D,ao as P,aQ as S,aM as H,ap as j}from"./index-4c2d8b53.js";import{d as x}from"./debounce-2dbbea42.js";import{a as E}from"./order-2c02b5f1.js";import{S as U,R as q,P as A,I as R}from"./infoCollection-3279d2ee.js";import{i as V,u as _,a as M,s as B,p as K,g as $}from"./trial-8c471e2f.js";import{p as Y}from"./product-b2dcacaf.js";import{t as z,g as J,a as W,o as G,s as Q,v as X,b as Z,j as ee}from"./utils-440295d8.js";import{t as ae}from"./theme-ea709837.js";import{d as re,B as te,D as ne,G as oe,S as le,H as se,P as ie,U as de,_ as ue,W as ce,a as me}from"./auth-83676df3.js";import{_ as pe}from"./close-02418833.js";import"./pdfh5-008ca364.js";import"./isObjectLike-d00d103b.js";import"./trial-215b0045.js";import"./index-0eed0644.js";import"./bankCard-a25dcf89.js";import"./validator-5a13dc82.js";import"./phoneVerify-f763d2c8.js";const ve={key:0},ye={class:"page-internet-product-detail"},fe={class:"info"},he={class:"footer-button"},Ie={class:"price"},Ne=(e=>(O("data-v-174fb5e8"),e=e(),D(),e))((()=>N("span",null,"总保费",-1))),ge={key:0};var we=e(a({__name:"packageProcess",setup(e){const a=r(),O=t(),{productCode:D="BWYL2021",tenantId:we,orderNo:be,phoneNo:ke,agentCode:Te="",saleChannelId:Ce,paymentMethod:Fe,certNo:Le,name:Oe,pageCode:De,from:Pe}=O.query,Se=n(),He=n(),je=n(),xe=n(),Ee="payBack"===De;n(!1);const Ue=n(!1),qe=n(!1),Ae=n(0),Re=n(!1),Ve=n(!1),_e=n({show:!1,html:""}),Me=n({}),Be=n(),Ke=n(!1),$e=n("");let Ye="";const ze=o({holder:{certNo:Le,certType:l.CERT,mobile:ke,name:Oe,socialFlag:U.HAS},insured:{certNo:Le,certType:l.CERT,name:Oe,socialFlag:U.HAS,relationToHolder:q.SELF},paymentMethod:Fe,renewalDK:"Y",paymentFrequency:A.YEAR,packageProductList:[],mobileSmsCode:""}),Je=n(re),We=n(re),Ge=o({showInsure:!Ee,canInsure:!1,canUpgrade:!1}),Qe=s((()=>{var e,a;return(null==(a=null==(e=He.value)?void 0:e.tenantProductInsureVO)?void 0:a.attachmentVOList.filter((e=>"健康告知"===e.attachmentName)))||[]})),Xe=s((()=>{var e,a;return(null==(a=null==(e=He.value)?void 0:e.tenantProductInsureVO)?void 0:a.attachmentVOList.filter((e=>"健康告知"!==e.attachmentName)))||[]})),Ze=()=>{$e.value=xe.value?ze.paymentFrequency==A.YEAR?"元/年":"元/月":""},ea=()=>{a.push({path:"/internet/guaranteeUpgrade",query:{...O.query,tenantId:we,productCode:"BWYL2022",orderNo:be,agentCode:Te}})},aa=()=>{Ve.value=!1},ra=()=>{We.value=Je.value},ta=()=>{We.value={...We.value,relationToHolderDisable:!1,insuredNameDisable:!1,insuredCertDisable:!1,insuredSocialDisable:!1}},na=e=>`${H}/internet/payFail?tenantId=${we}&orderNo=${e}&agentCode=${Te}&pageCode=payBack&from=${Pe||"normal"}`,oa=async e=>{const a=J({tenantId:we,saleUserId:Te,saleChannelId:Ce,detail:He.value,insureDetail:je.value,paymentMethod:ze.paymentMethod,paymentFrequency:ze.paymentFrequency,renewalDK:ze.renewalDK,iseeBizNo:Ye,successJumpUrl:"",premium:xe.value,holder:ze.holder,insured:ze.insured,tenantOrderRiskList:e,orderStatus:"",orderTopStatus:"",orderNo:be,originOrderIds:Be.value});try{const e=await B(a),{code:t,data:n}=e;qe.value=!1,Ue.value=!1,"10000"===t&&(F.clear(),delete a.id,Me.value={orderNo:n.data,order:a},qe.value=!0,r=0,Ae.value=r,qe.value=!0)}catch(t){F.clear(),Ge.canInsure=!0}var r},la=()=>new Promise(((e,a)=>{var r,t;null==(t=null==(r=Se.value)?void 0:r.validateForm)||t.call(r).then((async()=>{if(!(()=>{if(ze.holder.certNo){const e=j(ze.holder.certNo);if(X(ze.holder.certNo,18,"year"))return F("投保人年龄必须大于等于18岁！"),!1;if(ze.insured.certNo&&ze.insured.relationToHolder===q.MATE&&e===j(ze.insured.certNo))return F("被保人为配偶时，性别不可相同！"),!1}if(ze.insured.certNo){if(ze.insured.relationToHolder===q.CHILD&&X(ze.insured.certNo,30,"day"))return F("被保人为子女时，年龄必须大于等于30天！"),!1;if(ze.insured.relationToHolder===q.PARENT&&!X(ze.insured.certNo,71,"year"))return F("被保人为父母时，年龄必须小于等于70岁！"),!1}if([q.CHILD,q.PARENT].includes(ze.insured.relationToHolder)){const e=Z(ze.holder.certNo,"year"),a=Z(ze.insured.certNo,"year");if(ze.insured.relationToHolder===q.CHILD&&e-a<18)return F("投保人和子女年龄必须相差18岁！"),!1;if(ze.insured.relationToHolder===q.PARENT&&a-e<18)return F("投保人和父母年龄必须相差18岁！"),!1}return!0})())return void(Ge.canInsure=!0);const{calcData:r,riskVOList:t}=W({holder:ze.holder,insured:ze.insured,tenantId:we,productDetail:He.value,insureDetail:je.value,paymentFrequency:ze.paymentFrequency,packageRiskIdList:G(ze.packageProductList)},!1,ee);(!Array.isArray(t)||t.length<1)&&(F("被保人年龄需在30天(含) - 70岁(含)之间！"),xe.value=null,a(new Error));const n=await K(r),{code:o,data:l}=n;"10000"===o?(xe.value=l.premium,e({condition:t,data:l})):(xe.value=null,a(new Error))})).catch((e=>{Ge.canInsure=!0,Q(e)}))})),sa=async()=>{var e;if(Ee)ea();else try{F.loading({message:"订单生成中...",forbidClick:!0,duration:0});const{condition:a,data:r}=await la(),t={},n=(e=[])=>{(e||[]).forEach((e=>{var a;t[e.riskCode]=e,(null==(a=e.riskPremiumDetailVOList)?void 0:a.length)&&n(e.riskPremiumDetailVOList)}))};n(r.riskPremiumDetailVOList);const o=z({tenantId:we,riskList:a,riskPremium:t,productId:null==(e=He.value)?void 0:e.id});oa(o)}catch(a){Ge.canInsure=!0}finally{F.clear()}},ia=e=>{var a;"allFalse"===e?(Ue.value=!1,Ge.canInsure=!0,(async e=>{F.loading({message:"核保中...",forbidClick:!0,duration:0});try{const a=await _(e),{code:r}=a;if("10000"===r){const a=await M({orderNo:e.orderNo,tenantId:we}),{data:r}=a;"10000"===a.code&&(2===r.type?(_e.value={show:!0,html:r.paymentUrl},S((()=>{const e=document.getElementById("cashierSubmit");null==e||e.addEventListener("submit",(e=>{e.preventDefault()})),null==e||e.submit()}))):window.location.href=r.paymentUrl)}Ge.canInsure=!0}catch(a){Ge.canInsure=!0}finally{F.clear()}})({...Me.value.order,orderNo:Me.value.orderNo,extInfo:{extraInfo:{renewalDK:ze.renewalDK,paymentMethod:ze.paymentMethod,paymentFrequency:ze.paymentFrequency,successJumpUrl:(a=Me.value.orderNo,`${H}/pay?orderNo=${a}&saleUserId=${Te}&tenantId=${we}`),failUrl:na(Me.value.orderNo)},iseeBizNo:Ye}})):L.confirm({message:"您当前的健康状况不符合该产品",confirmButtonText:"确定"}).then((()=>{window.history.back()})).catch((()=>{Ge.canInsure=!0}))},da=()=>{qe.value=!1,Ue.value=!1,Ge.canInsure=!0},ua=()=>{qe.value=!1,Ue.value=!0};i([()=>ze.insured.certNo,()=>ze.insured.socialFlag,()=>ze.packageProductList,()=>ze.paymentFrequency],x((()=>{ze.insured.certNo&&ze.insured.socialFlag&&(()=>{const{holder:{certNo:e,mobile:a,name:r,socialFlag:t},insured:{certNo:n,name:o,socialFlag:l,relationToHolder:s},paymentMethod:i}=ze;return!(!P(n)||!l)})()&&(async()=>{const{calcData:e,riskVOList:a}=W({holder:ze.holder,insured:ze.insured,tenantId:we,productDetail:He.value,insureDetail:je.value,paymentFrequency:ze.paymentFrequency,packageRiskIdList:G(ze.packageProductList)},!1,ee);if(!Array.isArray(a)||a.length<1)return F("被保人年龄需在30天(含) - 70岁(含)之间！"),xe.value=null,{};Ke.value=!0;const r=await K(e);Ke.value=!1;const{code:t,data:n}=r;"10000"===t?ze.insured.certNo?(xe.value=n.premium,Ze()):(xe.value=null,Ze()):xe.value=null})()}),500),{deep:!0,immediate:!0}),i((()=>ze.insured.certNo),(()=>{ze.insured.certNo||(xe.value=null)}));const ca=async()=>{var e,a,r,t,n,o,l,s,i,d,u,c,m,p,v;const y=await $({orderNo:be,tenantId:we}),{code:f,data:h}=y;if("10000"===f){const{id:y,tenantOrderHolder:f,tenantOrderInsuredList:I,extInfo:N}=h;if(!Ee){Be.value={id:y,holderId:null==f?void 0:f.id,insuredId:null==I?void 0:I[0].id};const s=((null==(a=null==(e=I[0])?void 0:e.tenantOrderProductList[0])?void 0:a.tenantOrderRiskList)||[]).map((e=>{var a;return(null==(a=e.extInfo)?void 0:a.riskId)||""}));return ze.packageProductList.forEach((e=>{e.value=e.productRiskVoList.filter((e=>s.includes(e.id))).length>0?R.INSURE:R.UN_INSURE})),Object.assign(ze,{holder:{certNo:f.certNo,certType:f.certType,mobile:f.mobile,name:f.name,socialFlag:U.HAS},insured:{certNo:null==I?void 0:I[0].certNo,certType:null==(r=I[0])?void 0:r.certType,name:null==(t=I[0])?void 0:t.name,socialFlag:null==(o=null==(n=I[0])?void 0:n.extInfo)?void 0:o.hasSocialInsurance,relationToHolder:null==(l=I[0])?void 0:l.relationToHolder},paymentMethod:N.extraInfo.paymentMethod,paymentFrequency:N.extraInfo.paymentFrequency,renewalDK:N.extraInfo.renewalDK||"N"}),void(Ge.canInsure=!0)}Object.assign(ze,{holder:{certNo:f.certNo,certType:f.certType,mobile:f.mobile,name:f.name,socialFlag:U.HAS},insured:{certNo:null==I?void 0:I[0].certNo,certType:null==(s=I[0])?void 0:s.certType,name:null==(i=I[0])?void 0:i.name,socialFlag:null==(u=null==(d=I[0])?void 0:d.extInfo)?void 0:u.hasSocialInsurance,relationToHolder:null==(c=I[0])?void 0:c.relationToHolder},paymentMethod:N.extraInfo.paymentMethod,paymentFrequency:N.extraInfo.paymentFrequency,renewalDK:N.extraInfo.renewalDK||"N"}),xe.value=null==(v=null==(p=null==(m=I[0])?void 0:m.tenantOrderProductList)?void 0:p[0])?void 0:v.premium,h.orderStatus!==E.ACCEPT_POLICY&&h.orderStatus!==E.PAYMENT_SUCCESS||(Ge.canUpgrade=!0,Re.value=!1,Ve.value=!0),h.orderStatus===E.PAYING&&(Re.value=!0,setTimeout((()=>{ca()}),3e3))}};return d((()=>{We.value=me,Je.value=me,Ge.canInsure=!0,(async()=>{var e,a;const r=await Y({productCode:D,withInsureInfo:!0,tenantId:we});"10000"===r.code&&(He.value=r.data,document.title=(null==(e=r.data)?void 0:e.productFullName)||"");const t=await V({productCode:D});"10000"===t.code&&(ze.packageProductList=((null==(a=t.data)?void 0:a.packageProductVOList)||[]).map((e=>({...e,value:R.UN_INSURE,disabled:!1}))),je.value=t.data),be&&ca()})(),setTimeout((async()=>{Ye=window.getIseeBiz&&await window.getIseeBiz()}),1500)})),(e,a)=>{const r=u("van-loading"),t=u("van-button"),n=u("van-config-provider"),o=c("dompurify-html");return m(),p(C,null,[v(n,{"theme-vars":f(ae)},{default:y((()=>{var e,a,n,l,s,i,d;return[f(_e).show?h((m(),p("div",ve,null,512)),[[o,f(_e).html]]):I("",!0),N("div",ye,[N("div",fe,[v(te,{url:null==(a=null==(e=f(He))?void 0:e.tenantProductInsureVO)?void 0:a.banner[0]},null,8,["url"]),v(ne,{"product-name":null==(n=f(He))?void 0:n.productFullName,"product-desc":null==(s=null==(l=f(He))?void 0:l.showConfigVO)?void 0:s.desc},null,8,["product-name","product-desc"])]),v(oe,{"show-service-config":"","guarantee-list":null==(d=null==(i=f(He))?void 0:i.tenantProductInsureVO)?void 0:d.titleAndDescVOS},null,8,["guarantee-list"]),v(le,{detail:f(He)},{form:y((()=>[v(se,{ref_key:"formRef",ref:Se,"is-show-package":"",disable:!f(Ge).showInsure,"form-auth":f(We),"form-info":f(ze),"product-detail":f(He),onOnReset:ra,onOnUpdate:ta},null,8,["disable","form-auth","form-info","product-detail"])])),_:1},8,["detail"]),N("div",he,[N("div",Ie,[Ne,f(Ke)?(m(),b(r,{key:1,class:"premium-loading",type:"spinner"})):(m(),p("span",ge,g(f(xe)?"￥":"")+g(f(w)(f(xe)))+" "+g(f($e)),1))]),v(t,{type:"primary",class:"right",disabled:!(f(Ge).canInsure||f(Ge).canUpgrade),onClick:sa},{default:y((()=>[k(g(f(Ge).showInsure?"立即投保":"升级保障"),1)])),_:1},8,["disabled"])])]),f(be)?I("",!0):(m(),b(ie,{key:1,"product-detail":f(He)},null,8,["product-detail"])),v(de,{"order-no":f(be),"tenant-id":f(we),"is-show":f(Ve),onOnConfirm:ea,onOnClose:aa},null,8,["order-no","tenant-id","is-show"])]})),_:1},8,["theme-vars"]),v(ue,{show:f(Ue),"onUpdate:show":a[0]||(a[0]=e=>T(Ue)?Ue.value=e:null),"content-list":f(Qe),"active-index":0,onOnConfirmHealth:ia,onOnCloseHealth:da},null,8,["show","content-list"]),f(qe)?(m(),b(pe,{key:0,show:f(qe),"onUpdate:show":a[1]||(a[1]=e=>T(qe)?qe.value=e:null),"content-list":f(Xe),"active-index":f(Ae),text:"我已逐页阅读并确认告知内容","force-read-cound":2,"on-close-file-preview":"",onSubmit:ua,onOnCloseFilePreview:da},null,8,["show","content-list","active-index"])):I("",!0),v(ce,{"is-show":f(Re)},null,8,["is-show"])],64)}}}),[["__scopeId","data-v-174fb5e8"]]);export{we as default};
