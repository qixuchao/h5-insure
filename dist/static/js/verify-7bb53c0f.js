import{d as e,r as a,L as i,y as s,R as n,b as t,c as l,A as r,i as o,w as d,f as u,E as c,g as f,F as v,Z as g,h,j as p,e as m,a2 as y,C as S,aa as w,bn as b,u as I,aq as C,o as j,s as N,U as _,V as k,aW as L,aX as V,a9 as E,bA as O,n as D,D as T,P as x,T as R,b2 as P,aP as U,a3 as B,bB as A,B as F}from"./index-68649b11.js";import{a as H,q as M}from"./product-36de5021.js";import{n as Y}from"./nextStep-389e8f56.js";import{g as q,i as G}from"./trial-3c234a73.js";import{u as $}from"./useAttachment-2a2036e1.js";import{_ as W,f as J,a as X,s as Z}from"./verify-59fac18a.js";import{u as z}from"./useOrder-8a50d62d.js";import{t as K}from"./ProRenderFormWithCard.vue_vue_type_style_index_0_scoped_true_lang-8d1b496d.js";/* empty css              */import"./bankCard-72a2d1a2.js";import{P as Q,B as ee}from"./constants-7afb7c3d.js";import"./pdfh5-008ca364.js";import"./core-e0d6f353.js";import"./constant-8927d485.js";import"./utils-d4525461.js";import"./infoCollection-04d15c02.js";import"./trial-ad92c73e.js";import"./phoneVerify-5aa4ab54.js";import"./_initCloneObject-0663309f.js";import"./isObjectLike-a9798079.js";const ae={class:"com-sign-part"},ie={class:"people"},se={class:"name"},ne={key:0,class:"verify-item"},te=u("div",{class:"label"},"证件号码",-1),le={class:"no"},re={class:"sign-status"},oe={class:"status"},de=["src"],ue={key:1,class:"sign-desc"},ce={class:"sign-body"},fe={class:"date"},ve={class:"file"},ge=e({name:"signPart"}),he=e({...ge,props:{signString:{default:""},personalInfo:{default:()=>({})},fileList:null,title:{default:""},showSign:{type:Boolean,default:!1},showVerify:{type:Boolean,default:!1},showShareSign:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1}},emits:["handleVerify","handleSign"],setup(e,{expose:I,emit:C}){const j=e,N=a({}),_=a(""),k=a([]),L=a({});a(!0);const V=a(!1),E=a(0),{fileList:O}=$(L,k),D=e=>`${e}`===S.CERT,T=i((()=>s().format("YYYY-MM-DD"))),x=()=>{var e,a;C("handleVerify",null==(e=N.value)?void 0:e.name,null==(a=N.value)?void 0:a.certNo)},R=()=>{V.value=!1},P=a(),U=()=>{P.value&&P.value.rewrite()},B=()=>{j.disabled||P.value&&P.value.openSign()},A=e=>{C("handleSign",e)};return I({validateSign:()=>new Promise(((e,a)=>{_.value?e(!0):a(new Error(`请${j.title}完成签名后，去支付`))})),validateVerify:()=>new Promise(((e,a)=>{var i;(null==(i=j.personalInfo)?void 0:i.isCert)!==g.YES?a(new Error(`请${j.title}完成认证后，去支付`)):e(!0)}))}),n((()=>j.signString),(()=>{_.value=j.signString}),{immediate:!0}),n((()=>j.personalInfo),(()=>{N.value=j.personalInfo}),{deep:!0,immediate:!0}),(a,i)=>{const s=w,n=b,S=t("AttachmentList"),I=t("FilePreview");return l(),r("div",ae,[o(n,{title:e.title,class:"card"},{extra:d((()=>{var a,i,s,n;return[u("div",ie,[u("div",se,c(null==(a=f(N))?void 0:a.name),1),e.showVerify&&D(null==(i=f(N))?void 0:i.certType)?(l(),r("div",{key:0,class:v(["status",{verified:(null==(s=f(N))?void 0:s.isCert)===f(g).YES}])},c((null==(n=f(N))?void 0:n.isCert)===f(g).YES?"已认证":"待认证"),3)):h("",!0)])]})),default:d((()=>{var a,i,n,t;return[e.showVerify&&(null==(a=f(N))?void 0:a.certNo)?(l(),r("div",ne,[te,u("div",le,c(null==(i=f(N))?void 0:i.certNo),1),(null==(n=f(N))?void 0:n.isCert)!==f(g).YES&&D(null==(t=f(N))?void 0:t.certType)?(l(),r("div",{key:0,class:"action",onClick:x},[p(" 去认证 "),o(s,{name:"right_arrow",class:"icon"})])):h("",!0)])):h("",!0)]})),_:1},8,["title"]),e.showSign?(l(),m(n,{key:0,title:`${e.title}签名`,"show-icon":!1,class:"sign-card","show-line":!1},{extra:d((()=>[u("div",re,[u("div",oe,c(f(_)?"已签名":"未签名"),1),e.disabled?h("",!0):(l(),r("div",{key:0,class:"resign",onClick:U},"重签"))])])),default:d((()=>{var e;return[o(W,{ref_key:"signRef",ref:P,modelValue:f(_),"onUpdate:modelValue":i[0]||(i[0]=e=>y(_)?_.value=e:null),class:"sign",onSubmitSign:A},{signImg:d((({data:e})=>[u("div",{class:"sign-board",onClick:B},[e?(l(),r("img",{key:0,src:e,class:"sign-img",alt:""},null,8,de)):(l(),r("span",ue,"请签名"))])])),_:1},8,["modelValue"]),u("div",ce,[u("div",fe,"签名日期： "+c(f(T)),1),u("div",ve,[(null==(e=f(O))?void 0:e.length)?(l(),m(S,{key:0,"attachment-list":f(O),"pre-text":"签名将被用于以下文件：",onPreviewFile:i[1]||(i[1]=e=>(e=>{E.value=e,V.value=!0})(e))},null,8,["attachment-list"])):h("",!0)])])]})),_:1},8,["title"])):h("",!0),f(V)?(l(),m(I,{key:1,show:f(V),"onUpdate:show":i[2]||(i[2]=e=>y(V)?V.value=e:null),"content-list":f(O),"is-only-view":"","active-index":f(E),text:"关闭",onOnCloseFilePreviewByMask:R},null,8,["show","content-list","active-index"])):h("",!0)])}}}),pe=2,me=1,ye=2,Se=3;const we={class:"long-verify"},be={class:"header"},Ie={class:"verify-content"},Ce={class:"footer-button footer-bar"},je=u("div",{class:"text"},"刷新",-1),Ne=e({__name:"verify",setup(e){const i=I(),{productCode:s="",tenantId:n,agentCode:c="",agencyCode:v,saleChannelId:y,saleUserId:S,orderNo:b,orderCode:$,extraInfo:W,isShare:ae,insurerCode:ie,preview:se}=i.query;let ne={};try{ne=JSON.parse(decodeURIComponent(W))}catch(De){}const te=z(),le=`${window.origin}/baseInsurance/long/phoneVerify${window.location.search}`,re=new C({source:"localStorage"});a({});const oe=a({}),de=a(),ue=a(),ce=a(),fe=a({holder:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""},insured:{fileList:[],personalInfo:[],isSign:!1,isVerify:!1,isShareSign:!1,signData:{}},agent:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""}}),ve=(e,a)=>{let i=window.location.href;i=i.includes("orderCode")?i:i.replace("orderNo","orderCode"),X({callbackUrl:i,certiNo:a,faceAuthMode:"TENCENT",userName:e,tenantId:n}).then((({code:i,data:s})=>{if("10000"===i){const{originalUrl:i,serialNo:n}=s;window.location.href=i,N.set("verifyData",{serialNo:n,certNo:a,name:e})}}))},ge=(e,a,i)=>{var s;Z(e,a,null==(s=te.value)?void 0:s.id,n,i)},Ne=a({sign:[],verify:[]}),_e=()=>{if(se)return void D(Q.SIGN,i.query);const e=[];de.value&&Ne.value.sign.includes("1")&&e.push(de.value.validateSign()),ue.value&&((ae?Ne.value.sign.includes("4"):Ne.value.sign.includes("2"))&&e.push(ue.value.validateSign()),Ne.value.verify.includes("1")&&e.push(ue.value.validateVerify())),ce.value&&((ae?Ne.value.sign.includes("5"):Ne.value.sign.includes("3"))&&e.push(...(ce.value||[]).map((e=>e.validateSign()))),Ne.value.verify.includes("2")&&e.push(...(ce.value||[]).map((e=>e.validateVerify())))),Promise.all(e).then((e=>{b&&q({orderNo:$||b,saleUserId:S,tenantId:n}).then((({code:e,data:a})=>{"10000"===e&&T.confirm({title:"提示",message:"请确认信息填写无误后，再进行支付"}).then((()=>{Object.assign(te.value,{extInfo:{...te.value.extInfo,buttonCode:ee.SIGN,pageCode:Q.SIGN}}),Y(te.value,((e,a)=>{a===x.JUMP_URL&&(window.location.href=e.paymentUrl)}))}))}))})).catch((e=>{R(e.message)}))},ke=a(),Le=()=>{de.value.validateSign().then((()=>{ke.value&&(console.log("234242"),ke.value.handleShare())})).catch((()=>{R("请完成代理人签字后进行分享")}))},Ve=(e=!1)=>{b&&q({orderNo:$||b,tenantId:n}).then((({code:a,data:i})=>{var s;"10000"===a&&(e&&((null==(s=null==i?void 0:i.holder)?void 0:s.isCert)===g.NO||(null==i?void 0:i.insuredList.some((e=>e.isCert===g.NO)))?R("用户未完身份认证及签字"):(null==i?void 0:i.tenantOrderAttachmentList.find((e=>e.category===P.ELECTRIC_SIGN&&e.objectType===U.HOLDER)))&&(null==i?void 0:i.tenantOrderAttachmentList.find((e=>e.category===P.ELECTRIC_SIGN&&e.objectType===U.INSURED)))||R("用户未完身份认证及签字")),Object.assign(te.value,i),fe.value.holder.personalInfo=i.holder,fe.value.insured.personalInfo=i.insuredList,i.tenantOrderAttachmentList.forEach((e=>{e.objectType===me?fe.value.holder.signData=e.fileBase64:e.objectType===Se?fe.value.agent.signData=e.fileBase64:e.objectType===ye&&(fe.value.insured.signData[e.objectId]=e.fileBase64)})))}))},Ee=()=>{Ve(!0)},Oe=a({imgUrl:"",desc:"",title:"",link:le});return j((()=>{H({productCode:s,tenantId:n}).then((({data:e,code:a})=>{if("10000"===a){const{wxShareConfig:a,showWXShare:i,title:s,desc:n,image:t}=(null==e?void 0:e.PRODUCT_LIST)||{};i?Object.assign(Oe.value,{...a,isShare:i}):Object.assign(Oe.value,{title:s,desc:n,image:t,isShare:i}),B(e.BASIC_INFO.themeType)}})),M({productCode:s}).then((({code:e,data:a})=>{var i;if("10000"===e){const{productMaterialMap:e}=(null==(i=a.productInsureMaterialVOList)?void 0:i[0])||{};(Object.values(e||{})||[]).flat().filter((e=>e.materialType===pe)).forEach((e=>{e.noticeObject===Se?fe.value.agent.fileList.push(e):e.noticeObject===me?fe.value.holder.fileList.push(e):e.noticeObject===ye&&fe.value.insured.fileList.push(e)}))}})),G({productCode:s,isTenant:!se}).then((({data:e,code:a})=>{var i;if("10000"===a){oe.value=e;const{productFactor:a}=(null==(i=e.productPlanInsureVOList)?void 0:i[0])||{},{signInfo:s}=K(a);console.log("signInfo",s),s.schema.forEach((e=>{"eleSign"===e.name&&e.columns.forEach((a=>{e.required&&Ne.value.sign.push(a.code),"1"===a.code?fe.value.agent.isSign=!0:"2"===a.code?fe.value.holder.isSign=!0:"3"===a.code?fe.value.insured.isSign=!0:"4"===a.code?fe.value.holder.isShareSign=!0:"5"===a.code&&(fe.value.insured.isShareSign=!0)})),"customerFace"===e.name&&e.columns.forEach((a=>{e.required&&Ne.value.verify.push(a.code),"1"===a.code?fe.value.holder.isVerify=!0:"2"===a.code&&(fe.value.insured.isVerify=!0)}))}))}})),Ve();const e=N.get("verifyData");if(e){const{serialNo:a,certNo:i,name:s}=e;J({certiNo:i,orderNo:$||b,serialNo:a,tenantId:n,userName:s}).then((e=>{const{code:a,data:i}=e;"10000"===a&&(re.remove("verifyData"),Ve())}))}})),(e,a)=>{const i=A,s=w,n=F,c=t("ProPageWrap");return l(),m(c,null,{default:d((()=>[u("div",we,[u("div",be,[o(i,{type:"warning",title:"尊敬的客户，本次投保需要进行身份认证",content:"本产品投保需要对投保人、被保人进行实名认证，您购买本产品的累计总保费已超过20万，按监管要求，需要提供投保人、被保人、指定受益人证件影像，本产品非本人投保且带身故责任、需对投保人、被保人（成人）的投保意愿进行签字确认。"})]),u("div",Ie,[o(he,{ref_key:"agentSignRef",ref:de,"data-source":[],"order-detail":f(te),"sign-string":f(fe).agent.signData,"show-sign":f(fe).agent.isSign,"show-verify":f(fe).agent.isVerify,"show-share-sign":f(fe).agent.isShareSign,"file-list":f(fe).agent.fileList,"personal-info":f(fe).agent.personalInfo,disabled:!!f(ae),title:"代理人",onHandleSign:a[0]||(a[0]=e=>ge("AGENT",e))},null,8,["order-detail","sign-string","show-sign","show-verify","show-share-sign","file-list","personal-info","disabled"]),!f(ae)||f(fe).holder.isShareSign?(l(),m(he,{key:0,ref_key:"holderSignRef",ref:ue,"order-detail":f(te),"sign-string":f(fe).holder.signData,"show-sign":f(fe).holder.isSign,"show-verify":f(fe).holder.isVerify,"show-share-sign":f(fe).holder.isShareSign,"file-list":f(fe).holder.fileList,"personal-info":f(fe).holder.personalInfo,title:"投保人",onHandleSign:a[1]||(a[1]=e=>ge("HOLDER",e,f(fe).holder.personalInfo.id)),onHandleVerify:ve},null,8,["order-detail","sign-string","show-sign","show-verify","show-share-sign","file-list","personal-info"])):h("",!0),!f(ae)||f(fe).insured.isShareSign?(l(!0),r(_,{key:1},k(f(fe).insured.personalInfo||[],(e=>(l(),m(he,{key:e.id,ref_for:!0,ref_key:"insuredSignRef",ref:ce,"data-source":[],"order-detail":f(te),"sign-string":f(fe).insured.signData[e.id],"show-sign":f(fe).insured.isSign,"show-verify":f(fe).insured.isVerify,"show-share-sign":f(fe).insured.isShareSign,"file-list":f(fe).insured.fileList,"personal-info":e||{},title:"被保人",onHandleSign:a=>ge("INSURED",a,e.id),onHandleVerify:ve},null,8,["order-detail","sign-string","show-sign","show-verify","show-share-sign","file-list","personal-info","onHandleSign"])))),128)):h("",!0)]),u("div",Ce,[u("div",{class:"refresh-btn",onClick:Ee},[u("div",null,[o(s,{name:"refresh"})]),je]),!f(ae)&&f(L)()?(l(),m(V,E({key:0,ref_key:"shareRef",ref:ke},f(Oe),{onClick:O(Le,["stop"])}),{default:d((()=>[o(n,{plain:"",type:"primary",class:"share-btn"},{default:d((()=>[p("分享")])),_:1})])),_:1},16,["onClick"])):h("",!0),o(n,{type:"primary",class:"submit-btn",onClick:_e},{default:d((()=>[p("确认支付")])),_:1})])])])),_:1})}}});export{Ne as default};
