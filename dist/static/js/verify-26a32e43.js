import{d as e,r as i,G as a,y as s,N as n,Z as t,b as r,c as l,e as o,w as d,i as u,$ as c,f,a0 as v,Y as g,h as p,j as h,g as m,V as y,C as S,a1 as I,a2 as b,u as w,a as C,K as j,a3 as N,o as k,s as L,U as O,a4 as T,a5 as V,a6 as x,a7 as E,a8 as _,n as D,T as U,D as R,P as B,a9 as P,aa as A,ab as q,W as M,m as Y,ac as F,B as G,ad as H,ae as $}from"./index-6ca00243.js";import{a as J,q as W}from"./product-7886fb47.js";import{n as K}from"./nextStep-488fa65a.js";import{g as X,i as Z}from"./trial-db34e965.js";import{u as z}from"./useAttachment-34c155c4.js";import{S as Q,f as ee,a as ie,s as ae}from"./verify-c9fdedd5.js";import{u as se}from"./useOrder-1d98a389.js";import{M as ne}from"./product-585b0e6f.js";import{t as te}from"./PayInfo-41991535.js";import{P as re,B as le}from"./constants-7afb7c3d.js";import{c as oe}from"./scribing-54392163.js";import{m as de}from"./merge-12f1f658.js";import"./core-363583a7.js";import"./constant-8927d485.js";import"./utils-ef06fb8d.js";import"./infoCollection-05e407a9.js";import"./trial-e81c897c.js";import"./keysIn-193626ca.js";import"./isObjectLike-a9798079.js";import"./_getTag-0acae921.js";import"./debounce-592a0672.js";import"./phoneVerify-630e8211.js";import"./index-51285523.js";import"./useDicData-eae86bbe.js";import"./bankCard-7c541da3.js";const ue={class:"com-sign-part"},ce={class:"people"},fe={class:"name"},ve={key:0,class:"verify-item"},ge=u("div",{class:"label"},"证件号码",-1),pe={class:"no"},he={class:"sign-status"},me={class:"status"},ye=["src"],Se={key:1,class:"sign-desc"},Ie={class:"sign-body"},be={class:"date"},we={class:"file"},Ce=e({name:"signPart"}),je=e({...Ce,props:{signString:{default:""},personalInfo:{default:()=>({})},fileList:{},title:{default:""},showSign:{type:Boolean,default:!1},showVerify:{type:Boolean,default:!1},showShareSign:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1}},emits:["handleVerify","handleSign"],setup(e,{expose:w,emit:C}){const j=e,N=i({}),k=i(""),L=i([]),O=i({});i(!0);const T=i(!1),V=i(0),{fileList:x}=z(O,L),E=e=>`${e}`===S.CERT,_=a((()=>s().format("YYYY-MM-DD"))),D=()=>{var e,i;C("handleVerify",null==(e=N.value)?void 0:e.name,null==(i=N.value)?void 0:i.certNo)},U=()=>{T.value=!1},R=i(),B=()=>{R.value&&R.value.rewrite()},P=()=>{j.disabled||R.value&&R.value.openSign()},A=e=>{C("handleSign",e)};return w({validateSign:()=>new Promise(((e,i)=>{k.value?e(!0):i(new Error(`请${j.title}完成签名后，去支付`))})),validateVerify:()=>new Promise(((e,i)=>{var a;(null==(a=j.personalInfo)?void 0:a.isCert)!==g.YES?i(new Error(`请${j.title}完成认证后，去支付`)):e(!0)}))}),n((()=>j.signString),(()=>{k.value=j.signString}),{immediate:!0}),n((()=>j.personalInfo),(()=>{N.value=j.personalInfo}),{deep:!0,immediate:!0}),(e,i)=>{const a=I,s=b,n=t("AttachmentList"),S=t("FilePreview");return r(),l("div",ue,[o(s,{title:e.title,class:"card"},{extra:d((()=>{var i,a,s,n;return[u("div",ce,[u("div",fe,c(null==(i=f(N))?void 0:i.name),1),e.showVerify&&E(null==(a=f(N))?void 0:a.certType)?(r(),l("div",{key:0,class:v(["status",{verified:(null==(s=f(N))?void 0:s.isCert)===f(g).YES}])},c((null==(n=f(N))?void 0:n.isCert)===f(g).YES?"已认证":"待认证"),3)):p("",!0)])]})),default:d((()=>{var i,s,n,t;return[e.showVerify&&(null==(i=f(N))?void 0:i.certNo)?(r(),l("div",ve,[ge,u("div",pe,c(null==(s=f(N))?void 0:s.certNo),1),(null==(n=f(N))?void 0:n.isCert)!==f(g).YES&&E(null==(t=f(N))?void 0:t.certType)?(r(),l("div",{key:0,class:"action",onClick:D},[h(" 去认证 "),o(a,{name:"right_arrow",class:"icon"})])):p("",!0)])):p("",!0)]})),_:1},8,["title"]),e.showSign?(r(),m(s,{key:0,title:`${e.title}签名`,"show-icon":!1,class:"sign-card","show-line":!1},{extra:d((()=>[u("div",he,[u("div",me,c(f(k)?"已签名":"未签名"),1),e.disabled?p("",!0):(r(),l("div",{key:0,class:"resign",onClick:B},"重签"))])])),default:d((()=>{var e;return[o(Q,{ref_key:"signRef",ref:R,modelValue:f(k),"onUpdate:modelValue":i[0]||(i[0]=e=>y(k)?k.value=e:null),class:"sign",onSubmitSign:A},{signImg:d((({data:e})=>[u("div",{class:"sign-board",onClick:P},[e?(r(),l("img",{key:0,src:e,class:"sign-img",alt:""},null,8,ye)):(r(),l("span",Se,"请签名"))])])),_:1},8,["modelValue"]),u("div",Ie,[u("div",be,"签名日期： "+c(f(_)),1),u("div",we,[(null==(e=f(x))?void 0:e.length)?(r(),m(n,{key:0,"attachment-list":f(x),"pre-text":"签名将被用于以下文件：",onPreviewFile:i[1]||(i[1]=e=>(e=>{V.value=e,T.value=!0})(e))},null,8,["attachment-list"])):p("",!0)])])]})),_:1},8,["title"])):p("",!0),f(T)?(r(),m(S,{key:1,show:f(T),"onUpdate:show":i[2]||(i[2]=e=>y(T)?T.value=e:null),"content-list":f(x),"is-only-view":"","active-index":f(V),text:"关闭",onOnCloseFilePreviewByMask:U},null,8,["show","content-list","active-index"])):p("",!0)])}}}),Ne=1,ke=2,Le=3;const Oe={class:"long-verify"},Te={class:"header"},Ve={class:"verify-content"},xe={class:"footer-button footer-bar"},Ee=u("div",{class:"text"},"刷新",-1),_e=e({__name:"verify",setup(e){const a=w(),s=C(),{productCode:t="",tenantId:c,agentCode:v="",agencyCode:y,saleChannelId:S,saleUserId:b,orderNo:z,orderCode:Q,extraInfo:ue,isShare:ce,insurerCode:fe,preview:ve}=a.query;let ge={};try{ge=JSON.parse(decodeURIComponent(ue))}catch(Ge){}const pe=se(),he=`${window.origin}/baseInsurance/long/phoneVerify?${j.stringify({...a.query,orderNo:Q||z})}`,me=new N({source:"localStorage"});i({});const ye=i({}),Se=i(),Ie=i(),be=i(),we=i({holder:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""},insured:{fileList:[],personalInfo:[],isSign:!1,isVerify:!1,isShareSign:!1,signData:{}},agent:{fileList:[],personalInfo:{},isSign:!1,isVerify:!1,isShareSign:!1,signData:""}}),Ce=i({text:"",type:"",signInfo:""}),_e=i({text:"",type:"",signInfo:""}),De=(e,i)=>{let a=window.location.href;a=a.includes("orderCode")?a:a.replaceAll("orderNo","orderCode"),ie({callbackUrl:a,certiNo:i,faceAuthMode:"TENCENT",userName:e,tenantId:c}).then((({code:a,data:s})=>{if("10000"===a){const{originalUrl:a,serialNo:n}=s;window.location.href=a,L.set("verifyData",{serialNo:n,certNo:i,name:e})}}))},Ue=(e,i,a)=>{var s;ae(e,i,null==(s=pe.value)?void 0:s.id,c,a)},Re=i({sign:[],verify:[],scribing:""}),Be=()=>{if(ve)return void D(re.SIGN,a.query);const e=[];Se.value&&Re.value.sign.includes("1")&&e.push(Se.value.validateSign()),Ie.value&&((ce?Re.value.sign.includes("4"):Re.value.sign.includes("2"))&&e.push(Ie.value.validateSign()),Re.value.verify.includes("1")&&e.push(Ie.value.validateVerify())),be.value&&((ce?Re.value.sign.includes("5"):Re.value.sign.includes("3"))&&e.push(...(be.value||[]).map((e=>e.validateSign()))),Re.value.verify.includes("2")&&e.push(...(be.value||[]).map((e=>e.validateVerify())))),Promise.all(e).then((e=>{!Re.value.scribing||Ce.value.status?z&&X({orderNo:Q||z,saleUserId:b,tenantId:c}).then((({code:e,data:i})=>{"10000"===e&&R.confirm({title:"提示",message:"请确认信息填写无误后，再进行支付"}).then((()=>{Object.assign(pe.value,{extInfo:{...pe.value.extInfo,buttonCode:le.SIGN,pageCode:re.SIGN}}),K(pe.value,((e,i)=>{i===B.JUMP_URL&&(window.location.href=e.paymentUrl)}))}))})):U("请先完成风险抄录")})).catch((e=>{U(e.message)}))},Pe=i(),Ae=()=>{Se.value&&Re.value.sign.includes("1")&&Se.value.validateSign().then((()=>{Pe.value&&Pe.value.handleShare()})).catch((()=>{U("请完成代理人签字后进行分享")}))},qe=(e=!1)=>{z&&X({orderNo:Q||z,tenantId:c}).then((({code:i,data:a})=>{var s,n,t,r,l;"10000"===i&&(e&&((null==(s=null==a?void 0:a.holder)?void 0:s.isCert)===g.NO||(null==a?void 0:a.insuredList.some((e=>e.isCert===g.NO)))?U("用户未完身份认证及签字"):(null==a?void 0:a.tenantOrderAttachmentList.find((e=>e.category===P.ELECTRIC_SIGN&&e.objectType===A.HOLDER)))&&(null==a?void 0:a.tenantOrderAttachmentList.find((e=>e.category===P.ELECTRIC_SIGN&&e.objectType===A.INSURED)))||U("用户未完身份认证及签字")),Object.assign(pe.value,a),we.value.holder.personalInfo=a.holder,we.value.insured.personalInfo=a.insuredList,Object.assign(_e.value,{type:q[a.extInfo.transcriptionType],signInfo:null==(t=null==(n=a.riskTranscriptionList)?void 0:n[0])?void 0:t.uri,text:null==(l=null==(r=a.riskTranscriptionList)?void 0:r[0])?void 0:l.content,status:!!a.extInfo.transcriptionStatus}),a.tenantOrderAttachmentList.forEach((e=>{e.objectType===Ne?we.value.holder.signData=e.fileBase64:e.objectType===Le?we.value.agent.signData=e.fileBase64:e.objectType===ke&&(we.value.insured.signData[e.objectId]=e.fileBase64)})))}))},Me=()=>{qe(!0)},Ye=i({imgUrl:"",desc:"",title:"",link:he}),Fe=e=>{const{type:i,text:n}=Ce.value;"handle"===i?s.push({path:"scribing",query:{...a.query,text:n,orderId:pe.value.id}}):oe({content:n,image:e,orderNo:z,tenantId:c,transcriptionType:$.AUTO}).then((({code:e})=>{"10000"===e&&qe()}))};return n([()=>_e.value,()=>Ce.value],(()=>{de(Ce.value,_e.value)}),{deep:!0,immediate:!0}),k((()=>{J({productCode:t,tenantId:c}).then((({data:e,code:i})=>{if("10000"===i){const{wxShareConfig:i,showWXShare:a,title:s,desc:n,image:t}=(null==e?void 0:e.PRODUCT_LIST)||{};a?Object.assign(Ye.value,{...i,imgUrl:i.image,isShare:a}):Object.assign(Ye.value,{title:s,desc:n,imgUrl:t,isShare:a}),e.BASIC_INFO&&e.BASIC_INFO.themeType&&M(e.BASIC_INFO.themeType)}})),W({productCode:t}).then((({code:e,data:i})=>{var a;if("10000"===e){const{productMaterialMap:e}=(null==(a=i.productInsureMaterialVOList)?void 0:a[0])||{};(Object.values(e||{})||[]).flat().filter((e=>e.materialType===ne.SIGN)).forEach((e=>{e.noticeObject===Le?we.value.agent.fileList.push(e):e.noticeObject===Ne?we.value.holder.fileList.push(e):e.noticeObject===ke&&we.value.insured.fileList.push(e)}))}})),Z({productCode:t,isTenant:!ve}).then((({data:e,code:i})=>{var a;if("10000"===i){ye.value=e;const{productFactor:i}=(null==(a=e.productPlanInsureVOList)?void 0:a[0])||{},{signInfo:s}=te(i);s.schema.forEach((e=>{"eleSign"===e.name&&e.columns.forEach((i=>{e.required&&Re.value.sign.push(i.code),"1"===i.code?we.value.agent.isSign=!0:"2"===i.code?we.value.holder.isSign=!0:"3"===i.code?we.value.insured.isSign=!0:"4"===i.code?we.value.holder.isShareSign=!0:"5"===i.code&&(we.value.insured.isShareSign=!0)})),"riskNotificationCopy"===e.name&&(Ce.value.text=e.remark,Re.value.scribing=e.required,e.columns.forEach((e=>{"1"===e.code?Ce.value.type="handle":Ce.value.type="auto"}))),"customerFace"===e.name&&e.columns.forEach((i=>{e.required&&Re.value.verify.push(i.code),"1"===i.code?we.value.holder.isVerify=!0:"2"===i.code&&(we.value.insured.isVerify=!0)}))}))}})),qe();const e=L.get("verifyData");if(e){const{serialNo:i,certNo:a,name:s}=e;ee({certiNo:a,orderNo:Q||z,serialNo:i,tenantId:c,userName:s}).then((e=>{const{code:i,data:a}=e;"10000"===i&&(me.remove("verifyData"),qe())}))}})),(e,i)=>{const a=Y,s=F,n=I,t=G,c=H;return r(),l("div",Oe,[o(a),u("div",Te,[o(s,{type:"warning",title:"尊敬的客户，本次投保需要进行身份认证",content:"本产品投保需要对投保人、被保人进行实名认证，您购买本产品的累计总保费已超过20万，按监管要求，需要提供投保人、被保人、指定受益人证件影像，本产品非本人投保且带身故责任、需对投保人、被保人（成人）的投保意愿进行签字确认。"})]),u("div",Ve,[o(je,{ref_key:"agentSignRef",ref:Se,"order-detail":f(pe),"sign-string":f(we).agent.signData,"show-sign":f(we).agent.isSign,"show-verify":f(we).agent.isVerify,"file-list":f(we).agent.fileList,"personal-info":f(we).agent.personalInfo,disabled:!!f(ce),title:"代理人",onHandleSign:i[0]||(i[0]=e=>Ue("AGENT",e))},null,8,["order-detail","sign-string","show-sign","show-verify","file-list","personal-info","disabled"]),!f(ce)||f(we).holder.isShareSign?(r(),m(je,{key:0,ref_key:"holderSignRef",ref:Ie,"order-detail":f(pe),"sign-string":f(we).holder.signData,"show-sign":f(ce)?f(we).holder.isShareSign:f(we).holder.isSign,"show-verify":f(we).holder.isVerify,"file-list":f(we).holder.fileList,"personal-info":f(we).holder.personalInfo,title:"投保人",onHandleSign:i[1]||(i[1]=e=>Ue("HOLDER",e,f(we).holder.personalInfo.id)),onHandleVerify:De},null,8,["order-detail","sign-string","show-sign","show-verify","file-list","personal-info"])):p("",!0),!f(ce)||f(we).insured.isShareSign?(r(!0),l(O,{key:1},T(f(we).insured.personalInfo||[],(e=>(r(),m(je,{key:e.id,ref_for:!0,ref_key:"insuredSignRef",ref:be,"data-source":[],"order-detail":f(pe),"sign-string":f(we).insured.signData[e.id],"show-sign":f(ce)?f(we).insured.isShareSign:f(we).insured.isSign,"show-verify":f(we).insured.isVerify,"file-list":f(we).insured.fileList,"personal-info":e||{},title:"被保人",onHandleSign:i=>Ue("INSURED",i,e.id),onHandleVerify:De},null,8,["order-detail","sign-string","show-sign","show-verify","file-list","personal-info","onHandleSign"])))),128)):p("",!0)]),u("div",xe,[u("div",{class:"refresh-btn",onClick:Me},[u("div",null,[o(n,{name:"refresh"})]),Ee]),!f(ce)&&f(V)()?(r(),m(_,E({key:0,ref_key:"shareRef",ref:Pe},f(Ye)),{default:d((()=>[o(t,{plain:"",type:"primary",class:"share-btn",onClick:x(Ae,["stop"])},{default:d((()=>[h("分享")])),_:1},8,["onClick"])])),_:1},16)):p("",!0),o(t,{type:"primary",class:"submit-btn",onClick:Be},{default:d((()=>[h("确认支付")])),_:1})]),f(Re).scribing?(r(),m(c,E({key:0},f(Ce),{title:"为了保障您的权益请抄录以下声明内容",onOnSubmit:Fe}),null,16)):p("",!0)])}}});export{_e as default};
