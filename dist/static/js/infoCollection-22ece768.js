import{d as e,j as a,r as i,bi as t,O as l,z as s,o,c as n,b as r,u,F as d,f as c,aI as p,az as v,q as m,w as f,g as k,_ as I,bg as y,be as g,m as h,a as L,bf as V,i as C,h as R,k as P,aA as O,aB as b,T as D,E as T,aE as w,aF as F,aG as x,a9 as S,aH as N,av as _,aw as j,a4 as E,a5 as A,a6 as M,p as U,a8 as q,c5 as B,bA as K,ab as $,ac as H}from"./index-8ccea0ec.js";import{_ as Q}from"./PolicyInfo-11287dc5.js";import{u as G,c as J,h as z,d as W,q as X,g as Y,i as Z}from"./trial-eee9ad28.js";import{_ as ee}from"./TrialButton-91a089dc.js";import{n as ae}from"./nextStep-3fbda94c.js";import{u as ie}from"./useAttachment-e5dc3be3.js";import{a as te,c as le}from"./product-97cae19e.js";import{g as se}from"./utils-f86c0766.js";import{u as oe}from"./useOrder-99173ff9.js";import{_ as ne,P as re,B as ue}from"./constants-3e9a9875.js";import{t as de}from"./utils-e94b6cd3.js";import{c as ce}from"./cloneDeep-5f280262.js";import{B as pe,P as ve,R as me,a as fe}from"./index-afa48ae4.js";import{o as ke}from"./index-de590a0b.js";import{B as Ie}from"./index-d1a6007f.js";import{R as ye}from"./trial-c0526383.js";import{P as ge}from"./config-98e8d477.js";import{i as he}from"./isNaN-bcccce3b.js";import"./index-26608712.js";import"./format-31cde443.js";import"./core-73a53a48.js";import"./infoCollection-86362f87.js";import"./createProposal-683c8b9a.js";import"./index-158d5796.js";import"./search-2fed2fbb.js";import"./gender-bdd67324.js";import"./product-7bbf9c44.js";import"./index-d680c3b2.js";import"./empty-ae586b6c.js";import"./index-00b08bc7.js";const Le=e({name:"InsureInfos"}),Ve=e({...Le,props:{originData:{default:()=>({})},modelValue:{default:()=>({})},defaultValue:{default:()=>({})},trialResult:{default:()=>({})}},emits:["trialChange"],setup(e,{expose:v,emit:m}){const f=e,k=a(null),I=a({}),y=a({}),g=i({personalInfo:{},basicsAmount:"",basicsPremium:"",defaultValues:f.defaultValue,changeData:null,sValues:I.value});t("premium"),y.value=t("enumList")||{},l((()=>{}));const h=e=>{f.originData.mainRiskFlag,I.value.riskCategory=f.originData.riskCategory,I.value.riskCode=f.originData.riskCode,I.value.riskId=f.originData.riskId,I.value.riskType=f.originData.riskType,I.value.riskName=f.originData.riskName,I.value.riskType=f.originData.riskType,I.value.mainRiskCode=f.originData.mainRiskCode,I.value.mainRiskId=f.originData.mainRiskId,e?m("trialChange",I.value,e):m("trialChange",I.value)},L=(e,a)=>{a?I.value[a.key]=a.newValue:ke(e).forEach((a=>{I.value[a]=e[a]})),h(a)},V=e=>{var a,i;1==+(null==(i=null==(a=f.originData)?void 0:a.productRiskInsureLimitVO)?void 0:i.amountPremiumConfigVO.saleMethod)?g.basicsAmount=null==e?void 0:e.initialAmount:g.basicsAmount=null==e?void 0:e.initialPremium,ke(e).forEach((a=>{I.value[a]=e[a]})),h()},C=e=>{I.value.liabilityList=e,h()};return s((()=>f.defaultValue),(e=>{e&&(console.log("--default change ",e),g.defaultValues=ce(e),I.value={...e})}),{deep:!0,immediate:!0}),s((()=>I.value),(e=>{g.sValues=e}),{deep:!0,immediate:!0}),v({validate:async()=>{var e;await(null==(e=k.value)?void 0:e.validate())}}),(e,a)=>{var i,t,l,s,v,m;const f=p;return 1===(null==(i=e.originData)?void 0:i.factorDisPlayFlag)?(o(),n(d,{key:0},[r(f,{title:"保障计划",class:"insurePlan","show-divider":!1}),r(u(pe),{"v-model":u(g).sValues,"origin-data":null==(l=null==(t=e.originData)?void 0:t.productRiskInsureLimitVO)?void 0:l.amountPremiumConfigVO,"defalut-value":u(g).defaultValues,"trial-result":e.trialResult,onTrialChange:V},null,8,["v-model","origin-data","defalut-value","trial-result"]),r(u(ve),{"v-model":u(g).sValues,"use-data":u(g).sValues,"origin-data":e.originData.productRiskInsureLimitVO,"risk-info":e.originData,"default-value":u(g).defaultValues,onTrialChange:L},null,8,["v-model","use-data","origin-data","risk-info","default-value"]),r(u(me),{"data-source-folmulate":u(I),"data-source":e.originData,params:{amountUnit:null==(v=null==(s=e.originData)?void 0:s.productRiskInsureLimitVO)?void 0:v.amountPremiumConfigVO.displayUnit,basicsAmount:u(g).basicsAmount,basicsPremium:u(g).basicsPremium,riskId:null==(m=e.originData)?void 0:m.riskId},"default-value":u(g).defaultValues,onTrialChange:C},null,8,["data-source-folmulate","data-source","params","default-value"])],64)):c("",!0)}}});const Ce={key:0},Re={key:0,class:"risk2-field"},Pe=e({name:"ProductRiskList"});var Oe=I(e({...Pe,props:{dataSource:{type:Array,default:()=>[]},productInfo:{type:Object,default:()=>({productCode:"",productName:""})},showMainRisk:{type:Boolean,default:()=>!0},defaultValue:{type:Object,default:()=>{}}},emits:["trialChange"],setup(e,{emit:a}){const t=e,p=i({loading:!1,show:!0,select:{},list:[],userData:{},riskIsInsure:{},submitData:{},disabledRiskInfo:[],risksDefaultValue:{}}),I=e=>{const a=[];return e.riskLiabilityInfoVOList.map((e=>(1!=+e.showFlag&&a.push({...e}),[]))),a},h=(e,i,l)=>{var s;p.riskIsInsure[i].data=e;const o=[...p.disabledRiskInfo];null==(s=t.dataSource.insureProductRiskVOList)||s.forEach((e=>{if(1!==e.mainRiskFlag){const a=p.riskIsInsure[e.riskId];a.data&&Object.keys(a.data).length>0&&"1"===a.selected&&o.push(a.data)}})),a("trialChange",o,l)},L=(e,a)=>{var i;null==(i=t.dataSource.productRiskRelationVOList)||i.forEach((i=>{1!==i.collocationType&&(a.riskId===i.riskId?(p.riskIsInsure[a.riskId]&&p.riskIsInsure[a.riskId].selected,2===i.collocationType&&p.riskIsInsure[i.collocationRiskId]&&(p.riskIsInsure[i.collocationRiskId].selected=e),3===i.collocationType&&p.riskIsInsure[i.collocationRiskId]&&"1"===e&&(p.riskIsInsure[i.collocationRiskId].selected="1"===e?"2":"1")):a.riskId===i.collocationRiskId&&(3===i.collocationType&&"1"===e&&p.riskIsInsure[i.riskId]&&(p.riskIsInsure[i.riskId].selected="1"===e?"2":"1"),2===i.collocationType&&p.riskIsInsure[i.riskId]&&(p.riskIsInsure[i.riskId].selected=e)))})),"2"===e?h({},a.riskId):(e=>{var a,i,t,l,s,o,n,r,u,d,c,p;if(1!==(null==e?void 0:e.factorDisPlayFlag)){const v=null==(a=null==e?void 0:e.productRiskInsureLimitVO)?void 0:a.amountPremiumConfigVO,m={riskCategory:e.riskCategory,riskCode:e.riskCode,riskName:e.riskName,riskId:e.riskId,riskType:e.riskType,mainRiskId:e.mainRiskId,mainRiskCode:e.mainRiskCode,liabilityList:I(e)};m.chargePeriod=(null==(t=null==(i=null==e?void 0:e.productRiskInsureLimitVO)?void 0:i.paymentPeriodValueList)?void 0:t.length)>0&&(null==(l=null==e?void 0:e.productRiskInsureLimitVO)?void 0:l.paymentPeriodValueList[0].code)||null,m.coveragePeriod=(null==(o=null==(s=null==e?void 0:e.productRiskInsureLimitVO)?void 0:s.insurancePeriodValueList)?void 0:o.length)>0&&(null==(n=null==e?void 0:e.productRiskInsureLimitVO)?void 0:n.insurancePeriodValueList[0].code)||null,m.paymentFrequency=(null==(u=null==(r=null==e?void 0:e.productRiskInsureLimitVO)?void 0:r.paymentFrequencyList)?void 0:u.length)>0&&(null==(d=null==e?void 0:e.productRiskInsureLimitVO)?void 0:d.paymentFrequencyList[0].code)||null;let f=0;1===v.displayType?f=(null==v?void 0:v.minStepValue)>0?null==v?void 0:v.minStepValue:0:3===v.displayType&&2===v.requireCopies?f=(null==(c=null==v?void 0:v.displayValues)?void 0:c.length)>0?null==v?void 0:v.displayValues[0].value:0:3===v.displayType&&1===v.requireCopies?(f=(null==(p=null==v?void 0:v.displayValues)?void 0:p.length)>0?null==v?void 0:v.displayValues[0].value:0,m.copy=v.minCopiesValue):2===v.displayType?m.copy=v.minCopiesValue:f=0,1===v.saleMethod?m.initialAmount=f:m.initialPremium=f,h(m,e.riskId)}})(a)};return v((()=>{(()=>{var e,a;p.disabledRiskInfo=[];let i=null;if(null==(e=t.dataSource.insureProductRiskVOList)||e.forEach((e=>{var a;const l=1!==e.mainRiskFlag?null==(a=t.dataSource.productRiskRelationVOList)?void 0:a.find((a=>a.collocationRiskId===e.riskId)):{};1===e.mainRiskFlag&&(i=e),p.riskIsInsure[e.riskId]?(p.riskIsInsure[e.riskId].data=null,p.riskIsInsure[e.riskId].relation=l,p.riskIsInsure[e.riskId].isMust=!1):p.riskIsInsure[e.riskId]={selected:"2",data:null,relation:l,isMust:!1}})),i){const e=null==(a=t.dataSource.productRiskRelationVOList)?void 0:a.filter((e=>e.riskId===i.riskId));if(!e)return;null==e||e.forEach((e=>{var a,i,l,s,o,n,r,u,d,c,v,m,f,k,y;if(2===e.collocationType){p.riskIsInsure[e.collocationRiskId].selected="1",p.riskIsInsure[e.collocationRiskId].isMust=!0;const g=null==(a=t.dataSource.insureProductRiskVOList)?void 0:a.find((a=>e.collocationRiskId===a.riskId));if(g&&1!==g.factorDisPlayFlag&&(null==(i=null==g?void 0:g.productRiskInsureLimitVO)?void 0:i.amountPremiumConfigVO)){const a=null==(l=g.riskLiabilityInfoVOList)?void 0:l.every((e=>1!==e.showFlag)),i=null==(s=null==g?void 0:g.productRiskInsureLimitVO)?void 0:s.amountPremiumConfigVO;if(a){p.riskIsInsure[e.collocationRiskId].isDisabled=!0;const a={riskCategory:g.riskCategory,riskCode:g.riskCode,riskName:g.riskName,riskId:g.riskId,riskType:g.riskType,mainRiskId:g.mainRiskId,mainRiskCode:g.mainRiskCode,liabilityList:I(g)};a.chargePeriod=(null==(n=null==(o=null==g?void 0:g.productRiskInsureLimitVO)?void 0:o.paymentPeriodValueList)?void 0:n.length)>0&&(null==(r=null==g?void 0:g.productRiskInsureLimitVO)?void 0:r.paymentPeriodValueList[0].code)||null,a.coveragePeriod=(null==(d=null==(u=null==g?void 0:g.productRiskInsureLimitVO)?void 0:u.insurancePeriodValueList)?void 0:d.length)>0&&(null==(c=null==g?void 0:g.productRiskInsureLimitVO)?void 0:c.insurancePeriodValueList[0].code)||null,a.paymentFrequency=(null==(m=null==(v=null==g?void 0:g.productRiskInsureLimitVO)?void 0:v.paymentFrequencyList)?void 0:m.length)>0&&(null==(f=null==g?void 0:g.productRiskInsureLimitVO)?void 0:f.paymentFrequencyList[0].code)||null;let t=0;1===i.displayType?t=(null==i?void 0:i.minStepValue)>0?null==i?void 0:i.minStepValue:0:3===i.displayType&&2===i.requireCopies?t=(null==(k=null==i?void 0:i.displayValues)?void 0:k.length)>0?null==i?void 0:i.displayValues[0].value:0:3===i.displayType&&1===i.requireCopies?(t=(null==(y=null==i?void 0:i.displayValues)?void 0:y.length)>0?null==i?void 0:i.displayValues[0].value:0,a.copy=i.minCopiesValue):2===i.displayType&&(a.copy=i.minCopiesValue),1===i.saleMethod?a.initialAmount=t:a.initialPremium=t,p.disabledRiskInfo.push(a),h(a,g.riskId)}}}3===e.collocationType&&(p.riskIsInsure[e.collocationRiskId].selected="2",p.riskIsInsure[e.collocationRiskId].isMust=!0)}))}})()})),l((()=>{p.loading=!0})),s((()=>p.riskIsInsure),(e=>{}),{deep:!0,immediate:!0}),s((()=>t.defaultValue),(e=>{(null==e?void 0:e.length)>0&&e.forEach((e=>{p.risksDefaultValue[e.riskCode]=e,p.riskIsInsure[e.riskId]?(p.riskIsInsure[e.riskId].selected="1",h(e,e.riskId)):p.riskIsInsure[e.riskId]={selected:"1",isMust:!1}}))}),{deep:!0,immediate:!0}),(a,i)=>{const t=y,l=g;return o(!0),n(d,null,m(e.dataSource.insureProductRiskVOList,(i=>{var s,v;return o(),n(d,{key:i.riskCode},[(!e.showMainRisk&&1!==i.mainRiskFlag||e.showMainRisk)&&(null==(v=null==(s=u(p).riskIsInsure)?void 0:s[i.riskId])?void 0:v.relation)?(o(),n("div",Ce,[r(l,{modelValue:u(p).riskIsInsure[i.riskId].selected,"onUpdate:modelValue":e=>u(p).riskIsInsure[i.riskId].selected=e,label:i.riskName,name:"selected","label-width":"50%",border:!1,class:"risk-select-field risk-name"},{input:f((()=>[r(t,{modelValue:u(p).riskIsInsure[i.riskId].selected,"onUpdate:modelValue":e=>u(p).riskIsInsure[i.riskId].selected=e,"active-value":"1","inactive-value":"2",size:"0.68rem",disabled:u(p).riskIsInsure[i.riskId].isMust,style:{"margin-right":"8px"},onChange:e=>L(e,i)},null,8,["modelValue","onUpdate:modelValue","disabled","onChange"])])),_:2},1032,["modelValue","onUpdate:modelValue","label"]),"1"===u(p).riskIsInsure[i.riskId].selected?(o(),n("div",Re,[r(Ve,{modelValue:u(p).riskIsInsure[i.riskId].data,"onUpdate:modelValue":e=>u(p).riskIsInsure[i.riskId].data=e,"origin-data":i,"product-factor":e.dataSource.productFactor,"default-value":u(p).risksDefaultValue[i.riskCode],onTrialChange:(e,a)=>h(e,i.riskId,a)},null,8,["modelValue","onUpdate:modelValue","origin-data","product-factor","default-value","onTrialChange"])])):c("",!0),1===i.exemptFlag&&"1"===u(p).riskIsInsure[i.riskId].selected?k(a.$slots,"holderForm",{key:1},void 0,!0):c("",!0)])):c("",!0)],64)})),128)}}}),[["__scopeId","data-v-58a61f59"]]);const be={class:"pro-radio-wrap"},De=e({name:"PlanSelect"}),Te=e({...De,props:{planList:{default:()=>[]},defaultPlan:{default:()=>{}}},emits:["planChange"],setup(e,{emit:i}){const t=e,n=a("");let u=!1;return l((()=>{t.defaultPlan&&(u=!0,n.value=t.defaultPlan.planCode)})),s((()=>n),(e=>{u||i("planChange",n.value),u&&(u=!1)}),{deep:!0,immediate:!0}),(e,a)=>{const i=V,l=g;return e.planList.length>0?(o(),h(l,{key:0,modelValue:n.value,"onUpdate:modelValue":a[1]||(a[1]=e=>n.value=e),label:"保障计划",name:"planCode",class:"risk-select-field"},{input:f((()=>[L("div",be,[r(i,{modelValue:n.value,"onUpdate:modelValue":a[0]||(a[0]=e=>n.value=e),options:t.planList.map((e=>({label:e.planName,value:e.planCode})))},null,8,["modelValue","options"])])])),_:1},8,["modelValue"])):c("",!0)}}}),we=(e,a,i)=>{const t=e,{holder:l}=i,s=i.insuredList[0],o=(a||"").split("_");if(o.length<2)return a;if(he(Number(o[1])))return a;if(o[1]-=1,1===t.exemptFlag){if("to"===o[0]){let e=0;1===t.exemptType?(null==l?void 0:l.birthday)&&(e=parseInt(""+((new Date).getTime()-new Date(l.birthday).getTime())/31536e6,10)):2===t.exemptType&&(null==s?void 0:s.birthday)&&(e=parseInt(""+(+(new Date).getTime()-new Date(s.birthday).getTime())/31536e6,10)),o[1]=+o[1]-e}o[0]="year"}return o.join("_")},Fe=(e,a)=>{const i=[],t={};return null==e||e.forEach((e=>{t[e.riskId]=e})),null==a||a.forEach((e=>{var a,l,s,o;const{collocationType:n,collocationRiskId:r,riskId:u}=e;switch(n){case 2:{const e=null==(a=t[u])?void 0:a.riskName,s=null==(l=t[r])?void 0:l.riskName;i.push(`${e} 和 ${s} 必须同时投保`);break}case 3:{const e=null==(s=t[u])?void 0:s.riskName,a=null==(o=t[r])?void 0:o.riskName;i.push(`${e} 和 ${a} 不能同时投保`);break}}})),i};const xe={class:"com-body"},Se={class:"trial-body"},Ne={class:"container"},_e={class:"container"},je={class:"container"},Ee=(e=>(_("data-v-48af32c8"),e=e(),j(),e))((()=>L("div",{class:"empty"},null,-1))),Ae=e({name:"TrialBody"});var Me=I(e({...Ae,props:{selfKey:{default:""},dataSource:{default:()=>[]},productInfo:{default:()=>({productCode:"",productName:"",insurerCode:"",tenantId:"",planList:[]})},tenantProductDetail:{default:()=>({})},hideBenefit:{type:Boolean,default:!1},hidePopupButton:{type:Boolean,default:!1},title:{default:"算一算保费"},defaultData:{default:null},isTrial:{type:Boolean,default:!1},defaultOrder:{default:()=>({})}},emits:["trialStart","trialEnd","update:userData","closeCustomerPopoup"],setup(e,{expose:t,emit:d}){const p=e,m=a(null),I=C();R();const{tenantId:y,templateId:g,preview:V}=I.query,_=a(),j=i({loading:!1,show:!1,select:{},list:[],userData:{},riskIsInsure:{},submitData:{},riskList:[{}],mainRiskVO:{},ifPersonalInfoSuccess:!1,trialMsg:"",trialResultPremium:0,trialResult:{initialPremium:0,initialAmount:0},isAniShow:!1,defaultValue:null,isAutoChange:!1,planIndex:0,isSkipFirstTrial:!1,hadSkipFirstTrial:!1,isQuerying:!1,currentPlanCode:""}),E=oe();a();const A=a(),M=a(p.dataSource),U=a([]),q=e=>{const{holder:a,insuredList:i}=e||{};a&&(j.submitData.holder=a),i&&i.length>0&&i.forEach(((e,a)=>{var i;j.submitData.insuredList&&j.submitData.insuredList.length>a?j.submitData.insuredList[a]=e:((null==(i=j.submitData)?void 0:i.insuredList)||(j.submitData.insuredList=[]),j.submitData.insuredList.push(e))}))},B=P((()=>p.productInfo.planList&&p.productInfo.planList.length>2)),K=(e,a)=>{if(e){const i=["birthday","age","gender","id"];a.includes("occupationCodeList")&&i.push("occupationClass"),Object.keys(e).forEach((t=>{[...a,...i].includes(t)||(e[t]=null)}))}},$=e=>{console.log("我是客户数据",e),d("closeCustomerPopoup",e)},H=(e,a=(e=>!0))=>w(e)?e.filter(a).map((e=>e.code)):[],Q=()=>{console.log("--current plan = ",M.value),console.log("---current submit = ",j.submitData);const e=ce(j.submitData);if(!B.value)return e;const{1:a,2:i,3:t}=M.value.productFactor||{};if(e.holder&&K(e.holder,H(a)),e.insuredList){const a=["productList","beneficiaryList"],l=H(i,(e=>"2"!==String(e.subModuleType))),s=H(i,(e=>"2"===String(e.subModuleType))),o=w(s),n=H(t),r=w(n);e.insuredList.forEach(((e,i)=>{var t,u,d;K(e,[...i>=1&&o?s:l,...a,...r?["insuredBeneficiaryType"]:[]]),(null==(t=e.beneficiaryList)?void 0:t.length)>0&&(r?e.beneficiaryList.forEach((e=>K(e,n))):e.beneficiaryList.length=0),e.planCode=M.value.planCode;const c=(null==(d=null==(u=e.productList)?void 0:u[0])?void 0:d.riskList)||[],p=M.value.insureProductRiskVOList||[];if(c.length&&p){const a=c.filter((e=>null!==p.find((a=>a.riskCode===e.riskCode))));e.productList[0].riskList=a}}))}return e},Y=a(),Z=a({}),ee=["annuityDrawDate","coveragePeriod","chargePeriod","paymentFrequency"],ie=e=>{var a,i,t,l,s,o;if(null==(i=null==(a=null==e?void 0:e.data)?void 0:a[0])?void 0:i.productRiskDyInsureFactorVOList){const a=[];if(null==(t=M.value)||t.insureProductRiskVOList.forEach((i=>{var t,l;const s=null==(l=null==(t=null==e?void 0:e.data)?void 0:t[0])?void 0:l.productRiskDyInsureFactorVOList.find((e=>e.riskCode===i.riskCode));if(s){i.productRiskInsureLimitVO={...i.productRiskInsureLimitVO,...s};const e=j.riskList.find((e=>e.riskCode===i.riskCode));let t=!1;ge.forEach((a=>{if(ee.indexOf(a.valueKey)>=0){const l=i.productRiskInsureLimitVO[a.configKey];if(l&&e){const i=l.find((i=>i.code===e[a.valueKey]));if(i&&2===i.useFlag){const i=l.find((e=>1===e.defaultFlag));e[a.valueKey]=i.code,t=!0}}}})),t&&a.push({...e,...s,riskCode:i.riskCode})}})),a.length>0&&(null==(o=null==(s=null==(l=j.defaultValue)?void 0:l.insuredList)?void 0:s[0])?void 0:o.productList))return a.forEach((e=>{var a,i,t;j.defaultValue.insuredList[0].productList=null==(t=null==(i=null==(a=j.defaultValue)?void 0:a.insuredList)?void 0:i[0])?void 0:t.productList.map((a=>(a.riskList=null==a?void 0:a.riskList.map((a=>(a.riskCode===e.riskCode&&(a=e),a))),a)))})),!1}return!0},te=O((async(e,a=!0)=>{j.trialMsg="试算中...",j.trialResultPremium=0,j.loading=!0,d("trialStart");let i=!1;if(a){const{code:a}=await G(e);i="10000"===a}!i&&a||(j.isQuerying=!0,p.hideBenefit||J(e).then((e=>{e.data&&e.code===b&&(Z.value=e.data)})).finally((()=>{j.loading=!1})),z(e).then((a=>{var i,t;if(a.data&&a.code===b){(null==(i=null==a?void 0:a.data)?void 0:i.errorInfo)&&D(`${null==(t=null==a?void 0:a.data)?void 0:t.errorInfo}`),j.trialMsg="",j.trialResultPremium=a.data.initialPremium,j.trialResult=a.data;const l={};a.data.riskPremiumDetailVOList&&a.data.riskPremiumDetailVOList.length&&a.data.riskPremiumDetailVOList.forEach((e=>{l[e.riskCode]={initialAmount:e.initialAmount,initialPremium:e.initialPremium}})),Y.value=l,d("trialEnd",a.data,e)}})).finally((()=>{j.loading=!1,j.isQuerying=!1})))}),500),le=O((async()=>{console.log(">>>>>调用试算<<<<<",j.ifPersonalInfoSuccess,_.value.canTrail());const{productCode:e,productName:a}=p.productInfo||{};if(j.ifPersonalInfoSuccess||_.value.canTrail()){j.submitData.productCode=e,j.submitData.productName=a,j.submitData.tenantId=p.productInfo.tenantId,j.riskList=j.riskList.map((e=>(e=>{var a,i,t,l;const s=null==(a=M.value.insureProductRiskVOList)?void 0:a.find((a=>e.riskId===a.riskId));if(s&&1!==s.mainRiskFlag){const a=null==(t=null==(i=M.value)?void 0:i.productRiskRelationVOList)?void 0:t.filter((e=>{var a;if(e.collocationRiskId===s.riskId&&3!==e.collocationType){const i=null==(a=M.value.insureProductRiskVOList)?void 0:a.find((a=>e.riskId===a.riskId));if(i&&i.riskType===ye.MAIN_RISK)return!0}return!1})),o=a.length>0?a[0]:null;if(o){const a=null==(l=j.riskList)?void 0:l.find((e=>e.riskId===o.riskId));ge.forEach((i=>{i.ruleKey&&s.productRiskInsureLimitVO&&a&&(1===s.productRiskInsureLimitVO[i.ruleKey]&&(e[i.valueKey]=a[i.valueKey]),3===s.productRiskInsureLimitVO[i.ruleKey]&&(1!==s.exemptFlag?e[i.valueKey]=we(s,a[i.valueKey],j.submitData):e[i.valueKey]=we(s,a[i.ruleValueKey],j.submitData)))}))}}return e})(e))),j.submitData.insuredList&&j.submitData.insuredList.forEach((i=>{i.productList=[{productCode:e,productName:a,riskList:j.riskList}]}));const i=Q();console.log(">>>数据构建<<<",i),await te(i)}}),300),se=async e=>{console.log("人的信息更改了"),q(e),j.ifPersonalInfoSuccess=!0,console.log("处理第一被保人修改的dy变化"),le()};P((()=>{var e;return((null==(e=j.userData)?void 0:e.insuredList)||[]).map((e=>e.birthday)).join(",")})),s((()=>{var e;return((null==(e=j.userData)?void 0:e.insuredList)||[]).map((e=>e.birthday)).join(",")}),O((async e=>{var a;if(M.value.insureProductRiskVOList&&e){const e=j.userData.insuredList.filter((e=>e.birthday))||[];if(!e.length)return;const i=await W({calcProductFactorList:[{planCode:M.value.planCode,productCode:p.productInfo.productCode,riskEditVOList:[{insureProductRiskVO:null==(a=M.value.insureProductRiskVOList)?void 0:a[0]}]}],insuredVOList:e});ie(i)}})),{});const pe=async(e,a)=>{var i,t;if(a){const l=ce(e);delete l.insurancePeriodValueList,delete l.paymentFrequencyList,delete l.paymentPeriodValueList;if(ee.indexOf(a.key)>=0&&`${a.oldValue}`!=`${a.newValue}`){const s={};switch(a.key){case"annuityDrawDate":s.changeType=3;break;case"coveragePeriod":s.changeType=2;break;case"chargePeriod":s.changeType=1;break;case"paymentFrequency":s.changeType=4}const o=null==(t=null==(i=M.value)?void 0:i.insureProductRiskVOList)?void 0:t.find((a=>a.riskCode===e.riskCode));if(!j.isAutoChange){j.isQuerying=!0;const a=j.userData.insuredList.filter((e=>e.birthday))||[];if(!a.length)return!1;const i=await W({calcProductFactorList:[{planCode:M.value.planCode,productCode:p.productInfo.productCode,riskEditVOList:[{insureProductRiskVO:o,insureRiskEditReqVO:{riskId:e.riskId,riskCode:e.riskCode,...l,...s}}]}],insuredVOList:a});j.isQuerying=!1;const t=ie(i);return t||(j.isAutoChange=!0),t}j.isAutoChange=!1}}return!0},ve=async(e,a)=>{j.mainRiskVO=e;await pe(e,a)&&(j.riskList.length>0&&(j.riskList[0]=e),console.log("标准险种的信息回传",e),le())},me=async(e,a)=>{if(j.riskList=[j.mainRiskVO,...e],console.log("附加险列表数据回传",e),a){const i=e.find((e=>e.riskCode===a.riskCode));if(!(await pe(i,a)))return}le()},ke=e=>{var a,i,t,l;j.userData=e,j.defaultValue=e;const s=(null==(a=e.insuredList)?void 0:a[0].productList.findIndex((e=>e.planCode===M.value.planCode)))||0;j.planIndex=-1===s?0:s,j.riskList=(null==(l=null==(t=null==(i=null==e?void 0:e.insuredList)?void 0:i[0].productList)?void 0:t[j.planIndex])?void 0:l.riskList)||[],te(e,!0)},he=async e=>{var a;if(p.defaultData){const e=p.defaultData.find((e=>e.productCode===p.productInfo.productCode))||p.defaultData[0];ke(e),q(null==(a=p.defaultData)?void 0:a[0])}else U.value.push(M.value.planCode),await(async()=>{var e;const a=await X({calcProductFactorList:[{planCode:M.value.planCode,productCode:p.productInfo.productCode}]});if(a.data){const i=a.data.find((e=>e.productCode===p.productInfo.productCode))||a.data[0];ke(i),q(null==(e=a.data)?void 0:e[0])}})()},Le=async e=>{var a,i;const t=p.productInfo.planList.findIndex((a=>a.planCode===e)),l=(null==(i=null==(a=j.defaultValue)?void 0:a.insuredList)?void 0:i[0].productList.findIndex((a=>a.planCode===e)))||0,s=t>=0?p.productInfo.planList[t]:null;s&&(j.currentPlanCode=e,M.value=s,j.planIndex=l>=0?l:0,j.defaultValue.insuredList[0].productList[j.planIndex].riskList=j.riskList,U.value.findIndex((a=>a===e))<0&&U.value.push(e))};v((()=>{var e,a;j.select={},j.list=[],j.userData={},j.riskIsInsure={},j.submitData={},j.riskList=[{}],j.mainRiskVO={},j.ifPersonalInfoSuccess=!1,j.trialMsg="",j.trialResultPremium=0,j.riskIsInsure={},null==(a=null==(e=M.value)?void 0:e.insureProductRiskVOList)||a.forEach((e=>{var a;const i=null==(a=M.value.productRiskRelationVOList)?void 0:a.find((a=>a.collocationRiskId===e.riskId));i&&(j.riskIsInsure[e.riskCode]={selected:"2",data:null,relation:i})}))})),l((()=>{M.value=p.dataSource,j.loading=!0,j.show=!0,j.isAniShow=!0,j.isSkipFirstTrial=!0,j.hadSkipFirstTrial=!1,T((()=>{he()}))}));return t({getTrialSuccessFlag:()=>j.trialResultPremium>0,validate:()=>_.value.validate(!1),validateTrialFields:()=>_.value.validateTrialFields(),validateHolder:e=>{var a;return null==(a=_.value)?void 0:a.validateHolder(e)},getUserData:()=>({...j.userData}),onShare:e=>{var a;j.trialResultPremium&&(null==(a=m.value)||a.validate().then((()=>{Object.assign(E.value,p.defaultOrder,{extInfo:{...E.value.extInfo,buttonCode:ue.TRIAL_PREMIUM,pageCode:re.TRIAL_PREMIUM,templateId:g}});const a=de(p.productInfo,Y.value,E.value);ae(a,((a,i)=>{i===x.JUMP_PAGE&&(A.value.link=`${window.location.href}&isShare=1&orderNo=${a.orderNo}`,e())})),console.log("---- validate success ----")})))},onNext:()=>{var e;const{productCode:a,productName:i}=p.productInfo;V?F(re.TRIAL_PREMIUM,I.query):j.trialResultPremium&&(null==(e=m.value)||e.validate().then((()=>{Object.assign(E.value,p.defaultOrder,{extInfo:{templateId:g,...E.value.extInfo,...p.defaultOrder.extInfo||{},buttonCode:ue.TRIAL_PREMIUM,pageCode:re.TRIAL_PREMIUM}}),console.log("dealMixData()",Q());const e=de({...Q(),productCode:a,productName:i},j.trialResult,E.value);ae(e,((e,a)=>{a===x.JUMP_PAGE&&S(e.nextPageCode,{...I.query,orderNo:e.orderNo})})),console.log("---- validate success ----")})),j.loading=!1,j.show=!0,j.isAniShow=!0)},dealMixData:Q}),s((()=>j.riskIsInsure),(e=>{}),{deep:!0,immediate:!0}),s((()=>j.userData),(e=>{if(e){const{holder:a,insuredList:i}=e||{},t={holder:a,insuredList:i};Object.assign(j.submitData,t),d("update:userData",t)}}),{deep:!0}),s((()=>p.dataSource),(e=>{M.value=e}),{deep:!0,immediate:!0}),(e,a)=>{var i,t,l,s,d,p,v,I;const y=N;return o(),n("div",xe,[k(e.$slots,"trialHead",{},void 0,!0),L("div",Se,[r(ne,{labels:u(Fe)((null==(i=M.value)?void 0:i.insureProductRiskVOList)||[],M.value.productRiskRelationVOList)},null,8,["labels"]),L("div",Ne,[!e.hideBenefit&&(null==(t=Z.value)?void 0:t.benefitRiskResultVOList)?(o(),h(Ie,{key:0,class:"benefit-wrap","data-source":Z.value,"product-info":M.value,"show-type-list":Z.value.showTypList},null,8,["data-source","product-info","show-type-list"])):c("",!0),u(B)?(o(),h(Te,{key:1,"plan-list":e.productInfo.planList,"default-plan":M.value,onPlanChange:Le},null,8,["plan-list","default-plan"])):c("",!0),M.value.productFactor?(o(),h(u(fe),{ref_key:"personalInfoRef",ref:_,key:M.value.planCode,modelValue:u(j).userData,"onUpdate:modelValue":a[0]||(a[0]=e=>u(j).userData=e),"is-trial":e.isTrial,"product-factor":M.value.productFactor,"multi-insured-config":null==(l=M.value)?void 0:l.multiInsuredConfigVO,onTrailChange:se,onCloseCustomerPopoup:$},null,8,["modelValue","is-trial","product-factor","multi-insured-config"])):c("",!0)]),r(y,{size:"large"}),L("div",_e,[(o(),h(Ve,{ref_key:"insureInfosRef",ref:m,key:M.value.planCode,"origin-data":null==(s=M.value.insureProductRiskVOList)?void 0:s[0],"product-factor":M.value.productFactor,"default-value":u(j).defaultValue?null==(p=null==(d=u(j).defaultValue)?void 0:d.insuredList[0].productList[u(j).planIndex])?void 0:p.riskList[0]:null,"trial-result":u(j).trialResult,onTrialChange:ve},null,8,["origin-data","product-factor","default-value","trial-result"]))]),L("div",je,[M.value.insureProductRiskVOList?(o(),h(Oe,{key:M.value.planCode,"data-source":M.value,"show-main-risk":!1,"default-value":u(j).defaultValue?null==(I=null==(v=u(j).defaultValue)?void 0:v.insuredList[0].productList[u(j).planIndex])?void 0:I.riskList:[],onTrialChange:me},{holderForm:f((()=>{var i;return[e.isTrial&&e.dataSource.productFactor?(o(),h(u(fe),{key:0,ref_key:"personalInfoRef",ref:_,modelValue:u(j).userData,"onUpdate:modelValue":a[1]||(a[1]=e=>u(j).userData=e),"is-trial":e.isTrial,"is-only-holder":!0,"product-factor":e.dataSource.productFactor,"multi-insured-config":null==(i=e.dataSource)?void 0:i.multiInsuredConfigVO,onTrailChange:se},null,8,["modelValue","is-trial","product-factor","multi-insured-config"])):c("",!0)]})),_:1},8,["data-source","default-value"])):c("",!0)]),Ee]),k(e.$slots,"trialBtn",{trialData:u(j).submitData,riskPremium:u(j).trialResult,loading:u(j).isQuerying,personalInfoRef:_.value},void 0,!0)])}}}),[["__scopeId","data-v-48af32c8"]]);const Ue={class:"long-info-collection"},qe=e({__name:"infoCollection",setup(e){const t=E((()=>A((()=>import("./index-2032c629.js")),["static/js/index-2032c629.js","static/css/index-fa4edf2a.css","static/js/index-8ccea0ec.js","static/css/index-f1c5cfcb.css","static/js/theme-94cf7d00.js","static/js/index-26608712.js","static/css/index-bbfdd7ec.css","static/js/utils-f86c0766.js","static/js/infoCollection-86362f87.js","static/js/trial-c0526383.js"]))),l=E((()=>A((()=>import("./index-06abc937.js")),["static/js/index-06abc937.js","static/css/index-bf024e9b.css","static/js/index-8ccea0ec.js","static/css/index-f1c5cfcb.css"]))),s=C(),d=oe(),{productCode:p="",tenantId:m,agentCode:k="",agencyCode:I,saleChannelId:y,isShare:g,orderNo:L,extraInfo:V,insurerCode:R,preview:O}=s.query;let b={};try{b=JSON.parse(decodeURIComponent(V))}catch(we){}const T=i({isView:!1,personalInfo:{},payInfo:{schema:[],config:[],formData:[]},defaultValue:null,isAutoChange:!1,defaultPlanCode:"",userData:{}}),w=`${window.origin}/baseInsurance/long/phoneVerify${window.location.search}`,N=a({imgUrl:"",desc:"",title:"",link:w}),_=a();a();const j=a(),G=a({}),J=a({}),z=a([]),W=a(),X=a({}),ne=a(!1),ce=a(!1),pe=a(0),ve=a(!0),{fileList:me,mustReadFileCount:fe,popupFileList:ke}=ie(X,W),Ie=a(!1),ye=a(!1),ge=()=>{ce.value=!1,ve.value=!0,z.value.length<1||(ne.value=!0)},he=()=>{ne.value=!1,ce.value=!1,ve.value=!0};a({}),a(!1),a([{}]);const Le=a(""),Ve=a(0),Ce=a(!1);a(),a(),a(),P((()=>{var e,a;const{insureProductRiskVOList:i}=(null==(a=null==(e=J.value)?void 0:e.productPlanInsureVOList)?void 0:a[0])||{};return(i||[]).find((e=>e.mainRiskFlag===M.YES))}));const Re=a(0);a({});const Pe=a(),Oe=()=>{Le.value="试算中...",Ve.value=0,Ce.value=!0},be=(e,a)=>{Le.value="",Re.value=e.premium,Ve.value=e,Pe.value=a,Ce.value=!1},De=async()=>{var e,a;if(O)return void F(re.INFO_COLLECTION,s.query);if(!Ve.value)return;const i=[];j.value&&i.push(null==(e=j.value)?void 0:e.validate(!1)),_.value&&i.push(null==(a=_.value)?void 0:a.validate(!1)),Promise.all(i).then((()=>{if(!Ie.value)return void D("请勾选投保人阅读并接受");Object.assign(d.value,{extInfo:{...d.value.extInfo,buttonCode:ue.INFO_COLLECTION,pageCode:re.INFO_COLLECTION}});const e=j.value.dealMixData(),a=de({...e,productCode:p,productName:J.value.productName},Ve.value,d.value);ae(a,((e,a)=>{a===x.JUMP_PAGE&&S(e.nextPageCode,s.query)}))}))};i({tenantOrderPayInfoList:[]});const Te=async()=>{te({productCode:p,tenantId:m}).then((({data:e,code:a})=>{if("10000"===a){G.value=e;const{wxShareConfig:a,showWXShare:i,title:t,desc:l,image:s}=(null==e?void 0:e.PRODUCT_LIST)||{};i?Object.assign(N.value,{...a,imgUrl:a.image,isShare:i}):Object.assign(N.value,{title:t,desc:l,imgUrl:s,isShare:i}),e.BASIC_INFO&&e.BASIC_INFO.themeType&&B(e.BASIC_INFO.themeType)}})),L&&await Y({orderNo:L,tenantId:m}).then((({code:e,data:a})=>{var i;if("10000"===e){if(Ve.value=a.orderAmount,(null==(i=a.insuredList)?void 0:i.length)>0){const{planCode:e}=a.insuredList[0];T.defaultPlanCode=e}Object.assign(d.value,a,{tenantOrderPayInfoList:a.tenantOrderPayInfoList||[],operateOption:{withBeneficiaryInfo:!0,withHolderInfo:!0,withInsuredInfo:!0,withAttachmentInfo:!0,withProductInfo:!0,withPayInfo:!0},productCode:p}),T.defaultValue=d.value,ye.value=!0}})),le({productCode:p}).then((({code:e,data:a})=>{var i,t,l,s;if("10000"===e){const{productMaterialPlanVOList:e,productQuestionnaireVOList:o}=a;W.value=e||[];const{basicInfo:{questionnaireType:n},questions:r,questionnaireName:u}=(null==(i=null==o?void 0:o[0])?void 0:i.questionnaireDetailResponseVO)||{basicInfo:{}};n&&(z.value=2===n?[{attachmentName:u,attachmentUri:r,attachmentType:"question"}]:[{attachmentName:u,attachmentUri:null==(t=null==r?void 0:r[0])?void 0:t.content,attachmentType:se(String(null==(l=null==r?void 0:r[0])?void 0:l.textType),null==(s=null==r?void 0:r[0])?void 0:s.content)}])}})),await Z({productCode:p,isTenant:!O}).then((({data:e,code:a})=>{var i;if("10000"===a){J.value=e,X.value=e.productPlanInsureVOList.find((e=>!T.defaultPlanCode||e.planCode===T.defaultPlanCode))||{};const{payInfo:a}=K(null==(i=X.value)?void 0:i.productFactor);T.payInfo={...T.payInfo,...a}}}))};return v((()=>{Te()})),(e,a)=>{var i,s,v,k,I,y;const L=$,V=H;return o(),n("div",Ue,[r(L),u(ye)||u(O)?(o(),h(Me,{key:0,ref_key:"personalInfoRef",ref:j,"data-source":u(X),"product-info":{productCode:u(p),productName:u(J).productName,insurerCode:u(R),tenantId:u(m),planList:u(J).productPlanInsureVOList},"tenant-product-detail":u(G),"hide-benefit":"","default-data":[u(T).defaultValue],onTrialStart:Oe,onTrialEnd:be,"onUpdate:userData":a[0]||(a[0]=e=>u(T).userData=e)},null,8,["data-source","product-info","tenant-product-detail","default-data"])):c("",!0),u(T).payInfo.schema.length?(o(),h(u(Q),{key:1,ref_key:"payInfoRef",ref:_,modelValue:u(d).tenantOrderPayInfoList,"onUpdate:modelValue":a[1]||(a[1]=e=>u(d).tenantOrderPayInfoList=e),schema:u(T).payInfo.schema,"is-view":u(T).isView,"user-data":u(T).userData},null,8,["modelValue","schema","is-view","user-data"])):c("",!0),r(V,null,{default:f((()=>{var e;return[(null==(e=u(me))?void 0:e.length)?(o(),h(u(l),{key:0,modelValue:u(Ie),"onUpdate:modelValue":a[2]||(a[2]=e=>U(Ie)?Ie.value=e:null),"has-bg-color":!1,"attachment-list":u(me),"is-show-radio":"","pre-text":"投保人阅读并接受",onPreviewFile:a[3]||(a[3]=e=>(e=>{pe.value=e,ce.value=!0})(e))},null,8,["modelValue","attachment-list"])):c("",!0)]})),_:1}),u(ce)?(o(),h(u(t),{key:2,show:u(ce),"onUpdate:show":a[4]||(a[4]=e=>U(ce)?ce.value=e:null),"content-list":u(ve)?u(me):u(ke),"is-only-view":u(ve),"active-index":u(pe),text:u(ve)?"关闭":"我已逐页阅读并确认告知内容","force-read-count":u(ve)?0:u(fe),onSubmit:ge,onOnCloseFilePreviewByMask:he},null,8,["show","content-list","is-only-view","active-index","text","force-read-count"])):c("",!0),r(ee,{"is-share":u(N).isShare&&!u(g),premium:null==(i=u(Ve))?void 0:i.initialPremium,"share-info":u(N),"loading-text":u(Le),"payment-frequency":(null==(y=null==(I=null==(k=null==(v=null==(s=u(Pe))?void 0:s.insuredList)?void 0:v[0].productList)?void 0:k[0].riskList)?void 0:I[0])?void 0:y.paymentFrequency)+"","tenant-product-detail":u(G),"handle-share":e=>(e=>{j.value.validateHolder(["mobile"]).then((()=>{Object.assign(d.value,{extInfo:{...d.value.extInfo,buttonCode:ue.INFO_COLLECTION,pageCode:re.INFO_COLLECTION}});const a=j.value.getUserData(),i=de({...Pe.value,holder:null==a?void 0:a.holder},Ve.value||{},d.value);ae(i,((a,i)=>{i===x.JUMP_PAGE&&(null==e||e())}))})).catch((()=>{D("请录入投保人手机号后进行分享")}))})(e),disabled:!u(Ve),onHandleClick:De},{default:f((()=>[q("下一步")])),_:1},8,["is-share","premium","share-info","loading-text","payment-frequency","tenant-product-detail","handle-share","disabled"])])}}});export{qe as default};
