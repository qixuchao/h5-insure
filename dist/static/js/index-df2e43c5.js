import{_ as e,d as i,j as t,i as a,h as s,r,k as l,aI as u,aJ as d,T as o,E as n,aG as c,l as p,aK as v,o as f,c as k,g as m,a as L,b as y,u as h,p as R,f as C,F as g,s as I,aL as D,aM as P,w as b,e as O,v as V,aN as T,aO as j,aP as S,aQ as M,ah as E,aR as _,aS as F,aT as A,aU as N,aC as w,aD as x}from"./index-308a6130.js";import{c as $}from"./cloneDeep-e32c65b9.js";import{_ as K}from"./InsureInfos-e7463d7b.js";import{P as q}from"./index-f5d944d5.js";import{P as U,R as B,a as Q}from"./trial-34e9a059.js";import{_ as J}from"./PolicyInfo-78dfde71.js";import{u as G,c as H,p as Y,d as z,e as W,q as X}from"./trial-25629e93.js";import{P as Z,B as ee,a as ie}from"./constants-6ad2f07c.js";import{u as te}from"./useOrder-c150b01d.js";import{t as ae}from"./utils-3316dbce.js";import{n as se}from"./nextStep-90a89e2b.js";import{t as re}from"./format-31cde443.js";import"./index-421c0cf9.js";import"./infoCollection-e3913a49.js";import"./product-7bbf9c44.js";import"./questionnaire-42dcb602.js";import"./util-c8d82ba5.js";import"./createProposal-e19c686a.js";import"./core-fd6cee84.js";const le=(e,i)=>{const t=[],a={};return null==e||e.forEach((e=>{a[e.riskId]=e})),null==i||i.forEach((e=>{var i,s,r,l;const{collocationType:u,collocationRiskId:d,riskId:o}=e;switch(u){case 2:{const e=null==(i=a[o])?void 0:i.riskName,r=null==(s=a[d])?void 0:s.riskName;t.push(`${e} 和 ${r} 必须同时投保`);break}case 3:{const e=null==(r=a[o])?void 0:r.riskName,i=null==(l=a[d])?void 0:l.riskName;t.push(`${e} 和 ${i} 不能同时投保`);break}}})),t};const ue=e=>(w("data-v-219f4853"),e=e(),x(),e),de={class:"com-body"},oe={class:"trial-body"},ne={class:"container"},ce={class:"container"},pe={key:0,class:"product-list"},ve={key:0,class:"operate-bar"},fe=["onClick"],ke=["onClick"],me={class:"premium-item"},Le=ue((()=>L("span",{class:"label"},"首期保费",-1))),ye={class:"price"},he={key:1,class:"add-main-risk"},Re=ue((()=>L("div",{class:"empty"},null,-1))),Ce=i({name:"TrialBodyLian"});var ge=e(i({...Ce,props:{selfKey:{default:""},dataSource:{default:()=>[]},productInfo:{default:()=>({productCode:"",productName:"",insurerCode:"",tenantId:"",planList:[]})},tenantProductDetail:{default:()=>({})},hideBenefit:{type:Boolean,default:!1},hidePopupButton:{type:Boolean,default:!1},title:{default:"算一算保费"},defaultData:{default:null},isTrial:{type:Boolean,default:!1},defaultOrder:{default:()=>({})},productCollection:{default:()=>({})},productFactor:{default:()=>({})},productRiskCodeMap:{default:()=>({})},updateRiskCode:{default:""}},emits:["trialStart","trialEnd","update:userData","closeCustomerPopoup","addRisk","addMainRisk","deleteRisk","update-bank"],setup(e,{expose:i,emit:w}){const x=e,ue=t(null),Ce=a();s();const{tenantId:ge,templateId:Ie,preview:De}=Ce.query,Pe=t(),be=r({loading:!1,show:!1,select:{},list:[],userData:{},riskIsInsure:{},submitData:{},riskList:{},mainRiskVO:{},ifPersonalInfoSuccess:!1,trialMsg:"",trialResultPremium:0,trialResult:{initialPremium:0,initialAmount:0},isAniShow:!1,defaultValue:null,isAutoChange:!1,planIndex:0,isSkipFirstTrial:!1,hadSkipFirstTrial:!1,isQuerying:!1,currentPlanCode:""}),Oe=te();t();const Ve=t(),Te=t(x.dataSource),je=t([]),Se=t(),Me=t(),Ee=t({}),_e=l((()=>{var e;let i=!1;return((null==(e=x.productRiskCodeMap)?void 0:e.productList)||[]).forEach((e=>{e.mergeRiskReqList.find((e=>1===e.exemptType))&&(i=!0)})),i})),Fe=t({}),Ae=u((async(e,i=!0)=>{be.trialMsg="试算中...",be.trialResultPremium=0,be.loading=!0,w("trialStart");let t=!1;if(i){const{code:i}=await G(e);t="10000"===i}!t&&i||(be.isQuerying=!0,x.hideBenefit||H(e).then((e=>{e.data&&e.code===d&&(Fe.value=e.data)})).finally((()=>{be.loading=!1})),Y(e).then((({code:i,data:t})=>{var a,s;t&&i===d?((null==t?void 0:t.errorInfo)&&o(`${null==t?void 0:t.errorInfo}`),be.trialMsg="",be.trialResultPremium=t.initialPremium,be.trialResult=t,null==(s=null==(a=t.insuredPremiumList)?void 0:a[0])||s.productPremiumList.forEach((e=>{Ee.value[e.productCode]=e.riskPremiumDetailVOList})),w("trialEnd",t,e)):(be.trialResultPremium=null,be.trialResult={},Ee.value={})})).finally((()=>{be.loading=!1,be.isQuerying=!1})))}),500),Ne=l((()=>{var e,i;return![U.SINGLE_PRODUCT,U.TWO_PRODUCT].includes(null==(i=null==(e=Object.values(x.productCollection))?void 0:e[0])?void 0:i.productClass)})),we=()=>{w("addMainRisk",be.userData.insuredList)},xe=e=>{const{holder:i,insuredList:t}=e||{};i&&(be.submitData.holder=i),t&&t.length>0&&t.forEach(((e,i)=>{var t;be.submitData.insuredList&&be.submitData.insuredList.length>i?be.submitData.insuredList[i]=e:((null==(t=be.submitData)?void 0:t.insuredList)||(be.submitData.insuredList=[]),be.submitData.insuredList.push(e))}))},$e=l((()=>x.productInfo.planList&&x.productInfo.planList.length>2)),Ke=(e,i)=>{if(e){const t=["birthday","age","gender","id"];i.includes("occupationCodeList")&&t.push("occupationClass"),Object.keys(e).forEach((a=>{[...i,...t].includes(a)||(e[a]=null)}))}},qe=(e,i=(e=>!0))=>j(e)?e.filter(i).map((e=>e.code)):[],Ue=()=>{console.log("--current plan = ",Te.value),console.log("---current submit = ",be.submitData);const e=$(be.submitData);if(!$e.value)return e;const{1:i,2:t,3:a}=Te.value.productFactor||{};if(e.holder&&Ke(e.holder,qe(i)),e.insuredList){const i=["productList","beneficiaryList"],s=qe(t,(e=>"2"!==String(e.subModuleType))),r=qe(t,(e=>"2"===String(e.subModuleType))),l=j(r),u=qe(a),d=j(u);e.insuredList.forEach(((e,t)=>{var a,o,n;Ke(e,[...t>=1&&l?r:s,...i,...d?["insuredBeneficiaryType"]:[]]),(null==(a=e.beneficiaryList)?void 0:a.length)>0&&(d?e.beneficiaryList.forEach((e=>Ke(e,u))):e.beneficiaryList.length=0),e.planCode=Te.value.planCode;const c=(null==(n=null==(o=e.productList)?void 0:o[0])?void 0:n.riskList)||[],p=Te.value.insureProductRiskVOList||[];if(c.length&&p){const i=c.filter((e=>null!==p.find((i=>i.riskCode===e.riskCode))));e.productList[0].riskList=i}}))}return e},Be=["annuityDrawDate","coveragePeriod","chargePeriod","paymentFrequency"],Qe=()=>{var e,i,t,a,s,r,l;if(!(null==(e=Object.keys(Me.value))?void 0:e.length)||be.ifPersonalInfoSuccess||(null==(t=null==(i=Pe.value)?void 0:i.canTrail)?void 0:t.call(i))){be.submitData.tenantId=`${ge}`,(null==(a=be.submitData.insuredList)?void 0:a.length)&&(be.submitData.insuredList=null==(s=be.submitData)?void 0:s.insuredList.map((e=>({...e,productList:((null==e?void 0:e.productList)||[]).map((e=>({...e,riskList:be.riskList[e.productCode]})))}))));const e=Ue();console.log(">>>数据构建<<<",e),(null==(l=null==(r=e.insuredList[0])?void 0:r.productList)?void 0:l.length)&&Ae(e)}},Je=async e=>{var i,t,a;console.log("人的信息更改了"),xe(e),be.ifPersonalInfoSuccess=!0,console.log("处理第一被保人修改的dy变化"),(null==(a=null==(t=null==(i=be.userData.insuredList)?void 0:i[0])?void 0:t.productList)?void 0:a.length)&&Qe()};l((()=>{var e;return((null==(e=be.userData)?void 0:e.insuredList)||[]).map((e=>e.birthday)).join(",")})),n([()=>{var e;return((null==(e=be.userData)?void 0:e.insuredList)||[]).map((e=>e.birthday)).join(",")},()=>Se.value],(async([e])=>{if(e){const e=be.userData.insuredList.filter((e=>e.birthday))||[];if(!e.length)return;const i=Object.keys(Se.value).map((e=>({productCode:e,planCode:"",riskEditVOList:Se.value[e].productPlanInsureVOList[0].insureProductRiskVOList.map((e=>({insureProductRiskVO:e})))})));await z({calcProductFactorList:i,insuredVOList:e,holderVO:be.userData.holder})}}),{});const Ge=async(e,i,t)=>{if(i){const a=$(e);delete a.insurancePeriodValueList,delete a.paymentFrequencyList,delete a.paymentPeriodValueList;if(Be.indexOf(i.key)>=0&&`${i.oldValue}`!=`${i.newValue}`){const s={};switch(i.key){case"annuityDrawDate":s.changeType=3;break;case"coveragePeriod":s.changeType=2;break;case"chargePeriod":s.changeType=1;break;case"paymentFrequency":s.changeType=4}const r=((e,i,t)=>{var a,s;let r=null,l=null,u=null,d=null;if(t===B.RIDER_RISK){const t=null==(a=Se.value[e].productPlanInsureVOList)?void 0:a[0].insureProductRiskVOList.find((e=>e.riskCode===i)),{mainRiskCode:s,productRiskInsureLimitVO:o}=t,{paymentPeriodRule:n,paymentTypeRule:c,insurancePeriodRule:p}=o||{};r=n,l=c,u=p,d=s}return null==(s=Se.value[e].productPlanInsureVOList)?void 0:s[0].insureProductRiskVOList.filter((e=>{if(t===B.MAIN_RISK){const{paymentPeriodRule:i,paymentTypeRule:t,insurancePeriodRule:a}=e.productRiskInsureLimitVO||{};r=i,l=t,u=a}return!(t!==B.MAIN_RISK||e.mainRiskCode!==i||![r,l,u].includes(Q.MAIN_RISK_SAME)&&![r,l,u].includes(Q.MAIN_RISK_1))||!(t===B.MAIN_RISK||e.riskCode!==i&&e.riskCode!==d||![r,l,u].includes(Q.MAIN_RISK_SAME)&&![r,l,u].includes(Q.MAIN_RISK_1))||e.riskCode===i}))})(t,e.riskCode,e.riskType).flat(),l=(r||[]).map((i=>i.riskCode!==e.riskCode?{insureProductRiskVO:i,insureRiskEditReqVO:null}:{insureProductRiskVO:i,insureRiskEditReqVO:{riskId:e.riskId,riskCode:e.riskCode,...a,...s}}));be.isQuerying=!0;const u=be.userData.insuredList.filter((e=>e.age||e.birthday))||[];if(!u.length)return!1;const d=await z({calcProductFactorList:[{planCode:Te.value.planCode,productCode:t,riskEditVOList:l}],insuredVOList:u,holderVO:be.userData.holder});be.isQuerying=!1;const n=((e,i)=>{var t,a,s,r,l,u,d,n,c,p;const v=$(e);if(null==(a=null==(t=null==v?void 0:v.data)?void 0:t[0])?void 0:a.productRiskDyInsureFactorVOList){const e=[];if(null==(l=null==(r=null==(s=Se.value[i])?void 0:s.productPlanInsureVOList)?void 0:r[0])||l.insureProductRiskVOList.forEach((t=>{var a,s,r,l,u;const d=null==(s=null==(a=null==v?void 0:v.data)?void 0:a[0])?void 0:s.productRiskDyInsureFactorVOList.find((e=>e.riskCode===t.riskCode));if(t.exemptFlag===E.YES&&(d.chargePeriod=null==(r=d.paymentPeriodValueList)?void 0:r[0].code,d.coveragePeriod=null==(l=d.insurancePeriodValueList)?void 0:l[0].code,d.paymentFrequency=null==(u=d.paymentFrequencyList)?void 0:u[0].code),d){t.productRiskInsureLimitVO={...t.productRiskInsureLimitVO,...d};const a=be.riskList[i].find((e=>e.riskCode===t.riskCode));ie.forEach((e=>{var i;if(Be.indexOf(e.valueKey)>=0){const s=t.productRiskInsureLimitVO[null==(i=e.configKey)?void 0:i[0]];if(s&&a){const i=s.find((i=>i.code===a[e.valueKey]));if(i&&2===i.useFlag){const i=s.find((e=>1===e.defaultFlag));a[e.valueKey]=i.code}}}})),e.push({...a,...d,riskCode:t.riskCode})}})),e.length>0&&(null==(n=null==(d=null==(u=be.defaultValue)?void 0:u.insuredList)?void 0:d[0])?void 0:n.productList))return e.forEach((e=>{var i,t,a;null==(a=null==(t=null==(i=be.defaultValue)?void 0:i.insuredList)?void 0:t[0])||a.productList.map((i=>(i.riskList=null==i?void 0:i.riskList.map((i=>i.riskCode===e.riskCode?e:i)),i)))})),!1}return o(null==(p=null==(c=null==v?void 0:v.data)?void 0:c[0])?void 0:p.errorMessage),!0})(d,t);return n||(be.isAutoChange=!0),n}}return!0},He=e=>{be.userData=e,be.defaultValue=e},Ye=async e=>{x.defaultData?(He(x.defaultData),xe(x.defaultData)):(je.value.push(Te.value.planCode),await(async()=>{var e;const i=await X({calcProductFactorList:[{productCode:null==(e=Object.keys(x.productCollection))?void 0:e[0]}]});if(i.data){const{holder:e,insuredList:t}=i.data,a={holder:v(e),insuredList:t.map((e=>({...v(e),productList:e.productList})))};He(a),xe(a)}})())};c((()=>{var e,i;be.riskIsInsure={},null==(i=null==(e=Te.value)?void 0:e.insureProductRiskVOList)||i.forEach((e=>{var i;const t=null==(i=Te.value.productRiskRelationVOList)?void 0:i.find((i=>i.collocationRiskId===e.riskId));t&&(be.riskIsInsure[e.riskCode]={selected:"2",data:null,relation:t})}))})),p((()=>{Te.value=x.dataSource,be.loading=!0,be.show=!0,be.isAniShow=!0,be.isSkipFirstTrial=!0,be.hadSkipFirstTrial=!1}));return i({getTrialSuccessFlag:()=>be.trialResultPremium>0,getRiderRiskDefaultValue:async(e,i,t,a)=>{var s,r,l;const u=be.riskList[e].find((e=>e.riskCode===t)),{code:d,data:o}=await W({holder:be.userData.holder,insuredList:be.userData.insuredList,calcRiskDefaultFactorVO:{mainRiskInfo:u,riskCodeList:i}});if("10000"===d){let t=0;t=a.findIndex(((e,t)=>e.riskCode===i[0])),be.defaultValue.insuredList[0].productList=null==(l=null==(r=null==(s=be.defaultValue)?void 0:s.insuredList)?void 0:r[0])?void 0:l.productList.map((i=>(e===i.productCode&&(i.riskList=[...i.riskList.slice(0,t),...o,...i.riskList.slice(t,i.riskList.length)]),i)))}},getProductDefaultValue:async e=>{const{code:i,data:t}=await X({calcProductFactorList:e.map((e=>({productCode:e}))),holderVO:be.userData.holder,insuredVOList:be.userData.insuredList});"10000"===i&&(be.defaultValue.insuredList[0].productList=t.insuredList[0].productList,Object.assign(be.userData,t))},validate:()=>Pe.value.validate(!1),validateTrialFields:()=>Pe.value.validateTrialFields(),validateHolder:e=>{var i;return null==(i=Pe.value)?void 0:i.validateHolder(e)},getUserData:()=>({...be.userData}),onShare:e=>{var i;be.trialResultPremium&&(null==(i=ue.value)||i.validate().then((()=>{Object.assign(Oe.value,x.defaultOrder,{extInfo:{...Oe.value.extInfo,buttonCode:ee.TRIAL_PREMIUM,pageCode:Z.TRIAL_PREMIUM,templateId:Ie}});const i=ae(x.productInfo,be.trialResult,Oe.value);se(i,((i,t)=>{t===M.JUMP_PAGE&&(Ve.value.link=`${window.location.href}&isShare=1&orderNo=${i.orderNo}`,e())})),console.log("---- validate success ----")})))},onNext:e=>{var i,t;const{productCode:a,productName:s}=x.productInfo;if(De)return void S(Z.TRIAL_PREMIUM,Ce.query);Object.assign(Oe.value,x.defaultOrder,{extInfo:{templateId:Ie,...null==(i=Oe.value)?void 0:i.extInfo,...(null==(t=x.defaultOrder)?void 0:t.extInfo)||{},buttonCode:ee.TRIAL_PREMIUM,pageCode:Z.TRIAL_PREMIUM}});const r=ae({...Ue(),productCode:a,productName:s},be.trialResult,Oe.value);null==e||e(r)},dealMixData:Ue}),n((()=>be.userData),(e=>{if(e){const{holder:i,insuredList:t}=e||{},a={holder:i,insuredList:t};Object.assign(be.submitData,a),w("update:userData",a)}}),{immediate:!0,deep:!0}),n((()=>x.dataSource),(e=>{Te.value=e}),{deep:!0,immediate:!0}),n((()=>x.productCollection),((e,i)=>{Object.keys(e||{}).length&&!be.defaultValue&&Ye(),Se.value=e,Object.keys(e||[]).forEach((i=>{var t,a,s;be.riskList[i]=((null==(s=null==(a=null==(t=null==e?void 0:e[i])?void 0:t.productPlanInsureVOList)?void 0:a[0])?void 0:s.insureProductRiskVOList)||[]).map((e=>(be.riskList[i]||[]).find((i=>i.riskCode===e.riskCode))||e))}))}),{deep:!0,immediate:!0}),n((()=>x.productFactor),((e,i)=>{Me.value=e,!Object.keys(e).length&&be.userData.holder&&x.isTrial&&(Object.assign(be.userData.holder,v(be.userData.holder)),Object.assign(be.userData.insuredList[0],v(be.userData.insuredList[0])))}),{deep:!0,immediate:!0}),n((()=>x.defaultData),((e,i)=>{JSON.stringify($(e))!==JSON.stringify($(i))&&(be.defaultValue=e,be.userData=e||{},e&&(Oe.value=e||{}))}),{deep:!0,immediate:!0}),(e,i)=>{var t,a,s;const r=_,l=F,u=A,d=N;return f(),k("div",de,[m(e.$slots,"trialHead",{},void 0,!0),L("div",oe,[y(J,{labels:h(le)((null==(t=Te.value)?void 0:t.insureProductRiskVOList)||[],Te.value.productRiskRelationVOList)},null,8,["labels"]),L("div",ne,[(null==(a=Object.keys(Me.value))?void 0:a.length)?(f(),R(q,{ref_key:"personalInfoRef",ref:Pe,key:Te.value.planCode,modelValue:h(be).userData,"onUpdate:modelValue":i[0]||(i[0]=e=>h(be).userData=e),"is-holder-exempt":h(_e),"is-trial":e.isTrial,"product-factor":Me.value,"multi-insured-config":null==(s=Te.value)?void 0:s.multiInsuredConfigVO,onTrailChange:Je,onUpdateBank:i[1]||(i[1]=i=>e.$emit("update-bank",i))},null,8,["modelValue","is-holder-exempt","is-trial","product-factor","multi-insured-config"])):C("",!0)]),m(e.$slots,"middleInfo",{},void 0,!0),y(r,{size:"large"}),L("div",ce,[y(l,{title:"保障计划",class:"insurePlan","show-divider":!1}),Object.keys(Se.value).length?(f(),k("div",pe,[(f(!0),k(g,null,I(Object.keys(Se.value),((i,t)=>(f(),k("div",{key:i,class:"product-item"},[(f(!0),k(g,null,I(Se.value[i].productPlanInsureVOList[0].insureProductRiskVOList||[],((a,s)=>{var r,l,d,o,n,c,p,v,m,R,g,I;return D((f(),k("div",{key:`${i}-${a.riskCode}`,class:"risk-item"},[y(u,{title:a.riskName,"risk-type":a.riskType},{default:b((()=>[e.isTrial?(f(),k("div",ve,[a.riskType===h(B).MAIN_RISK?(f(),k("div",{key:0,class:"add-risk btn",onClick:e=>((e,i)=>{const t=be.riskList[e].find((e=>e.riskCode===i));w("addRisk",e,t,be.userData.insuredList)})(i,a.riskCode)}," +附加险 ",8,fe)):C("",!0),L("div",{class:"delete-risk btn",onClick:e=>((e,i,t)=>{T.confirm({message:"删除后将无法恢复，是否需要删除该产品？"}).then((()=>{var a,s;i?(be.defaultValue.insuredList[0].productList=be.defaultValue.insuredList[0].productList.map((i=>(i.productCode===e&&(i.riskList=i.riskList.filter((e=>e.riskCode!==t))),i))),be.userData.insuredList[0].productList=be.userData.insuredList[0].productList.map((i=>(i.productCode===e&&(i.riskList=i.riskList.filter((e=>e.riskCode!==t))),i)))):(be.defaultValue.insuredList[0].productList=be.defaultValue.insuredList[0].productList.filter((i=>i.productCode!==e)),be.userData.insuredList[0].productList=be.userData.insuredList[0].productList.filter((i=>i.productCode!==e))),(null==(s=null==(a=be.userData.insuredList[0])?void 0:a.productList)?void 0:s.length)?Ae(be.userData):be.trialResult={initialPremium:0,initialAmount:0},w("deleteRisk",e,t,i)}))})(i,a.mainRiskCode,a.riskCode)}," 删除 ",8,ke)])):C("",!0)])),_:2},1032,["title","risk-type"]),y(K,{ref_for:!0,ref_key:"insureInfosRef",ref:ue,"origin-data":a,"product-factor":Te.value.productFactor,"default-value":h(be).defaultValue?null==(c=null==(n=null==(o=null==(d=null==(l=null==(r=h(be).defaultValue)?void 0:r.insuredList)?void 0:l[0])?void 0:d.productList)?void 0:o[t])?void 0:n.riskList)?void 0:c[s]:null,"trial-result":null==(m=null==(v=null==(p=Ee.value)?void 0:p[i])?void 0:v[s])?void 0:m.initialAmount,onTrialChange:(e,t)=>(async(e,i,t)=>{var a,s,r;if((null==(s=null==(a=be.riskList)?void 0:a[t])?void 0:s.find((i=>i.riskCode===e.riskCode)))?be.riskList[t]=be.riskList[t].map((i=>i.riskCode===e.riskCode?e:i)):(null==(r=be.riskList[t])?void 0:r.length)?be.riskList[t].push(e):be.riskList[t]=[e],e.exemptFlag!==E.YES&&!(await Ge(e,i,t)))return;console.log("标准险种的信息回传",e),Qe()})(e,t,i)},null,8,["origin-data","product-factor","default-value","trial-result","onTrialChange"]),L("div",me,[Le,L("span",ye,O(h(re)(null==(I=null==(g=null==(R=Ee.value)?void 0:R[i])?void 0:g[s])?void 0:I.initialPremium)),1)])])),[[P,!e.updateRiskCode||a.riskCode===e.updateRiskCode]])})),128))])))),128))])):C("",!0),h(Ne)&&e.isTrial?(f(),k("div",he,[y(d,{activated:"",onClick:we},{default:b((()=>[V("+新增主险")])),_:1})])):C("",!0)]),Re]),m(e.$slots,"trialBtn",{trialData:h(be).submitData,riskPremium:h(be).trialResult,loading:h(be).isQuerying,personalInfoRef:Pe.value},void 0,!0)])}}}),[["__scopeId","data-v-219f4853"]]);export{ge as default};
