<template>
  <div v-if="loading">__SKELETON_SHORT_CONTENT__</div>
  <van-config-provider v-else data-skeleton-root="SHORT" :theme-vars="themeVars">
    <div class="page-internet-product-detail">
      <div class="info">
        <Banner
          v-if="tenantProductDetail?.BASIC_INFO?.banner.length"
          data-skeleton-type="img"
          :url="tenantProductDetail?.BASIC_INFO.banner[0]"
        />
        <Banner
          v-if="tenantProductDetail?.BASIC_INFO?.bannerMove?.length"
          :url="tenantProductDetail?.BASIC_INFO?.bannerMove?.[0]"
          @click="onClickToInsure"
        />
        <div ref="observeRef"></div>
      </div>
      <!-- <Guarantee
        show-service-config
        :data-source="tenantProductDetail"
        :plan-list="planList"
        :active-plan-code="guaranteeObj.planCode"
        :payment-frequency="guaranteeObj.paymentFrequency"
        :premium-info="{ premium, premiumLoadingText }"
      /> -->
      <ScrollInfo ref="tenantProductDetailScrollRef" :data-source="tenantProductDetail">
        <template #form>
          <div class="custom-page-form">
            <div class="form-title">请填写投保信息</div>
            <ProRenderFormWithCard
              ref="holderFormRef"
              title="本人信息（投保人）"
              :model="state.holder.formData"
              :schema="state.holder.schema"
              :config="state.holder.config"
            />
            <!-- <ProDatePickerV2 label="日期" />
            </ProRenderFormWithCard> -->

            <!-- 被保人 -->
            <ProRenderFormWithCard
              v-for="(insured, index) in state.insuredList"
              ref="insuredFormRef"
              :key="index"
              title="为谁投保（被保人）"
              :model="state.insuredList[index].formData"
              :schema="insured.schema"
              :config="insured.config"
            />
            <!-- <ProRenderFormWithCard
              ref="insuredFormRef"
              title="为谁投保（被保人）"
              :model="state.insuredList[0].formData"
              :schema="state.insuredList[0].schema"
              :config="state.insuredList[0].config"
            /> -->
            <!-- <InsureForm
              v-if="insureProductDetail"
              ref="formRef"
              :title-collection="{
                HOLDER: '本人信息（投保人）',
                INSURER: '为谁投保（被保人）',
              }"
              :form-info="orderDetail"
              :need-desensitize="needDesensitize"
              :send-sms-code="sendSmsCode"
              :factor-object="factorObj || {}"
            >
              <template v-if="relationCustomerList.length > 1" #holderName>
                <CustomerList
                  :user-info="orderDetail.tenantOrderHolder"
                  :data="relationCustomerList"
                  @change="onUpdateHolderData"
                />
              </template>
              <template v-if="relationCustomerList.length > 1" #insurerName>
                <CustomerList
                  title="选择被保人"
                  :user-info="orderDetail.tenantOrderInsuredList[0]"
                  :data="relationCustomerList"
                  @change="onUpdateInsurerData"
                />
              </template>
            </InsureForm> -->
          </div>
          <PaymentType
            :form-info="guaranteeObj"
            :risk-info="mainRiskInfo"
            :tenant-product-detail="tenantProductDetail.PREMIUM"
            :plan-list="planList"
            :premium-info="{ premium, premiumLoadingText }"
            @update-active-plan="updateActivePlan"
          />
          <Package v-if="currentPackageConfigVOList.length > 0" :package-product-list="currentPackageConfigVOList" />
        </template>
      </ScrollInfo>
      <ProLazyComponent>
        <InscribedContent
          v-if="tenantProductDetail.SIGNATURE?.inscribedContent"
          :inscribed-content="tenantProductDetail?.SIGNATURE?.inscribedContent"
        />
      </ProLazyComponent>
      <ProLazyComponent>
        <AttachmentList
          v-if="filterHealthAttachmentList && filterHealthAttachmentList.length > 0"
          :attachement-list="filterHealthAttachmentList"
          pre-text="请阅读"
          @preview-file="(index) => previewFile(index)"
        />
      </ProLazyComponent>
      <template v-if="showFooterBtn">
        <TrialButton
          :premium="premium"
          :loading-text="premiumLoadingText"
          :plan-code="guaranteeObj.planCode"
          :payment-frequency="guaranteeObj.paymentFrequency"
          :tenant-product-detail="tenantProductDetail"
          @click="onNext"
          >立即投保</TrialButton
        >
      </template>
    </div>
    <PreNotice v-if="preNoticeLoading" :product-detail="tenantProductDetail"></PreNotice>
    <div id="xinaoDialog"></div>
  </van-config-provider>
  <HealthNoticePreview
    v-model:show="showHealthPreview"
    :content-list="healthAttachmentList"
    :active-index="0"
    @on-confirm-health="onCloseHealth"
    @on-close-health-by-mask="onResetFileFlag"
  ></HealthNoticePreview>
  <!-- <FilePreview
    v-if="showFilePreview"
    v-model:show="showFilePreview"
    :content-list="isOnlyView ? filterHealthAttachmentList : mustReadFileList"
    :is-only-view="isOnlyView"
    :active-index="activeIndex"
    :text="isOnlyView ? '关闭' : '我已逐页阅读并确认告知内容'"
    :force-read-cound="isOnlyView ? 0 : 2"
    @submit="onSubmit"
    @on-close-file-preview-by-mask="onResetFileFlag"
  ></FilePreview> -->
</template>

<script lang="ts" setup name="InsuranceShort">
import { useRoute, useRouter } from 'vue-router';
import { Toast, Dialog } from 'vant/es';
import debounce from 'lodash-es/debounce';
import { useIntersectionObserver } from '@vueuse/core';
import { useTheme } from '@/hooks/useTheme';
import {
  ProductDetail,
  AttachmentVOList,
  PlanInsureVO,
  ProductPremiumVoItem,
  ProductFactorItem,
  InsureProductData,
  ProductPlanInsureVoItem,
  RiskDetailVoItem,
} from '@/api/modules/product.data';
import { ProductDetail as ProductData } from '@/api/modules/newTrial.data';
import {
  OrderDetail,
  PackageProductVoItem,
  RiskPremiumDetailVoItem,
  TenantOrderRiskItem,
  TenantOrderHolder,
  TenantOrderInsuredItem,
  PremiumCalcData,
  RelationCustomer,
} from '@/api/modules/trial.data';
import {
  premiumCalc,
  insureProductDetail as getInsureProductDetail,
  getTenantOrderDetail,
  underWriteRule,
} from '@/api/modules/trial';
import { productDetail as getTenantProductDetail, queryProductMaterial, querySalesInfo } from '@/api/modules/product';
import { nextStepOperate as nextStep } from '../nextStep';

import {
  SOCIAL_SECURITY_ENUM,
  RELATION_HOLDER_ENUM,
  PAYMENT_COMMON_FREQUENCY_ENUM,
  ORDER_DETAIL_KEY,
  INSURE_TYPE_ENUM,
} from '@/common/constants/infoCollection';
import { INSURANCE_PERIOD_ENUM, RELATIONENUM } from '@/common/constants/trial';
import { CERT_TYPE_ENUM } from '@/common/constants';

import { useWXCode } from '../../cashier/core';
import useAddressList from '@/hooks/useAddressList';
import useLoading from '@/hooks/useLoading';
// import { useTheme } from '../theme';
import { isEmpty, toLocal } from '@/utils';
import { transformData, riskToOrder, validateSmsCode, getFileType } from '../utils';
import { validateCustomName } from '@/utils/validator';

import Banner from './components/Banner/index.vue';
import Guarantee from './components/Guarantee/index.vue';
import PreNotice from './components/PreNotice/index.vue';
import Package from './components/Package/index.vue';
import { YES_NO_ENUM, PAGE_ACTION_TYPE_ENUM } from '@/common/constants/index';
import { isTestEnv, isAppFkq } from '@/utils/index';

import ScrollInfo from './components/ScrollInfo/index.vue';

import { sendCode, checkCode } from '@/api/modules/phoneVerify';
import { sessionStore } from '@/hooks/useStorage';
import { TenantOrderProductItem } from '@/api/index.data';
import useOrder from '@/hooks/useOrder';
import TrialButton from './components/TrialButton.vue';
import useAttachment from '@/hooks/useAttachment';
import { combineOccupation, ProRenderFormWithCard, transformFactorToSchema } from '@/components/RenderForm';
import { formData2Order } from './utils';

const isApp = isAppFkq();
const FilePreview = defineAsyncComponent(() => import('./components/FilePreview/index.vue'));
const HealthNoticePreview = defineAsyncComponent(() => import('./components/HealthNoticePreview/index.vue'));
const PaymentType = defineAsyncComponent(() => import('./components/PaymentType/index.vue'));
const ProShadowButton = defineAsyncComponent(() => import('./components/ProShadowButton/index.vue'));
const InsureForm = defineAsyncComponent(() => import('./components/InsureForm/index.vue'));
const CustomerList = defineAsyncComponent(() => import('./components/CustomerList/index.vue'));
const InscribedContent = defineAsyncComponent(() => import('./components/InscribedContent/index.vue'));
const AttachmentList = defineAsyncComponent(() => import('./components/AttachmentList/index.vue'));

const themeVars = useTheme();
const router = useRouter();
const route = useRoute();

/** 页面query参数类型 */
interface QueryData {
  productCode: string; // 产品code
  tenantId: string; // 订单id
  phoneNo: string; // 手机号
  agentCode: string;
  agencyCode: string;
  orderNo: string;
  pageCode: string;
  from: string; // from = 'check' 审核版
  preview: string;
  [key: string]: string;
}

const {
  productCode = '',
  tenantId,
  agentCode = '',
  agencyCode,
  saleChannelId,
  extraInfo,
  insurerCode,
  preview,
} = route.query as QueryData;

let extInfo: any = {};

try {
  console.log('extInfo', decodeURIComponent(extraInfo));

  extInfo = JSON.parse(decodeURIComponent(extraInfo as string));
} catch (error) {
  //
}

const { openId } = extInfo;

const formRef = ref();
const detailScrollRef = ref();
const observeRef = ref();
const showFooterBtn = ref<boolean>(false);

const tenantProductDetail = ref<Partial<ProductDetail>>({}); // 核心系统产品信息
const insureProductDetail = ref<Partial<InsureProductData>>({}); // 产品中心产品信息

const showHealthPreview = ref<boolean>(false); // 是否显示健康告知
const showFilePreview = ref<boolean>(false); // 附件资料弹窗展示状态
const activeIndex = ref<number>(0); // 附件资料弹窗中要展示的附件编号
const preNoticeLoading = ref<boolean>(false); // 首页弹窗
const premiumMap = ref<any>({}); // 试算后保费
const relationList = ref<any>({});
const isOnlyView = ref<boolean>(true); // 资料查看模式
const needDesensitize = ref<boolean>(true); // 投被保人身份证手机号是否需要掩码
const loading = ref<boolean>(true);
const iseeBizNo = ref('');
const currentPackageConfigVOList = ref([]); // 加油包列表
const currentFactor = ref<any>({});
const currentPlanObj = ref<Partial<ProductPlanInsureVoItem>>({});
const mainRiskInfo = ref<Partial<RiskDetailVoItem>>({}); // 标准主险信息
const planList = ref<any[]>([]);

const holderFormRef = ref<InstanceType<typeof ProRenderFormWithCard>>();
const insuredFormRef = ref<InstanceType<typeof ProRenderFormWithCard>>();

const sendSMSCode = async ({ mobile }, callback) => {
  const res = await sendCode(mobile);
  const { code } = res;
  if (code === '10000') {
    typeof callback === 'function' && callback();
  }
};

const state = reactive({
  // 投保人
  holder: {
    formData: {},
    schema: [],
    // 试算因子
    trialFactorCodes: [],
    config: {
      name: {
        // slots: {
        //   nameTips: 'extra',
        // },
        // unit: '元',
      },
      verificationCode: {
        sendSMSCode,
      },
      certType: {
        // visible: false,
      },
      certNo: {
        label: '身份证号',
      },
      occupation: {
        dictCode: combineOccupation(insurerCode),
      },
    },
  },
  // 被保人
  insuredList: [
    {
      formData: {},
      schema: [],
      // 试算因子
      trialFactorCodes: [],
      config: {
        relationToHolder: {
          label: '',
        },
        certNo: {
          label: '身份证号',
        },
      },
    },
  ],
});

if (openId) {
  useAddressList({ openId }, (data: any) => {
    relationList.value = data;
  });
}

// 分享信息
const shareInfo = ref({
  imgUrl: '',
  desc: '',
  title: '',
  link: window.location.href,
});

const setShareLink = (config: { image: string; desc: string; title: string }) => {
  shareInfo.value = {
    desc: config.desc || '你好，这里是描述',
    imgUrl: config.image,
    title: config.title,
    link: window.location.href,
  };
};

// 订单数据
const orderDetail = useOrder({
  extInfo: {
    buttonCode: 'EVENT_SHORT_saveOrder',
    pageCode: 'productInfo',
    extraInfo: extInfo,
    templateId: extInfo?.templateId || '1',
    iseeBizNo: '',
  },
});

// 保障方案相关信息
const guaranteeObj = ref<any>({});

// 是否是preview模式
const previewMode = computed(() => !!preview);

/* -------产品资料模块------------ */
const healthAttachmentList = ref([]);
const queryProductMaterialData = () => {
  queryProductMaterial({ productCode }).then(({ code, data }) => {
    if (code === '10000') {
      const { productInsureMaterialVOList, productQuestionnaireVOList } = data;
      const {
        basicInfo: { questionnaireType },
        questions,
        questionnaireName,
      } = productQuestionnaireVOList?.[0]?.questionnaireDetailResponseVO || { basicInfo: {} };
      // 1: 文本 2、问答
      if (questionnaireType === 2) {
        healthAttachmentList.value = [
          {
            attachmentName: questionnaireName,
            attachmentUri: questions,
            attachmentType: 'question',
          },
        ];
      }
      healthAttachmentList.value = [
        {
          attachmentName: questionnaireName,
          attachmentUri: questions?.[0]?.content,
          attachmentType: getFileType(String(questions?.[0]?.textType), questions?.[0]?.content),
        },
      ];
    }
  });
};

// 初始化数据，获取产品配置详情和产品详情
const initData = async () => {
  querySalesInfo({ productCode, tenantId }).then(({ data, code }) => {
    if (code === '10000') {
      tenantProductDetail.value = data;
      document.title = data.BASIC_INFO.title || '';
      const { title, desc, image } = data?.showConfigVO || {};
      // 设置分享参数
      setShareLink({ title, desc, image });
    }
  });

  await getInsureProductDetail({ productCode }).then(({ data, code }) => {
    if (code === '10000') {
      preNoticeLoading.value = true;
      insureProductDetail.value = data;
      currentPlanObj.value = data.productPlanInsureVOList?.[0];
      planList.value = (data.productPlanInsureVOList || [])
        .filter((plan) => plan.planCode)
        .map((plan) => ({ planName: plan.planName, planCode: plan.planCode }));
    }
  });

  loading.value = false;
  queryProductMaterialData();
};

// 用户信息反显以及通讯录信息
const relationCustomerList = computed(() => {
  if (relationList.value) {
    const result: any = [];
    Object.keys(relationList.value).forEach((key) => {
      result.push(...relationList.value[key]);
    });
    return result;
  }
  return [];
});

// 是否是老客户
const isOldUser = computed(() => {
  return relationCustomerList.value.length > 0;
});

// 是否可以在无身份证的时候默认设置证件类型为身份证
// const isSetDefaultCertNo = computed(() => {
//   const factorList = factorObj.value?.[2] || [];
//   const idx = factorList.findIndex((e: ProductFactorItem) => e.code === 'certType');
//   if (idx > -1) {
//     const { attributeValues, isDisplay } = factorList[idx] || {};
//     if (isDisplay === 1) {
//       const attributeValuesList = JSON.parse(attributeValues);
//       if (attributeValuesList.length > 1) return false;
//       if (attributeValuesList.length === 1 && attributeValuesList[0].code !== '1') return false;
//     }
//     return true;
//   }
//   return false;
// });

// 险种信息
const currentRiskInfo = ref([]);

// 切换计划
const updateActivePlan = (planCode: string) => {
  console.log('currentPlanObj.value', planCode, currentPlanObj.value);
};

watch(
  () => guaranteeObj.value.planCode,
  (planCode) => {
    currentPlanObj.value = (insureProductDetail.value.productPlanInsureVOList || []).find(
      (plan) => plan.planCode === planCode,
    );
  },
);

// 滑动到投保信息
const onClickToInsure = () => {
  detailScrollRef.value.handleClickTab()('tab3');
};

// 通讯录投保人信息更新
const onUpdateHolderData = (data: RelationCustomer) => {
  needDesensitize.value = false;
  Object.assign(orderDetail.value.tenantOrderHolder, data);
  nextTick(() => {
    needDesensitize.value = true;
  });
};

// 通讯录被保人信息更新
const onUpdateInsurerData = (data: RelationCustomer) => {
  needDesensitize.value = false;
  Object.assign(orderDetail.value.tenantOrderInsuredList[0], data);
  nextTick(() => {
    needDesensitize.value = true;
  });
};

/** -----------资料阅读模块开始-------------------- */
// const { fileList = [], mustReadFileList = [] } = useAttachment('', {});
const fileList = ref([]);
const mustReadFileList = ref([]);
// 文件预览
const previewFile = (index: number) => {
  activeIndex.value = index;
  showFilePreview.value = true;
};

// 试算参数转化为生成订单参数
const trialData2Order = (
  currentProductDetail: ProductData = {} as ProductData,
  riskPremium = {},
  currentOrderDetail = {},
) => {
  debugger;
  const nextStepParams: any = { ...currentOrderDetail };
  const transformDataReq = {
    tenantId,
    riskList: nextStepParams.tenantOrderInsuredList[0]?.tenantOrderProductList[0].riskVOList || [],
    riskPremium,
    productId: currentProductDetail.id,
  };
  nextStepParams.extInfo.iseeBizNo = iseeBizNo.value;
  nextStepParams.productCode = currentProductDetail.productCode;
  nextStepParams.commencementTime = nextStepParams.insuranceStartDate;
  nextStepParams.expiryDate = nextStepParams.insuranceEndDate;
  nextStepParams.tenantOrderHolder = {
    ...nextStepParams.tenantOrderHolder,
    certType: nextStepParams.tenantOrderHolder.certType || CERT_TYPE_ENUM.CERT,
    certNo: (nextStepParams.tenantOrderHolder.certNo || '').toLocaleUpperCase(),
    extInfo: {
      ...nextStepParams.tenantOrderHolder.extInfo,
    },
  };
  nextStepParams.tenantOrderInsuredList = nextStepParams.tenantOrderInsuredList.map((insurer: any) => {
    return {
      ...insurer,
      certType: insurer.certType || CERT_TYPE_ENUM.CERT,
      certNo: (insurer.certNo || '').toLocaleUpperCase(),
      planCode: currentPlanObj.value.planCode,
      extInfo: {
        ...insurer.extInfo,
      },
    };
  });
  nextStepParams.tenantOrderInsuredList[0].tenantOrderProductList[0] = {
    // premium: premium.value,
    productCode: currentProductDetail.productCode,
    productName: currentProductDetail.productName,
    planCode: currentPlanObj.value.planCode,
    tenantOrderRiskList: transformData(transformDataReq),
  };
  return nextStepParams;
};

// 核保接口调用
const onUnderWrite = async (orderNo: string) => {
  try {
    const { code, data } = await getTenantOrderDetail({ orderNo, tenantId });
    if (code === '10000') {
      // 核保 buttonCode: 'EVENT_SHORT_underWrite'
      data.extInfo = { ...data.extInfo, buttonCode: 'EVENT_SHORT_underWrite' };
      await nextStep(data);
    }
  } catch (error) {
    //
  }
};

// 生成订单
const onSaveOrder = async () => {
  try {
    await nextStep(
      trialData2Order(insureProductDetail.value, premiumMap.value, orderDetail.value),
      async (data: any, pageAction: string) => {
        if (pageAction === PAGE_ACTION_TYPE_ENUM.JUMP_PAGE) {
          if (data?.orderNo) {
            await onUnderWrite(data?.orderNo);
          }
        }
      },
    );
  } catch (error) {
    //
  }
};

/** -------------  保费试算 -----------------*/
const premiumLoadingText = ref<string>('');
const premium = ref<number>(0);

const trialPremium = async (
  orderInfo: OrderDetail,
  currentProductDetail: any,
  productRiskList: any,
  isOnlyPremiumCalc = true,
) => {
  const { chargePeriod, coveragePeriod, paymentFrequency, insuranceEndDate, insuranceStartDate } = guaranteeObj.value;
  premiumLoadingText.value = '保费试算中...';
  const tempRiskVOList = riskToOrder(productRiskList).map((riskVOList: any) => {
    return {
      ...riskVOList,
      paymentFrequency,
      chargePeriod, // 保障期限
      coveragePeriod,
    };
  });
  // 试算接口参数组装
  const trialParams = {
    tenantId,
    productCode: currentProductDetail.productCode,
    insuranceStartDate,
    insuranceEndDate,
    holder: {
      personVO: {
        ...orderInfo.tenantOrderHolder,
        socialFlag: orderInfo.tenantOrderHolder.extInfo?.hasSocialInsurance,
        certType: orderInfo.tenantOrderHolder.certType || CERT_TYPE_ENUM.CERT,
      },
    },
    insuredVOList: orderInfo.tenantOrderInsuredList.map((person) => {
      return {
        insuredCode: '',
        relationToHolder: person.relationToHolder,
        personVO: {
          ...person,
          socialFlag: person.extInfo.hasSocialInsurance,
          certType: person.certType || CERT_TYPE_ENUM.CERT,
        },
        productPlanVOList: [
          {
            insurerCode,
            planCode: currentPlanObj.value.planCode,
            riskVOList: tempRiskVOList,
          },
        ],
      };
    }),
  };
  const { code: ruleCode, message: ruleMessage } = await underWriteRule(trialParams);

  if (ruleCode === '10000') {
    const { code, data } = await premiumCalc(trialParams as PremiumCalcData);
    if (code === '10000') {
      premiumLoadingText.value = '';
      orderDetail.value.tenantOrderInsuredList[0].tenantOrderProductList =
        trialParams.insuredVOList[0].productPlanVOList;
      premium.value = data?.premium;
      orderDetail.value.premium = data.premium;
      orderDetail.value.orderAmount = data.premium;
      orderDetail.value.orderRealAmount = data.premium;
      if (!isOnlyPremiumCalc) {
        // 获取试算结果，存储，在健告通过后将保费赋值给对应的险种
        const riskPremiumMap = {};
        if (data.riskPremiumDetailVOList && data.riskPremiumDetailVOList.length) {
          data.riskPremiumDetailVOList.forEach((riskDetail: any) => {
            riskPremiumMap[riskDetail.riskCode] = {
              premium: riskDetail.premium,
              amount: riskDetail.amount,
            };
          });
        }
        premiumMap.value = riskPremiumMap;
        // 文件弹窗
        if (mustReadFileList.value.length > 0) {
          isOnlyView.value = false;
          previewFile(0);
        } else if (healthAttachmentList.value.length > 0) {
          // 无文件，弹健告
          showHealthPreview.value = true;
        } else {
          // 无文件、无健告直接生成订单
          await onSaveOrder();
        }
      }
    } else {
      premiumLoadingText.value = '';
    }
  } else {
    premiumLoadingText.value = '';
    Toast(ruleMessage);
  }
};

// 获取选中的加油包列表
const getPackageRiskList = () => {
  const packageRiskList = [];

  currentPackageConfigVOList.value
    .filter((packageItem) => packageItem.value === INSURE_TYPE_ENUM.INSURE)
    .forEach((e) => {
      packageRiskList.push(...e.productRiskVoList);
    });

  return packageRiskList;
};

// 点击立即投保
const onNext = async () => {
  console.log('insuredFormRef', insuredFormRef);
  if (premium.value) {
    onSaveOrder();
    return;
  }
  try {
    showHealthPreview.value = false;
    showFilePreview.value = false;
    if (holderFormRef.value) {
      holderFormRef.value
        .validate()
        .then(async () => {
          // 老用户或者投保要素不包含验证码的情况
          if (isOldUser.value) {
            await trialPremium(
              orderDetail.value as OrderDetail,
              insureProductDetail.value,
              [...currentRiskInfo.value, ...getPackageRiskList()],
              false,
            );
          } else {
            // 验证码验证
            const smsCode = orderDetail.value.tenantOrderHolder?.verificationCode;
            if (!validateSmsCode(smsCode)) {
              Toast({
                message: '请输入正确的验证码',
              });
              return;
            }
            const { code, data } = await checkCode(orderDetail.value.tenantOrderHolder.mobile as string, smsCode);
            if (code === '10000') {
              await trialPremium(
                orderDetail.value as OrderDetail,
                insureProductDetail.value,
                [...currentRiskInfo.value, ...getPackageRiskList()],
                false,
              );
            }
          }
        })
        .catch(() => {
          // 表单验证错误定位问题
          const dom = document.querySelector('.form-title');
          if (dom) {
            dom.scrollIntoView();
          }
        });
    }
  } catch (e) {
    //
  }
};

// 健告选择弹窗
const onCloseHealth = (type: string) => {
  // 全部为否
  if (type === 'allFalse') {
    showHealthPreview.value = false;
    onSaveOrder();
  } else {
    Dialog.confirm({
      className: 'xinao-custom-dialog',
      title: '提示',
      teleport: '#xinaoDialog',
      message: '被保人不符合健康要求，很抱歉暂时无法投保该产品',
      confirmButtonText: '选错了',
      cancelButtonText: '为其他人投保',
    })
      .then(() => {
        // 选错了的情况下不做特殊处理，让用户重新选择
      })
      .catch(() => {
        // 为其他人投保
        showHealthPreview.value = false;
      });
  }
};

// 文件阅读完毕
const onSubmit = () => {
  showFilePreview.value = false;
  isOnlyView.value = true;
  if (healthAttachmentList.value.length < 1) {
    onSaveOrder();
  } else {
    showHealthPreview.value = true;
  }
};

const onResetFileFlag = () => {
  showHealthPreview.value = false;
  showFilePreview.value = false;
  isOnlyView.value = true;
};

// 表单组件切换被保人时不会赋值默认社保以及身份证类型，需手动赋值
watch(
  () => orderDetail.value.tenantOrderInsuredList[0].relationToHolder,
  () => {
    // 被保人与投保人关系切换时，重置加油包为不投保
    if (currentPackageConfigVOList.value) {
      currentPackageConfigVOList.value.forEach((e) => {
        e.value = INSURE_TYPE_ENUM.UN_INSURE;
      });
    }

    needDesensitize.value = false;
    nextTick(() => {
      const { certType, extInfo: insuredExtInfo } = orderDetail.value.tenantOrderInsuredList[0];

      if (insuredExtInfo && !insuredExtInfo.hasSocialInsurance) {
        orderDetail.value.tenantOrderInsuredList[0].extInfo.hasSocialInsurance = SOCIAL_SECURITY_ENUM.HAS;
      }
      // if (isSetDefaultCertNo.value && !certType) {
      //   orderDetail.value.tenantOrderInsuredList[0].certType = CERT_TYPE_ENUM.CERT;
      // }
      needDesensitize.value = true;
    });
  },
  {
    deep: true,
    immediate: true,
  },
);

// 监听投被保人数据，同步到订单结构
watch(
  [() => state.holder.formData, () => state.insuredList],
  ([holder, insuredList]) => {
    Object.assign(
      orderDetail.value,
      formData2Order({ holder, insuredList: insuredList.map((insured) => insured.formData) }),
    );
  },
  {
    deep: true,
  },
);

const onTrialCheck = (): boolean => {
  const {
    name,
    birthday,
    gender,
    certType,
    extInfo: { hasSocialInsurance },
  } = orderDetail.value.tenantOrderInsuredList[0];

  if (
    birthday &&
    gender &&
    orderDetail.value.paymentFrequency &&
    name &&
    validateCustomName(name) &&
    hasSocialInsurance
  ) {
    return true;
  }
  return false;
};

// 设置产品保费 =》 试算保费 | 默认保费
const setPremium = () => {
  if (onTrialCheck()) {
    // 试算的话，优先在这里将保费文字改为加载中，因为watch触发试算有延迟，导致文案切换过慢
    premiumLoadingText.value = '保费试算中...';
  }
};

// 当计划和交费方式切换时，需重置产品保费为默认值
watch(
  [() => currentPlanObj.value, () => guaranteeObj.value.paymentFrequency],
  () => {
    setPremium();
  },
  {
    deep: true,
    immediate: true,
  },
);

// 监听试算因子
watch(
  () => [
    ...state.holder.trialFactorCodes.map((key) => state.holder.formData[key]),
    ...state.insuredList.reduce((res, insuredItem, index) => {
      res.push(...insuredItem.trialFactorCodes.map((key) => state.insuredList[index].formData[key]));
      return res;
    }, []),
  ],
  (...rest) => {
    // if (holderFormRef.value) {
    //   holderFormRef.value.validate()
    // }
    console.log(999999, rest);
    console.log('%c🔥 试算因子变动了', 'color:#1989fa;background:#5e4;padding:3px 5px;');
  },
  {
    deep: true,
    immediate: true,
  },
);
watch(
  [
    () => orderDetail.value.tenantOrderInsuredList[0].birthday,
    () => orderDetail.value.tenantOrderInsuredList[0].name,
    () => orderDetail.value.tenantOrderInsuredList[0].gender,
    () => orderDetail.value.tenantOrderInsuredList[0].extInfo.hasSocialInsurance,
    () => orderDetail.value.activePlanCode,
    () => orderDetail.value.paymentFrequency,
    () => orderDetail.value.insurancePeriodValue,
    () => currentPackageConfigVOList.value,
  ],
  debounce(() => {
    if (onTrialCheck()) {
      // 预览模式，不需要试算
      if (previewMode.value) return;
      // 产品试算
      trialPremium(orderDetail.value as OrderDetail, insureProductDetail.value, [
        ...currentRiskInfo.value,
        ...getPackageRiskList(),
      ]);
    } else {
      // 设置产品保费
      setPremium();
    }
  }, 500),
  {
    deep: true,
  },
);

// 老客户信息反显，被保人与投保人关系切换时，根据关系获取老用户信息
// watch(
//   () => orderDetail.value.tenantOrderInsuredList[0],
//   (e) => {
//     if (isEmpty(relationList.value)) return null;
//     const targets = relationList.value[e.relationToHolder] || [];
//     if (targets.length === 1) {
//       if (RELATIONENUM.SELF !== e.relationToHolder) {
//         const { dontFetchDefaultInfo, certNo, name, certType, mobile } = orderDetail.value.tenantOrderInsuredList[0];
//         if (!dontFetchDefaultInfo) {
//           Object.assign(orderDetail.value.tenantOrderInsuredList[0], {
//             dontFetchDefaultInfo: true,
//             certNo: certNo || targets[0].cert[0].certNo,
//             name: name || targets[0].cert[0].certName,
//             certType: certType || targets[0].cert[0].certType || CERT_TYPE_ENUM.CERT,
//             mobile: mobile || targets[0].contact[0].contactNo,
//           });
//         }
//       } else {
//         const { dontFetchDefaultInfo, certNo, name, certType, mobile } = orderDetail.value.tenantOrderHolder;
//         if (!dontFetchDefaultInfo) {
//           Object.assign(orderDetail.value.tenantOrderHolder, {
//             dontFetchDefaultInfo: true,
//             certNo: certNo || targets[0].cert[0].certNo,
//             name: name || targets[0].cert[0].certName,
//             certType: certType || targets[0].cert[0].certType || CERT_TYPE_ENUM.CERT,
//             mobile: mobile || targets[0].contact[0].contactNo,
//           });
//         }
//       }
//     }
//     return false;
//   },
//   {
//     immediate: true,
//     deep: true,
//   },
// );

// 监听投保人信息
watch(
  () => state.holder.formData,
  (...rest) => {
    console.log('%c🔥 投保人信息变动了', 'color:#1989fa;background:#5e4;padding:3px 5px;');
    state.insuredList.forEach((insuredItem, index) => {
      const { formData, schema } = insuredItem || {};
      // 若为本人合并投保人数据
      if (formData.relationToHolder === '1') {
        Object.assign(insuredItem.formData, state.holder.formData);
      }
    });
  },
  {
    deep: true,
    immediate: true,
  },
);

// 切换计划时,
watch(
  () => currentPlanObj.value,
  () => {
    let { productFactor } = currentPlanObj.value;
    const { oilPackageProductVOList, planCode, insureProductRiskVOList } = currentPlanObj.value;
    if (isOldUser.value && productFactor[1]) {
      productFactor = productFactor[1].filter((e: ProductFactorItem) => e.code !== 'verificationCode');
    }

    // 设置默认选中的计划
    guaranteeObj.value.planCode = planCode;

    currentRiskInfo.value = insureProductRiskVOList;

    mainRiskInfo.value = (insureProductRiskVOList || []).find((risk) => risk.mainRiskFlag === YES_NO_ENUM.YES);
    console.log('mainRiskInfo.value', mainRiskInfo.value);
    currentPackageConfigVOList.value = (oilPackageProductVOList || []).map((oli) => ({
      ...oli,
      value: INSURE_TYPE_ENUM.UN_INSURE,
    }));

    const [holder, insured, beneficiary] = transformFactorToSchema(productFactor);
    state.holder = {
      ...state.holder,
      ...holder,
    };
    state.insuredList[0] = {
      ...state.insuredList[0],
      ...insured,
    };
  },
  {
    deep: true,
    immediate: true,
  },
);

// 监听投被保人关系
watch(
  () => state.insuredList.map((item, index) => state.insuredList[index].formData.relationToHolder),
  (val, val1) => {
    console.log('%c🔥 与投保人关系变动了', 'color:#1989fa;background:#5e4;padding:3px 5px;');
    state.insuredList.forEach((insuredItem, index) => {
      const { formData, schema, config } = insuredItem || {};

      const isSelf = formData.relationToHolder === '1';
      const isChild = formData.relationToHolder === '3';

      config.certNo.label = `身份证号${isChild ? '(户口簿)' : ''}`;

      insuredItem.schema.forEach((schemaItem) => {
        schemaItem.relationToHolder = formData.relationToHolder;
        schemaItem.hidden = !schemaItem.isSelfInsuredNeed && isSelf;
      });

      // 若为本人合并投保人数据
      if (isSelf) {
        Object.assign(insuredItem.formData, {
          ...state.insuredList[index].formData,
          ...state.holder.formData,
        });
      } else {
        Object.assign(insuredItem.formData, {
          ...Object.keys(insuredItem.formData).reduce((res, key) => {
            res[key] = '';
            return res;
          }, {}),
          relationToHolder: formData.relationToHolder,
        });
      }
    });
  },
  {
    immediate: true,
    deep: true,
  },
);

// 底部按钮展示逻辑
nextTick(() => {
  useIntersectionObserver(observeRef, ([{ isIntersecting }], observerElement) => {
    showFooterBtn.value = !isIntersecting;
  });
});

// 需要支付的页面发起微信授权
// useWXCode();

// 再来一单，数据反显
onBeforeMount(() => {
  const oldOrderDetailInfo = sessionStore.get(ORDER_DETAIL_KEY);
  if (oldOrderDetailInfo) {
    const { tenantOrderHolder, tenantOrderInsuredList } = oldOrderDetailInfo;
    if (tenantOrderHolder) {
      orderDetail.value.tenantOrderHolder = {
        ...tenantOrderHolder,
        certType: tenantOrderHolder.certType || CERT_TYPE_ENUM.CERT,
      };
    }
    if (Array(tenantOrderInsuredList) && tenantOrderInsuredList[0]) {
      const insurer = tenantOrderInsuredList[0] || {};
      orderDetail.value.activePlanCode = insurer.planCode;
      if (
        insurer.tenantOrderProductListtenantOrderProductList &&
        insurer.tenantOrderProductList[0] &&
        insurer.tenantOrderProductList[0].tenantOrderRiskList
      ) {
        const item = insurer.tenantOrderProductList[0].tenantOrderRiskList?.find(
          (e: TenantOrderRiskItem) => String(e.riskType) === '1',
        );
        if (item) {
          orderDetail.value.paymentFrequency = item?.paymentFrequency
            ? String(item?.paymentFrequency)
            : PAYMENT_COMMON_FREQUENCY_ENUM.SINGLE;
        }
      }
    }
  }
});

onMounted(() => {
  loading.value = true;
  initData();
  // 调用千里眼插件获取一个iseeBiz
  setTimeout(async () => {
    iseeBizNo.value = window.getIseeBiz && (await window.getIseeBiz());
  }, 1500);
});

onUnmounted(() => {
  // 清除再来一单的缓存值
  sessionStore.remove(ORDER_DETAIL_KEY);
});
</script>

<style lang="scss" scoped>
.page-internet-product-detail {
  padding-bottom: 150px;
  background: #f1f5fc;

  .custom-page-form {
    background: #ffffff;
    .form-title {
      padding: 40px 0px 10px;
      text-align: center;
      font-size: 40px;
      font-family: PingFangSC-Medium, PingFang SC;
      font-weight: 500;
      color: #333333;
    }
    :deep(.com-card-wrap) {
      .header {
        margin-left: 0px !important;

        .title-wrapper .title {
          &::before {
            margin-right: 28px !important;
          }
        }
      }

      .relation-holder {
        .van-cell__title {
          display: none;
        }
      }
    }

    :deep(.radio-btn) {
      justify-content: flex-start;

      .btn-wrapper {
        margin-left: 0px !important;
        margin-right: 8px !important;
      }
    }
  }

  .footer-area {
    width: 100%;
    height: 150px;
    position: fixed;
    bottom: 0;
    left: 0;
    display: flex;
    align-items: center;
    border-top: 1px solid $zaui-line;
    padding: 0 30px;
    background: #ffffff;
    z-index: 10;
    justify-content: space-between;
    border-radius: 30px 30px 0px 0px;

    :deep(.com-share) {
      width: 77px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      span {
        font-size: 24px;
        color: $zaui-text;
      }
    }
  }

  // footer覆盖
  .price {
    color: #393d46;
    font-size: 34px;
    font-weight: normal;
    width: 270px;
    margin: 0 20px;

    span {
      color: $primary-color;
      font-weight: bold;

      &:last-child {
        font-size: 26px;
        font-family: PingFangSC-Regular, PingFang SC;
        font-weight: 400;
      }
    }
  }

  .right {
    width: 300px;
    height: 88px;
    border-radius: 44px;
  }
}
</style>
